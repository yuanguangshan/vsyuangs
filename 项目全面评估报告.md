# Yuangs AI Agent VS Code æ‰©å±•é¡¹ç›®å…¨é¢è¯„ä¼°æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

Yuangs AI Agent æ˜¯ä¸€æ¬¾åˆ›æ–°æ€§çš„ VS Code æ‰©å±•ï¼Œä»£è¡¨äº†"æ²»ç†å‹ AI"ï¼ˆGoverned AIï¼‰åœ¨å¼€å‘å·¥å…·é¢†åŸŸçš„å…ˆè¿›å®è·µã€‚è¯¥é¡¹ç›®ä¸ä»…æä¾›äº†æ™ºèƒ½ä»£ç è¾…åŠ©åŠŸèƒ½ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„"æ€è€ƒ-æ²»ç†-æ‰§è¡Œ"ï¼ˆThink-Govern-Executeï¼‰é—­ç¯ä½“ç³»ï¼Œåœ¨ä¿è¯ AI èƒ½åŠ›çš„åŒæ—¶ï¼Œé€šè¿‡å¤šå±‚å®‰å…¨æœºåˆ¶ç¡®ä¿ä»£ç å˜æ›´çš„å®‰å…¨æ€§ã€å¯æ§æ€§å’Œå¯è¿½æº¯æ€§ã€‚

æœ¬æŠ¥å‘Šå°†ä»åŠŸèƒ½ç‰¹æ€§ã€æ¶æ„è®¾è®¡ã€æ ¸å¿ƒæ–‡ä»¶è§£è¯»ã€æŠ€æœ¯åˆ›æ–°ã€åº”ç”¨åœºæ™¯ã€æœªæ¥å‘å±•è¶‹åŠ¿ç­‰å¤šä¸ªç»´åº¦ï¼Œå¯¹è¯¥é¡¹ç›®è¿›è¡Œå…¨æ–¹ä½çš„æ·±åº¦è¯„ä¼°ï¼Œå­—æ•°è¶…è¿‡ 10,000 å­—ã€‚

---

## ç¬¬ä¸€ç« ï¼šé¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½ä¸æ„¿æ™¯

Yuangs AI Agent çš„æ ¸å¿ƒå®šä½æ˜¯**æ·±åº¦é›†æˆåœ¨ VS Code ä¸­çš„æ–°ä¸€ä»£ AI è¾…åŠ©å¼€å‘å·¥å…·**ã€‚ä¸ä¼ ç»Ÿçš„ Chat æ’ä»¶ä¸åŒï¼Œå®ƒå…·å¤‡å®Œæ•´çš„é—­ç¯èƒ½åŠ›ï¼Œèƒ½å¤Ÿï¼š

1. **æ„ŸçŸ¥é¡¹ç›®ä¸Šä¸‹æ–‡**ï¼šé€šè¿‡æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿï¼Œç†è§£é¡¹ç›®ç»“æ„ã€æ–‡ä»¶å…³ç³»å’Œä¸šåŠ¡é€»è¾‘
2. **åœ¨å®‰å…¨æ²™ç®±ç›‘ç®¡ä¸‹æ‰§è¡Œä»»åŠ¡**ï¼šé€šè¿‡ WebAssembly ç‰©ç†æ²™ç®±å’Œç­–ç•¥ç³»ç»Ÿï¼Œç¡®ä¿æ‰€æœ‰ AI ç”Ÿæˆçš„ä»£ç å˜æ›´éƒ½åœ¨å¯æ§èŒƒå›´å†…
3. **æä¾›å¯è§£é‡Šã€å¯è¿½æº¯çš„å†³ç­–è¿‡ç¨‹**ï¼šæ¯ä¸€é¡¹æ“ä½œéƒ½æœ‰è¯¦ç»†çš„è®°å½•å’Œå®¡è®¡è½¨è¿¹

é¡¹ç›®çš„æ„¿æ™¯æ˜¯å°† AI ä»"å·¥å…·"å‡çº§ä¸º"å¯ä¿¡èµ–çš„åä½œä¼™ä¼´"ï¼Œåœ¨æå‡å¼€å‘æ•ˆç‡çš„åŒæ—¶ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œå®‰å…¨ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

è¯¥é¡¹ç›®åœ¨ä¼—å¤š AI ç¼–ç¨‹åŠ©æ‰‹ä¸­çš„ç‹¬ç‰¹ä»·å€¼ä½“ç°åœ¨ï¼š

**å®‰å…¨æ€§ä¼˜å…ˆ**
- å¤šå±‚å®‰å…¨é˜²å¾¡ä½“ç³»ï¼ˆSchema éªŒè¯ã€å®‰å…¨éªŒè¯å™¨ã€è‡ªåŠ¨åŒ–æ‰«æã€ç”¨æˆ·ç¡®è®¤ï¼‰
- WebAssembly ç‰©ç†æ²™ç®±éš”ç¦»æ‰§è¡Œ
- ç­–ç•¥çƒ­åŠ è½½æœºåˆ¶ï¼Œæ”¯æŒçµæ´»çš„æƒé™è¾¹ç•Œå®šä¹‰

**æ™ºèƒ½è€Œéè‡ªæ²»**
- AI åªèƒ½å»ºè®®ï¼Œä¸èƒ½è¶Šæƒ
- ä¸ç¡®å®šæ—¶å¿…é¡»åœä¸‹ï¼Œç­‰å¾…äººç±»ç¡®è®¤
- å¯è§£é‡Šçš„å†³ç­–è¿‡ç¨‹ï¼Œæ¯ä¸ªè¡ŒåŠ¨éƒ½æœ‰æ˜ç¡®çš„æ¨ç†ä¾æ®

**æ·±åº¦ä¸Šä¸‹æ–‡ç†è§£**
- Context Bank æŒä¹…åŒ–å­˜å‚¨é«˜ä»·å€¼ä¸Šä¸‹æ–‡
- DSL æŸ¥è¯¢è¯­è¨€æ”¯æŒç²¾ç¡®çš„ä¸Šä¸‹æ–‡æ£€ç´¢
- æ™ºèƒ½çš„ä¸Šä¸‹æ–‡é‡è¦æ€§è¯„ä¼°å’Œè‡ªåŠ¨æ¸…ç†

**å¼€å‘è€…ä½“éªŒä¼˜åŒ–**
- ç»ç’ƒæ‹Ÿæ€è®¾è®¡çš„ç°ä»£åŒ– UI
- æ™ºèƒ½ Diff åº”ç”¨ï¼Œä¸€é”®åº”ç”¨ä»£ç å˜æ›´
- Smart Stage æ™ºèƒ½åˆ†ç»„ Git æäº¤å»ºè®®
- å®æ—¶çš„å®‰å…¨æ‰«æå’Œé—®é¢˜æ ‡æ³¨

### 1.3 æŠ€æœ¯æ ˆæ¦‚è§ˆ

**å‰ç«¯ä¸é›†æˆå±‚**
- TypeScript 5.0+ï¼šç±»å‹å®‰å…¨çš„æ ¸å¿ƒå¼€å‘è¯­è¨€
- VS Code Extension APIï¼šæ·±åº¦é›†æˆåˆ°ç¼–è¾‘å™¨
- WebAssembly (AssemblyScript)ï¼šé«˜æ€§èƒ½çš„æ²™ç®±æ‰§è¡Œç¯å¢ƒ
- Webview æŠ€æœ¯ï¼šä¾§è¾¹æ èŠå¤©ç•Œé¢

**æ ¸å¿ƒå¼•æ“**
- Node.js è¿è¡Œæ—¶ï¼šåç«¯é€»è¾‘æ‰§è¡Œ
- Markdown è§£æï¼šæ”¯æŒå®Œæ•´çš„ Markdown æ¸²æŸ“
- YAML é…ç½®ï¼šç­–ç•¥æ–‡ä»¶æ ¼å¼

**å®‰å…¨ä¸éªŒè¯**
- Zodï¼šè¿è¡Œæ—¶ç±»å‹éªŒè¯
- è‡ªç ”å®‰å…¨éªŒè¯å™¨ï¼šå¤šå±‚å®‰å…¨æ£€æŸ¥
- å±æ€§åŸºæµ‹è¯•ï¼ˆPBTï¼‰ï¼šç¡®ä¿ diff åº”ç”¨é€»è¾‘çš„æ­£ç¡®æ€§

**æ„å»ºä¸å·¥å…·é“¾**
- Webpack 5ï¼šæ¨¡å—æ‰“åŒ…
- Mocha + Chaiï¼šå•å…ƒæµ‹è¯•æ¡†æ¶
- ESLintï¼šä»£ç è´¨é‡æ£€æŸ¥

---

## ç¬¬äºŒç« ï¼šåŠŸèƒ½ç‰¹æ€§æ·±åº¦è§£æ

### 2.1 æ ¸å¿ƒåŠŸèƒ½çŸ©é˜µ

#### 2.1.1 Thinkï¼ˆæ€è€ƒï¼‰æ¨¡å—

**è‡ªåŠ¨ä»»åŠ¡æ‹†è§£**
- åŸºäºå…ˆè¿› LLM çš„æ™ºèƒ½ä»»åŠ¡ç†è§£
- è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œå°†å¤æ‚ä»»åŠ¡æ‹†è§£ä¸ºå¯æ‰§è¡Œçš„æ­¥éª¤
- æ”¯æŒè‡ªç„¶è¯­è¨€è¾“å…¥ï¼Œæ— éœ€è®°å¿†ç‰¹å®šå‘½ä»¤

**ä¸Šä¸‹æ–‡æ„ŸçŸ¥**
- è‡ªåŠ¨åŠ è½½é¡¹ç›®ç›¸å…³ä¸Šä¸‹æ–‡
- DSL æŸ¥è¯¢æ”¯æŒï¼š`@file` å¼•ç”¨æ–‡ä»¶ï¼Œ`#symbol` å¼•ç”¨ç¬¦å·
- Context Bank æ™ºèƒ½æ£€ç´¢å†å²ä¸Šä¸‹æ–‡

**æ¨ç†è¿‡ç¨‹å¯è§†åŒ–**
- æ¯ä¸ªè¡ŒåŠ¨éƒ½é™„å¸¦è¯¦ç»†çš„æ¨ç†è¯´æ˜
- æ”¯æŒè°ƒè¯•æ¨¡å¼ä¸‹çš„å®Œæ•´æ‰§è¡Œè½¨è¿¹å›æ”¾

#### 2.1.2 Governï¼ˆæ²»ç†ï¼‰æ¨¡å—

**ä¸‰å±‚æ²»ç†ä½“ç³»**

1. **é¢„æ£€å±‚ï¼ˆPre-flightï¼‰**
   - è§„åˆ™å¼•æ“å¿«é€ŸéªŒè¯
   - åŸºäº policy.yaml çš„å³æ—¶æ‹’ç»
   - æ— å»¶è¿Ÿçš„å†³ç­–å“åº”

2. **é€»è¾‘å±‚ï¼ˆLogicalï¼‰**
   - å¤æ‚æ¡ä»¶çš„è¯„ä¼°
   - å†å²è¡Œä¸ºçš„å­¦ä¹ ä¸è°ƒæ•´
   - é£é™©è¯„åˆ†æœºåˆ¶

3. **ç‰©ç†å±‚ï¼ˆPhysical WASMï¼‰**
   - WebAssembly ç¼–è¯‘çš„è§„åˆ™å¼•æ“
   - çœŸæ­£çš„ç‰©ç†éš”ç¦»æ‰§è¡Œ
   - é˜²æ­¢å†…å­˜ç¯¡æ”¹å’Œä»£ç æ³¨å…¥

**ç­–ç•¥çƒ­åŠ è½½**
- æ”¯æŒé¡¹ç›®çº§ policy.yaml é…ç½®
- è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ç­–ç•¥è§„åˆ™
- æ”¯æŒå¤šç§æ•ˆæœï¼šå…è®¸ã€æ‹’ç»ã€è­¦å‘Š

**äººç±»ä»‹å…¥æœºåˆ¶**
- å…³é”®æ“ä½œï¼ˆåˆ é™¤æ–‡ä»¶ã€æ‰§è¡Œå±é™©è„šæœ¬ï¼‰è‡ªåŠ¨è§¦å‘ç¡®è®¤
- å¯é…ç½®çš„é£é™©çº§åˆ«é˜ˆå€¼
- æ”¯æŒæ‰¹é‡å®¡æ‰¹å’Œå•æ¬¡å®¡æ‰¹

#### 2.1.3 Executeï¼ˆæ‰§è¡Œï¼‰æ¨¡å—

**æ™ºèƒ½å·¥å…·è°ƒç”¨**
- `read_file`ï¼šæ™ºèƒ½è¯»å–æ–‡ä»¶å†…å®¹
- `write_file`ï¼šå®‰å…¨å†™å…¥æˆ–è¦†ç›–æ–‡ä»¶
- `list_files`ï¼šæµè§ˆé¡¹ç›®ç›®å½•ç»“æ„
- `shell_cmd`ï¼šåœ¨é›†æˆç»ˆç«¯æ‰§è¡Œå‘½ä»¤
- `code_diff`ï¼šåº”ç”¨ä»£ç å˜æ›´

**Diff æ™ºèƒ½åº”ç”¨**
- ä¸‰çº§åŒ¹é…ç­–ç•¥ï¼šç²¾ç¡®åŒ¹é… â†’ æ¨¡ç³ŠåŒ¹é… â†’ å†…å®¹ç›¸ä¼¼åº¦åŒ¹é…
- è‡ªåŠ¨å¤„ç†è¡Œå·åç§»
- æ”¯æŒéƒ¨åˆ†æˆåŠŸã€éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ
- äº‹åŠ¡æ€§åº”ç”¨ï¼Œæ”¯æŒå›æ»š

**è‡ªåŠ¨åŒ–æ‰«æ**
- å®‰å…¨æ‰«æï¼šæ£€æµ‹è·¯å¾„ç©¿è¶Šã€ç»å¯¹è·¯å¾„ã€æ•æ„Ÿç›®å½•è®¿é—®
- è´¨é‡æ‰«æï¼šæ£€æŸ¥æ–‡ä»¶å¤§å°ã€ä»£ç å¤æ‚åº¦
- æ¶æ„ Diff æµ‹è¯•ï¼šè‡ªåŠ¨åŒ–çš„å®‰å…¨æµ‹è¯•å¥—ä»¶

### 2.2 åˆ›æ–°åŠŸèƒ½è¯¦è§£

#### 2.2.1 Smart Stageï¼šæ²»ç†å‹ AI çš„å…¸èŒƒ

**æ ¸å¿ƒè®¾è®¡ç†å¿µ**

Smart Stage æ˜¯è¯¥é¡¹ç›®ä¸­æœ€å…·ä»£è¡¨æ€§çš„"æ²»ç†å‹ AI"åŠŸèƒ½ï¼Œå®ƒå®Œç¾ä½“ç°äº†é¡¹ç›®çš„æ ¸å¿ƒç†å¿µï¼š**AI åªèƒ½å»ºè®®ï¼Œä¸èƒ½è¶Šæƒï¼›ä¸ç¡®å®šæ—¶ï¼Œå¿…é¡»åœä¸‹**ã€‚

**å¤šä¿¡å·æŠ•ç¥¨ç³»ç»Ÿ**

Smart Stage ä½¿ç”¨ä¸‰ä¸ªç»´åº¦çš„ä¿¡å·è¿›è¡Œç»¼åˆåˆ¤æ–­ï¼š

1. **è·¯å¾„ä¿¡å·**ï¼šåŸºäºæ–‡ä»¶è·¯å¾„æ¨¡å¼ï¼ˆå¦‚ `/ui/`ã€`test/`ã€`docs/`ï¼‰
2. **å†…å®¹ä¿¡å·**ï¼šåŸºäº diff å†…å®¹ç‰¹å¾ï¼ˆå¦‚ JSX æ ‡è®°ã€æµ‹è¯•æ¡†æ¶è¯­æ³•ï¼‰
3. **å…³é”®è¯ä¿¡å·**ï¼šåŸºäºç‰¹å®šå…³é”®è¯ï¼ˆå¦‚ "fix:"ã€"docs:"ï¼‰

æ¯ç§ä¿¡å·éƒ½æœ‰é¢„è®¾æƒé‡ï¼Œé€šè¿‡åŠ æƒæŠ•ç¥¨å¾—å‡ºæœ€ç»ˆåˆ†ç±»ï¼Œé¿å…äº†å•ä¸€ä¿¡å·çš„è¯¯åˆ¤é£é™©ã€‚

**ç½®ä¿¡åº¦é©±åŠ¨çš„è¡Œä¸ºæ¨¡å¼**

æ¯ä¸€æ¬¡å†³ç­–éƒ½ä¼šç”Ÿæˆ 0.0â€“1.0 çš„ç½®ä¿¡åº¦è¯„åˆ†ï¼š

- **â‰¥ 0.6ï¼ˆè‡ªåŠ¨åˆ†ç»„ï¼‰**ï¼šAI è‡ªåŠ¨æ‰§è¡Œåˆ†ç»„æ“ä½œï¼Œæ— éœ€äººå·¥å¹²é¢„
- **0.3â€“0.6ï¼ˆå»ºè®®åˆ†ç»„ï¼‰**ï¼šAI æä¾›å»ºè®®ï¼Œä½†ç­‰å¾…ç”¨æˆ·ç¡®è®¤
- **< 0.3ï¼ˆéœ€è¦ç¡®è®¤ï¼‰**ï¼šAI æ˜ç¡®è¡¨ç¤ºä¸ç¡®å®šï¼Œå¿…é¡»ç­‰å¾…äººç±»å†³ç­–

è¿™ç§è®¾è®¡ç¡®ä¿äº† AI åœ¨é«˜ç½®ä¿¡åº¦æ—¶æé«˜æ•ˆç‡ï¼Œåœ¨ä½ç½®ä¿¡åº¦æ—¶é¿å…é”™è¯¯ã€‚

**å¯è§£é‡Šæ€§å¼ºåˆ¶è¦æ±‚**

æ¯ä¸€ä¸ªåˆ†ç»„ç»“æœéƒ½é™„å¸¦è¯¦ç»†çš„è§£é‡Šï¼š

- ä½¿ç”¨äº†å“ªäº›ä¿¡å·
- ä¸ºä»€ä¹ˆè¿™äº›ä¿¡å·é‡è¦
- ä¸ºä»€ä¹ˆå…¶ä»–åˆ†ç±»è¢«å¦å®š
- å†³ç­–çš„ç½®ä¿¡åº¦å’Œä¾æ®

è§£é‡Šä¸æ˜¯æ—¥å¿—ï¼Œè€Œæ˜¯äº§å“åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œç”¨æˆ·å¯ä»¥æ¸…æ¥šåœ°ç†è§£ AI çš„å†³ç­–è¿‡ç¨‹ã€‚

**äººç±»åé¦ˆå¾ªç¯**

å½“ç”¨æˆ·çº æ­£é”™è¯¯åˆ†ç±»æ—¶ï¼š

- ç³»ç»Ÿä¸ä¼š"å­¦ä¼šæ–°è§„åˆ™"ï¼ˆé¿å…æ¨¡å‹é€€åŒ–ï¼‰
- åªä¼šè°ƒæ•´å·²æœ‰ä¿¡å·çš„æƒé‡ï¼ˆå¾®è°ƒè€Œéé‡å­¦ï¼‰
- æ‰€æœ‰å­¦ä¹ éƒ½æœ‰ä¸Šä¸‹ç•Œï¼ˆ0.5-1.5 å€ç‡ï¼‰å’Œæ—¶é—´è¡°å‡ï¼ˆ7 å¤©ï¼‰

è¿™æ˜¯ä¸€ç§"å¯æ²»ç†çš„å­¦ä¹ "ï¼Œç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¤„äºäººç±»å¯æ§èŒƒå›´å†…ã€‚

#### 2.2.2 ä¸‰å±‚å®‰å…¨æ‰«æä½“ç³»

**Phase 1ï¼šAI ä»‹å…¥å‰çš„æœ¬åœ°æ‰«æ**

åœ¨ AI ç”Ÿæˆä»£ç ä¹‹å‰ï¼Œè¿è¡Œå¿«é€Ÿæœ¬åœ°æ‰«æï¼ˆ<50msï¼‰ï¼š

- æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™åŒ¹é…
- åŸºæœ¬çš„ä»£ç æ¨¡å¼æ£€æµ‹
- æ— éœ€ LLM å‚ä¸çš„è¶…ä½å»¶è¿Ÿæ‰«æ

å¦‚æœå‘ç°å…³é”®å®‰å…¨é—®é¢˜ï¼Œç«‹å³é˜»æ­¢ AI ä»‹å…¥ï¼Œé¿å…ç”Ÿæˆä¸å®‰å…¨çš„ä»£ç ã€‚

**Phase 2ï¼šDiff åº”ç”¨å‰çš„éªŒè¯**

åœ¨åº”ç”¨ diff ä¹‹å‰ï¼Œè¿›è¡Œå®Œæ•´çš„å®‰å…¨éªŒè¯ï¼š

- è·¯å¾„ç©¿è¶Šæ£€æµ‹ï¼ˆé˜²æ­¢ `../` æ”»å‡»ï¼‰
- ç»å¯¹è·¯å¾„æ£€æµ‹ï¼ˆé˜²æ­¢è®¿é—® `/etc/`ã€`C:\Windows\`ï¼‰
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé»˜è®¤ 1MBï¼‰
- Hunk Header ä¼ªé€ æ£€æµ‹
- æ–‡ä»¶æ‰©å±•åç™½åå•éªŒè¯

**Phase 3ï¼šDiff åº”ç”¨åçš„è¯­ä¹‰å®¡æŸ¥**

åœ¨åº”ç”¨ diff ä¹‹åï¼Œè¿›è¡Œè¯­ä¹‰çº§åˆ«çš„å®¡æŸ¥ï¼š

- è¯­æ³•æ­£ç¡®æ€§éªŒè¯
- ä»£ç é£æ ¼ä¸€è‡´æ€§æ£€æŸ¥
- æ½œåœ¨çš„é€»è¾‘é”™è¯¯æ£€æµ‹
- å®‰å…¨æ¼æ´æ‰«æ

**ç»¼åˆå®‰å…¨æŠ¥å‘Š**

ç³»ç»Ÿä¼šæ±‡æ€»æ‰€æœ‰æ‰«æç»“æœï¼Œç”ŸæˆåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„ç»¼åˆæŠ¥å‘Šï¼š

- æ€»ä½“è¯„ä¼°ï¼ˆpassed / warning / failedï¼‰
- å„çº§åˆ«é—®é¢˜æ•°é‡ç»Ÿè®¡
- è¯¦ç»†çš„ issue åˆ—è¡¨å’Œä½ç½®ä¿¡æ¯
- ä¿®å¤å»ºè®®å’Œä¼˜å…ˆçº§æ’åº

#### 2.2.3 Context Bankï¼šæ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†

**é«˜ä»·å€¼ä¸Šä¸‹æ–‡è¯†åˆ«**

ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å’Œæ ‡è®°é«˜ä»·å€¼çš„ä¸Šä¸‹æ–‡é¡¹ï¼š

- è¢«é¢‘ç¹å¼•ç”¨çš„æ–‡ä»¶
- åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ä»£ç 
- é¡¹ç›®é…ç½®æ–‡ä»¶å’Œæ–‡æ¡£
- ç”¨æˆ·æ˜¾å¼æ ‡è®°çš„é‡è¦æ–‡ä»¶

**ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†**

æ¯ä¸ªä¸Šä¸‹æ–‡é¡¹éƒ½æœ‰å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸè·Ÿè¸ªï¼š

- **åˆ›å»ºæ—¶é—´**ï¼šé¦–æ¬¡æ·»åŠ åˆ° ContextBuffer çš„æ—¶é—´
- **ä½¿ç”¨æ¬¡æ•°**ï¼šè¢«å¼•ç”¨å’Œä½¿ç”¨çš„æ¬¡æ•°
- **æˆåŠŸ/å¤±è´¥è®¡æ•°**ï¼šä½¿ç”¨è¯¥ä¸Šä¸‹æ–‡å®Œæˆä»»åŠ¡çš„æˆåŠŸç‡å’Œå¤±è´¥ç‡
- **æœ€åä½¿ç”¨æ—¶é—´**ï¼šæœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´
- **é‡è¦æ€§è¯„åˆ†**ï¼šç»¼åˆä»¥ä¸Šå› ç´ è®¡ç®—çš„åŠ¨æ€è¯„åˆ†

**è‡ªåŠ¨æ¸…ç†æœºåˆ¶**

ç³»ç»Ÿä¼šå®šæœŸæ¸…ç†ä½ä»·å€¼çš„ä¸Šä¸‹æ–‡é¡¹ï¼š

- é•¿æ—¶é—´æœªä½¿ç”¨çš„é¡¹ï¼ˆè¶…è¿‡ 30 å¤©ï¼‰
- ä½é‡è¦æ€§çš„é¡¹ï¼ˆè¯„åˆ† < 0.3ï¼‰
- ä½¿ç”¨å¤±è´¥ç‡é«˜çš„é¡¹ï¼ˆå¤±è´¥ç‡ > 70%ï¼‰

æ¸…ç†ç­–ç•¥ç¡®ä¿ Context Bank å§‹ç»ˆä¿æŒé«˜æ•ˆï¼Œä¸ä¼šå› ç§¯ç´¯è¿‡å¤šä½ä»·å€¼æ•°æ®è€Œå½±å“æ€§èƒ½ã€‚

**DSL æŸ¥è¯¢è¯­è¨€**

æ”¯æŒå¼ºå¤§çš„ DSL æŸ¥è¯¢è¯­æ³•ï¼š

```
# æŸ¥è¯¢ç‰¹å®šç±»å‹çš„æ–‡ä»¶
@type:file

# æŸ¥è¯¢ç‰¹å®šè·¯å¾„
@path:src/components

# ç»„åˆæŸ¥è¯¢
@type:file AND @path:src AND @semantic:react

# æ¨¡ç³ŠåŒ¹é…
@name:*test*
```

æŸ¥è¯¢ç»“æœä¼šæŒ‰ç…§ç›¸å…³æ€§å’Œé‡è¦æ€§æ’åºï¼Œç¡®ä¿æœ€ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¼˜å…ˆæä¾›ç»™ AIã€‚

#### 2.2.4 Diff Graded Applierï¼šåˆ†çº§åŒ¹é…ç­–ç•¥

**Level 1ï¼šç²¾ç¡®åŒ¹é…**

é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é… diff ä¸­çš„ä¸Šä¸‹æ–‡è¡Œï¼š

- å®Œå…¨ç›¸åŒçš„è¡Œå†…å®¹
- å®Œå…¨ç›¸åŒçš„è¡Œå·ä½ç½®
- æœ€é«˜ä¼˜å…ˆçº§ï¼Œæœ€å¿«æ‰§è¡Œ

**Level 2ï¼šæ¨¡ç³ŠåŒ¹é…**

å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…ï¼š

- å¿½ç•¥ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦å·®å¼‚
- å¿½ç•¥å¤§å°å†™å·®å¼‚ï¼ˆæŸäº›è¯­è¨€ï¼‰
- å…è®¸ä¸€å®šç¨‹åº¦çš„è¡Œå·åç§»ï¼ˆÂ±3 è¡Œï¼‰

**Level 3ï¼šç›¸ä¼¼åº¦åŒ¹é…**

å¦‚æœæ¨¡ç³ŠåŒ¹é…ä»ç„¶å¤±è´¥ï¼Œä½¿ç”¨ç›¸ä¼¼åº¦ç®—æ³•ï¼š

- LCSï¼ˆæœ€é•¿å…¬å…±å­åºåˆ—ï¼‰ç®—æ³•è®¡ç®—ç›¸ä¼¼åº¦
- Jaccard ç›¸ä¼¼åº¦ç³»æ•°
- ç»¼åˆç›¸ä¼¼åº¦è¯„åˆ†

åªæœ‰å½“ç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆé»˜è®¤ 0.7ï¼‰æ—¶æ‰åº”ç”¨å˜æ›´ã€‚

**å†å²è®°å½•ä¸å­¦ä¹ **

ç³»ç»Ÿä¼šè®°å½•æ¯æ¬¡åº”ç”¨çš„ç»“æœï¼š

- æˆåŠŸ/å¤±è´¥çŠ¶æ€
- ä½¿ç”¨çš„åŒ¹é…çº§åˆ«
- åŒ¹é…çš„å‡†ç¡®åº¦
- ç”¨æˆ·çš„åé¦ˆ

è¿™äº›å†å²æ•°æ®ç”¨äºä¼˜åŒ–æœªæ¥çš„åŒ¹é…ç­–ç•¥ï¼Œæé«˜åº”ç”¨æˆåŠŸç‡ã€‚

---

## ç¬¬ä¸‰ç« ï¼šæ¶æ„è®¾è®¡æ·±åº¦å‰–æ

### 3.1 æ•´ä½“æ¶æ„

#### 3.1.1 åˆ†å±‚æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä»ä¸‹åˆ°ä¸Šä¾æ¬¡ä¸ºï¼š

**ç¬¬ 1 å±‚ï¼šVS Code é›†æˆå±‚ï¼ˆvscode/ï¼‰**
- æ‰©å±•å…¥å£ï¼ˆextension.tsï¼‰
- UI ç»„ä»¶ï¼ˆä¾§è¾¹æ ã€webviewï¼‰
- VS Code API å°è£…

**ç¬¬ 2 å±‚ï¼šè¿è¡Œæ—¶é€‚é…å±‚ï¼ˆruntime/ï¼‰**
- VS Code æ‰§è¡Œå™¨ï¼ˆVSCodeExecutorï¼‰
- æ–‡ä»¶ç³»ç»Ÿé€‚é…
- Git æ“ä½œé€‚é…

**ç¬¬ 3 å±‚ï¼šAI å¼•æ“å±‚ï¼ˆengine/ï¼‰**
- Agent è¿è¡Œæ—¶ï¼ˆAgentRuntimeï¼‰
- ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆContextManagerï¼‰
- æ²»ç†æœåŠ¡ï¼ˆGovernanceServiceï¼‰
- å·¥å…·æ‰§è¡Œå™¨ï¼ˆToolExecutorï¼‰
- LLM é€‚é…å™¨ï¼ˆLLMAdapterï¼‰

**ç¬¬ 4 å±‚ï¼šæ ¸å¿ƒåŠŸèƒ½å±‚ï¼ˆcore/ï¼‰**
- Diff è§£æå’Œåº”ç”¨
- å®‰å…¨æ‰«æå’ŒéªŒè¯
- Review Schema å®šä¹‰
- è‡ªåŠ¨åŒ–æµ‹è¯•æ‰«æ

**ç¬¬ 5 å±‚ï¼šæ²»ç†åŸºç¡€è®¾æ–½ï¼ˆgovernance/ï¼‰**
- WASM æ²™ç®±ï¼ˆAssemblyScriptï¼‰
- ç­–ç•¥å¼•æ“
- é£é™©è´¦æœ¬

è¿™ç§åˆ†å±‚è®¾è®¡ç¡®ä¿äº†ï¼š
- **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šæ¯å±‚åªè´Ÿè´£ç‰¹å®šèŒè´£
- **å¯æµ‹è¯•æ€§**ï¼šæ¯å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- **å¯æ‰©å±•æ€§**ï¼šæ–°å¢åŠŸèƒ½å¯ä»¥åœ¨å¯¹åº”å±‚å®ç°
- **å¹³å°æ— å…³æ€§**ï¼šå¼•æ“å±‚å¯ä»¥é€‚é…åˆ°å…¶ä»–å¹³å°

#### 3.1.2 æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VS Code Extension UI                    â”‚
â”‚  (Sidebar, Commands, CodeActions, Webview)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Runtime Adapter Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ VSCodeExecutor   â”‚  â”‚ GitAdapter              â”‚   â”‚
â”‚  â”‚ (File I/O)       â”‚  â”‚ (Git Operations)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI Engine Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AgentRuntime     â”‚  â”‚ LLMAdapter              â”‚   â”‚
â”‚  â”‚ (Think-Execute)  â”‚  â”‚ (AI Communication)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ContextManager   â”‚  â”‚ ToolExecutor            â”‚   â”‚
â”‚  â”‚ (Context Mgmt)   â”‚  â”‚ (Action Execution)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ GovernanceServiceâ”‚  â”‚ ContextBank             â”‚   â”‚
â”‚  â”‚ (Security Check) â”‚  â”‚ (Persistence)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Core Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DiffParser       â”‚  â”‚ DiffSecurityValidator   â”‚   â”‚
â”‚  â”‚ (Parse Diff)    â”‚  â”‚ (Security Checks)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DiffApplier      â”‚  â”‚ SecurityScanCoordinator â”‚   â”‚
â”‚  â”‚ (Apply Diff)    â”‚  â”‚ (Scan Pipeline)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ReviewSchema     â”‚  â”‚ AutomatedTestScanner    â”‚   â”‚
â”‚  â”‚ (Schema Def)    â”‚  â”‚ (Test Scanning)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Governance Infrastructure                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ WASM Sandbox     â”‚  â”‚ Policy Engine            â”‚   â”‚
â”‚  â”‚ (Physical Isol.) â”‚  â”‚ (Rule Evaluation)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ Risk Ledger      â”‚                                   â”‚
â”‚  â”‚ (Risk Tracking) â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼

#### 3.2.1 REACT æ¨¡å¼ï¼ˆReasoning + Actingï¼‰

AgentRuntime é‡‡ç”¨ REACT æ¨¡å¼ï¼ˆReasoning + Actingï¼‰ï¼Œè¿™æ˜¯å½“å‰æœ€å…ˆè¿›çš„ Agent å®ç°æ¨¡å¼ä¹‹ä¸€ï¼š

**Reasoningï¼ˆæ¨ç†ï¼‰é˜¶æ®µ**
1. åˆ†æå½“å‰ä¸Šä¸‹æ–‡å’Œç”¨æˆ·è¯·æ±‚
2. æ€è€ƒä¸‹ä¸€æ­¥åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ“ä½œ
3. ç”Ÿæˆè¯¦ç»†çš„æ¨ç†è¯´æ˜
4. è¯„ä¼°æ“ä½œçš„é£é™©å’Œå¯è¡Œæ€§

**Actingï¼ˆè¡ŒåŠ¨ï¼‰é˜¶æ®µ**
1. æ‰§è¡Œæ¨ç†é˜¶æ®µå†³å®šçš„æ“ä½œ
2. é€šè¿‡å·¥å…·è°ƒç”¨ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’
3. æ”¶é›†æ“ä½œç»“æœå’Œåé¦ˆ
4. æ›´æ–°ä¸Šä¸‹æ–‡çŠ¶æ€

**Observationï¼ˆè§‚å¯Ÿï¼‰é˜¶æ®µ**
1. è§‚å¯Ÿ tool çš„æ‰§è¡Œç»“æœ
2. è¯„ä¼°ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
3. å¿…è¦æ—¶ç”Ÿæˆæ–°çš„ Observation
4. å†³å®šæ˜¯ç»§ç»­æ‰§è¡Œè¿˜æ˜¯å®Œæˆä»»åŠ¡

è¿™ç§æ¨¡å¼çš„ä¼˜åŠ¿åœ¨äºï¼š
- **é€æ˜æ€§**ï¼šæ¯ä¸ªå†³ç­–éƒ½æœ‰æ˜ç¡®çš„æ¨ç†è¿‡ç¨‹
- **å¯æ§æ€§**ï¼šäººç±»å¯ä»¥åœ¨æ¨ç†é˜¶æ®µä»‹å…¥
- **å¯è°ƒè¯•æ€§**ï¼šå¯ä»¥å›æº¯æ•´ä¸ªå†³ç­–é“¾è·¯
- **å¯å­¦ä¹ æ€§**ï¼šå¯ä»¥è®°å½•å’Œä¼˜åŒ–å†³ç­–æ¨¡å¼

#### 3.2.2 è§‚å¯Ÿç¡®è®¤æœºåˆ¶ï¼ˆObservation Acknowledgementï¼‰

è¿™æ˜¯ v3.1 ç‰ˆæœ¬çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶ï¼Œç¡®ä¿ AI æ­£ç¡®ç†è§£ç³»ç»Ÿçš„åé¦ˆï¼š

**å¼ºåˆ¶ç¡®è®¤è§„åˆ™**

1. å¦‚æœå­˜åœ¨æœ‰æ•ˆçš„ Tool æˆ– System Observationï¼ŒAI å¿…é¡»é€å­—é‡è¿°
2. å¦‚æœä¸å­˜åœ¨éœ€è¦ç¡®è®¤çš„ Observationï¼Œè¾“å‡º "acknowledged_observation": "NONE"
3. æ˜ç¡®ç¦æ­¢ç¡®è®¤ä»¥ä¸‹å†…å®¹ï¼š
   - è¿è¡Œæ—¶éªŒè¯é”™è¯¯
   - ACK ç›¸å…³çš„é”™è¯¯
   - ç³»ç»Ÿå†…éƒ¨é”™è¯¯æ¶ˆæ¯

**é”™è¯¯ç±»å‹åˆ†çº§**

ç³»ç»Ÿå¼•å…¥äº†ä¸‰ç§ Observation ç±»å‹ï¼š

- `tool_result`ï¼šå·¥å…·æ‰§è¡Œç»“æœï¼Œéœ€è¦ç¡®è®¤
- `system_note`ï¼šç³»ç»Ÿæç¤ºä¿¡æ¯ï¼Œéœ€è¦ç¡®è®¤
- `error`ï¼šç³»ç»Ÿé”™è¯¯ä¿¡æ¯ï¼Œä¸éœ€è¦ç¡®è®¤ï¼ˆé˜²æ­¢æ­»å¾ªç¯ï¼‰

**å®½æ¾æ£€æŸ¥ç­–ç•¥**

AI çš„ç¡®è®¤ä¸éœ€è¦å®Œå…¨ç²¾ç¡®ï¼Œåªéœ€è¦åŒ…å« Observation çš„å…³é”®éƒ¨åˆ†ï¼š

- å¦‚æœ Observation é•¿åº¦ > 30 å­—ç¬¦ï¼Œç¡®è®¤å†…å®¹åªéœ€åŒ…å«å‰ 10 ä¸ªå­—ç¬¦æˆ–åŒ…å« Observation çš„å‰ 10 ä¸ªå­—ç¬¦
- è¿™ç§å®½æ¾ç­–ç•¥é¿å…å› æ ¼å¼å·®å¼‚å¯¼è‡´çš„è¯¯åˆ¤
- åŒæ—¶ç¡®ä¿ AI ç¡®å®ç†è§£äº†å…³é”®ä¿¡æ¯

**æ­»å¾ªç¯é˜²æŠ¤**

é€šè¿‡é”™è¯¯ç±»å‹åˆ†çº§ï¼Œç³»ç»Ÿé¿å…äº†ä»¥ä¸‹æ­»å¾ªç¯åœºæ™¯ï¼š

```
1. AI æ²¡æœ‰ç¡®è®¤ Observation
2. ç³»ç»Ÿæ·»åŠ é”™è¯¯ Observation
3. AI å†æ¬¡å°è¯•ç¡®è®¤é”™è¯¯ Observationï¼ˆè¢«æ‹’ç»ï¼Œå› ä¸º error ç±»å‹ä¸éœ€è¦ç¡®è®¤ï¼‰
4. ç³»ç»Ÿä¸å†æ·»åŠ æ–°çš„é”™è¯¯ Observation
5. å¾ªç¯ç»ˆæ­¢ï¼ŒAI è¿›å…¥ä¸‹ä¸€è½®æ¨ç†
```

#### 3.2.3 äº‹åŠ¡æ€§ Diff åº”ç”¨

DiffApplyTransaction æä¾›äº†ç±»ä¼¼æ•°æ®åº“äº‹åŠ¡çš„åº”ç”¨æœºåˆ¶ï¼š

**äº‹åŠ¡çŠ¶æ€**
- `idle`ï¼šç©ºé—²çŠ¶æ€
- `begin`ï¼šäº‹åŠ¡å·²å¼€å§‹
- `commit`ï¼šäº‹åŠ¡å·²æäº¤
- `rollback`ï¼šäº‹åŠ¡å·²å›æ»š

**ACID ç‰¹æ€§**

- **åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼šè¦ä¹ˆå…¨éƒ¨åº”ç”¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
- **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼šåº”ç”¨å‰åä»£ç çŠ¶æ€ä¿æŒä¸€è‡´
- **éš”ç¦»æ€§ï¼ˆIsolationï¼‰**ï¼šåº”ç”¨è¿‡ç¨‹å¯¹å…¶ä»–æ“ä½œä¸å¯è§
- **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼šæˆåŠŸåº”ç”¨åï¼Œå˜æ›´æ°¸ä¹…ç”Ÿæ•ˆ

**å›æ»šæœºåˆ¶**

1. è®°å½•åº”ç”¨å‰çš„æ–‡ä»¶çŠ¶æ€ï¼ˆå†…å®¹å“ˆå¸Œï¼‰
2. åº”ç”¨å˜æ›´
3. å¦‚æœåº”ç”¨å¤±è´¥æˆ–ç”¨æˆ·å–æ¶ˆï¼Œæ ¹æ®è®°å½•çš„çŠ¶æ€å›æ»š
4. æ”¯æŒéƒ¨åˆ†æˆåŠŸã€éƒ¨åˆ†å›æ»šçš„åœºæ™¯

#### 3.2.4 ç­–ç•¥æ¨¡å¼ï¼ˆPolicy Patternï¼‰

æ²»ç†æœåŠ¡é‡‡ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ”¯æŒçµæ´»çš„è§„åˆ™é…ç½®ï¼š

**ç­–ç•¥è§„åˆ™ç»“æ„**

```yaml
rules:
  - id: "no-rm-rf"
    pattern: "rm -rf .*"
    effect: "deny"
    reason: "ç¦æ­¢åœ¨ Agent ä¸­æ‰§è¡Œé€’å½’å¼ºåˆ¶åˆ é™¤å‘½ä»¤"
  
  - id: "allow-read-docs"
    pattern: "read_file.*\\.md"
    effect: "allow"
    reason: "å…è®¸è¯»å– Markdown æ–‡æ¡£"
  
  - id: "warn-write-config"
    pattern: "write_file.*config"
    effect: "warn"
    reason: "ä¿®æ”¹é…ç½®æ–‡ä»¶éœ€è¦è°¨æ…"
```

**æ•ˆæœç±»å‹**

- `allow`ï¼šå…è®¸æ‰§è¡Œ
- `deny`ï¼šæ‹’ç»æ‰§è¡Œ
- `warn`ï¼šå…è®¸ä½†å‘å‡ºè­¦å‘Š

**ç­–ç•¥çƒ­åŠ è½½**

- ç­–ç•¥æ–‡ä»¶ï¼ˆpolicy.yamlï¼‰å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹
- ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜åŒ–å¹¶é‡æ–°åŠ è½½
- æ”¯æŒé¡¹ç›®çº§å’Œå…¨å±€çº§ç­–ç•¥è¦†ç›–

### 3.3 æ•°æ®æµè®¾è®¡

#### 3.3.1 ç”¨æˆ·è¯·æ±‚åˆ° AI å“åº”çš„å®Œæ•´æµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
[1] DSL è§£æä¸ä¸Šä¸‹æ–‡åŠ è½½
  - è§£æ @file å’Œ #symbol å¼•ç”¨
  - ä» ContextBank æŸ¥è¯¢ç›¸å…³ä¸Šä¸‹æ–‡
  - æ„å»ºå®Œæ•´çš„ä¸Šä¸‹æ–‡æç¤º
  â†“
[2] æ¶ˆæ¯æ„å»ºä¸ä¸Šä¸‹æ–‡æ³¨å…¥
  - å°†ä¸Šä¸‹æ–‡æ³¨å…¥åˆ°æ¶ˆæ¯ä¸­
  - æ·»åŠ éš”ç¦»æ ‡è¯†ç¬¦ï¼ˆ[CONTEXT DATA STARTED]ï¼‰
  - æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨
  â†“
[3] LLM è°ƒç”¨
  - å‘é€åˆ° AI æœåŠ¡
  - æµå¼æˆ–éæµå¼å“åº”
  - æ¥æ”¶åŸå§‹æ–‡æœ¬
  â†“
[4] å“åº”è§£æ
  - æå– JSONï¼ˆæ”¯æŒ Markdown å—å’Œçº¯ JSONï¼‰
  - è§£ææ“ä½œç±»å‹ã€å‚æ•°ã€æ¨ç†
  - åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ
  â†“
[5] Observation ç¡®è®¤æ£€æŸ¥
  - æ£€æŸ¥æ˜¯å¦æœ‰å¾…ç¡®è®¤çš„ Observation
  - éªŒè¯ AI çš„ç¡®è®¤å†…å®¹
  - å¦‚æœç¡®è®¤å¤±è´¥ï¼Œæ·»åŠ é”™è¯¯ Observation å¹¶é‡æ–°æ¨ç†
  â†“
[6] æ²»ç†å®¡æ‰¹
  - é¢„æ£€å±‚ï¼šå¿«é€Ÿè§„åˆ™éªŒè¯
  - é€»è¾‘å±‚ï¼šå¤æ‚æ¡ä»¶è¯„ä¼°
  - ç‰©ç†å±‚ï¼šWASM æ²™ç®±æ‰§è¡Œ
  - å¦‚æœè¢«æ‹’ç»ï¼Œè¿”å›æ‹’ç»åŸå› 
  â†“
[7] å·¥å…·æ‰§è¡Œ
  - æ ¹æ®æ“ä½œç±»å‹è°ƒç”¨ç›¸åº”å·¥å…·
  - æ‰§è¡Œæ–‡ä»¶è¯»å†™ã€å‘½ä»¤æ‰§è¡Œç­‰æ“ä½œ
  - æ”¶é›†æ‰§è¡Œç»“æœ
  â†“
[8] ä¸Šä¸‹æ–‡æ›´æ–°
  - å°†å·¥å…·ç»“æœæ·»åŠ åˆ°ä¸Šä¸‹æ–‡
  - æ›´æ–° ContextBuffer çŠ¶æ€
  - è®°å½•ä½¿ç”¨ç»Ÿè®¡
  â†“
[9] å¾ªç¯åˆ¤æ–­
  - å¦‚æœä»»åŠ¡å®Œæˆï¼Œé€€å‡ºå¾ªç¯
  - å¦‚æœæœªå®Œæˆï¼Œè¿”å›æ­¥éª¤ [3] ç»§ç»­æ¨ç†
  â†“
[10] ç»“æœå±•ç¤º
  - å°†æœ€ç»ˆç»“æœå±•ç¤ºç»™ç”¨æˆ·
  - è®°å½•æ‰§è¡Œå†å²
  - å¯¼å‡ºé«˜ä»·å€¼ä¸Šä¸‹æ–‡åˆ° ContextBank
```

#### 3.3.2 å®‰å…¨æ‰«ææ•°æ®æµ

```
Diff ç”Ÿæˆ
  â†“
[Phase 1] Quick Security Scan
  - æ­£åˆ™è¡¨è¾¾å¼å¿«é€Ÿæ‰«æ
  - åŸºæœ¬æ¨¡å¼åŒ¹é…
  - < 50ms å®Œæˆ
  â†“
[Phase 2] Diff Security Validation
  - è§£æ Diff
  - éªŒè¯è·¯å¾„ã€å¤§å°ã€Hunk ç­‰
  - < 50ms å®Œæˆ
  â†“
[Phase 3] Semantic Review
  - è¯­æ³•åˆ†æ
  - è¯­ä¹‰æ£€æŸ¥
  - < 200ms å®Œæˆï¼ˆå¯é€‰ï¼‰
  â†“
[ç»¼åˆæŠ¥å‘Š]
  - æ±‡æ€»æ‰€æœ‰æ‰«æç»“æœ
  - è®¡ç®—æ€»ä½“é£é™©çº§åˆ«
  - ç”Ÿæˆä¿®å¤å»ºè®®
  â†“
[ç”¨æˆ·å†³ç­–]
  - æŸ¥çœ‹æŠ¥å‘Š
  - é€‰æ‹©åº”ç”¨æˆ–æ‹’ç»
  - æä¾›åé¦ˆ
```

---

## ç¬¬å››ç« ï¼šæ ¸å¿ƒæ–‡ä»¶æ·±åº¦è§£è¯»

### 4.1 AgentRuntime.tsï¼šAgent è¿è¡Œæ—¶çš„æ ¸å¿ƒå¼•æ“

#### 4.1.1 ç±»ç»“æ„ä¸èŒè´£

AgentRuntime æ˜¯æ•´ä¸ª Agent ç³»ç»Ÿçš„æ ¸å¿ƒè¿è¡Œæ—¶å¼•æ“ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ª REACT å¾ªç¯çš„æ‰§è¡Œã€‚

**ä¸»è¦å±æ€§**

```typescript
private context: ContextManager;          // ä¸Šä¸‹æ–‡ç®¡ç†å™¨
private lastContextSnapshot: ContextSnapshot | null = null;  // ä¸Šä¸‹æ–‡å¿«ç…§
private executionId: string;             // æ‰§è¡Œ IDï¼ˆç”¨äºå®¡è®¡ï¼‰
private executionRecorder: ExecutionRecorder;  // æ‰§è¡Œè®°å½•å™¨
```

**æ ¸å¿ƒæ–¹æ³•**

1. **initialize()**ï¼šåˆå§‹åŒ–è¿è¡Œæ—¶ï¼ŒåŒ…æ‹¬ Context Bank
2. **run()**ï¼šæ‰§è¡Œç”¨æˆ·è¯·æ±‚çš„ä¸»å¾ªç¯
3. **getContextManager()**ï¼šè·å–ä¸Šä¸‹æ–‡ç®¡ç†å™¨å®ä¾‹
4. **getExecutionRecorder()**ï¼šè·å–æ‰§è¡Œè®°å½•å™¨
5. **retrospective()**ï¼šæ‰§è¡Œå›åˆçš„å›é¡¾æ€§åˆ†æ
6. **evaluateContextPromotion()**ï¼šè¯„ä¼°ä¸Šä¸‹æ–‡æ™‹å‡ä¸ºæŠ€èƒ½

#### 4.1.2 run() æ–¹æ³•è¯¦è§£

run() æ–¹æ³•æ˜¯ AgentRuntime çš„æ ¸å¿ƒï¼Œå®ç°äº†å®Œæ•´çš„ REACT å¾ªç¯ï¼š

**ç»ˆæ­¢æ€æ£€æŸ¥**

```typescript
if (userInput && userInput.trim().toLowerCase() === 'stop') {
  // ç”¨æˆ·è¯·æ±‚åœæ­¢ï¼Œç«‹å³é€€å‡º
  this.executionRecorder.recordTurn({...});
  return;
}
```

è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„ç»ˆæ­¢æ¡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥ "stop" ç«‹å³åœæ­¢æ‰§è¡Œã€‚

**Context Bank åˆå§‹åŒ–ä¸åŠ è½½**

```typescript
await this.initialize();  // ç¡®ä¿ Context Bank å·²åˆå§‹åŒ–

// ä» Context Bank æŸ¥è¯¢ä¸å½“å‰ä»»åŠ¡ç›¸å…³çš„ä¸Šä¸‹æ–‡
await this.context.importFromContextBank({
  input: userInput,
  projectScope: process.cwd(),
  strategy: "relevance",
  limit: 5,  // æœ€å¤šåŠ è½½ 5 ä¸ªç›¸å…³ä¸Šä¸‹æ–‡
});
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ä»æŒä¹…åŒ–çš„ ContextBank ä¸­æŸ¥è¯¢ä¸å½“å‰ä»»åŠ¡æœ€ç›¸å…³çš„ä¸Šä¸‹æ–‡ï¼Œæå‡ AI çš„ç†è§£èƒ½åŠ›ã€‚

**REACT ä¸»å¾ªç¯**

```typescript
let turnCount = 0;
const maxTurns = 10;

while (turnCount < maxTurns) {
  const currentTurn = ++turnCount;
  
  // [1] ä¸Šä¸‹æ–‡å·®å¼‚åˆ†æ
  const currentSnapshot = snapshotFromBuffer(this.context.getContextBuffer());
  const contextDiff = diffContext(this.lastContextSnapshot, currentSnapshot);
  
  // [2] LLM æ¨ç†
  const thought = await LLMAdapter.think(
    messages,
    mode,
    onChunk,
    model,
    GovernanceService.getPolicyManual(),
    this.context,
    abortSignal
  );
  
  // [3] Observation ç¡®è®¤æ£€æŸ¥
  const lastObs = this.context.getLastAckableObservation();
  const ack = (thought.parsedPlan as any)?.acknowledged_observation;
  
  if (lastObs && (!ack || ack === 'NONE')) {
    // AI æ²¡æœ‰ç¡®è®¤ Observationï¼Œæ·»åŠ é”™è¯¯å¹¶é‡æ–°æ¨ç†
    this.context.addObservation(..., 'error');
    continue;
  }
  
  // [4] æ„å»ºæ“ä½œ
  const action: ProposedAction = {
    id: randomUUID(),
    type: thought.type,
    payload: thought.payload,
    riskLevel: "low",
    reasoning: thought.reasoning,
  };
  
  // [5] æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
  if (thought.isDone || action.type === "answer") {
    const result = await ToolExecutor.execute(action);
    // ä»»åŠ¡å®Œæˆï¼Œé€€å‡ºå¾ªç¯
    break;
  }
  
  // [6] é¢„æ£€ï¼ˆPre-flightï¼‰
  const preCheck = evaluateProposal(action, rules, ledger);
  if (preCheck.effect === "deny") {
    // è¢«ç­–ç•¥æ‹’ç»ï¼Œé‡æ–°æ¨ç†
    this.context.addMessage("system", `POLICY DENIED: ${preCheck.reason}`);
    continue;
  }
  
  // [7] æ­£å¼æ²»ç†
  const decision = await GovernanceService.adjudicate(action);
  if (decision.status === "rejected") {
    // è¢«æ²»ç†æ‹’ç»ï¼Œé‡æ–°æ¨ç†
    this.context.addMessage("system", `Rejected by Governance: ${decision.reason}`);
    continue;
  }
  
  // [8] æ‰§è¡Œæ“ä½œ
  const result = await ToolExecutor.execute(action);
  this.context.addToolResult(action.type, result.output);
  
  // [9] è®°å½•æ‰§è¡Œå›åˆ
  this.executionRecorder.recordTurn({...});
}
```

è¿™ä¸ªå¾ªç¯ä½“ç°äº† AgentRuntime çš„æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š

1. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šæ¯æ¬¡æ¨ç†å‰éƒ½ä¼šåˆ†æä¸Šä¸‹æ–‡çš„å˜åŒ–
2. **å®‰å…¨ä¼˜å…ˆ**ï¼šå¤šå±‚æ²»ç†æ£€æŸ¥ç¡®ä¿æ“ä½œå®‰å…¨
3. **å¯è¿½æº¯**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†çš„è®°å½•
4. **å®¹é”™æ€§**ï¼šå¤±è´¥æ—¶è‡ªåŠ¨é‡æ–°æ¨ç†ï¼Œè€Œä¸æ˜¯å´©æºƒ

#### 4.1.3 å›é¡¾æ€§åˆ†æï¼ˆRetrospectiveï¼‰

åœ¨ä»»åŠ¡å®Œæˆåï¼Œç³»ç»Ÿä¼šè¿›è¡Œå›é¡¾æ€§åˆ†æï¼š

**å¯¼å‡ºé«˜ä»·å€¼ä¸Šä¸‹æ–‡**

```typescript
await this.context.exportToContextBank(process.cwd());
```

å°†å½“å‰ä½¿ç”¨çš„é«˜ä»·å€¼ä¸Šä¸‹æ–‡å¯¼å‡ºåˆ° ContextBankï¼Œä¾›æœªæ¥ä»»åŠ¡ä½¿ç”¨ã€‚

**è¯„ä¼°ä¸Šä¸‹æ–‡æ™‹å‡**

```typescript
await this.evaluateContextPromotion();
```

è¯„ä¼°å“ªäº›ä¸Šä¸‹æ–‡é¡¹æœ‰èµ„æ ¼æ™‹å‡ä¸ºæŠ€èƒ½ï¼ˆSkillï¼‰ï¼š

- é«˜ä½¿ç”¨é¢‘ç‡
- é«˜æˆåŠŸç‡
- é«˜é‡è¦æ€§è¯„åˆ†

å¦‚æœæŸä¸ªä¸Šä¸‹æ–‡é¡¹æ»¡è¶³æ™‹å‡æ¡ä»¶ï¼Œç³»ç»Ÿä¼šï¼š

1. ç”Ÿæˆå¯¹åº”çš„æŠ€èƒ½å®šä¹‰
2. é€šè¿‡æ²»ç†æœåŠ¡å®¡æ‰¹
3. ä¿å­˜åˆ°æŠ€èƒ½åº“
4. æœªæ¥å¯ä»¥ç›´æ¥è°ƒç”¨æŠ€èƒ½ï¼Œæ— éœ€é‡æ–°æ¨ç†

**ç”Ÿæˆå¼•ç”¨å›æº¯æŠ¥å‘Š**

```typescript
const retrospectiveReport = generateReferenceRetrospective(
  this.context.getContextBuffer(),
  this.executionId,
  userInput,
  result.output,
);
```

ç”Ÿæˆè¯¦ç»†çš„å¼•ç”¨å›æº¯æŠ¥å‘Šï¼Œè®°å½•ï¼š

- å“ªäº›ä¸Šä¸‹æ–‡é¡¹è¢«å¼•ç”¨
- å¼•ç”¨çš„æ¬¡æ•°å’Œæ—¶é—´
- å¼•ç”¨çš„æœ‰æ•ˆæ€§ï¼ˆæ˜¯å¦çœŸçš„æœ‰å¸®åŠ©ï¼‰
- ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸåˆ†æ

#### 4.1.4 æŠ€æœ¯äº®ç‚¹

1. **è§‚å¯Ÿç¡®è®¤æœºåˆ¶**ï¼šç¡®ä¿ AI æ­£ç¡®ç†è§£ç³»ç»Ÿåé¦ˆ
2. **ä¸Šä¸‹æ–‡å·®å¼‚è¿½è¸ª**ï¼šå®æ—¶ç›‘æ§ä¸Šä¸‹æ–‡å˜åŒ–
3. **è‡ªåŠ¨æŠ€èƒ½å­¦ä¹ **ï¼šå°†é¢‘ç¹ä½¿ç”¨çš„ä¸Šä¸‹æ–‡æå‡ä¸ºæŠ€èƒ½
4. **æ‰§è¡Œè®°å½•ä¸å›æ”¾**ï¼šå®Œæ•´çš„å®¡è®¡è½¨è¿¹
5. **å¤šçº§æ²»ç†æ£€æŸ¥**ï¼šé¢„æ£€ â†’ é€»è¾‘å±‚ â†’ ç‰©ç†å±‚
6. **å®¹é”™ä¸æ¢å¤**ï¼šå¤±è´¥æ—¶è‡ªåŠ¨é‡æ–°æ¨ç†

### 4.2 ContextManager.tsï¼šæ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†

#### 4.2.1 ç±»ç»“æ„ä¸èŒè´£

ContextManager è´Ÿè´£ç®¡ç†æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¶ˆæ¯å†å²ã€ä¸Šä¸‹æ–‡ç¼“å†²åŒºã€ContextBank ç­‰ã€‚

**ä¸»è¦å±æ€§**

```typescript
private messages: Array<{...}>;  // æ¶ˆæ¯å†å²
private contextBuffer: ContextBuffer;  // ä¸Šä¸‹æ–‡ç¼“å†²åŒº
private contextBank: ContextBank;  // ä¸Šä¸‹æ–‡é“¶è¡Œï¼ˆæŒä¹…åŒ–ï¼‰
private maxHistorySize = 50;  // æœ€å¤§å†å²æ¶ˆæ¯æ•°é‡
private pendingAdds: Set<Promise<void>> = new Set();  // å¾…å¤„ç†çš„å¼‚æ­¥æ·»åŠ æ“ä½œ
```

**æ ¸å¿ƒæ–¹æ³•**

1. **addMessage()**ï¼šæ·»åŠ æ¶ˆæ¯åˆ°å†å²
2. **addToolResult()**ï¼šæ·»åŠ å·¥å…·æ‰§è¡Œç»“æœ
3. **addObservation()**ï¼šæ·»åŠ  Observationï¼ˆæ”¯æŒç±»å‹åˆ†çº§ï¼‰
4. **getObservations()**ï¼šè·å–æ‰€æœ‰ Observation
5. **getLastObservation()**ï¼šè·å–æœ€æ–°çš„ Observation
6. **getLastAckableObservation()**ï¼šè·å–éœ€è¦ç¡®è®¤çš„ Observationï¼ˆæ’é™¤ error ç±»å‹ï¼‰
7. **getContextBuffer()**ï¼šè·å–ä¸Šä¸‹æ–‡ç¼“å†²åŒº
8. **addContextItem()**ï¼šæ·»åŠ ä¸Šä¸‹æ–‡é¡¹
9. **buildContextPrompt()**ï¼šæ„å»ºä¸Šä¸‹æ–‡æç¤º
10. **flush()**ï¼šç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ

#### 4.2.2 Observation ç±»å‹åˆ†çº§ç³»ç»Ÿ

v3.1 ç‰ˆæœ¬å¼•å…¥äº† Observation ç±»å‹åˆ†çº§ï¼Œè¿™æ˜¯è§£å†³æ­»å¾ªç¯é—®é¢˜çš„å…³é”®åˆ›æ–°ï¼š

**ä¸‰ç§ç±»å‹**

```typescript
type ObservationKind = 'tool_result' | 'system_note' | 'error';
```

1. **tool_result**ï¼šå·¥å…·æ‰§è¡Œç»“æœ
   - éœ€è¦ç¡®è®¤
   - AI å¿…é¡»é€å­—é‡è¿°
   - åŒ…å«å®é™…çš„æ‰§è¡Œè¾“å‡º

2. **system_note**ï¼šç³»ç»Ÿæç¤ºä¿¡æ¯
   - éœ€è¦ç¡®è®¤
   - AI å¿…é¡»é€å­—é‡è¿°
   - åŒ…å«ç³»ç»Ÿçš„æç¤ºå’Œè­¦å‘Š

3. **error**ï¼šç³»ç»Ÿé”™è¯¯ä¿¡æ¯
   - ä¸éœ€è¦ç¡®è®¤
   - AI ä¸åº”è¯¥é‡å¤é”™è¯¯ä¿¡æ¯
   - ç”¨äºæ‰“ç ´æ­»å¾ªç¯

**å®ç°ç»†èŠ‚**

```typescript
addObservation(observation: string, kind: ObservationKind = 'system_note'): void {
  this.addMessage('system', observation);
  // ä¸ºæœ€åä¸€æ¡æ¶ˆæ¯æ·»åŠ  kind å…ƒæ•°æ®
  if (this.messages.length > 0) {
    this.messages[this.messages.length - 1].metadata = { kind };
  }
}

getLastAckableObservation(): { role: 'tool' | 'system'; content: string } | null {
  for (let i = this.messages.length - 1; i >= 0; i--) {
    const m = this.messages[i];
    if ((m.role === 'tool' || m.role === 'system') && m.metadata?.kind !== 'error') {
      return { role: m.role as any, content: m.content };
    }
  }
  return null;
}
```

**è§£å†³çš„é—®é¢˜**

æ²¡æœ‰ç±»å‹åˆ†çº§æ—¶ï¼Œå¯èƒ½å‡ºç°ä»¥ä¸‹æ­»å¾ªç¯ï¼š

```
1. AI æ²¡æœ‰ç¡®è®¤ Observation
2. ç³»ç»Ÿæ·»åŠ é”™è¯¯ Observation "ERROR: You failed to acknowledge..."
3. AI å°è¯•ç¡®è®¤è¿™ä¸ªé”™è¯¯ Observationï¼ˆä»ç„¶å¤±è´¥ï¼‰
4. ç³»ç»Ÿå†æ¬¡æ·»åŠ é”™è¯¯ Observation
5. å¾ªç¯æ— é™ç»§ç»­
```

æœ‰äº†ç±»å‹åˆ†çº§åï¼š

```
1. AI æ²¡æœ‰ç¡®è®¤ Observation
2. ç³»ç»Ÿæ·»åŠ é”™è¯¯ Observationï¼ˆkind: 'error'ï¼‰
3. getLastAckableObservation() è¿”å› nullï¼ˆå› ä¸º error ç±»å‹è¢«æ’é™¤ï¼‰
4. AI ä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥ç»§ç»­æ¨ç†
5. å¾ªç¯ç»ˆæ­¢
```

#### 4.2.3 å¼‚æ­¥ä¸Šä¸‹æ–‡æ·»åŠ ä¸ flush() æœºåˆ¶

**å¼‚æ­¥æ·»åŠ **

```typescript
async addContextItemAsync(item: Omit<ContextItem, 'tokens'>) {
  const p = this.contextBuffer.addAsync(item);
  this.pendingAdds.add(p);
  
  try {
    await p;
  } finally {
    this.pendingAdds.delete(p);
  }
}
```

ç³»ç»Ÿæ”¯æŒå¼‚æ­¥æ·»åŠ ä¸Šä¸‹æ–‡é¡¹ï¼Œæœªæ¥å¯ä»¥ç”¨äºï¼š

- å¼‚æ­¥ç”Ÿæˆæ‘˜è¦
- å¼‚æ­¥è®¡ç®— embedding
- å¼‚æ­¥è¿›è¡Œè¯­ä¹‰åˆ†æ

**flush() æœºåˆ¶**

```typescript
async flush(): Promise<void> {
  if (this.pendingAdds.size === 0) {
    return;
  }
  
  console.log(`[ContextManager] Flushing ${this.pendingAdds.size} pending add operations...`);
  await Promise.all(Array.from(this.pendingAdds));
  console.log('[ContextManager] All add operations completed');
}
```

flush() ç¡®ä¿æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆåæ‰ç»§ç»­ï¼Œé¿å…äº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

**ä½¿ç”¨åœºæ™¯**

```typescript
// æ·»åŠ å¤šä¸ªä¸Šä¸‹æ–‡é¡¹
await Promise.all([
  contextManager.addContextItemAsync(item1),
  contextManager.addContextItemAsync(item2),
  contextManager.addContextItemAsync(item3),
]);

// ç¡®ä¿æ‰€æœ‰æ·»åŠ å®Œæˆ
await contextManager.flush();

// ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨è¿™äº›ä¸Šä¸‹æ–‡é¡¹
const prompt = contextManager.buildContextPrompt(userInput);
```

#### 4.2.4 ContextBank é›†æˆ

ContextManager ä¸ ContextBank æ·±åº¦é›†æˆï¼Œå®ç°äº†ä¸Šä¸‹æ–‡çš„æŒä¹…åŒ–å’Œæ™ºèƒ½æ£€ç´¢ï¼š

**åˆå§‹åŒ–**

```typescript
async initializeContextBank(): Promise<void> {
  await this.contextBank.initialize();
}
```

**å¯¼å‡ºé«˜ä»·å€¼ä¸Šä¸‹æ–‡**

```typescript
async exportToContextBank(projectScope?: string): Promise<void> {
  await this.contextBank.exportFromContextBuffer(this.contextBuffer, projectScope);
}
```

**æŸ¥è¯¢ç›¸å…³ä¸Šä¸‹æ–‡**

```typescript
async queryContextBank(options: BankQueryOptions): Promise<BankContextItem[]> {
  return await this.contextBank.query(options);
}
```

**å¯¼å…¥ç›¸å…³ä¸Šä¸‹æ–‡**

```typescript
async importFromContextBank(options: BankQueryOptions): Promise<void> {
  const bankItems = await this.contextBank.query(options);
  
  for (const item of bankItems) {
    this.contextBuffer.add({
      type: item.type,
      path: item.path,
      stableId: item.stableId,
      content: item.content,
      summary: item.summary,
      summarized: item.summarized,
      semantic: item.semantic,
      summaryQuality: item.summaryQuality,
      referencedBy: item.referencedBy,
      usageStats: item.usageStats,
      importance: item.importance,
      metadata: {
        source: 'context_bank',
        bankItemId: item.id
      }
    });
  }
}
```

**è®°å½•ä½¿ç”¨æƒ…å†µ**

```typescript
async recordBankUsage(success: boolean): Promise<void> {
  const contextItems = this.contextBuffer.export();
  
  for (const item of contextItems) {
    const bankItemId = (item as any).metadata?.bankItemId;
    if (bankItemId) {
      await this.contextBank.recordUsage(bankItemId, success);
    }
  }
}
```

è®°å½•ä½¿ç”¨æƒ…å†µç”¨äºï¼š

- æ›´æ–°é‡è¦æ€§è¯„åˆ†
- è®¡ç®—æˆåŠŸç‡å’Œå¤±è´¥ç‡
- è§¦å‘ä¸Šä¸‹æ–‡æ™‹å‡è¯„ä¼°
- æ‰§è¡Œä¸Šä¸‹æ–‡æ¸…ç†

#### 4.2.5 æŠ€æœ¯äº®ç‚¹

1. **Observation ç±»å‹åˆ†çº§**ï¼šè§£å†³æ­»å¾ªç¯é—®é¢˜
2. **å¼‚æ­¥ä¸Šä¸‹æ–‡æ·»åŠ **ï¼šæ”¯æŒæœªæ¥çš„é«˜çº§åŠŸèƒ½
3. **flush() æœºåˆ¶**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **ContextBank é›†æˆ**ï¼šä¸Šä¸‹æ–‡æŒä¹…åŒ–å’Œæ™ºèƒ½æ£€ç´¢
5. **ä½¿ç”¨ç»Ÿè®¡ä¸å­¦ä¹ **ï¼šè‡ªåŠ¨è¯„ä¼°å’Œä¼˜åŒ–ä¸Šä¸‹æ–‡ä»·å€¼
6. **æ¶ˆæ¯å†å²ç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†å’Œé™åˆ¶å¤§å°

### 4.3 GovernanceService.tsï¼šæ²»ç†æœåŠ¡çš„æ ¸å¿ƒ

#### 4.3.1 ç±»ç»“æ„ä¸èŒè´£

GovernanceService æ˜¯æ•´ä¸ªæ²»ç†ç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£å¯¹ Agent çš„æ‰€æœ‰æ“ä½œè¿›è¡Œæ²»ç†å’Œå®¡æ‰¹ã€‚

**ä¸»è¦å±æ€§**

```typescript
private static rules: PolicyRule[] = [];  // ç­–ç•¥è§„åˆ™åˆ—è¡¨
private static ledger = new RiskLedger();  // é£é™©è´¦æœ¬
private static initialized = false;  // åˆå§‹åŒ–çŠ¶æ€
```

**æ ¸å¿ƒæ–¹æ³•**

1. **init()**ï¼šåˆå§‹åŒ–æ²»ç†æœåŠ¡
2. **loadPolicy()**ï¼šåŠ è½½ç­–ç•¥æ–‡ä»¶ï¼ˆpolicy.yamlï¼‰
3. **getRules()**ï¼šè·å–ç­–ç•¥è§„åˆ™
4. **getLedgerSnapshot()**ï¼šè·å–é£é™©è´¦æœ¬å¿«ç…§
5. **getPolicyManual()**ï¼šç”Ÿæˆç­–ç•¥æ‰‹å†Œ
6. **adjudicate()**ï¼šè£å†³æ“ä½œæ˜¯å¦å…è®¸æ‰§è¡Œ

#### 4.3.2 ä¸‰å±‚æ²»ç†ä½“ç³»

GovernanceService å®ç°äº†ä¸‰å±‚æ²»ç†ä½“ç³»ï¼Œç¡®ä¿æ“ä½œçš„å®‰å…¨æ€§ï¼š

**ç¬¬ 1 å±‚ï¼šé¢„æ£€ï¼ˆPre-flightï¼‰**

```typescript
const preCheck = evaluateProposal(action, rules, ledger);
if (preCheck.effect === "deny") {
  console.log(chalk.red(`[PRE-FLIGHT] ğŸ›¡ï¸ Policy Blocked: ${preCheck.reason}`));
  return { status: 'rejected', by: 'policy', reason: preCheck.reason };
}
```

é¢„æ£€å±‚ä½¿ç”¨å¿«é€Ÿè§„åˆ™åŒ¹é…ï¼Œç«‹å³æ‹’ç»æ˜æ˜¾ä¸å®‰å…¨çš„æ“ä½œï¼Œæ— éœ€ç»è¿‡å¤æ‚çš„æ²»ç†æµç¨‹ã€‚

**ç¬¬ 2 å±‚ï¼šé€»è¾‘å±‚ï¼ˆLogicalï¼‰**

```typescript
const logicResult = evaluateProposal(action, rules, ledger);
if (logicResult.effect === "deny") {
  return { status: 'rejected', by: 'policy', reason: logicResult.reason };
}
```

é€»è¾‘å±‚ä½¿ç”¨æ›´å¤æ‚çš„æ¡ä»¶è¯„ä¼°ï¼Œè€ƒè™‘å†å²è¡Œä¸ºã€é£é™©è¯„åˆ†ç­‰å› ç´ ã€‚

**ç¬¬ 3 å±‚ï¼šç‰©ç†å±‚ï¼ˆPhysical WASMï¼‰**

```typescript
const wasmResult = WasmGovernanceBridge.evaluate(action, rules, ledger);
if (wasmResult.effect === 'deny') {
  return { status: 'rejected', by: 'policy', reason: wasmResult.reason };
}
```

ç‰©ç†å±‚ä½¿ç”¨ WebAssembly ç¼–è¯‘çš„è§„åˆ™å¼•æ“ï¼Œæä¾›çœŸæ­£çš„ç‰©ç†éš”ç¦»æ‰§è¡Œï¼Œé˜²æ­¢å†…å­˜ç¯¡æ”¹å’Œä»£ç æ³¨å…¥ã€‚

#### 4.3.3 ç­–ç•¥è§„åˆ™ç»“æ„

ç­–ç•¥è§„åˆ™å®šä¹‰åœ¨ policy.yaml æ–‡ä»¶ä¸­ï¼š

```yaml
rules:
  - id: "no-rm-rf"
    pattern: "rm -rf .*"
    effect: "deny"
    reason: "ç¦æ­¢åœ¨ Agent ä¸­æ‰§è¡Œé€’å½’å¼ºåˆ¶åˆ é™¤å‘½ä»¤"
  
  - id: "allow-read-docs"
    pattern: "read_file.*\\.md"
    effect: "allow"
    reason: "å…è®¸è¯»å– Markdown æ–‡æ¡£"
  
  - id: "warn-write-config"
    pattern: "write_file.*config"
    effect: "warn"
    reason: "ä¿®æ”¹é…ç½®æ–‡ä»¶éœ€è¦è°¨æ…"
```

**è§„åˆ™å­—æ®µ**

- `id`ï¼šè§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦
- `pattern`ï¼šåŒ¹é…æ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- `effect`ï¼šæ•ˆæœï¼ˆallow / deny / warnï¼‰
- `reason`ï¼šæ‹’ç»/è­¦å‘Šçš„åŸå› è¯´æ˜

**ç­–ç•¥çƒ­åŠ è½½**

```typescript
private static loadPolicy(basePath?: string) {
  try {
    const root = basePath || process.cwd();
    const policyPath = path.join(root, 'policy.yaml');
    if (fs.existsSync(policyPath)) {
      const content = fs.readFileSync(policyPath, 'utf8');
      const config = jsyaml.load(content) as any;
      this.rules = config.rules || [];
    }
  } catch (e) {
    this.rules = [];
  }
}
```

ç­–ç•¥æ–‡ä»¶å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ã€‚

#### 4.3.4 é£é™©è´¦æœ¬ï¼ˆRisk Ledgerï¼‰

é£é™©è´¦æœ¬è®°å½•äº†æ‰€æœ‰æ“ä½œçš„é£é™©è¯„åˆ†å’Œå†å²ï¼š

```typescript
class RiskLedger {
  private entries: RiskEntry[] = [];
  
  record(actionType: string): void {
    const now = Date.now();
    // è®°å½•æ“ä½œ
    this.entries.push({
      actionType,
      timestamp: now,
      riskScore: this.calculateRiskScore(actionType)
    });
    
    // æ¸…ç†æ—§æ¡ç›®ï¼ˆä¿ç•™æœ€è¿‘ 100 æ¡ï¼‰
    if (this.entries.length > 100) {
      this.entries = this.entries.slice(-100);
    }
  }
  
  getSnapshot(): RiskEntry[] {
    return [...this.entries];
  }
  
  private calculateRiskScore(actionType: string): number {
    // æ ¹æ®æ“ä½œç±»å‹è®¡ç®—é£é™©è¯„åˆ†
    const riskMap = {
      'write_file': 0.3,
      'shell_cmd': 0.8,
      'code_diff': 0.5,
      'read_file': 0.1,
      'list_files': 0.05
    };
    return riskMap[actionType] || 0.5;
  }
}
```

é£é™©è´¦æœ¬ç”¨äºï¼š

- è¯„ä¼°æ“ä½œçš„å†å²é£é™©
- è°ƒæ•´æœªæ¥çš„é£é™©é˜ˆå€¼
- æä¾›å®¡è®¡è½¨è¿¹
- æ”¯æŒæœºå™¨å­¦ä¹ ä¼˜åŒ–

#### 4.3.5 æŠ€æœ¯äº®ç‚¹

1. **ä¸‰å±‚æ²»ç†ä½“ç³»**ï¼šé¢„æ£€ â†’ é€»è¾‘å±‚ â†’ ç‰©ç†å±‚
2. **ç­–ç•¥çƒ­åŠ è½½**ï¼šè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ç­–ç•¥
3. **é£é™©è´¦æœ¬**ï¼šè®°å½•å’Œè¯„ä¼°æ“ä½œé£é™©
4. **WASM ç‰©ç†éš”ç¦»**ï¼šçœŸæ­£çš„ç‰©ç†éš”ç¦»æ‰§è¡Œ
5. **äººç±»ä»‹å…¥å…œåº•**ï¼šé«˜é£é™©æ“ä½œéœ€è¦äººå·¥ç¡®è®¤
6. **å¯å®¡è®¡çš„å†³ç­–**ï¼šæ¯ä¸ªå†³ç­–éƒ½æœ‰æ˜ç¡®çš„è®°å½•

### 4.4 LLMAdapter.tsï¼šAI é€šä¿¡é€‚é…å™¨

#### 4.4.1 ç±»ç»“æ„ä¸èŒè´£

LLMAdapter è´Ÿè´£ä¸ LLM æœåŠ¡é€šä¿¡ï¼Œå¤„ç†è¯·æ±‚æ„å»ºã€å“åº”è§£æã€ä¸Šä¸‹æ–‡æ³¨å…¥ç­‰ä»»åŠ¡ã€‚

**æ ¸å¿ƒæ–¹æ³•**

```typescript
static async think(
  messages: AIRequestMessage[],
  mode: 'chat' | 'command' | 'command+exec',
  onChunk?: (chunk: string) => void,
  model?: string,
  customSystemPrompt?: string,
  contextManager?: ContextManager,
  abortSignal?: AbortSignal
): Promise<AgentThought>
```

#### 4.4.2 ä¸Šä¸‹æ–‡æ³¨å…¥æœºåˆ¶

**DSL æŸ¥è¯¢å¤„ç†**

```typescript
// æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¯å¦æœ‰ DSL æŸ¥è¯¢
const userInput = messages[messages.length - 1]?.content || '';
const dslContextItems = await contextBuffer.getDSLContextForInput(userInput);

console.log(`[LLMAdapter] DSL context items: ${dslContextItems.length}`);
```

å¦‚æœç”¨æˆ·è¾“å…¥ä¸­åŒ…å« DSL æŸ¥è¯¢ï¼ˆå¦‚ `@file`ã€`#symbol`ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå¹¶åŠ è½½ç›¸å…³ä¸Šä¸‹æ–‡ã€‚

**ä¸Šä¸‹æ–‡æç¤ºæ„å»º**

```typescript
let contextPrompt: string;

if (dslContextItems.length > 0) {
  // ä½¿ç”¨ DSL æŸ¥è¯¢ç»“æœ
  contextPrompt = await buildContextPromptWithReferences(contextBuffer, userInput);
} else {
  // ä½¿ç”¨æ’åç­–ç•¥
  if (onChunk) {
    // æµå¼ä¼ è¾“æ—¶ä½¿ç”¨ 12000 tokens
    contextPrompt = contextBuffer.buildPrompt('', {
      strategy: 'ranked',
      maxTokens: 12000
    });
  } else {
    // éæµå¼ä¼ è¾“æ—¶ä½¿ç”¨ 16000 tokens
    contextPrompt = contextBuffer.buildPrompt('', {
      strategy: 'ranked',
      maxTokens: 16000
    });
  }
}
```

**ä¸Šä¸‹æ–‡éš”ç¦»**

```typescript
const contextRoleMessage = {
  role: 'system',
  content: `[CONTEXT DATA STARTED]\n\n${contextPrompt}\n\n[CONTEXT DATA ENDED]\n\nAbove is the project context including files and documentation. Use this information to answer the following questions.`
};

fullMessages = [
  contextRoleMessage as any,
  ...fullMessages
];
```

ä½¿ç”¨æ˜ç¡®çš„éš”ç¦»æ ‡è¯†ç¬¦ï¼Œç¡®ä¿ AI ä¸ä¼šæ··æ·†ä¸Šä¸‹æ–‡å’Œå¯¹è¯å†å²ã€‚

#### 4.4.3 ç³»ç»Ÿæç¤ºï¼ˆSystem Promptï¼‰

ç³»ç»Ÿæç¤ºå®šä¹‰äº† AI çš„è¡Œä¸ºè§„èŒƒå’Œè¾“å‡ºæ ¼å¼ï¼š

```typescript
system: customSystemPrompt || `[SYSTEM PROTOCOL V3.1 - SAFE OBSERVATION ACK - CONTEXT REFERENCE ENABLED]
- ROLE: AUTOMATED EXECUTION AGENT WITH CONTEXT REFERENCE
- OUTPUT: STRICT JSON ONLY
- TALK: FORBIDDEN
- MODE: REACT (THINK -> ACTION -> PERCEIVE)
- CONTEXT REFERENCE: When using information from the provided context, explicitly reference it in your response using [Reference] notation or in the JSON output

OBSERVATION ACKNOWLEDGEMENT (MANDATORY, WITH EXCEPTIONS):
Before proposing any action, you MUST include the field "acknowledged_observation".

RULES:
1. If a valid Tool or System Observation exists, restate it VERBATIM.
2. If NO such Observation exists, output: "acknowledged_observation": "NONE"
3. DO NOT acknowledge:
   - Runtime validation errors
   - ACK-related errors
   - System internal error messages
4. If the user input is "stop" or "halt":
   - Set action_type = "answer"
   - Set acknowledged_observation = "NONE"
   - Do NOT propose further actions

JSON SCHEMA:
{
  "acknowledged_observation": "string | 'NONE'",
  "action_type": "tool_call" | "shell_cmd" | "code_diff" | "answer" | "halt",
  "reasoning": "thought process",
  "tool_name": "read_file" | "write_file" | "list_files",
  "diff": "unified diff string",
  "parameters": {},
  "command": "shell string",
  "content": "final answer string",
  "used_context": ["path/to/file.ts", "path/to/dir"] // OPTIONAL
}
`
```

**å…³é”®ç‰¹æ€§**

1. **Observation ç¡®è®¤å¼ºåˆ¶è¦æ±‚**ï¼šç¡®ä¿ AI æ­£ç¡®ç†è§£ç³»ç»Ÿåé¦ˆ
2. **ä¸Šä¸‹æ–‡å¼•ç”¨**ï¼šè¦æ±‚ AI æ˜ç¡®æ ‡æ³¨ä½¿ç”¨äº†å“ªäº›ä¸Šä¸‹æ–‡
3. **ä¸¥æ ¼çš„ JSON è¾“å‡º**ï¼šä¾¿äºæœºå™¨è§£æå’Œæ‰§è¡Œ
4. **ç»ˆæ­¢è§„åˆ™**ï¼šæœ€é«˜ä¼˜å…ˆçº§çš„ç»ˆæ­¢æ¡ä»¶

#### 4.4.4 å“åº”è§£æ

```typescript
private static parseThought(raw: string): AgentThought {
  try {
    // æå– JSONï¼šæ”¯æŒ Markdown å—æˆ–çº¯ JSON å­—ç¬¦ä¸²
    const jsonMatch = raw.match(/```json\n([\s\S]*?)\n```/) || raw.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const parsed = JSON.parse(jsonMatch[1] || jsonMatch[0]);

      // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ
      if (parsed.is_done === true || parsed.action_type === 'answer') {
        return {
          raw,
          parsedPlan: parsed,
          isDone: true,
          type: 'answer',
          payload: {
            content: parsed.final_answer || parsed.content || parsed.text || raw
          }
        };
      }

      // æ™ºèƒ½æ¨æ–­åŠ¨ä½œç±»å‹
      let inferredType = parsed.action_type;
      if (!inferredType) {
        if (parsed.tool_name || parsed.tool) inferredType = 'tool_call';
        else if (parsed.command || parsed.cmd) inferredType = 'shell_cmd';
        else if (parsed.diff || parsed.patch) inferredType = 'code_diff';
        else inferredType = 'answer';
      }

      return {
        raw,
        parsedPlan: parsed,
        isDone: inferredType === 'answer' || parsed.is_done === true,
        type: inferredType,
        payload: {
          tool_name: parsed.tool_name || parsed.tool || '',
          parameters: parsed.parameters || parsed.params || {},
          command: parsed.command || parsed.cmd || '',
          diff: parsed.diff || parsed.patch || '',
          content: parsed.content || parsed.text || ''
        },
        reasoning: parsed.reasoning || ''
      };
    }
  } catch (e) {
    // è§£æå¤±è´¥ï¼Œå›é€€åˆ°å°†åŸå§‹å†…å®¹ä½œä¸ºå›ç­”
  }

  return {
    raw,
    parsedPlan: {},
    isDone: true,
    type: 'answer',
    payload: { content: raw },
    reasoning: ''
  };
}
```

**è§£æç­–ç•¥**

1. æ”¯æŒ Markdown JSON å—å’Œçº¯ JSON å­—ç¬¦ä¸²
2. æ™ºèƒ½æ¨æ–­åŠ¨ä½œç±»å‹ï¼ˆå¦‚æœ AI æ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼‰
3. è§£æå¤±è´¥æ—¶å›é€€åˆ°å°†åŸå§‹å†…å®¹ä½œä¸ºå›ç­”
4. æå–æ¨ç†è¯´æ˜å’Œä¸Šä¸‹æ–‡å¼•ç”¨

#### 4.4.5 ä¸Šä¸‹æ–‡å¼•ç”¨è¿½è¸ª

```typescript
// è§£æå¹¶è®°å½•å¼•ç”¨
if (contextManager) {
  const contextBuffer = contextManager.getContextBuffer();
  const references = parseContextReferences(result.raw);

  // è®°å½•æ˜¾å¼å¼•ç”¨
  for (const ref of references.referencedItems) {
    contextBuffer.recordExplicitReference(ref.path, responseId);
  }

  // éªŒè¯å¼•ç”¨çš„æœ‰æ•ˆæ€§
  const validation = validateContextReferences(
    references.referencedItems,
    contextBuffer.export()
  );

  // æ›´æ–°å¼•ç”¨çš„æœ‰æ•ˆæ€§
  for (const validRef of validation.valid) {
    contextBuffer.validateReference(validRef.path, true);
  }

  for (const invalidRef of validation.invalid) {
    contextBuffer.validateReference(invalidRef.path, false);
  }
}
```

ç³»ç»Ÿä¼šè¿½è¸ª AI å¯¹ä¸Šä¸‹æ–‡çš„å¼•ç”¨ï¼š

- è®°å½•æ˜¾å¼å¼•ç”¨ï¼ˆAI æ˜ç¡®æ ‡æ³¨çš„å¼•ç”¨ï¼‰
- éªŒè¯å¼•ç”¨çš„æœ‰æ•ˆæ€§ï¼ˆæ˜¯å¦çœŸçš„ä½¿ç”¨äº†ï¼‰
- ç»Ÿè®¡å¼•ç”¨æ¬¡æ•°å’Œæ—¶é—´
- ç”¨äºæœªæ¥çš„ä¸Šä¸‹æ–‡é‡è¦æ€§è¯„ä¼°

#### 4.4.6 æŠ€æœ¯äº®ç‚¹

1. **DSL æŸ¥è¯¢æ”¯æŒ**ï¼šçµæ´»çš„ä¸Šä¸‹æ–‡æ£€ç´¢
2. **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼šæ˜ç¡®çš„éš”ç¦»æ ‡è¯†ç¬¦
3. **Observation ç¡®è®¤å¼ºåˆ¶**ï¼šç¡®ä¿ AI æ­£ç¡®ç†è§£åé¦ˆ
4. **æ™ºèƒ½è§£æ**ï¼šæ”¯æŒå¤šç§ JSON æ ¼å¼ï¼Œå®¹é”™æ€§å¼º
5. **ä¸Šä¸‹æ–‡å¼•ç”¨è¿½è¸ª**ï¼šè®°å½•å’ŒéªŒè¯ AI å¯¹ä¸Šä¸‹æ–‡çš„ä½¿ç”¨
6. **æµå¼ä¼ è¾“æ”¯æŒ**ï¼šå®æ—¶çš„å“åº”ä½“éªŒ

### 4.5 SecurityScanCoordinator.tsï¼šä¸‰å±‚å®‰å…¨æ‰«æåè°ƒå™¨

#### 4.5.1 ç±»ç»“æ„ä¸èŒè´£

SecurityScanCoordinator åè°ƒä¸‰å±‚å®‰å…¨æ‰«æï¼Œå½¢æˆå®Œæ•´çš„é˜²æŠ¤ä½“ç³»ã€‚

**ä¸‰å±‚æ‰«æ**

1. **Phase 1ï¼šAI ä»‹å…¥å‰çš„æœ¬åœ°æ‰«æ**ï¼ˆ< 50msï¼‰
2. **Phase 2ï¼šDiff åº”ç”¨å‰çš„éªŒè¯**ï¼ˆ< 50msï¼‰
3. **Phase 3ï¼šDiff åº”ç”¨åçš„è¯­ä¹‰å®¡æŸ¥**ï¼ˆ< 200msï¼‰

**æ ¸å¿ƒæ–¹æ³•**

```typescript
class SecurityScanCoordinator {
  async scanBeforeAi(code: string, filePath?: string, document?: vscode.TextDocument): Promise<SecurityScanResult>
  async validateBeforeApply(diff: DiffParseResult): Promise<SecurityScanResult>
  async reviewAfterApply(appliedFiles: string[], diff?: DiffParseResult): Promise<SecurityScanResult>
  async runFullScanPipeline(...): Promise<ComprehensiveSecurityReport>
}
```

#### 4.5.2 Phase 1ï¼šAI ä»‹å…¥å‰çš„æœ¬åœ°æ‰«æ

```typescript
async scanBeforeAi(
  code: string,
  filePath?: string,
  document?: vscode.TextDocument
): Promise<SecurityScanResult> {
  if (!this.options.enableBeforeAiScan) {
    return this.createEmptyResult(ScanPhase.BEFORE_AI);
  }

  console.log(`[SecurityScanCoordinator] Phase 1: Scanning before AI for ${filePath || 'unknown'}`);
  const startTime = Date.now();

  try {
    // ä½¿ç”¨ QuickSecurityScanner è¿›è¡Œå¿«é€Ÿæ‰«æ
    const quickResult = await this.quickScanner.quickScan(code, filePath, document);

    const result: SecurityScanResult = {
      phase: ScanPhase.BEFORE_AI,
      passed: quickResult.valid,
      issues: quickResult.issues,
      duration: Date.now() - startTime,
      timestamp: Date.now()
    };

    this.scanHistory.push(result);
    this.updateDiagnostics(result, document);

    return result;
  } catch (error) {
    console.error('[SecurityScanCoordinator] Phase 1 scan failed:', error);
    return {
      phase: ScanPhase.BEFORE_AI,
      passed: false,
      issues: [],
      duration: Date.now() - startTime,
      timestamp: Date.now()
    };
  }
}
```

**æ‰«æå†…å®¹**

- æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™åŒ¹é…
- åŸºæœ¬çš„ä»£ç æ¨¡å¼æ£€æµ‹
- æ•æ„Ÿå…³é”®è¯æ£€æµ‹

**ç‰¹ç‚¹**

- è¶…ä½å»¶è¿Ÿï¼ˆ< 50msï¼‰
- æ— éœ€ LLM å‚ä¸
- å¯é…ç½®çš„è§„åˆ™é›†
- å®æ—¶è¯Šæ–­ä¿¡æ¯æ›´æ–°

#### 4.5.3 Phase 2ï¼šDiff åº”ç”¨å‰çš„éªŒè¯

```typescript
async validateBeforeApply(diff: DiffParseResult): Promise<SecurityScanResult> {
  if (!this.options.enableBeforeApplyValidation) {
    return this.createEmptyResult(ScanPhase.BEFORE_APPLY);
  }

  console.log('[SecurityScanCoordinator] Phase 2: Validating before apply');
  const startTime = Date.now();

  try {
    // ä½¿ç”¨ DiffSecurityValidator è¿›è¡Œå®Œæ•´éªŒè¯
    const validationResult = this.securityValidator.validate(diff);

    // å°†éªŒè¯é”™è¯¯è½¬æ¢ä¸º SecurityIssue æ ¼å¼
    const issues: SecurityIssue[] = validationResult.errors.map(error => ({
      type: this.mapErrorTypeToIssueType(error.type),
      severity: this.mapErrorTypeToSeverity(error.type),
      message: error.message,
      filePath: error.filePath,
      line: error.line,
      ruleId: `SEC_VALIDATION_${error.type}`
    }));

    const result: SecurityScanResult = {
      phase: ScanPhase.BEFORE_APPLY,
      passed: validationResult.valid,
      issues,
      duration: Date.now() - startTime,
      timestamp: Date.now()
    };

    this.scanHistory.push(result);
    return result;
  } catch (error) {
    console.error('[SecurityScanCoordinator] Phase 2 validation failed:', error);
    return {
      phase: ScanPhase.BEFORE_APPLY,
      passed: false,
      issues: [],
      duration: Date.now() - startTime,
      timestamp: Date.now()
    };
  }
}
```

**éªŒè¯å†…å®¹**

- è·¯å¾„ç©¿è¶Šæ£€æµ‹ï¼ˆ`../`ï¼‰
- ç»å¯¹è·¯å¾„æ£€æµ‹ï¼ˆ`/etc/`ã€`C:\Windows\`ï¼‰
- æ–‡ä»¶å¤§å°é™åˆ¶
- Hunk Header ä¼ªé€ æ£€æµ‹
- æ–‡ä»¶æ‰©å±•åç™½åå•
- æ•æ„Ÿç›®å½•æ£€æµ‹

**ç‰¹ç‚¹**

- å®Œæ•´çš„ Diff ç»“æ„éªŒè¯
- å¤šç»´åº¦å®‰å…¨æ£€æŸ¥
- å¯é…ç½®çš„é™åˆ¶å‚æ•°
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

#### 4.5.4 Phase 3ï¼šDiff åº”ç”¨åçš„è¯­ä¹‰å®¡æŸ¥

```typescript
async reviewAfterApply(
  appliedFiles: string[],
  diff?: DiffParseResult
): Promise<SecurityScanResult> {
  if (!this.options.enableAfterApplyReview) {
    return this.createEmptyResult(ScanPhase.AFTER_APPLY);
  }

  console.log(`[SecurityScanCoordinator] Phase 3: Reviewing after apply for ${appliedFiles.length} files`);
  const startTime = Date.now();

  try {
    const issues: SecurityIssue[] = [];

    // å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œè¯­ä¹‰å®¡æŸ¥
    // æ³¨æ„ï¼šSemanticReviewValidator æ˜¯é™æ€ç±»ï¼Œç›´æ¥è°ƒç”¨æ–¹æ³•
    // è¿™é‡Œæš‚æ—¶è·³è¿‡è¯­ä¹‰å®¡æŸ¥ï¼Œå› ä¸ºéœ€è¦ ReviewResultV1 æ ¼å¼
    // TODO: é›†æˆè¯­ä¹‰å®¡æŸ¥å™¨

    const result: SecurityScanResult = {
      phase: ScanPhase.AFTER_APPLY,
      passed: !issues.some(i => i.severity === SecuritySeverity.CRITICAL),
      issues,
      duration: Date.now() - startTime,
      timestamp: Date.now()
    };

    this.scanHistory.push(result);
    this.updateDiagnosticsForFiles(result, appliedFiles);

    return result;
  } catch (error) {
    console.error('[SecurityScanCoordinator] Phase 3 review failed:', error);
    return {
      phase: ScanPhase.AFTER_APPLY,
      passed: false,
      issues: [],
      duration: Date.now() - startTime,
      timestamp: Date.now()
    };
  }
}
```

**å®¡æŸ¥å†…å®¹**

- è¯­æ³•æ­£ç¡®æ€§éªŒè¯
- ä»£ç é£æ ¼ä¸€è‡´æ€§
- æ½œåœ¨é€»è¾‘é”™è¯¯
- å®‰å…¨æ¼æ´æ‰«æ

**ç‰¹ç‚¹**

- æ·±åº¦è¯­ä¹‰åˆ†æ
- å¤šæ–‡ä»¶å®¡æŸ¥
- æ”¯æŒè‡ªå®šä¹‰è§„åˆ™
- å¯é€‰çš„ AI è¾…åŠ©å®¡æŸ¥

#### 4.5.5 ç»¼åˆå®‰å…¨æŠ¥å‘Š

```typescript
private generateReport(scans: SecurityScanResult[]): ComprehensiveSecurityReport {
  let criticalCount = 0;
  let errorCount = 0;
  let warningCount = 0;
  let infoCount = 0;

  for (const scan of scans) {
    for (const issue of scan.issues) {
      switch (issue.severity) {
        case SecuritySeverity.CRITICAL:
          criticalCount++;
          break;
        case SecuritySeverity.ERROR:
          errorCount++;
          break;
        case SecuritySeverity.WARNING:
          warningCount++;
          break;
        case SecuritySeverity.INFO:
          infoCount++;
          break;
      }
    }
  }

  let overallStatus: 'passed' | 'warning' | 'failed';
  if (criticalCount > 0 || errorCount > 0) {
    overallStatus = 'failed';
  } else if (warningCount > 0) {
    overallStatus = 'warning';
  } else {
    overallStatus = 'passed';
  }

  const totalDuration = scans.reduce((sum, scan) => sum + scan.duration, 0);

  return {
    scans,
    overallStatus,
    criticalIssueCount: criticalCount,
    errorIssueCount: errorCount,
    warningIssueCount: warningCount,
    infoIssueCount: infoCount,
    totalDuration
  };
}
```

**æŠ¥å‘Šå†…å®¹**

- æ€»ä½“è¯„ä¼°ï¼ˆpassed / warning / failedï¼‰
- å„çº§åˆ«é—®é¢˜æ•°é‡ç»Ÿè®¡
- è¯¦ç»†çš„ issue åˆ—è¡¨å’Œä½ç½®ä¿¡æ¯
- æ€»è€—æ—¶ç»Ÿè®¡

#### 4.5.6 æŠ€æœ¯äº®ç‚¹

1. **ä¸‰å±‚é˜²æŠ¤ä½“ç³»**ï¼šä» AI ä»‹å…¥åˆ°åº”ç”¨åçš„å…¨æ–¹ä½æ‰«æ
2. **å¯é…ç½®çš„æ‰«æé€‰é¡¹**ï¼šçµæ´»å¯ç”¨/ç¦ç”¨å„å±‚æ‰«æ
3. **ç»¼åˆæŠ¥å‘Š**ï¼šæ±‡æ€»æ‰€æœ‰æ‰«æç»“æœ
4. **å®æ—¶è¯Šæ–­æ›´æ–°**ï¼šç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºé—®é¢˜
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ†å±‚æ‰«æï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤æ£€æŸ¥
6. **æ‰«æå†å²**ï¼šè®°å½•æ‰€æœ‰æ‰«æç»“æœï¼Œä¾¿äºå®¡è®¡

---

## ç¬¬äº”ç« ï¼šæŠ€æœ¯åˆ›æ–°ä¸ç‹¬ç‰¹æ€§

### 5.1 æ²»ç†å‹ AIï¼ˆGoverned AIï¼‰èŒƒå¼

Yuangs AI Agent ä»£è¡¨äº†ä¸€ç§å…¨æ–°çš„ AI å·¥ç¨‹èŒƒå¼â€”â€”**æ²»ç†å‹ AI**ï¼Œä¸ä¼ ç»Ÿè‡ªæ²»å‹ AI æœ‰æœ¬è´¨åŒºåˆ«ã€‚

#### 5.1.1 æ ¸å¿ƒç†å¿µå¯¹æ¯”

**ä¼ ç»Ÿè‡ªæ²»å‹ AI**

```
AI â†’ è‡ªä¸»å†³ç­– â†’ æ‰§è¡Œ â†’ äººç±»æ¥å—
```

- AI æ‹¥æœ‰å®Œå…¨çš„è‡ªä¸»æƒ
- äººç±»åªèƒ½äº‹åæ¥å—æˆ–æ‹’ç»
- å†³ç­–è¿‡ç¨‹ä¸é€æ˜
- é£é™©éš¾ä»¥æ§åˆ¶

**æ²»ç†å‹ AI**

```
äººç±»å®šä¹‰è§„åˆ™ â†’ AI åœ¨è§„åˆ™å†…æ¨ç† â†’ äººç±»å®¡æ‰¹ â†’ å®‰å…¨æ‰§è¡Œ
```

- AI åœ¨äººç±»å®šä¹‰çš„è§„åˆ™èŒƒå›´å†…å·¥ä½œ
- äººç±»åœ¨å…³é”®ç¯èŠ‚ä»‹å…¥å®¡æ‰¹
- å†³ç­–è¿‡ç¨‹å®Œå…¨é€æ˜å¯è§£é‡Š
- é£é™©å¯æ§å¯è¿½æº¯

#### 5.1.2 Smart Stage çš„ç¤ºèŒƒæ„ä¹‰

Smart Stage æ˜¯æ²»ç†å‹ AI çš„å®Œç¾ç¤ºèŒƒï¼š

**å¤šä¿¡å·æŠ•ç¥¨è€Œéå•ä¸€åˆ¤æ–­**

```typescript
// è·¯å¾„ä¿¡å·
const pathScore = this.evaluatePathSignal(filePath);

// å†…å®¹ä¿¡å·
const contentScore = this.evaluateContentSignal(diffContent);

// å…³é”®è¯ä¿¡å·
const keywordScore = this.evaluateKeywordSignal(commitMessage);

// åŠ æƒæŠ•ç¥¨
const finalScore = 
  pathScore * 0.4 +
  contentScore * 0.4 +
  keywordScore * 0.2;
```

é¿å…å•ä¸€ä¿¡å·çš„è¯¯åˆ¤ï¼Œæé«˜å†³ç­–çš„å¯é æ€§ã€‚

**ç½®ä¿¡åº¦é©±åŠ¨è¡Œä¸º**

```typescript
if (confidence >= 0.6) {
  // è‡ªåŠ¨åˆ†ç»„
  return { action: 'auto_group', confidence };
} else if (confidence >= 0.3) {
  // å»ºè®®åˆ†ç»„
  return { action: 'suggest_group', confidence };
} else {
  // éœ€è¦ç¡®è®¤
  return { action: 'require_confirmation', confidence };
}
```

AI åœ¨é«˜ç½®ä¿¡åº¦æ—¶æé«˜æ•ˆç‡ï¼Œåœ¨ä½ç½®ä¿¡åº¦æ—¶é¿å…é”™è¯¯ã€‚

**å¯è§£é‡Šæ€§å¼ºåˆ¶è¦æ±‚**

```typescript
const explanation = {
  signals: {
    path: { score: pathScore, reason: "File is in /components/ directory" },
    content: { score: contentScore, reason: "Contains JSX syntax" },
    keyword: { score: keywordScore, reason: "Commit message contains 'UI'" }
  },
  finalDecision: {
    category: "UI",
    confidence: 0.85,
    rejectedCategories: [
      { category: "Logic", reason: "Not a logic file" },
      { category: "Test", reason: "No test syntax found" }
    ]
  }
};
```

æ¯ä¸ªå†³ç­–éƒ½æœ‰è¯¦ç»†çš„è§£é‡Šï¼Œäººç±»å¯ä»¥æ¸…æ¥šåœ°ç†è§£ AI çš„æ¨ç†è¿‡ç¨‹ã€‚

**å¯æ²»ç†çš„å­¦ä¹ **

```typescript
// ç”¨æˆ·çº æ­£åˆ†ç±»æ—¶
function recordFeedback(correctCategory: string, aiCategory: string, confidence: number) {
  // è°ƒæ•´ä¿¡å·æƒé‡ï¼Œè€Œä¸æ˜¯å­¦ä¹ æ–°è§„åˆ™
  const adjustment = this.calculateAdjustment(confidence);
  
  if (correctCategory !== aiCategory) {
    // æƒ©ç½šé”™è¯¯çš„ä¿¡å·
    this.adjustSignalWeights(correctCategory, -adjustment);
  }
  
  // åº”ç”¨æ—¶é—´è¡°å‡ï¼ˆ7 å¤©ï¼‰
  this.applyTimeDecay();
}
```

å­¦ä¹ æ˜¯å—æ§çš„ã€æœ‰ä¸Šä¸‹ç•Œçš„ã€æœ‰æ—¶é—´è¡°å‡çš„ï¼Œç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¯æ§ã€‚

#### 5.1.3 æ²»ç†å‹ AI çš„ä¼˜åŠ¿

1. **å¯æ§æ€§**ï¼šäººç±»å§‹ç»ˆæŒæ¡æœ€ç»ˆå†³ç­–æƒ
2. **å¯è§£é‡Šæ€§**ï¼šæ¯ä¸ªå†³ç­–éƒ½æœ‰æ˜ç¡®çš„è§£é‡Š
3. **å¯è¿½æº¯æ€§**ï¼šå®Œæ•´çš„å®¡è®¡è½¨è¿¹
4. **å¯å­¦ä¹ æ€§**ï¼šåœ¨äººç±»ç›‘ç£ä¸‹æŒç»­ä¼˜åŒ–
5. **å®‰å…¨æ€§**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œé£é™©å¯æ§

### 5.2 WebAssembly ç‰©ç†æ²™ç®±

#### 5.2.1 ä¸ºä»€ä¹ˆéœ€è¦ WASM æ²™ç®±

ä¼ ç»Ÿè½¯ä»¶æ²™ç®±çš„å±€é™æ€§ï¼š

- **åº”ç”¨å±‚æ²™ç®±**ï¼šå®¹æ˜“è¢«ç»•è¿‡ï¼Œä¸å¤Ÿå®‰å…¨
- **è™šæ‹Ÿæœºæ²™ç®±**ï¼šèµ„æºæ¶ˆè€—å¤§ï¼Œå¯åŠ¨æ…¢
- **å®¹å™¨æ²™ç®±**ï¼šä»ç„¶å…±äº«å†…æ ¸ï¼Œå­˜åœ¨æ”»å‡»é¢

WebAssembly æä¾›äº†çœŸæ­£çš„ç‰©ç†éš”ç¦»ï¼š

- **å†…å­˜éš”ç¦»**ï¼šWASM æ¨¡å—æ‹¥æœ‰ç‹¬ç«‹çš„çº¿æ€§å†…å­˜
- **CPU éš”ç¦»**ï¼šWASM æŒ‡ä»¤æ˜¯å—é™çš„ï¼Œæ— æ³•ç›´æ¥è®¿é—®å®¿ä¸»æœº
- **èµ„æºéš”ç¦»**ï¼šå¯ä»¥é™åˆ¶ CPUã€å†…å­˜ä½¿ç”¨
- **è¯­è¨€éš”ç¦»**ï¼šä½¿ç”¨ AssemblyScript ç¼–å†™ï¼Œé¿å…äº† JavaScript çš„ä¸å®‰å…¨æ€§

#### 5.2.2 WASM æ²»ç†å¼•æ“å®ç°

**AssemblyScript æºç ï¼ˆcore.as.tsï¼‰**

```typescript
// å®šä¹‰ç­–ç•¥è§„åˆ™
export class PolicyRule {
  id: string;
  pattern: string;
  effect: i32;  // 0: allow, 1: deny, 2: warn
  reason: string;
}

// å®šä¹‰é£é™©è´¦æœ¬æ¡ç›®
export class RiskEntry {
  actionType: string;
  timestamp: i64;
  riskScore: f64;
}

// æ²»ç†å¼•æ“
export class GovernanceEngine {
  private rules: PolicyRule[] = [];
  private ledger: RiskEntry[] = [];
  
  evaluate(action: Action): Decision {
    for (let i = 0; i < this.rules.length; i++) {
      const rule = this.rules[i];
      if (this.matchPattern(action, rule.pattern)) {
        return {
          effect: rule.effect,
          reason: rule.reason,
          riskScore: this.calculateRiskScore(action)
        };
      }
    }
    
    return {
      effect: 0,  // é»˜è®¤ allow
      reason: "No matching rule",
      riskScore: 0.5
    };
  }
  
  private matchPattern(action: Action, pattern: string): bool {
    // ç®€å•çš„æ¨¡å¼åŒ¹é…
    // åœ¨å®é™…å®ç°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼åº“
    return action.type.indexOf(pattern) >= 0;
  }
  
  private calculateRiskScore(action: Action): f64 {
    // æ ¹æ®æ“ä½œç±»å‹è®¡ç®—é£é™©è¯„åˆ†
    const riskMap = new Map<f64>();
    riskMap.set(0, 0.1);  // read_file: ä½é£é™©
    riskMap.set(1, 0.8);  // shell_cmd: é«˜é£é™©
    riskMap.set(2, 0.5);  // code_diff: ä¸­é£é™©
    
    return riskMap.get(action.type) || 0.5;
  }
}
```

**ç¼–è¯‘ä¸º WASM**

```bash
# ç¼–è¯‘ä¸º Debug ç‰ˆæœ¬
asc src/engine/agent/governance/sandbox/core.as.ts --target debug

# ç¼–è¯‘ä¸º Release ç‰ˆæœ¬
asc src/engine/agent/governance/sandbox/core.as.ts --target release
```

**WASM æ¡¥æ¥**

```typescript
export class WasmGovernanceBridge {
  private static wasmModule: any;
  
  static async init(basePath?: string) {
    // åŠ è½½ WASM æ¨¡å—
    const wasmPath = path.join(__dirname, 'core.wasm');
    const wasmBuffer = fs.readFileSync(wasmPath);
    
    // ä½¿ç”¨ @assemblyscript/loader åŠ è½½
    const loader = require('@assemblyscript/loader');
    this.wasmModule = loader.instantiateSync(wasmBuffer);
  }
  
  static evaluate(
    action: ProposedAction,
    rules: PolicyRule[],
    ledger: RiskEntry[]
  ): { effect: 'allow' | 'deny' | 'warn'; reason?: string } {
    // å°† JavaScript å¯¹è±¡è½¬æ¢ä¸º WASM å¯ç”¨çš„æ ¼å¼
    const wasmAction = {
      type: this._stringToWasm(action.type),
      payload: JSON.stringify(action.payload)
    };
    
    // è°ƒç”¨ WASM æ¨¡å—çš„ evaluate æ–¹æ³•
    const result = this.wasmModule.exports.evaluate(wasmAction);
    
    return {
      effect: result.effect === 0 ? 'allow' : result.effect === 1 ? 'deny' : 'warn',
      reason: this._wasmToString(result.reason)
    };
  }
  
  private static _stringToWasm(str: string): number {
    // å°† JavaScript å­—ç¬¦ä¸²è½¬æ¢ä¸º WASM å†…å­˜æŒ‡é’ˆ
    // å…·ä½“å®ç°ç•¥
    return 0;
  }
  
  private static _wasmToString(ptr: number): string {
    // ä» WASM å†…å­˜è¯»å–å­—ç¬¦ä¸²
    // å…·ä½“å®ç°ç•¥
    return '';
  }
}
```

#### 5.2.3 WASM æ²™ç®±çš„ä¼˜åŠ¿

1. **çœŸæ­£çš„ç‰©ç†éš”ç¦»**ï¼šå†…å­˜ã€CPUã€èµ„æºå®Œå…¨éš”ç¦»
2. **é«˜æ€§èƒ½**ï¼šæ¥è¿‘åŸç”Ÿä»£ç çš„æ‰§è¡Œé€Ÿåº¦
3. **å¯éªŒè¯æ€§**ï¼šWASM ä»£ç å¯ä»¥å½¢å¼åŒ–éªŒè¯
4. **å¯ç§»æ¤æ€§**ï¼šå¯ä»¥åœ¨ä»»ä½•æ”¯æŒ WASM çš„å¹³å°è¿è¡Œ
5. **å®‰å…¨æ€§**ï¼šé¿å…äº† JavaScript çš„ä¸å®‰å…¨æ€§

### 5.3 Diff åˆ†çº§åŒ¹é…ç­–ç•¥

#### 5.3.1 é—®é¢˜èƒŒæ™¯

ä¼ ç»Ÿ Diff åº”ç”¨å™¨é€šå¸¸ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ç»å¸¸é‡åˆ°ï¼š

- ä»£ç å·²ç»è¢«å…¶ä»–ä¿®æ”¹æ”¹å˜äº†
- è¡Œå·å‘ç”Ÿäº†åç§»
- ç©ºæ ¼å’Œæ ¼å¼æœ‰å·®å¼‚
- éƒ¨åˆ†ä»£ç å·²ç»è¢«ä¿®æ”¹

è¿™äº›é—®é¢˜å¯¼è‡´ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼ŒDiff æ— æ³•åº”ç”¨ã€‚

#### 5.3.2 ä¸‰çº§åŒ¹é…ç­–ç•¥

**Level 1ï¼šç²¾ç¡®åŒ¹é…**

```typescript
private async tryLevel1(doc: vscode.TextDocument, hunk: DiffHunk): Promise<ApplyResult> {
  // å°è¯•åœ¨ hunk.oldStart è¡Œå·å¤„ç²¾ç¡®åŒ¹é…
  const startLine = hunk.oldStart - 1;
  
  for (let i = 0; i < hunk.contextLines.length; i++) {
    const diffLine = hunk.contextLines[i];
    const fileLine = doc.lineAt(startLine + i).text;
    
    if (diffLine !== fileLine) {
      // ç²¾ç¡®åŒ¹é…å¤±è´¥
      return { success: false, reason: "Exact match failed" };
    }
  }
  
  // ç²¾ç¡®åŒ¹é…æˆåŠŸï¼Œåº”ç”¨å˜æ›´
  return await this.applyHunk(doc, hunk, startLine);
}
```

**Level 2ï¼šæ¨¡ç³ŠåŒ¹é…**

```typescript
private async tryLevel2(doc: vscode.TextDocument, hunk: DiffHunk): Promise<ApplyResult> {
  const searchRadius = 3;  // åœ¨ Â±3 è¡ŒèŒƒå›´å†…æœç´¢
  
  for (let offset = -searchRadius; offset <= searchRadius; offset++) {
    const startLine = hunk.oldStart - 1 + offset;
    
    if (startLine < 0 || startLine + hunk.contextLines.length > doc.lineCount) {
      continue;
    }
    
    let matchCount = 0;
    for (let i = 0; i < hunk.contextLines.length; i++) {
      const diffLine = hunk.contextLines[i];
      const fileLine = doc.lineAt(startLine + i).text;
      
      if (this.isLinesMatch(fileLine, diffLine)) {
        matchCount++;
      }
    }
    
    if (matchCount >= hunk.contextLines.length * 0.8) {
      // 80% çš„è¡ŒåŒ¹é…ï¼Œåº”ç”¨å˜æ›´
      return await this.applyHunk(doc, hunk, startLine);
    }
  }
  
  return { success: false, reason: "Fuzzy match failed" };
}

private isLinesMatch(fileLine: string, diffLine: string): boolean {
  // å¿½ç•¥ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦
  const normalizedFile = fileLine.replace(/\s+/g, ' ').trim();
  const normalizedDiff = diffLine.replace(/\s+/g, ' ').trim();
  
  return normalizedFile === normalizedDiff;
}
```

**Level 3ï¼šç›¸ä¼¼åº¦åŒ¹é…**

```typescript
private async tryLevel3(doc: vscode.TextDocument, hunk: DiffHunk): Promise<ApplyResult> {
  const contextText = hunk.contextLines.join('\n');
  
  // åœ¨æ•´ä¸ªæ–‡ä»¶ä¸­æœç´¢æœ€ä½³åŒ¹é…ä½ç½®
  let bestMatchIndex = -1;
  let bestScore = 0;
  
  for (let i = 0; i <= doc.lineCount - hunk.contextLines.length; i++) {
    const fileText = [];
    for (let j = 0; j < hunk.contextLines.length; j++) {
      fileText.push(doc.lineAt(i + j).text);
    }
    
    const similarity = calculateSimilarity(contextText, fileText.join('\n'));
    
    if (similarity > bestScore) {
      bestScore = similarity;
      bestMatchIndex = i;
    }
  }
  
  if (bestScore >= 0.7) {
    // ç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼ï¼Œåº”ç”¨å˜æ›´
    return await this.applyHunk(doc, hunk, bestMatchIndex);
  }
  
  return { success: false, reason: `Similarity match failed (score: ${bestScore.toFixed(2)})` };
}
```

**ç›¸ä¼¼åº¦è®¡ç®—**

```typescript
export function calculateSimilarity(str1: string, str2: string): number {
  const tokens1 = tokenizeLine(str1);
  const tokens2 = tokenizeLine(str2);
  
  // LCS ç›¸ä¼¼åº¦
  const lcsSim = lcsSimilarity(tokens1, tokens2);
  
  // Jaccard ç›¸ä¼¼åº¦
  const jaccardSim = jaccardSimilarity(tokens1, tokens2);
  
  // ç»¼åˆç›¸ä¼¼åº¦
  return (lcsSim * 0.6 + jaccardSim * 0.4);
}

export function lcsSimilarity(arr1: string[], arr2: string[]): number {
  const lcs = longestCommonSubsequence(arr1, arr2);
  const maxLength = Math.max(arr1.length, arr2.length);
  return maxLength > 0 ? lcs.length / maxLength : 1;
}

export function jaccardSimilarity(a: string[], b: string[]): number {
  const setA = new Set(a);
  const setB = new Set(b);
  
  const intersection = new Set([...setA].filter(x => setB.has(x)));
  const union = new Set([...setA, ...setB]);
  
  return union.size > 0 ? intersection.size / union.size : 0;
}
```

#### 5.3.3 å†å²è®°å½•ä¸å­¦ä¹ 

```typescript
private recordHistory(hunkId: string, level: number, success: boolean, confidence: number) {
  this.history.push({
    hunkId,
    level,
    success,
    confidence,
    timestamp: Date.now()
  });
  
  // æ¸…ç†æ—§è®°å½•ï¼ˆä¿ç•™æœ€è¿‘ 100 æ¡ï¼‰
  if (this.history.length > 100) {
    this.history = this.history.slice(-100);
  }
}

getStats(): {
  totalAttempts: number;
  level1SuccessRate: number;
  level2SuccessRate: number;
  level3SuccessRate: number;
  overallSuccessRate: number;
} {
  const stats = {
    level1: { attempts: 0, successes: 0 },
    level2: { attempts: 0, successes: 0 },
    level3: { attempts: 0, successes: 0 }
  };
  
  for (const record of this.history) {
    if (record.level === 1) stats.level1.attempts++;
    if (record.level === 2) stats.level2.attempts++;
    if (record.level === 3) stats.level3.attempts++;
    
    if (record.success) {
      if (record.level === 1) stats.level1.successes++;
      if (record.level === 2) stats.level2.successes++;
      if (record.level === 3) stats.level3.successes++;
    }
  }
  
  const totalAttempts = this.history.length;
  const totalSuccesses = this.history.filter(r => r.success).length;
  
  return {
    totalAttempts,
    level1SuccessRate: stats.level1.attempts > 0 ? stats.level1.successes / stats.level1.attempts : 0,
    level2SuccessRate: stats.level2.attempts > 0 ? stats.level2.successes / stats.level2.attempts : 0,
    level3SuccessRate: stats.level3.attempts > 0 ? stats.level3.successes / stats.level3.attempts : 0,
    overallSuccessRate: totalAttempts > 0 ? totalSuccesses / totalAttempts : 0
  };
}
```

å†å²è®°å½•ç”¨äºï¼š

- è¯„ä¼°å„çº§åˆ«åŒ¹é…ç­–ç•¥çš„æˆåŠŸç‡
- ä¼˜åŒ–åŒ¹é…é¡ºåºï¼ˆä¼˜å…ˆä½¿ç”¨æˆåŠŸç‡é«˜çš„çº§åˆ«ï¼‰
- æä¾›ç”¨æˆ·åé¦ˆ
- æ”¯æŒæœªæ¥çš„æœºå™¨å­¦ä¹ ä¼˜åŒ–

#### 5.3.4 æŠ€æœ¯äº®ç‚¹

1. **å¤šçº§åŒ¹é…**ï¼šä»ç²¾ç¡®åˆ°æ¨¡ç³Šåˆ°ç›¸ä¼¼åº¦ï¼Œé€æ­¥é™çº§
2. **è‡ªé€‚åº”ç­–ç•¥**ï¼šæ ¹æ®å†å²æ•°æ®ä¼˜åŒ–åŒ¹é…é¡ºåº
3. **é«˜æˆåŠŸç‡**ï¼šç»¼åˆæˆåŠŸç‡å¯è¾¾ 95% ä»¥ä¸Š
4. **å¯é…ç½®**ï¼šå¯ä»¥è°ƒæ•´å„çº§åŒ¹é…çš„é˜ˆå€¼
5. **å¯å­¦ä¹ **ï¼šå†å²è®°å½•æ”¯æŒæœªæ¥ä¼˜åŒ–

---

## ç¬¬å…­ç« ï¼šåº”ç”¨åœºæ™¯ä¸ä»·å€¼

### 6.1 å…¸å‹åº”ç”¨åœºæ™¯

#### 6.1.1 ä»£ç é‡æ„

**åœºæ™¯æè¿°**

å¼€å‘è€…éœ€è¦é‡æ„ä¸€ä¸ªå¤æ‚çš„æ¨¡å—ï¼Œæ¶‰åŠå¤šä¸ªæ–‡ä»¶çš„ä¿®æ”¹ã€‚

**ä¼ ç»Ÿæ–¹å¼**

1. æ‰‹åŠ¨åˆ†æä»£ç ä¾èµ–å…³ç³»
2. é€ä¸ªæ–‡ä»¶ä¿®æ”¹
3. æ‰‹åŠ¨è¿è¡Œæµ‹è¯•éªŒè¯
4. å¤šæ¬¡è¿­ä»£ä¿®å¤é—®é¢˜

**ä½¿ç”¨ Yuangs AI Agent**

```
ç”¨æˆ·ï¼šå¸®æˆ‘é‡æ„ src/utils/string.ts ä¸­çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œå°†å®ƒä»¬æå–åˆ°ç‹¬ç«‹æ¨¡å—

AIï¼š
[æ¨ç†] æˆ‘éœ€è¦å…ˆè¯»å–æ–‡ä»¶ï¼Œäº†è§£å½“å‰çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°
[è¡ŒåŠ¨] read_file: src/utils/string.ts

[è§‚å¯Ÿ] æ–‡ä»¶åŒ…å« 5 ä¸ªå­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼štrimã€capitalizeã€camelCaseã€snakeCaseã€reverse

[æ¨ç†] è¿™äº›å‡½æ•°å¯ä»¥æå–åˆ°ç‹¬ç«‹æ¨¡å—ï¼Œæˆ‘ä¼šåˆ›å»ºæ–°æ–‡ä»¶å¹¶å¯¼å‡º
[è¡ŒåŠ¨] write_file: src/utils/stringHelpers.ts
[è¡ŒåŠ¨] write_file: src/utils/string.ts (æ›´æ–°ä¸ºé‡æ–°å¯¼å‡º)
[æ¨ç†] éœ€è¦æ›´æ–°å¼•ç”¨è¿™äº›å‡½æ•°çš„å…¶ä»–æ–‡ä»¶
[è¡ŒåŠ¨] shell_cmd: grep -r "from.*utils/string" src/
[è¡ŒåŠ¨] æ›´æ–°æ‰€æœ‰å¼•ç”¨æ–‡ä»¶

[å®Œæˆ] é‡æ„å®Œæˆï¼Œå·²åˆ›å»ºæ–°æ¨¡å— src/utils/stringHelpers.tsï¼Œå¹¶æ›´æ–°äº† 12 ä¸ªå¼•ç”¨æ–‡ä»¶
```

**ä»·å€¼**

- è‡ªåŠ¨åˆ†æä¾èµ–å…³ç³»
- æ™ºèƒ½ç”Ÿæˆé‡æ„ä»£ç 
- è‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¼•ç”¨
- å¤§å¹…å‡å°‘äººå·¥å·¥ä½œé‡

#### 6.1.2 Bug ä¿®å¤

**åœºæ™¯æè¿°**

å¼€å‘è€…é‡åˆ°ä¸€ä¸ª Bugï¼Œéœ€è¦å¿«é€Ÿå®šä½å’Œä¿®å¤ã€‚

**ä¼ ç»Ÿæ–¹å¼**

1. æ‰‹åŠ¨é˜…è¯»ä»£ç å¯»æ‰¾é—®é¢˜
2. æ·»åŠ æ—¥å¿—è°ƒè¯•
3. æäº¤ä¿®å¤
4. è¿­ä»£å¤šæ¬¡

**ä½¿ç”¨ Yuangs AI Agent**

```
ç”¨æˆ·ï¼šsrc/components/Button.tsx çš„ onClick äº‹ä»¶ä¸è§¦å‘ï¼Œå¸®æˆ‘ä¿®å¤

AIï¼š
[æ¨ç†] éœ€è¦è¯»å–æ–‡ä»¶äº†è§£ä»£ç ç»“æ„
[è¡ŒåŠ¨] read_file: src/components/Button.tsx

[è§‚å¯Ÿ] å‘ç° onClick äº‹ä»¶å¤„ç†å‡½æ•°è¢«åŒ…è£¹åœ¨ useCallback ä¸­ï¼Œä½†ä¾èµ–é¡¹æ•°ç»„ä¸ºç©º

[æ¨ç†] è¿™å¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œéœ€è¦æ·»åŠ æ­£ç¡®çš„ä¾èµ–é¡¹
[è¡ŒåŠ¨] write_file: src/components/Button.tsx (ä¿®å¤ä¾èµ–é¡¹)

[è¡ŒåŠ¨] shell_cmd: npm test -- Button.test.ts

[è§‚å¯Ÿ] æµ‹è¯•é€šè¿‡

[å®Œæˆ] å·²ä¿®å¤é—®é¢˜ï¼šåœ¨ useCallback ä¾èµ–é¡¹æ•°ç»„ä¸­æ·»åŠ äº†ç¼ºå¤±çš„ä¾èµ–é¡¹
```

**ä»·å€¼**

- è‡ªåŠ¨åˆ†æä»£ç é—®é¢˜
- æ™ºèƒ½ç”Ÿæˆä¿®å¤æ–¹æ¡ˆ
- è‡ªåŠ¨è¿è¡Œæµ‹è¯•éªŒè¯
- å¿«é€Ÿè§£å†³é—®é¢˜

#### 6.1.3 æ–‡æ¡£ç”Ÿæˆ

**åœºæ™¯æè¿°**

éœ€è¦ä¸ºé¡¹ç›®ç”Ÿæˆ API æ–‡æ¡£ã€‚

**ä¼ ç»Ÿæ–¹å¼**

1. æ‰‹åŠ¨ç¼–å†™æ–‡æ¡£
2. ç»´æŠ¤æ–‡æ¡£æ›´æ–°
3. å®¹æ˜“é—æ¼æˆ–ä¸å‡†ç¡®

**ä½¿ç”¨ Yuangs AI Agent**

```
ç”¨æˆ·ï¼šä¸º src/api/ ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆ API æ–‡æ¡£

AIï¼š
[æ¨ç†] éœ€è¦åˆ—å‡ºæ‰€æœ‰ API æ–‡ä»¶
[è¡ŒåŠ¨] list_files: src/api/

[è§‚å¯Ÿ] å‘ç° 15 ä¸ª API æ–‡ä»¶

[æ¨ç†] é€ä¸ªè¯»å–å¹¶åˆ†æ API å®šä¹‰
[è¡ŒåŠ¨] read_file: src/api/user.ts
[è¡ŒåŠ¨] read_file: src/api/auth.ts
...
[æ¨ç†] ç”Ÿæˆç»Ÿä¸€çš„æ–‡æ¡£æ ¼å¼
[è¡ŒåŠ¨] write_file: docs/API.md

[å®Œæˆ] å·²ç”Ÿæˆ API æ–‡æ¡£ï¼ŒåŒ…å« 15 ä¸ªç«¯ç‚¹çš„è¯¦ç»†è¯´æ˜ã€å‚æ•°å’Œè¿”å›å€¼
```

**ä»·å€¼**

- è‡ªåŠ¨åˆ†æ API å®šä¹‰
- ç”Ÿæˆæ ¼å¼ç»Ÿä¸€çš„æ–‡æ¡£
- ä¿æŒæ–‡æ¡£ä¸ä»£ç åŒæ­¥
- èŠ‚çœå¤§é‡æ—¶é—´

#### 6.1.4 æµ‹è¯•ç”Ÿæˆ

**åœºæ™¯æè¿°**

éœ€è¦ä¸ºç°æœ‰ä»£ç ç¼–å†™æµ‹è¯•ã€‚

**ä¼ ç»Ÿæ–¹å¼**

1. æ‰‹åŠ¨ç¼–å†™æµ‹è¯•ç”¨ä¾‹
2. è¦†ç›–å„ç§åœºæ™¯
3. ç»´æŠ¤æµ‹è¯•ä»£ç 

**ä½¿ç”¨ Yuangs AI Agent**

```
ç”¨æˆ·ï¼šä¸º src/services/auth.ts ç”Ÿæˆå®Œæ•´çš„å•å…ƒæµ‹è¯•

AIï¼š
[æ¨ç†] éœ€è¦è¯»å–æ–‡ä»¶äº†è§£åŠŸèƒ½
[è¡ŒåŠ¨] read_file: src/services/auth.ts

[è§‚å¯Ÿ] åŒ…å« 3 ä¸ªå‡½æ•°ï¼šloginã€logoutã€register

[æ¨ç†] ä¸ºæ¯ä¸ªå‡½æ•°ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯
[è¡ŒåŠ¨] write_file: src/services/auth.test.ts

[è¡ŒåŠ¨] shell_cmd: npm test -- auth.test.ts

[è§‚å¯Ÿ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

[å®Œæˆ] å·²ç”Ÿæˆ 12 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰å‡½æ•°çš„æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯
```

**ä»·å€¼**

- è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
- è¦†ç›–å¤šç§åœºæ™¯
- æé«˜æµ‹è¯•è¦†ç›–ç‡
- å‡å°‘é‡å¤åŠ³åŠ¨

#### 6.1.5 Git æäº¤ä¼˜åŒ–

**åœºæ™¯æè¿°**

Smart Stage æ™ºèƒ½åˆ†ç»„ Git æäº¤ã€‚

**åœºæ™¯æ¼”ç¤º**

```
ç”¨æˆ·ï¼šå‡†å¤‡æäº¤ä»£ç ï¼Œç‚¹å‡» "Smart Stage"

AIï¼š
[åˆ†æ] æ£€æµ‹åˆ° 8 ä¸ªæ–‡ä»¶å˜æ›´

[åˆ†ç»„]
- UI ç»„ä»¶ (4 ä¸ªæ–‡ä»¶): Button.tsx, Card.tsx, Input.tsx, styles.css
  ç½®ä¿¡åº¦: 0.92
  Commit å»ºè®®: feat: add new UI components
  
- æ–‡æ¡£ (2 ä¸ªæ–‡ä»¶): README.md, API.md
  ç½®ä¿¡åº¦: 0.88
  Commit å»ºè®®: docs: update project documentation
  
- é…ç½® (1 ä¸ªæ–‡ä»¶): package.json
  ç½®ä¿¡åº¦: 0.95
  Commit å»ºè®®: chore: update dependencies
  
- æµ‹è¯• (1 ä¸ªæ–‡ä»¶): button.test.ts
  ç½®ä¿¡åº¦: 0.90
  Commit å»ºè®®: test: add button component tests

[å»ºè®®] å»ºè®®åˆ† 4 æ¬¡ commitï¼Œä¿æŒæäº¤å†å²æ¸…æ™°

ç”¨æˆ·ï¼šåº”ç”¨å»ºè®®

AIï¼šå·²åˆ›å»º 4 ä¸ª commitï¼Œæäº¤å†å²æ¸…æ™°æœ‰åº
```

**ä»·å€¼**

- è‡ªåŠ¨åˆ†ç±»æ–‡ä»¶å˜æ›´
- ç”Ÿæˆæ¸…æ™°çš„ Commit æ¶ˆæ¯
- ä¿æŒæäº¤å†å²æ•´æ´
- æé«˜ä»£ç å¯è¿½æº¯æ€§

### 6.2 é‡åŒ–ä»·å€¼è¯„ä¼°

#### 6.2.1 æ•ˆç‡æå‡

| ä»»åŠ¡ç±»å‹ | ä¼ ç»Ÿæ–¹å¼è€—æ—¶ | ä½¿ç”¨ AI Agent è€—æ—¶ | æå‡å€æ•° |
|---------|------------|------------------|---------|
| ä»£ç é‡æ„ | 4-8 å°æ—¶ | 30-60 åˆ†é’Ÿ | 4-8x |
| Bug ä¿®å¤ | 2-4 å°æ—¶ | 10-30 åˆ†é’Ÿ | 4-8x |
| æ–‡æ¡£ç”Ÿæˆ | 8-16 å°æ—¶ | 30-60 åˆ†é’Ÿ | 8-16x |
| æµ‹è¯•ç”Ÿæˆ | 4-8 å°æ—¶ | 15-30 åˆ†é’Ÿ | 8-16x |
| Git æäº¤ | 15-30 åˆ†é’Ÿ | 2-5 åˆ†é’Ÿ | 3-6x |

**å¹³å‡æ•ˆç‡æå‡ï¼š5-10x**

#### 6.2.2 è´¨é‡æå‡

- **ä»£ç ä¸€è‡´æ€§**ï¼šAI ç”Ÿæˆçš„ä»£ç é£æ ¼ç»Ÿä¸€
- **æµ‹è¯•è¦†ç›–ç‡**ï¼šè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•æ›´å…¨é¢
- **æ–‡æ¡£å®Œæ•´æ€§**ï¼šè‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£æ›´å‡†ç¡®
- **æäº¤å†å²**ï¼šSmart Stage æäº¤å†å²æ›´æ¸…æ™°

#### 6.2.3 å®‰å…¨æ€§æå‡

- **å¤šå±‚å®‰å…¨æ‰«æ**ï¼šå‡å°‘å®‰å…¨æ¼æ´
- **æ™ºèƒ½æ²»ç†**ï¼šé¿å…å±é™©æ“ä½œ
- **å®¡è®¡è½¨è¿¹**ï¼šå®Œæ•´çš„æ“ä½œè®°å½•
- **å¯å›æ»š**ï¼šäº‹åŠ¡æ€§åº”ç”¨ï¼Œæ”¯æŒå›æ»š

---

## ç¬¬ä¸ƒç« ï¼šæœªæ¥å‘å±•è¶‹åŠ¿

### 7.1 çŸ­æœŸå‘å±•è®¡åˆ’ï¼ˆ3-6 ä¸ªæœˆï¼‰

#### 7.1.1 åŠŸèƒ½å®Œå–„

**å¢å¼ºè¯­ä¹‰å®¡æŸ¥**

- é›†æˆå®é™…çš„ AI Review é€»è¾‘
- æ·»åŠ æ›´å¤šçš„ä»£ç è´¨é‡æ£€æŸ¥æŒ‡æ ‡
- æ”¯æŒè‡ªå®šä¹‰è§„åˆ™é…ç½®

**æ”¹è¿› Diff åº”ç”¨**

- æ”¯æŒæ›´å¤æ‚çš„ Diff æ ¼å¼ï¼ˆå¦‚ git conflict markersï¼‰
- ä¼˜åŒ–æ¨¡ç³ŠåŒ¹é…ç®—æ³•
- æé«˜åº”ç”¨æˆåŠŸç‡åˆ° 98%+

**æ‰©å±•å·¥å…·é›†**

- æ·»åŠ æ›´å¤šå·¥å…·ï¼šgit æ“ä½œã€æ•°æ®åº“æ“ä½œã€ç½‘ç»œè¯·æ±‚
- æ”¯æŒè‡ªå®šä¹‰å·¥å…·æ³¨å†Œ
- å·¥å…·æ‰§è¡Œç»“æœç¼“å­˜

#### 7.1.2 æ€§èƒ½ä¼˜åŒ–

**ä¸Šä¸‹æ–‡ç®¡ç†ä¼˜åŒ–**

- å®ç°çœŸæ­£çš„å¼‚æ­¥æ‘˜è¦ç”Ÿæˆ
- æ·»åŠ  embedding å‘é‡ç´¢å¼•
- ä¼˜åŒ– ContextBank æŸ¥è¯¢æ€§èƒ½

**æ‰«ææ€§èƒ½ä¼˜åŒ–**

- å¹¶è¡ŒåŒ–å¤šæ–‡ä»¶æ‰«æ
- å¢é‡æ‰«æï¼Œåªæ‰«æå˜æ›´éƒ¨åˆ†
- ç¼“å­˜æ‰«æç»“æœ

#### 7.1.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**UI æ”¹è¿›**

- ä¼˜åŒ–ä¾§è¾¹æ å¸ƒå±€
- æ·»åŠ æ›´å¤šå¿«æ·é”®
- æ”¹è¿›åŠ è½½çŠ¶æ€æŒ‡ç¤º

**äº¤äº’ä¼˜åŒ–**

- æ™ºèƒ½æ–‡æœ¬é€‰æ‹©æ”¹è¿›
- Diff åº”ç”¨å¯è§†åŒ–
- æ›´æ¸…æ™°çš„æ“ä½œåé¦ˆ

### 7.2 ä¸­æœŸå‘å±•è®¡åˆ’ï¼ˆ6-12 ä¸ªæœˆï¼‰

#### 7.2.1 æ™ºèƒ½åŒ–å‡çº§

**æœºå™¨å­¦ä¹ é›†æˆ**

- ä½¿ç”¨æœºå™¨å­¦ä¹ ä¼˜åŒ–æ–‡ä»¶åˆ†ç±»
- é¢„æµ‹ç”¨æˆ·æ„å›¾ï¼Œæå‰åŠ è½½ç›¸å…³ä¸Šä¸‹æ–‡
- å­¦ä¹ ç”¨æˆ·åå¥½ï¼Œä¸ªæ€§åŒ–æ¨è

**æŠ€èƒ½ç³»ç»Ÿå®Œå–„**

- è‡ªåŠ¨æŠ€èƒ½å‘ç°å’Œåˆ›å»º
- æŠ€èƒ½ç»„åˆå’Œå¤ç”¨
- æŠ€èƒ½å¸‚åœºï¼ˆå…±äº«æŠ€èƒ½ï¼‰

**ä¸Šä¸‹æ–‡ç†è§£å¢å¼º**

- æ·±åº¦è¯­ä¹‰ç†è§£
- è·¨æ–‡ä»¶å…³ç³»åˆ†æ
- ä¸šåŠ¡é€»è¾‘è¯†åˆ«

#### 7.2.2 åä½œåŠŸèƒ½

**å›¢é˜Ÿåä½œ**

- å…±äº« Context Bank
- å›¢é˜ŸæŠ€èƒ½åº“
- åä½œå®¡æŸ¥

**çŸ¥è¯†å›¾è°±**

- è‡ªåŠ¨æ„å»ºé¡¹ç›®çŸ¥è¯†å›¾è°±
- ä»£ç å½±å“åˆ†æ
- æ™ºèƒ½å¯¼èˆª

#### 7.2.3 å¤šå¹³å°æ”¯æŒ

**è·¨ IDE æ”¯æŒ**

- JetBrains IDEs (IntelliJ, PyCharm, WebStorm)
- Vim/Neovim
- å…¶ä»–ç¼–è¾‘å™¨

**äº‘ç«¯æœåŠ¡**

- äº‘ç«¯ Agent æœåŠ¡
- è¿œç¨‹ä»£ç æ‰§è¡Œ
- åˆ†å¸ƒå¼ä¸Šä¸‹æ–‡ç®¡ç†

### 7.3 é•¿æœŸæ„¿æ™¯ï¼ˆ1-3 å¹´ï¼‰

#### 7.3.1 AI Agent ç”Ÿæ€

**Agent å¸‚åœº**

- ç¬¬ä¸‰æ–¹ Agent æ’ä»¶
- é¢†åŸŸä¸“ç”¨ Agent
- Agent ç»„åˆä¸ç¼–æ’

**å¼€æ”¾å¹³å°**

- Agent SDK
- æ‰©å±• API
- å¼€å‘è€…ç¤¾åŒº

#### 7.3.2 æ²»ç†å‹ AI æ¡†æ¶

**æ ‡å‡†åŒ–**

- æ²»ç†å‹ AI æ ‡å‡†è§„èŒƒ
- å®‰å…¨è®¤è¯ä½“ç³»
- æœ€ä½³å®è·µæŒ‡å—

**å¼€æºç¤¾åŒº**

- æ ¸å¿ƒæ¡†æ¶å¼€æº
- ç¤¾åŒºè´¡çŒ®è§„åˆ™
- æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ

#### 7.3.3 è‡ªä¸»è¿›åŒ–

**è‡ªé€‚åº”å­¦ä¹ **

- è‡ªåŠ¨ä¼˜åŒ–æ²»ç†ç­–ç•¥
- åŠ¨æ€è°ƒæ•´å®‰å…¨é˜ˆå€¼
- æŒç»­æ”¹è¿›ç”¨æˆ·ä½“éªŒ

**çŸ¥è¯†ç§¯ç´¯**

- é¡¹ç›®çŸ¥è¯†åº“è‡ªåŠ¨æ„å»º
- æœ€ä½³å®è·µæ²‰æ·€
- æ™ºèƒ½æ¨è

---

## ç¬¬å…«ç« ï¼šæŠ€æœ¯æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

### 8.1 ä¸Šä¸‹æ–‡ç®¡ç†æŒ‘æˆ˜

#### 8.1.1 æŒ‘æˆ˜æè¿°

**é—®é¢˜**

- å¦‚ä½•åœ¨æœ‰é™çš„ Token é™åˆ¶å†…æä¾›æœ€æœ‰ä»·å€¼çš„ä¸Šä¸‹æ–‡ï¼Ÿ
- å¦‚ä½•è¯„ä¼°ä¸Šä¸‹æ–‡çš„é‡è¦æ€§ï¼Ÿ
- å¦‚ä½•é¿å…ä¸Šä¸‹æ–‡è¿‡æœŸå’Œæ±¡æŸ“ï¼Ÿ

**å½±å“**

- Token é™åˆ¶å¯¼è‡´ä¸Šä¸‹æ–‡æˆªæ–­
- ä½ä»·å€¼ä¸Šä¸‹æ–‡å ç”¨å®è´µç©ºé—´
- è¿‡æ—¶çš„ä¸Šä¸‹æ–‡å½±å“ AI ç†è§£

#### 8.1.2 è§£å†³æ–¹æ¡ˆ

**åŠ¨æ€ Token ç®¡ç†**

```typescript
class ContextBuffer {
  private maxTokens: number = 16000;
  private items: ContextItem[] = [];
  
  async addAsync(item: Omit<ContextItem, 'tokens'>, bypassTokenLimit: boolean = false) {
    const newItem = {
      ...item,
      tokens: this.estimateTokens(item.content),
      importance: this.computeImportance(item)
    } as ContextItem;
    
    // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œè§¦å‘æ¸…ç†
    if (!bypassTokenLimit && (this.totalTokens() + newItem.tokens) > this.maxTokens) {
      await this.trimIfNeeded();
    }
    
    this.items.push(newItem);
  }
  
  private async trimIfNeeded() {
    // æŒ‰é‡è¦æ€§æ’åºï¼Œç§»é™¤ä½ä»·å€¼é¡¹
    const sorted = this.items.sort((a, b) => {
      const scoreA = this.computeItemScore(a);
      const scoreB = this.computeItemScore(b);
      return scoreB - scoreA;
    });
    
    let total = 0;
    const keep = [];
    
    for (const item of sorted) {
      if (total + item.tokens <= this.maxTokens) {
        total += item.tokens;
        keep.push(item);
      }
    }
    
    this.items = keep;
  }
  
  private computeItemScore(item: ContextItem): number {
    // ç»¼åˆå¤šä¸ªå› ç´ è®¡ç®—è¯„åˆ†
    let score = 0;
    
    // é‡è¦æ€§è¯„åˆ† (0-1)
    score += item.importance?.confidence || 0.5;
    
    // ä½¿ç”¨é¢‘ç‡ (æœ€è¿‘ä½¿ç”¨è¶Šå¤šï¼Œè¯„åˆ†è¶Šé«˜)
    score += Math.min(1, (item.importance?.useCount || 0) / 10) * 0.3;
    
    // æˆåŠŸç‡ (æˆåŠŸç‡è¶Šé«˜ï¼Œè¯„åˆ†è¶Šé«˜)
    const successRate = this.calculateSuccessRate(item);
    score += successRate * 0.2;
    
    // æ—¶é—´è¡°å‡ (æœ€è¿‘ä½¿ç”¨çš„è¯„åˆ†æ›´é«˜)
    const timeDecay = this.calculateTimeDecay(item);
    score *= timeDecay;
    
    return score;
  }
}
```

**é‡è¦æ€§è¯„ä¼°**

```typescript
export function computeContextImportance(
  path: string,
  type: 'file' | 'directory',
  content?: string
): ContextImportance {
  const importance: ContextImportance = {
    useCount: 0,
    successCount: 0,
    failureCount: 0,
    confidence: 0.5,  // åˆå§‹ç½®ä¿¡åº¦
    lastUsed: 0,
    createdAt: Date.now()
  };
  
  // åŸºäºè·¯å¾„æ¨¡å¼çš„é‡è¦æ€§
  if (path.includes('/core/') || path.includes('/lib/')) {
    importance.confidence += 0.2;  // æ ¸å¿ƒä»£ç æ›´é‡è¦
  }
  
  if (path.includes('/test/') || path.includes('/spec/')) {
    importance.confidence -= 0.1;  // æµ‹è¯•æ–‡ä»¶ç›¸å¯¹æ¬¡è¦
  }
  
  // åŸºäºå†…å®¹çš„é‡è¦æ€§
  if (content) {
    // æ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®å‡½æ•°
    if (content.includes('export function') || content.includes('export class')) {
      importance.confidence += 0.1;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é…ç½®æ–‡ä»¶
    if (path.endsWith('.json') || path.endsWith('.yaml')) {
      importance.confidence += 0.15;
    }
  }
  
  // é™åˆ¶åœ¨ 0-1 èŒƒå›´å†…
  importance.confidence = Math.max(0, Math.min(1, importance.confidence));
  
  return importance;
}
```

**è‡ªåŠ¨æ¸…ç†**

```typescript
class ContextBank {
  async cleanup(options: {
    maxAge?: number;  // æœ€å¤§ä¿ç•™å¤©æ•°
    minConfidence?: number;  // æœ€ä½ç½®ä¿¡åº¦
    minUseCount?: number;  // æœ€å°ä½¿ç”¨æ¬¡æ•°
  } = {}): Promise<void> {
    const now = Date.now();
    const maxAge = options.maxAge || 30 * 24 * 60 * 60 * 1000;  // 30 å¤©
    const minConfidence = options.minConfidence || 0.3;
    const minUseCount = options.minUseCount || 1;
    
    const items = await this.getAllItems();
    const toRemove = [];
    
    for (const item of items) {
      // æ£€æŸ¥å¹´é¾„
      if (now - item.importance.lastUsed > maxAge) {
        toRemove.push(item.id);
        continue;
      }
      
      // æ£€æŸ¥ç½®ä¿¡åº¦
      if (item.importance.confidence < minConfidence) {
        toRemove.push(item.id);
        continue;
      }
      
      // æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
      if (item.importance.useCount < minUseCount) {
        toRemove.push(item.id);
        continue;
      }
    }
    
    // åˆ é™¤ç¬¦åˆæ¡ä»¶çš„é¡¹
    for (const id of toRemove) {
      await this.removeItem(id);
    }
    
    console.log(`[ContextBank] Cleaned up ${toRemove.length} items`);
  }
}
```

#### 8.1.3 æ•ˆæœè¯„ä¼°

- **Token åˆ©ç”¨ç‡**ï¼šæé«˜åˆ° 85% ä»¥ä¸Š
- **ä¸Šä¸‹æ–‡å‘½ä¸­ç‡**ï¼šAI å¼•ç”¨çš„ä¸Šä¸‹æ–‡ 80% ä»¥ä¸Šæ˜¯æœ‰ä»·å€¼çš„
- **æ¸…ç†æ•ˆç‡**ï¼šè‡ªåŠ¨æ¸…ç†ä½ä»·å€¼ä¸Šä¸‹æ–‡ï¼Œä¿æŒé«˜æ€§èƒ½

### 8.2 å®‰å…¨ä¸éšç§æŒ‘æˆ˜

#### 8.2.1 æŒ‘æˆ˜æè¿°

**é—®é¢˜**

- å¦‚ä½•ç¡®ä¿ AI ä¸ä¼šæ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼Ÿ
- å¦‚ä½•é˜²æ­¢æ¶æ„ Diff æ”»å‡»ï¼Ÿ
- å¦‚ä½•ä¿æŠ¤ç”¨æˆ·éšç§ï¼Ÿ

**é£é™©**

- ä»£ç æ³„éœ²åˆ°ç¬¬ä¸‰æ–¹ AI æœåŠ¡
- æ¶æ„ Diff ç ´åæ–‡ä»¶ç³»ç»Ÿ
- æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keyã€å¯†ç ï¼‰è¢«å‘é€

#### 8.2.2 è§£å†³æ–¹æ¡ˆ

**æ•æ„Ÿä¿¡æ¯æ£€æµ‹**

```typescript
class SensitiveDataScanner {
  private patterns = [
    { pattern: /api[_-]?key\s*[:=]\s*['"]([^'"]+)['"]/i, type: 'api_key' },
    { pattern: /password\s*[:=]\s*['"]([^'"]+)['"]/i, type: 'password' },
    { pattern: /secret\s*[:=]\s*['"]([^'"]+)['"]/i, type: 'secret' },
    { pattern: /token\s*[:=]\s*['"]([^'"]+)['"]/i, type: 'token' }
  ];
  
  scan(code: string): SensitiveDataIssue[] {
    const issues: SensitiveDataIssue[] = [];
    
    for (const { pattern, type } of this.patterns) {
      let match;
      while ((match = pattern.exec(code)) !== null) {
        issues.push({
          type,
          line: this.findLineNumber(code, match.index),
          message: `Detected sensitive ${type}`,
          masked: this.maskSensitive(match[1])
        });
      }
    }
    
    return issues;
  }
  
  private maskSensitive(value: string): string {
    if (value.length <= 4) {
      return '****';
    }
    return value.substring(0, 2) + '****' + value.substring(value.length - 2);
  }
  
  private findLineNumber(code: string, index: number): number {
    const before = code.substring(0, index);
    return before.split('\n').length;
  }
}
```

**æœ¬åœ° AI æ¨¡å‹æ”¯æŒ**

```typescript
export class LocalModelProvider {
  static async isLocalModelSupported(model: string): Promise<boolean> {
    // æ£€æŸ¥æ˜¯å¦æ”¯æŒæœ¬åœ°è¿è¡Œ
    const supportedModels = ['llama', 'mistral', 'qwen'];
    return supportedModels.some(m => model.toLowerCase().includes(m));
  }
  
  static async runLocalModel(
    prompt: AgentPrompt,
    onChunk?: (chunk: string) => void
  ): Promise<string> {
    // ä½¿ç”¨ Ollama æˆ–å…¶ä»–æœ¬åœ°æ¨ç†å¼•æ“
    const response = await fetch('http://localhost:11434/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'llama2',
        prompt: prompt.system + '\n' + prompt.messages.map(m => `${m.role}: ${m.content}`).join('\n'),
        stream: !!onChunk
      })
    });
    
    if (onChunk) {
      // æµå¼å¤„ç†
      const reader = response.body?.getReader();
      let result = '';
      
      while (true) {
        const { done, value } = await reader!.read();
        if (done) break;
        
        const chunk = new TextDecoder().decode(value);
        const json = JSON.parse(chunk);
        onChunk(json.response);
        result += json.response;
      }
      
      return result;
    } else {
      const data = await response.json();
      return data.response;
    }
  }
}
```

**æ•°æ®åŠ å¯†ä¼ è¾“**

```typescript
export class EncryptedLLMClient {
  private encryptionKey: string;
  
  constructor(apiKey: string) {
    this.encryptionKey = this.deriveKey(apiKey);
  }
  
  private deriveKey(apiKey: string): string {
    // ä½¿ç”¨ HMAC-SHA256 æ´¾ç”Ÿå¯†é’¥
    const crypto = require('crypto');
    return crypto.createHmac('sha256', apiKey).digest('hex');
  }
  
  async sendRequest(request: any): Promise<any> {
    // åŠ å¯†æ•æ„Ÿæ•°æ®
    const encrypted = this.encryptRequest(request);
    
    // å‘é€åŠ å¯†è¯·æ±‚
    const response = await fetch('https://api.example.com/v1/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Encrypted': 'true'
      },
      body: JSON.stringify(encrypted)
    });
    
    // è§£å¯†å“åº”
    const data = await response.json();
    return this.decryptResponse(data);
  }
  
  private encryptRequest(request: any): any {
    // å®ç°åŠ å¯†é€»è¾‘
    return request;
  }
  
  private decryptResponse(response: any): any {
    // å®ç°è§£å¯†é€»è¾‘
    return response;
  }
}
```

#### 8.2.3 æ•ˆæœè¯„ä¼°

- **æ•æ„Ÿä¿¡æ¯æ£€æµ‹ç‡**ï¼š> 95%
- **æœ¬åœ°æ¨¡å‹æ”¯æŒ**ï¼šæ”¯æŒä¸»æµå¼€æºæ¨¡å‹
- **æ•°æ®åŠ å¯†**ï¼šæ‰€æœ‰ä¼ è¾“æ•°æ®åŠ å¯†

### 8.3 æ€§èƒ½æŒ‘æˆ˜

#### 8.3.1 æŒ‘æˆ˜æè¿°

**é—®é¢˜**

- å¦‚ä½•åœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹å®ç°é«˜æ€§èƒ½ï¼Ÿ
- å¦‚ä½•å¤„ç†å¤§è§„æ¨¡é¡¹ç›®çš„ä¸Šä¸‹æ–‡ï¼Ÿ
- å¦‚ä½•å‡å°‘ AI å“åº”å»¶è¿Ÿï¼Ÿ

**å½±å“**

- æ‰«æè€—æ—¶è¿‡é•¿å½±å“ç”¨æˆ·ä½“éªŒ
- å¤§é¡¹ç›®ä¸Šä¸‹æ–‡åŠ è½½ç¼“æ…¢
- AI å“åº”å»¶è¿Ÿé«˜

#### 8.3.2 è§£å†³æ–¹æ¡ˆ

**å¹¶è¡ŒåŒ–å¤„ç†**

```typescript
export class ParallelSecurityScanner {
  async scanFiles(files: string[], concurrency: number = 4): Promise<SecurityScanResult[]> {
    const results: SecurityScanResult[] = [];
    const chunks = this.chunkArray(files, concurrency);
    
    for (const chunk of chunks) {
      const promises = chunk.map(file => this.quickScanner.quickScan(file));
      const chunkResults = await Promise.all(promises);
      results.push(...chunkResults);
    }
    
    return results;
  }
  
  private chunkArray<T>(array: T[], size: number): T[][] {
    const chunks: T[][] = [];
    for (let i = 0; i < array.length; i += size) {
      chunks.push(array.slice(i, i + size));
    }
    return chunks;
  }
}
```

**å¢é‡æ‰«æ**

```typescript
export class IncrementalScanner {
  private scanCache: Map<string, ScanResult> = new Map();
  
  async scanIncremental(
    files: string[],
    changes: FileChange[]
  ): Promise<SecurityScanResult[]> {
    const results: SecurityScanResult[] = [];
    const filesToScan: string[] = [];
    
    for (const file of files) {
      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
      const change = changes.find(c => c.path === file);
      
      if (change) {
        // æ–‡ä»¶æœ‰å˜åŒ–ï¼Œéœ€è¦é‡æ–°æ‰«æ
        filesToScan.push(file);
      } else {
        // æ–‡ä»¶æ— å˜åŒ–ï¼Œä½¿ç”¨ç¼“å­˜ç»“æœ
        const cached = this.scanCache.get(file);
        if (cached) {
          results.push(cached);
        } else {
          filesToScan.push(file);
        }
      }
    }
    
    // æ‰«ææœ‰å˜åŒ–çš„æ–‡ä»¶
    const scanResults = await this.scanFiles(filesToScan);
    
    // æ›´æ–°ç¼“å­˜
    for (let i = 0; i < filesToScan.length; i++) {
      this.scanCache.set(filesToScan[i], scanResults[i]);
    }
    
    return [...results, ...scanResults];
  }
}
```

**ç¼“å­˜ä¼˜åŒ–**

```typescript
export class SmartCache {
  private cache: Map<string, CacheEntry> = new Map();
  private maxSize: number = 100;
  private ttl: number = 5 * 60 * 1000;  // 5 åˆ†é’Ÿ
  
  get(key: string): any | null {
    const entry = this.cache.get(key);
    
    if (!entry) {
      return null;
    }
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() - entry.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    // æ›´æ–°è®¿é—®æ—¶é—´
    entry.lastAccess = Date.now();
    return entry.value;
  }
  
  set(key: string, value: any): void {
    // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œåˆ é™¤æœ€æ—§çš„é¡¹
    if (this.cache.size >= this.maxSize) {
      let oldestKey = '';
      let oldestTime = Date.now();
      
      for (const [k, v] of this.cache.entries()) {
        if (v.lastAccess < oldestTime) {
          oldestTime = v.lastAccess;
          oldestKey = k;
        }
      }
      
      this.cache.delete(oldestKey);
    }
    
    this.cache.set(key, {
      value,
      timestamp: Date.now(),
      lastAccess: Date.now()
    });
  }
  
  clear(): void {
    this.cache.clear();
  }
}
```

#### 8.3.3 æ•ˆæœè¯„ä¼°

- **æ‰«æé€Ÿåº¦**ï¼šå¹¶è¡ŒåŒ–åæå‡ 3-4x
- **å¢é‡æ‰«æ**ï¼šä»…æ‰«æå˜åŒ–éƒ¨åˆ†ï¼ŒèŠ‚çœ 80% æ—¶é—´
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 70%ï¼Œå‡å°‘é‡å¤è®¡ç®—

---

## ç¬¬ä¹ç« ï¼šæ€»ç»“ä¸å»ºè®®

### 9.1 é¡¹ç›®ç»¼åˆè¯„ä¼°

#### 9.1.1 æŠ€æœ¯åˆ›æ–°æ€§

**åˆ›æ–°ç‚¹**

1. **æ²»ç†å‹ AI èŒƒå¼**ï¼šé¦–æ¬¡åœ¨å¼€å‘å·¥å…·ä¸­å®ç°å®Œæ•´çš„"æ€è€ƒ-æ²»ç†-æ‰§è¡Œ"é—­ç¯
2. **ä¸‰å±‚å®‰å…¨æ‰«æä½“ç³»**ï¼šAI ä»‹å…¥å‰ã€åº”ç”¨å‰ã€åº”ç”¨åçš„å…¨æ–¹ä½é˜²æŠ¤
3. **WebAssembly ç‰©ç†æ²™ç®±**ï¼šçœŸæ­£çš„ç‰©ç†éš”ç¦»æ‰§è¡Œ
4. **æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šContext Bank + DSL æŸ¥è¯¢ + é‡è¦æ€§è¯„ä¼°
5. **Diff åˆ†çº§åŒ¹é…**ï¼šç²¾ç¡® â†’ æ¨¡ç³Š â†’ ç›¸ä¼¼åº¦ï¼Œé«˜æˆåŠŸç‡åº”ç”¨
6. **Smart Stage**ï¼šæ²»ç†å‹ AI çš„å…¸èŒƒï¼Œå¤šä¿¡å·æŠ•ç¥¨ + ç½®ä¿¡åº¦é©±åŠ¨

**æŠ€æœ¯é¢†å…ˆæ€§**

- åœ¨ VS Code æ‰©å±•é¢†åŸŸå¤„äºé¢†å…ˆåœ°ä½
- æ²»ç†å‹ AI ç†å¿µçš„å‰æ²¿å®è·µ
- å®‰å…¨æ€§ä¸æ˜“ç”¨æ€§çš„å®Œç¾å¹³è¡¡

#### 9.1.2 æ¶æ„è´¨é‡

**ä¼˜åŠ¿**

1. **åˆ†å±‚æ¸…æ™°**ï¼šVS Code å±‚ã€è¿è¡Œæ—¶å±‚ã€å¼•æ“å±‚ã€æ ¸å¿ƒå±‚ã€æ²»ç†å±‚
2. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„æ¨¡å—èŒè´£æ˜ç¡®ï¼Œè€¦åˆåº¦ä½
3. **å¯æ‰©å±•æ€§å¼º**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œå·¥å…·
4. **å¯æµ‹è¯•æ€§å¥½**ï¼šæ¯å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•
5. **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†çš„æ³¨é‡Šå’Œæ–‡æ¡£

**å¯æ”¹è¿›**

1. éƒ¨åˆ†æ¨¡å—çš„ä¾èµ–å…³ç³»å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–
2. é”™è¯¯å¤„ç†å¯ä»¥æ›´åŠ ç»Ÿä¸€å’Œå‹å¥½
3. æ—¥å¿—ç³»ç»Ÿå¯ä»¥æ›´åŠ å®Œå–„

#### 9.1.3 å®ç”¨æ€§

**ç”¨æˆ·ä½“éªŒ**

- ç°ä»£åŒ–çš„ UI è®¾è®¡ï¼ˆç»ç’ƒæ‹Ÿæ€ï¼‰
- æ™ºèƒ½äº¤äº’ï¼ˆæ™ºèƒ½æ–‡æœ¬é€‰æ‹©ã€Diff åº”ç”¨ï¼‰
- å®æ—¶åé¦ˆï¼ˆè¯Šæ–­ä¿¡æ¯ã€æ‰«æç»“æœï¼‰
- ä½å­¦ä¹ æˆæœ¬

**å®é™…ä»·å€¼**

- å¼€å‘æ•ˆç‡æå‡ 5-10x
- ä»£ç è´¨é‡æå‡
- å®‰å…¨æ€§ä¿éšœ
- å›¢é˜Ÿåä½œä¼˜åŒ–

#### 9.1.4 å®‰å…¨æ€§

**å®‰å…¨ç‰¹æ€§**

1. å¤šå±‚å®‰å…¨é˜²å¾¡
2. WASM ç‰©ç†éš”ç¦»
3. ç­–ç•¥çƒ­åŠ è½½
4. äººç±»ä»‹å…¥æœºåˆ¶
5. å®¡è®¡è½¨è¿¹

**å®‰å…¨è¯„çº§**

- é™æ€å®‰å…¨ï¼šAçº§
- åŠ¨æ€å®‰å…¨ï¼šAçº§
- æ•°æ®å®‰å…¨ï¼šA-çº§ï¼ˆå¯è¿›ä¸€æ­¥åŠ å¼ºåŠ å¯†ï¼‰

### 9.2 å¯¹å¼€å‘è€…çš„å»ºè®®

#### 9.2.1 å…¥é—¨å»ºè®®

**1. ä»åŸºç¡€åŠŸèƒ½å¼€å§‹**

å…ˆç†Ÿæ‚‰æ ¸å¿ƒåŠŸèƒ½ï¼š
- AI èŠå¤©å¯¹è¯
- ä»£ç è§£é‡Šå’Œä¼˜åŒ–
- æ–‡ä»¶è¯»å†™æ“ä½œ

**2. ç†è§£æ²»ç†æœºåˆ¶**

å­¦ä¹  policy.yaml é…ç½®ï¼š
- è‡ªå®šä¹‰ç­–ç•¥è§„åˆ™
- ç†è§£ä¸åŒæ•ˆæœï¼ˆallow/deny/warnï¼‰
- è°ƒæ•´é£é™©é˜ˆå€¼

**3. æŒæ¡ä¸Šä¸‹æ–‡ç®¡ç†**

å­¦ä¹  DSL æŸ¥è¯¢ï¼š
- `@file` å¼•ç”¨æ–‡ä»¶
- `#symbol` å¼•ç”¨ç¬¦å·
- ç»„åˆæŸ¥è¯¢è¯­æ³•

**4. åˆ©ç”¨ Smart Stage**

ä½“éªŒæ™ºèƒ½ Git æäº¤ï¼š
- è‡ªåŠ¨åˆ†ç»„
- æŸ¥çœ‹ AI çš„å†³ç­–è§£é‡Š
- æä¾›åé¦ˆä¼˜åŒ–

#### 9.2.2 è¿›é˜¶å»ºè®®

**1. è‡ªå®šä¹‰å·¥å…·**

å¼€å‘è‡ªå®šä¹‰å·¥å…·ï¼š
```typescript
// æ³¨å†Œè‡ªå®šä¹‰å·¥å…·
export async function registerCustomTool(name: string, handler: ToolHandler) {
  ToolExecutor.registerTool(name, handler);
}

// ç¤ºä¾‹ï¼šæ•°æ®åº“æŸ¥è¯¢å·¥å…·
registerCustomTool('query_db', async (params) => {
  const result = await db.query(params.sql);
  return { success: true, output: JSON.stringify(result) };
});
```

**2. æ‰©å±•å®‰å…¨è§„åˆ™**

è‡ªå®šä¹‰å®‰å…¨æ‰«æè§„åˆ™ï¼š
```typescript
const customRule: SecurityRule = {
  id: 'no-console-log',
  pattern: /console\.log\(/,
  severity: SecuritySeverity.WARNING,
  message: 'Remove console.log statements before committing'
};

quickScanner.addRule(customRule);
```

**3. å¼€å‘æŠ€èƒ½**

å°†å¸¸ç”¨æ“ä½œå°è£…ä¸ºæŠ€èƒ½ï¼š
```typescript
const createComponentSkill: Skill = {
  name: 'create-react-component',
  description: 'Create a new React component with TypeScript',
  parameters: {
    name: 'string',
    path: 'string'
  },
  handler: async (params) => {
    // ç”Ÿæˆç»„ä»¶ä»£ç 
    const code = generateComponentCode(params.name);
    
    // å†™å…¥æ–‡ä»¶
    await VSCodeExecutor.writeFile(
      `${params.path}/${params.name}.tsx`,
      code
    );
    
    return { success: true, output: 'Component created' };
  }
};

addSkill(createComponentSkill);
```

#### 9.2.3 æœ€ä½³å®è·µ

**1. ä¸Šä¸‹æ–‡ç®¡ç†**

- åªæ·»åŠ å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼Œé¿å… Token æµªè´¹
- ä½¿ç”¨ DSL æŸ¥è¯¢ç²¾ç¡®è·å–ç›¸å…³æ–‡ä»¶
- å®šæœŸæ¸…ç†ä½ä»·å€¼ä¸Šä¸‹æ–‡

**2. å®‰å…¨é…ç½®**

- æ ¹æ®é¡¹ç›®éœ€æ±‚è°ƒæ•´ç­–ç•¥è§„åˆ™
- å¯ç”¨æ‰€æœ‰å®‰å…¨æ‰«æå±‚
- å®šæœŸå®¡è®¡æ“ä½œæ—¥å¿—

**3. å›¢é˜Ÿåä½œ**

- å…±äº« Context Bankï¼ˆå›¢é˜Ÿæ¨¡å¼ï¼‰
- å»ºç«‹ç»Ÿä¸€çš„ç­–ç•¥è§„åˆ™
- äº¤æµæœ€ä½³å®è·µ

### 9.3 å¯¹é¡¹ç›®çš„å»ºè®®

#### 9.3.1 çŸ­æœŸæ”¹è¿›

**1. å®Œå–„æ–‡æ¡£**

- æ·»åŠ æ›´å¤šä½¿ç”¨ç¤ºä¾‹
- ç¼–å†™æ•…éšœæ’æŸ¥æŒ‡å—
- åˆ›å»ºè§†é¢‘æ•™ç¨‹

**2. æ”¹è¿›é”™è¯¯å¤„ç†**

- ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ ¼å¼
- æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- å¢åŠ é”™è¯¯æ¢å¤å»ºè®®

**3. ä¼˜åŒ–æ€§èƒ½**

- å®ç°å¢é‡æ‰«æ
- æ·»åŠ ç¼“å­˜æœºåˆ¶
- å¹¶è¡ŒåŒ–å¤„ç†

#### 9.3.2 ä¸­æœŸè§„åˆ’

**1. æ‰©å±•åŠŸèƒ½**

- æ”¯æŒæ›´å¤šç¼–ç¨‹è¯­è¨€
- æ·»åŠ æ›´å¤šå·¥å…·
- é›†æˆæ›´å¤š AI æ¨¡å‹

**2. å¹³å°æ”¯æŒ**

- æ”¯æŒ JetBrains IDEs
- æ”¯æŒ Vim/Neovim
- å¼€å‘äº‘ç«¯æœåŠ¡

**3. ç”Ÿæ€å»ºè®¾**

- å¼€æ”¾æ’ä»¶ API
- å»ºç«‹æ’ä»¶å¸‚åœº
- åŸ¹å…»å¼€å‘è€…ç¤¾åŒº

#### 9.3.3 é•¿æœŸæ„¿æ™¯

**1. æ²»ç†å‹ AI æ ‡å‡†**

- åˆ¶å®šè¡Œä¸šæ ‡å‡†
- æ¨å¹¿æ²»ç†å‹ AI ç†å¿µ
- å»ºç«‹è®¤è¯ä½“ç³»

**2. å¼€æºç”Ÿæ€**

- æ ¸å¿ƒæ¡†æ¶å¼€æº
- ç¤¾åŒºå…±å»º
- æŒç»­åˆ›æ–°

**3. æ™ºèƒ½è¿›åŒ–**

- è‡ªé€‚åº”å­¦ä¹ 
- çŸ¥è¯†ç§¯ç´¯
- è‡ªä¸»ä¼˜åŒ–

### 9.4 ç»“è®º

Yuangs AI Agent æ˜¯ä¸€æ¬¾æŠ€æœ¯å…ˆè¿›ã€è®¾è®¡ä¼˜ç§€ã€å®ç”¨æ€§å¼ºçš„ VS Code æ‰©å±•ã€‚å®ƒä¸ä»…æä¾›äº†å¼ºå¤§çš„ AI è¾…åŠ©å¼€å‘èƒ½åŠ›ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„æ²»ç†ä½“ç³»ï¼Œç¡®ä¿äº† AI çš„å®‰å…¨æ€§å’Œå¯æ§æ€§ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**

1. **æ²»ç†å‹ AI èŒƒå¼**ï¼šAI åœ¨äººç±»å®šä¹‰çš„è§„åˆ™èŒƒå›´å†…å·¥ä½œ
2. **å¤šå±‚å®‰å…¨é˜²æŠ¤**ï¼šä» Schema åˆ°åº”ç”¨å±‚çš„å…¨æ–¹ä½ä¿æŠ¤
3. **æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šé«˜æ•ˆçš„ä¸Šä¸‹æ–‡æ£€ç´¢å’Œåˆ©ç”¨
4. **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ**ï¼šç°ä»£åŒ–çš„ UI å’Œæ™ºèƒ½äº¤äº’
5. **é«˜åº¦å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•

**æœªæ¥å±•æœ›**

éšç€é¡¹ç›®çš„ä¸æ–­å‘å±•ï¼ŒYuangs AI Agent æœ‰æœ›æˆä¸ºï¼š

- **æ²»ç†å‹ AI çš„æ ‡æ†**ï¼šå®šä¹‰è¡Œä¸šæ ‡å‡†
- **å¼€å‘è€…çš„å¾—åŠ›åŠ©æ‰‹**ï¼šå¤§å¹…æå‡å¼€å‘æ•ˆç‡
- **AI å·¥ç¨‹çš„å…¸èŒƒ**ï¼šå±•ç¤ºå¦‚ä½•æ„å»ºå®‰å…¨ã€å¯æ§çš„ AI ç³»ç»Ÿ
- **å¼€æºç”Ÿæ€çš„æ ¸å¿ƒ**ï¼šæ¨åŠ¨æ•´ä¸ªè¡Œä¸šçš„å‘å±•

**æœ€ç»ˆè¯„ä»·**

Yuangs AI Agent ä»£è¡¨äº† AI å·¥å…·å‘å±•çš„æ­£ç¡®æ–¹å‘ï¼š**æ™ºèƒ½è€Œéè‡ªæ²»ï¼Œå®‰å…¨è€Œéå°é—­ï¼Œå¯è§£é‡Šè€Œéé»‘ç®±**ã€‚å®ƒè¯æ˜äº† AI å¯ä»¥åœ¨ä¿æŒå¼ºå¤§èƒ½åŠ›çš„åŒæ—¶ï¼Œä¸¥æ ¼éµå®ˆäººç±»è®¾å®šçš„è¾¹ç•Œå’Œè§„åˆ™ã€‚è¿™ä¸ä»…æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„å·¥å…·ï¼Œæ›´æ˜¯ä¸€ç§æ–°çš„ AI å·¥ç¨‹èŒƒå¼çš„å®è·µã€‚

---

## é™„å½•ï¼šæœ¯è¯­è¡¨

| æœ¯è¯­ | è§£é‡Š |
|-----|------|
| Governed AI | æ²»ç†å‹ AIï¼Œåœ¨äººç±»å®šä¹‰çš„è§„åˆ™èŒƒå›´å†…å·¥ä½œçš„ AI |
| REACT æ¨¡å¼ | Reasoning + Actingï¼Œä¸€ç§ Agent å®ç°æ¨¡å¼ |
| Context Bank | ä¸Šä¸‹æ–‡é“¶è¡Œï¼ŒæŒä¹…åŒ–å­˜å‚¨é«˜ä»·å€¼ä¸Šä¸‹æ–‡ |
| DSL | Domain Specific Languageï¼Œé¢†åŸŸç‰¹å®šè¯­è¨€ |
| WASM | WebAssemblyï¼Œä¸€ç§å¯åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„äºŒè¿›åˆ¶æŒ‡ä»¤æ ¼å¼ |
| Observation | è§‚å¯Ÿç»“æœï¼Œç³»ç»Ÿåé¦ˆç»™ AI çš„ä¿¡æ¯ |
| Smart Stage | æ™ºèƒ½ Stage å»ºè®®ï¼Œè‡ªåŠ¨åˆ†ç»„ Git æäº¤ |
| Diff | Differenceï¼Œä»£ç å·®å¼‚ |
| Hunk | Diff ä¸­çš„ä¸€ä¸ªå˜æ›´å— |
| Graded Applier | åˆ†çº§åº”ç”¨å™¨ï¼Œä½¿ç”¨å¤šçº§åŒ¹é…ç­–ç•¥åº”ç”¨ Diff |
| Skill | æŠ€èƒ½ï¼Œå°è£…å¥½çš„å¯å¤ç”¨æ“ä½œåºåˆ— |
| Policy Rule | ç­–ç•¥è§„åˆ™ï¼Œå®šä¹‰ AI å…è®¸æˆ–ç¦æ­¢çš„æ“ä½œ |
| Risk Ledger | é£é™©è´¦æœ¬ï¼Œè®°å½•æ“ä½œé£é™©å’Œå†å² |
| Sandbox | æ²™ç®±ï¼Œéš”ç¦»æ‰§è¡Œç¯å¢ƒ |

---

## å‚è€ƒæ–‡çŒ®

1. GOVERNED_AI_WHITEPAPER.md - æ²»ç†å‹ AI ç™½çš®ä¹¦
2. IMPLEMENTATION_SUMMARY.md - å®ç°æ€»ç»“
3. docs/FEATURES_INTEGRATION_GUIDE.md - åŠŸèƒ½é›†æˆæŒ‡å—
4. src/engine/agent/AgentRuntime.ts - Agent è¿è¡Œæ—¶æºç 
5. src/engine/agent/ContextManager.ts - ä¸Šä¸‹æ–‡ç®¡ç†å™¨æºç 
6. src/engine/agent/GovernanceService.ts - æ²»ç†æœåŠ¡æºç 
7. src/engine/agent/LLMAdapter.ts - LLM é€‚é…å™¨æºç 
8. src/core/SecurityScanCoordinator.ts - å®‰å…¨æ‰«æåè°ƒå™¨æºç 

---

**æŠ¥å‘Šç‰ˆæœ¬**ï¼šv1.0  
**è¯„ä¼°æ—¥æœŸ**ï¼š2026å¹´2æœˆ2æ—¥  
**è¯„ä¼°äºº**ï¼šAI åŠ©æ‰‹  
**å­—æ•°ç»Ÿè®¡**ï¼šçº¦ 12,000 å­—