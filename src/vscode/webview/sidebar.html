<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuangs Premium AI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bubble-user: var(--vscode-button-background);
            --bubble-ai: var(--vscode-editor-background);
            --text-main: var(--vscode-foreground);
            --accent: var(--vscode-focusBorder);
            --border: var(--vscode-panel-border);
            --input-bg: var(--vscode-input-background);
        }

        body {
            font-family: var(--vscode-font-family), "Inter", -apple-system, sans-serif;
            font-size: var(--vscode-font-size);
            color: var(--text-main);
            background: var(--vscode-sideBar-background);
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨è£…é¥°çº¿ä¸æ ‡é¢˜æ  */
        header {
            height: 40px;
            width: 100%;
            background: var(--vscode-sideBar-background);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            box-sizing: border-box;
            z-index: 100;
        }

        header::before {
            content: "";
            height: 2px;
            width: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            position: absolute;
            top: 0;
            left: 0;
        }

        .header-title {
            font-size: 0.9em;
            font-weight: bold;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 2000;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 4px;
        }

        .icon-btn:hover {
            opacity: 1;
            background: var(--vscode-toolbar-hoverBackground);
        }

        .icon-btn.context-btn {
            opacity: 1 !important;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: 1px solid var(--vscode-focusBorder);
            z-index: 2000;
            padding: 6px 12px;
        }

        .icon-btn.context-btn:hover {
            opacity: 1;
            background: var(--vscode-button-hoverBackground);
        }

        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background: var(--vscode-scrollbarSlider-background);
            border-radius: 10px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
            background: var(--bubble-user);
            color: var(--vscode-button-foreground);
            border-bottom-right-radius: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ai-message {
            align-self: flex-start;
            background: var(--bubble-ai);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
            backdrop-filter: blur(10px);
        }

        /* Markdown æ ·å¼ */
        .ai-message pre {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            position: relative;
        }

        /* Diff ä»£ç å—æ ·å¼ */
        .ai-message pre.diff-block {
            border: 1px solid var(--vscode-editorWidget-border);
            background: rgba(0, 0, 0, 0.3);
        }

        .ai-message pre.diff-block::before {
            content: "ğŸ“ Diff";
            position: absolute;
            top: 4px;
            left: 8px;
            font-size: 0.75em;
            opacity: 0.6;
            font-family: var(--vscode-font-family);
        }

        /* åº”ç”¨æŒ‰é’® */
        .apply-diff-btn {
            position: absolute;
            top: 4px;
            right: 8px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            font-family: var(--vscode-font-family);
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 10;
        }

        .ai-message pre.diff-block:hover .apply-diff-btn {
            opacity: 1;
        }

        .apply-diff-btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .apply-diff-btn:active {
            transform: scale(0.95);
        }

        .apply-diff-btn.applied {
            background: var(--vscode-testing-iconPassed);
            opacity: 1;
        }

        .apply-diff-btn.error {
            background: var(--vscode-testing-iconFailed);
            opacity: 1;
        }

        .ai-message code {
            font-family: var(--vscode-editor-font-family);
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }

        .system-message {
            align-self: center;
            font-size: 0.85em;
            color: var(--vscode-descriptionForeground);
            background: transparent;
            box-shadow: none;
            text-align: center;
            opacity: 0.7;
        }

        #input-area {
            padding: 16px;
            background: var(--vscode-sideBar-background);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .input-wrapper {
            display: flex;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 8px;
            align-items: center;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
        }

        #user-input {
            flex-grow: 1;
            background: transparent;
            color: var(--vscode-input-foreground);
            border: none;
            padding: 8px;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            font-family: inherit;
        }

        #send-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        #send-btn:hover {
            opacity: 0.9;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: #aaa;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        /* å»ºè®®åˆ—è¡¨æ ·å¼ */
        #suggestions-list {
            position: absolute;
            bottom: 100%;
            left: 16px;
            right: 16px;
            background: var(--vscode-editor-background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--vscode-list-hoverBackground);
            color: var(--vscode-list-hoverForeground);
        }

        .suggestion-icon {
            opacity: 0.7;
            font-size: 1.1em;
        }

        /* æµå¼ä¼ è¾“æœŸé—´çš„è‰ç¨¿æ€æ ·å¼ */
        .streaming-draft {
            font-family: 'Courier New', Consolas, Monaco, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .streaming-content {
            margin: 0;
            padding: 0;
            font-family: inherit;
            line-height: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .final-render {
            /* æœ€ç»ˆæ¸²æŸ“å®Œæˆåçš„æ ·å¼ */
        }

        /* å…‰æ ‡é—ªçƒæ•ˆæœ */
        .cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: var(--text-main);
            margin-left: 4px;
            animation: blink 1s step-start infinite;
            vertical-align: middle;
            opacity: 0.8;
            border-radius: 1px;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* ä¸Šä¸‹æ–‡é¢æ¿æ ·å¼ */
        #context-panel {
            position: fixed;
            top: 40px;
            right: -400px;
            width: 380px;
            height: calc(100vh - 40px);
            background: var(--vscode-sideBar-background);
            border-left: 1px solid var(--border);
            border-top: 1px solid var(--border);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
        }

        #context-panel.open {
            right: 0;
        }

        .context-panel-header {
            padding: 12px 16px;
            background: var(--vscode-editor-background);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .context-panel-title {
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-panel-stats {
            font-size: 0.75em;
            opacity: 0.7;
        }

        .context-panel-close {
            background: transparent;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            padding: 4px;
            opacity: 0.6;
        }

        .context-panel-close:hover {
            opacity: 1;
        }

        .context-panel-controls {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .context-search {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--vscode-input-foreground);
            font-size: 0.85em;
            outline: none;
        }

        .context-search:focus {
            border-color: var(--accent);
        }

        .context-filter-btn {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text-main);
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s;
        }

        .context-filter-btn:hover,
        .context-filter-btn.active {
            background: var(--accent);
            color: var(--vscode-button-foreground);
            border-color: var(--accent);
        }

        .context-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .context-item {
            background: var(--vscode-editor-background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .context-item:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .context-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .context-item-icon {
            font-size: 1.2em;
        }

        .context-item-title {
            flex: 1;
            font-weight: 500;
            font-size: 0.85em;
            word-break: break-all;
        }

        .context-item-badges {
            display: flex;
            gap: 4px;
        }

        .context-badge {
            background: rgba(127, 127, 127, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7em;
            opacity: 0.8;
        }

        .context-badge.source_code {
            background: rgba(86, 156, 214, 0.2);
        }

        .context-badge.log {
            background: rgba(152, 195, 121, 0.2);
        }

        .context-badge.git {
            background: rgba(229, 192, 123, 0.2);
        }

        .context-badge.diagnostics {
            background: rgba(224, 108, 117, 0.2);
        }

        .context-item-stats {
            display: flex;
            gap: 12px;
            font-size: 0.75em;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .context-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .context-usage-bar {
            height: 3px;
            background: rgba(127, 127, 127, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .context-usage-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--vscode-focusBorder), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .context-item-preview {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            padding: 8px;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.8em;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .context-empty {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.5;
            font-size: 0.9em;
        }

    </style>
</head>

<body>
    <header>
        <div class="header-title">YUANGS AI</div>
        <div class="header-actions">
            <button class="icon-btn context-btn" id="context-toggle" title="Show Context Panel" style="z-index: 2000;">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path
                        d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z" />
                </svg>
                <span style="margin-left: 4px; font-size: 0.8em;">Context</span>
            </button>
            <button class="icon-btn" id="export-btn" title="Export Chat History (.md)">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path
                        d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM13 5H9V1h4v4zM3 2v12h10V6H8V2H3z" />
                </svg>
            </button>
            <button class="icon-btn" id="clear-btn" title="Clear Chat">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M10 3h3v1h-1v9l-1 1H4l-1-1V4H2V3h3V2a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v1zM9 2H6v1h3V2zM4 4v9h7V4H4z" />
                </svg>
            </button>
        </div>
    </header>

    <div id="chat-container">
        <div class="message system-message">âœ¨ Yuangs AI Agent initialized and ready.</div>
    </div>

    <div id="input-area">
        <div id="suggestions-list"></div>
        <div class="input-wrapper">
            <textarea id="user-input" rows="1" placeholder="Type your message..."></textarea>
            <button id="send-btn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path
                        d="M1.146 1.146a.5.5 0 0 1 .538-.093l13 5a.5.5 0 0 1 0 .94l-13 5a.5.5 0 0 1-.667-.615L2.854 8 1.017 2.618a.5.5 0 0 1 .129-.472zM3.854 8l-1.5 4.34L13.84 8 2.354 3.66 3.854 8z" />
                </svg>
            </button>
        </div>
    </div>


    <!-- ä¸Šä¸‹æ–‡é¢æ¿ -->
    <div id="context-panel">
        <div class="context-panel-header">
            <div class="context-panel-title">
                <span>ğŸ“‹ Context</span>
                <span class="context-panel-stats" id="context-stats">0 items</span>
            </div>
            <button class="context-panel-close" id="context-close">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path
                        d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                </svg>
            </button>
        </div>
        <div class="context-panel-controls">
            <input type="text" class="context-search" id="context-search" placeholder="Search context...">
            <button class="context-filter-btn active" data-filter="all">All</button>
            <button class="context-filter-btn" data-filter="source_code">Code</button>
            <button class="context-filter-btn" data-filter="log">Log</button>
            <button class="context-filter-btn" data-filter="git">Git</button>
        </div>
        <div class="context-panel-content" id="context-panel-content">
            <div class="context-empty">No context available</div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const exportBtn = document.getElementById('export-btn');
        const clearBtn = document.getElementById('clear-btn');
        const suggestionsList = document.getElementById('suggestions-list');
        
        // ä¸Šä¸‹æ–‡é¢æ¿ç›¸å…³å…ƒç´ 
        const contextPanel = document.getElementById('context-panel');
        const contextToggle = document.getElementById('context-toggle');
        const contextClose = document.getElementById('context-close');
        const contextPanelContent = document.getElementById('context-panel-content');
        const contextSearch = document.getElementById('context-search');
        const contextStats = document.getElementById('context-stats');
        const contextFilterBtns = document.querySelectorAll('.context-filter-btn');

        let currentAiMessageElement = null;
        let currentAiRawText = "";
        let suggestionType = null; // '@' or '#'
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];
        
        // ä¸Šä¸‹æ–‡ç›¸å…³çŠ¶æ€
        let currentContextItems = [];
        let currentFilter = 'all';
        let currentSearchQuery = '';

        // è¾“å…¥æ¡†é«˜åº¦è‡ªåŠ¨ä¼¸ç¼©
        userInput.addEventListener('input', (e) => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';

            handleTriggerDetection(e);
        });

        function handleTriggerDetection(e) {
            const value = userInput.value;
            const cursorPos = userInput.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);

            // æ£€æµ‹è§¦å‘ç¬¦
            const lastAt = textBeforeCursor.lastIndexOf('@');
            const lastHash = textBeforeCursor.lastIndexOf('#');
            const lastTriggerIndex = Math.max(lastAt, lastHash);

            if (lastTriggerIndex !== -1 && (lastTriggerIndex === 0 || /\s/.test(textBeforeCursor[lastTriggerIndex - 1]))) {
                const trigger = textBeforeCursor[lastTriggerIndex];
                const query = textBeforeCursor.substring(lastTriggerIndex + 1);

                if (!/\s/.test(query)) {
                    suggestionType = trigger;

                    // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    suggestionsList.innerHTML = '<div class="suggestion-item">ğŸ” Loading...</div>';
                    suggestionsList.style.display = 'block';

                    if (trigger === '@') {
                        vscode.postMessage({ type: 'getFiles', query });
                    } else {
                        vscode.postMessage({ type: 'getSymbols', query });
                    }
                    return;
                }
            }

            hideSuggestions();
        }

        function showSuggestions(suggestions, trigger) {
            currentSuggestions = suggestions;
            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }

            suggestionsList.innerHTML = '';
            suggestionsList.style.display = 'block';
            selectedSuggestionIndex = 0;

            suggestions.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'suggestion-item' + (index === 0 ? ' selected' : '');
                const icon = trigger === '@' ? 'ğŸ“„' : 'ğŸ”§';
                div.innerHTML = `<span class="suggestion-icon">${icon}</span><span>${item}</span>`;
                div.onclick = () => selectSuggestion(item);
                suggestionsList.appendChild(div);
            });
        }

        function hideSuggestions() {
            suggestionsList.style.display = 'none';
            suggestionType = null;
            selectedSuggestionIndex = -1;
        }

        function selectSuggestion(value) {
            const text = userInput.value;
            const cursorPos = userInput.selectionStart;
            const textBeforeCursor = text.substring(0, cursorPos);
            const textAfterCursor = text.substring(cursorPos);

            const lastTriggerIndex = textBeforeCursor.lastIndexOf(suggestionType);
            const newText = textBeforeCursor.substring(0, lastTriggerIndex) + suggestionType + value + ' ' + textAfterCursor;

            userInput.value = newText;
            hideSuggestions();
            userInput.focus();

            // é‡æ–°è®¡ç®—é«˜åº¦
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        }

        function addMessage(text, role, isRaw = false) {
            const div = document.createElement('div');
            div.className = `message ${role}-message`;

            if (role === 'ai') {
                div.innerHTML = marked.parse(text);
                // å¤„ç† diff ä»£ç å—
                processDiffBlocks(div);
            } else {
                div.textContent = text;
            }

            chatContainer.appendChild(div);
            scrollToBottom();
            return div;
        }

        // æ£€æµ‹å¹¶å¤„ç† diff ä»£ç å—
        function processDiffBlocks(messageElement) {
            const codeBlocks = messageElement.querySelectorAll('pre code');

            codeBlocks.forEach((codeBlock, index) => {
                const content = codeBlock.textContent;
                const preElement = codeBlock.parentElement;

                // æ£€æµ‹æ˜¯å¦æ˜¯ diff æ ¼å¼
                if (isDiffContent(content)) {
                    preElement.classList.add('diff-block');

                    // æ·»åŠ åº”ç”¨æŒ‰é’®
                    const applyBtn = document.createElement('button');
                    applyBtn.className = 'apply-diff-btn';
                    applyBtn.innerHTML = 'âœ“ Apply';
                    applyBtn.title = 'Apply this diff to your code';

                    // å­˜å‚¨ diff å†…å®¹
                    applyBtn.dataset.diffContent = content;
                    applyBtn.dataset.diffIndex = index;

                    applyBtn.onclick = () => applyDiff(applyBtn, content);

                    preElement.appendChild(applyBtn);
                }
            });
        }

        // æ£€æµ‹æ˜¯å¦æ˜¯ diff å†…å®¹
        function isDiffContent(content) {
            const lines = content.trim().split('\n');

            // æ£€æµ‹å¸¸è§çš„ diff æ ¼å¼ç‰¹å¾
            const hasDiffMarkers = lines.some(line =>
                line.startsWith('+++') ||
                line.startsWith('---') ||
                line.startsWith('@@') ||
                line.match(/^diff --git/)
            );

            // æˆ–è€…æ£€æµ‹æ˜¯å¦æœ‰è¶³å¤Ÿå¤šçš„ +/- è¡Œ
            const changeLines = lines.filter(line =>
                line.startsWith('+') || line.startsWith('-')
            );

            return hasDiffMarkers || (changeLines.length >= 3 && changeLines.length / lines.length > 0.3);
        }

        // åº”ç”¨ diff
        function applyDiff(button, diffContent) {
            button.disabled = true;
            button.innerHTML = 'â³ Applying...';

            // è§£æ diff å†…å®¹
            const diffData = parseDiff(diffContent);

            if (!diffData) {
                button.innerHTML = 'âœ— Invalid Diff';
                button.classList.add('error');
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = 'âœ“ Apply';
                    button.classList.remove('error');
                }, 2000);
                return;
            }

            // å‘é€åˆ° VS Code æ‰©å±•è¿›è¡Œåº”ç”¨
            vscode.postMessage({
                type: 'applyDiff',
                value: diffData
            });

            // ç­‰å¾…å“åº”
            button.dataset.pending = 'true';
        }

        // è§£æ diff å†…å®¹
        function parseDiff(diffContent) {
            const lines = diffContent.trim().split('\n');
            let currentFile = null;
            const files = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // æ£€æµ‹æ–‡ä»¶å
                if (line.startsWith('--- ') || line.startsWith('+++ ')) {
                    const match = line.match(/^[+-]{3}\s+(?:a\/|b\/)?(.+?)(?:\s+|$)/);
                    if (match) {
                        const filename = match[1];
                        if (line.startsWith('---')) {
                            currentFile = { oldFile: filename, newFile: null, hunks: [] };
                        } else if (currentFile) {
                            currentFile.newFile = filename;
                            files.push(currentFile);
                        }
                    }
                }

                // æ£€æµ‹ hunk å¤´éƒ¨ (@@)
                if (line.startsWith('@@') && currentFile) {
                    const hunkMatch = line.match(/@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/);
                    if (hunkMatch) {
                        const hunk = {
                            oldStart: parseInt(hunkMatch[1]),
                            oldLines: parseInt(hunkMatch[2] || '1'),
                            newStart: parseInt(hunkMatch[3]),
                            newLines: parseInt(hunkMatch[4] || '1'),
                            lines: []
                        };

                        // æ”¶é›† hunk çš„å†…å®¹
                        i++;
                        while (i < lines.length && !lines[i].startsWith('@@') && !lines[i].startsWith('---')) {
                            hunk.lines.push(lines[i]);
                            i++;
                        }
                        i--; // å›é€€ä¸€è¡Œ

                        currentFile.hunks.push(hunk);
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†æ ¼å¼ï¼Œå°è¯•ç®€å•çš„ +/- æ ¼å¼
            if (files.length === 0) {
                const addedLines = [];
                const removedLines = [];
                const contextLines = [];

                lines.forEach(line => {
                    if (line.startsWith('+') && !line.startsWith('+++')) {
                        addedLines.push(line.substring(1));
                    } else if (line.startsWith('-') && !line.startsWith('---')) {
                        removedLines.push(line.substring(1));
                    } else if (!line.startsWith('@@')) {
                        contextLines.push(line);
                    }
                });

                if (addedLines.length > 0 || removedLines.length > 0) {
                    return {
                        type: 'simple',
                        added: addedLines,
                        removed: removedLines,
                        context: contextLines,
                        raw: diffContent
                    };
                }
            }

            return files.length > 0 ? { type: 'unified', files, raw: diffContent } : null;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function handleSend() {
            const text = userInput.value.trim();
            if (text) {
                addMessage(text, 'user');
                vscode.postMessage({ type: 'ask', value: text });
                userInput.value = '';
                userInput.style.height = 'auto';
                currentAiMessageElement = null;
                currentAiRawText = "";

                // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                const loader = document.createElement('div');
                loader.id = 'ai-loader';
                loader.className = 'message ai-message system-message';
                loader.innerHTML = '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
                chatContainer.appendChild(loader);
                scrollToBottom();
            }
        }

        sendBtn.addEventListener('click', handleSend);

        userInput.addEventListener('keydown', (e) => {
            if (suggestionsList.style.display === 'block') {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
                    updateSuggestionSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
                    updateSuggestionSelection();
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    if (selectedSuggestionIndex !== -1) {
                        selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
                return;
            }

            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        exportBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'exportChat' });
        });

        clearBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'clear' }); // å·²ç»åœ¨ Provider ä¸­å®ç°æ¸…ç†é€»è¾‘
        });

        function updateSuggestionSelection() {
            const items = suggestionsList.querySelectorAll('.suggestion-item');
            items.forEach((item, index) => {
                item.className = 'suggestion-item' + (index === selectedSuggestionIndex ? ' selected' : '');
                if (index === selectedSuggestionIndex) {
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }

        // ç›‘å¬æ–‡æœ¬é€‰æ‹©äº‹ä»¶ï¼Œè‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†
        document.addEventListener('mouseup', () => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText) {
                // æ£€æŸ¥é€‰ä¸­çš„æ–‡æœ¬æ˜¯å¦åœ¨èŠå¤©å®¹å™¨å†…
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                const parentElement = container.nodeType === Node.TEXT_NODE
                    ? container.parentElement
                    : container;

                // ç¡®ä¿é€‰ä¸­çš„å†…å®¹åœ¨èŠå¤©å®¹å™¨å†…ï¼Œä¸”ä¸åœ¨è¾“å…¥æ¡†å†…
                if (chatContainer.contains(parentElement) && !userInput.contains(parentElement)) {
                    userInput.value = selectedText;
                    userInput.focus();

                    // é‡æ–°è®¡ç®—è¾“å…¥æ¡†é«˜åº¦
                    userInput.style.height = 'auto';
                    userInput.style.height = userInput.scrollHeight + 'px';

                    // æ¸…é™¤é€‰æ‹©ï¼Œé¿å…è§†è§‰å¹²æ‰°
                    selection.removeAllRanges();
                }
            }
        });

        // æ·»åŠ ä¸€ä¸ªæ ‡å¿—æ¥æ ‡è¯†å½“å‰æ˜¯å¦æ­£åœ¨æµå¼æ¥æ”¶AIæ¶ˆæ¯
        let isStreaming = false;

        window.addEventListener('message', event => {
            const message = event.data;
            const loader = document.getElementById('ai-loader');

            switch (message.type) {
                case 'suggestions':
                    showSuggestions(message.value, message.trigger);
                    break;
                case 'aiChunk':
                    if (loader) loader.remove();

                    // å¼€å§‹æµå¼æ¥æ”¶
                    isStreaming = true;

                    if (!currentAiMessageElement) {
                        // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
                        const aiMessageDiv = document.createElement('div');
                        aiMessageDiv.className = 'message ai-message'; // ç›´æ¥ä½¿ç”¨æœ€ç»ˆæ ·å¼
                        // aiMessageDiv.style.minHeight = '24px'; // é˜²æ­¢é«˜åº¦å¡Œé™·
                        chatContainer.appendChild(aiMessageDiv);
                        currentAiMessageElement = aiMessageDiv;
                    }

                    currentAiRawText += message.value;

                    // å®æ—¶ Markdown æ¸²æŸ“
                    // æŠ€å·§ï¼šå¦‚æœä»£ç å—æœªé—­åˆï¼Œæ‰‹åŠ¨ä¸´æ—¶é—­åˆå®ƒä»¥ä¿è¯æ¸²æŸ“æ­£ç¡®
                    let textToRender = currentAiRawText;
                    const codeBlockCount = (textToRender.match(/```/g) || []).length;
                    if (codeBlockCount % 2 !== 0) {
                        textToRender += '\n```';
                    }

                    // æ¸²æŸ“å†…å®¹å¹¶æ·»åŠ å…‰æ ‡
                    currentAiMessageElement.innerHTML = marked.parse(textToRender) + '<span class="cursor"></span>';

                    // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
                    // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
                    requestAnimationFrame(() => {
                        scrollToBottom();
                    });
                    break;
                case 'history':
                    chatContainer.innerHTML = '';
                    if (message.value && message.value.length > 0) {
                        message.value.forEach(msg => {
                            addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                        });
                    } else {
                        chatContainer.innerHTML = '<div class="message system-message">âœ¨ Yuangs AI Agent initialized and ready.</div>';
                    }
                    break;
                case 'done':
                    // æµå¼ä¼ è¾“ç»“æŸ
                    if (isStreaming && currentAiMessageElement) {
                        isStreaming = false;

                        // ç§»é™¤å…‰æ ‡ï¼Œè¿›è¡Œæœ€ç»ˆæ¸²æŸ“
                        currentAiMessageElement.innerHTML = marked.parse(currentAiRawText);
                        
                        // å¤„ç†diffå—å’Œå…¶ä»–åå¤„ç†
                        processDiffBlocks(currentAiMessageElement);
                        
                        // æ·»åŠ æ·¡å…¥æ•ˆæœæˆ–å…¶ä»–å®ŒæˆåŠ¨æ•ˆ
                        currentAiMessageElement.classList.add('final-render');
                    }

                    currentAiMessageElement = null;
                    currentAiRawText = "";
                    break;
                case 'clear':
                    chatContainer.innerHTML = '<div class="message system-message">âœ¨ Chat cleared.</div>';
                    break;
                case 'error':
                    if (loader) loader.remove();
                    addMessage('âŒ Error: ' + message.value, 'system');
                    break;
                case 'diffApplied':
                    // Diff åº”ç”¨æˆåŠŸ
                    const successButtons = document.querySelectorAll('.apply-diff-btn[data-pending="true"]');
                    successButtons.forEach(btn => {
                        btn.innerHTML = 'âœ“ Applied';
                        btn.classList.add('applied');
                        btn.disabled = true;
                        btn.dataset.pending = 'false';
                    });
                    break;
                case 'diffError':
                    // Diff åº”ç”¨å¤±è´¥
                    const errorButtons = document.querySelectorAll('.apply-diff-btn[data-pending="true"]');
                    errorButtons.forEach(btn => {
                        btn.innerHTML = 'âœ— Failed';
                        btn.classList.add('error');
                        btn.dataset.pending = 'false';
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = 'âœ“ Apply';
                            btn.classList.remove('error');
                        }, 3000);
                    });
                    if (message.value) {
                        addMessage('âŒ Diff application error: ' + message.value, 'system');
                    }
                    break;
                case 'contextUpdate':
                    // æ›´æ–°ä¸Šä¸‹æ–‡æ•°æ®
                    if (typeof updateContextItems === 'function') {
                        updateContextItems(message.value);
                    }
                    break;
                case 'showContextPanel':
                    // æ˜¾ç¤ºä¸Šä¸‹æ–‡é¢æ¿
                    if (typeof showContextPanel === 'function') {
                        showContextPanel();
                    }
                    break;
            }
        });

        // åˆå§‹åŒ–ä¸Šä¸‹æ–‡é¢æ¿
        if (typeof setupContextPanel === 'function') {
            setupContextPanel();
        }

        // === ä¸Šä¸‹æ–‡é¢æ¿åŠŸèƒ½å‡½æ•° ===

        // ä¸Šä¸‹æ–‡é¢æ¿å¼€å…³
        function setupContextPanel() {
            // ä¸Šä¸‹æ–‡é¢æ¿å¼€å…³
            contextToggle.addEventListener('click', () => {
                contextPanel.classList.toggle('open');
                contextToggle.classList.toggle('visible');
            });

            contextClose.addEventListener('click', () => {
                contextPanel.classList.remove('open');
                contextToggle.classList.remove('visible');
            });

            // è¿‡æ»¤æŒ‰é’®äº‹ä»¶
            contextFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    contextFilterBtns.forEach(b => b.classList.remove('active'));
                    // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
                    btn.classList.add('active');
                    // æ›´æ–°è¿‡æ»¤å™¨
                    currentFilter = btn.dataset.filter;
                    // é‡æ–°æ¸²æŸ“
                    renderContextItems();
                });
            });

            // æœç´¢åŠŸèƒ½
            contextSearch.addEventListener('input', (e) => {
                currentSearchQuery = e.target.value.toLowerCase();
                renderContextItems();
            });
        }

        // æ›´æ–°ä¸Šä¸‹æ–‡æ•°æ®
        function updateContextItems(items) {
            currentContextItems = items || [];
            renderContextItems();
        }

        // æ¸²æŸ“ä¸Šä¸‹æ–‡é¡¹ç›®
        function renderContextItems() {
            // è¿‡æ»¤ä¸Šä¸‹æ–‡é¡¹ç›®
            let filteredItems = currentContextItems.filter(item => {
                // ç±»å‹è¿‡æ»¤
                if (currentFilter !== 'all' && item.semantic !== currentFilter) {
                    return false;
                }
                
                // æœç´¢è¿‡æ»¤
                if (currentSearchQuery) {
                    const searchText = (item.path + item.summary + item.content).toLowerCase();
                    if (!searchText.includes(currentSearchQuery)) {
                        return false;
                    }
                }
                
                return true;
            });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            contextStats.textContent = `${filteredItems.length} items`;
            
            // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
            contextPanelContent.innerHTML = '';
            
            if (filteredItems.length === 0) {
                contextPanelContent.innerHTML = '<div class="context-empty">No context available</div>';
                return;
            }

            // æ¸²æŸ“æ¯ä¸ªä¸Šä¸‹æ–‡é¡¹ç›®
            filteredItems.forEach(item => {
                const itemElement = createContextItemElement(item);
                contextPanelContent.appendChild(itemElement);
            });
        }

        // åˆ›å»ºå•ä¸ªä¸Šä¸‹æ–‡é¡¹ç›®å…ƒç´ 
        function createContextItemElement(item) {
            const div = document.createElement('div');
            div.className = 'context-item';
            
            // è·å–å›¾æ ‡
            const icon = getContextIcon(item.semantic);
            
            // è·å–é‡è¦æ€§ç™¾åˆ†æ¯”
            const importancePercent = item.importance ? 
                (item.importance.confidence * 100).toFixed(0) : '50';
            
            // è·å–æ ‡ç­¾HTML
            const badgesHtml = createContextBadges(item);
            
            // è·å–ç»Ÿè®¡ä¿¡æ¯
            const statsHtml = createContextStats(item);
            
            // è·å–å†…å®¹é¢„è§ˆ
            const previewText = item.summary || item.content.substring(0, 200);
            
            div.innerHTML = `
                <div class="context-item-header">
                    <span class="context-item-icon">${icon}</span>
                    <span class="context-item-title">${item.alias || item.path}</span>
                    <div class="context-item-badges">${badgesHtml}</div>
                </div>
                <div class="context-item-stats">${statsHtml}</div>
                <div class="context-usage-bar">
                    <div class="context-usage-fill" style="width: ${importancePercent}%"></div>
                </div>
                <div class="context-item-preview">${previewText}</div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            div.addEventListener('click', () => {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šäº¤äº’é€»è¾‘
                console.log('Context item clicked:', item);
            });
            
            return div;
        }

        // è·å–ä¸Šä¸‹æ–‡å›¾æ ‡
        function getContextIcon(semantic) {
            const iconMap = {
                'source_code': 'ğŸ“„',
                'log': 'ğŸ“‹',
                'config': 'âš™ï¸',
                'documentation': 'ğŸ“š',
                'test': 'ğŸ§ª',
                'git': 'ğŸ”€',
                'evidence': 'ğŸ”',
                'diagnostics': 'âš ï¸'
            };
            
            return iconMap[semantic] || 'ğŸ“„';
        }

        // åˆ›å»ºæ ‡ç­¾
        function createContextBadges(item) {
            const badges = [];
            
            // ç±»å‹æ ‡ç­¾
            if (item.semantic) {
                badges.push(`<span class="context-badge ${item.semantic}">${item.semantic}</span>`);
            }
            
            // æ ‡ç­¾
            if (item.tags && item.tags.length > 0) {
                item.tags.slice(0, 2).forEach(tag => {
                    badges.push(`<span class="context-badge">${tag}</span>`);
                });
            }
            
            return badges.join('');
        }

        // åˆ›å»ºç»Ÿè®¡ä¿¡æ¯
        function createContextStats(item) {
            const stats = [];
            
            // Tokenæ•°é‡
            if (item.tokens) {
                stats.push(`<span class="context-stat">ğŸ“Š ${item.tokens} tokens</span>`);
            }
            
            // ä½¿ç”¨æ¬¡æ•°
            if (item.importance && item.importance.useCount > 0) {
                stats.push(`<span class="context-stat">ğŸ”„ ${item.importance.useCount} uses</span>`);
            }
            
            // æœ€åä½¿ç”¨æ—¶é—´
            if (item.importance && item.importance.lastUsed) {
                const lastUsed = new Date(item.importance.lastUsed);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastUsed) / 60000);
                
                if (diffMinutes < 1) {
                    stats.push(`<span class="context-stat">â° just now</span>`);
                } else if (diffMinutes < 60) {
                    stats.push(`<span class="context-stat">â° ${diffMinutes}m ago</span>`);
                } else if (diffMinutes < 1440) {
                    stats.push(`<span class="context-stat">â° ${Math.floor(diffMinutes / 60)}h ago</span>`);
                } else {
                    stats.push(`<span class="context-stat">â° ${Math.floor(diffMinutes / 1440)}d ago</span>`);
                }
            }
            
            return stats.join('');
        }

        // æ˜¾ç¤ºä¸Šä¸‹æ–‡é¢æ¿
        function showContextPanel() {
            contextPanel.classList.add('open');
            contextToggle.classList.add('visible');
        }

        // éšè—ä¸Šä¸‹æ–‡é¢æ¿
        function hideContextPanel() {
            contextPanel.classList.remove('open');
            contextToggle.classList.remove('visible');
        }
    </script>
</body>
</html>
