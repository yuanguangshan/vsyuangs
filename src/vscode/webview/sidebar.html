<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yuangs Premium AI</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* =========================================
       1. å…¨å±€å˜é‡ä¸åŸºç¡€è®¾ç½®
       ========================================= */
    :root {
      /* æ ¸å¿ƒé¢œè‰²å¼•ç”¨ VS Code ä¸»é¢˜ */
      --bg-primary: var(--vscode-sideBar-background);
      --bg-secondary: var(--vscode-editor-background);
      --text-primary: var(--vscode-foreground);
      --text-secondary: var(--vscode-descriptionForeground);
      --accent: var(--vscode-textLink-foreground);
      --accent-hover: var(--vscode-textLink-activeForeground);
      --border-color: var(--vscode-widget-border);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);

      /* è‡ªå®šä¹‰é«˜çº§é…è‰² */
      --user-msg-bg: var(--vscode-button-background);
      --user-msg-text: var(--vscode-button-foreground);
      --ai-msg-bg: var(--vscode-editor-background);
      --radius-lg: 12px;
      --radius-md: 8px;
      --radius-sm: 4px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Inter", sans-serif;
      font-size: var(--vscode-font-size);
      color: var(--text-primary);
      background: var(--bg-primary);
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--vscode-scrollbarSlider-background);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--vscode-scrollbarSlider-hoverBackground);
    }

    /* =========================================
       2. é¡¶éƒ¨å¯¼èˆªæ  (Header)
       ========================================= */
    header {
      height: 48px;
      width: 100%;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-sizing: border-box;
      z-index: 100;
      backdrop-filter: blur(10px);
      /* æ¯›ç»ç’ƒæ•ˆæœ */
    }

    /* ç§»é™¤æ—§çš„å½©è™¹çº¿ï¼Œæ”¹ç”¨ç²¾è‡´çš„ Logo æ ·å¼ */
    header::before {
      display: none;
    }

    .header-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      background: linear-gradient(90deg, var(--accent) 0%, var(--vscode-textLink-activeForeground) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-primary);
      cursor: pointer;
      opacity: 0.7;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      opacity: 1;
      background: var(--vscode-toolbar-hoverBackground);
      transform: translateY(-1px);
    }

    .icon-btn.context-btn {
      background: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
      border: 1px solid var(--border-color);
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      opacity: 1;
    }

    .icon-btn.context-btn:hover {
      background: var(--vscode-button-secondaryHoverBackground);
    }

    /* æ¨¡å‹é€‰æ‹©å™¨ä¼˜åŒ– */
    .model-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--vscode-input-background);
      border: 1px solid var(--border-color);
      border-radius: 100px;
      /* èƒ¶å›Šæ ·å¼ */
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }

    .model-selector:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(127, 127, 127, 0.1);
    }

    .model-selector-label {
      opacity: 0.9;
      white-space: nowrap;
    }

    .model-selector-dropdown {
      position: absolute;
      top: 40px;
      right: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 3000;
      padding: 4px;
    }

    .model-option {
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.85em;
      border-radius: var(--radius-sm);
      margin-bottom: 2px;
    }

    .model-selector-dropdown.visible {
      display: block;
    }

    .model-option:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .model-option.active {
      background: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .model-option-name {
      flex: 1;
    }

    .model-option-icon {
      opacity: 0.5;
      font-size: 0.8em;
    }

    .model-option.active .model-option-icon {
      opacity: 1;
    }

    /* =========================================
       3. å·¥å…·æ  (Git Toolbar)
       ========================================= */
    .git-toolbar {
      padding: 10px 16px;
      display: flex;
      gap: 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
    }

    .secondary-btn {
      background: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
      border: 1px solid transparent;
      padding: 6px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .secondary-btn:hover {
      background: var(--vscode-button-secondaryHoverBackground);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    /* Patch ä¸‹æ‹‰èœå• */
    .patch-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: var(--vscode-editor-background);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      min-width: 200px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 3000;
      padding: 4px;
    }

    .patch-dropdown.visible {
      display: block;
    }

    .patch-option {
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85em;
      border-radius: var(--radius-sm);
      margin-bottom: 2px;
    }

    .patch-option:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .patch-option span:first-child {
      font-size: 1.4em;
      opacity: 0.8;
    }

    .patch-option strong {
      display: block;
      font-size: 1em;
    }

    .patch-option span:last-child {
      display: block;
      opacity: 0.6;
      font-size: 0.9em;
      margin-top: 2px;
    }

    /* =========================================
       4. èŠå¤©åŒºåŸŸ (Chat Container)
       ========================================= */
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      /* å¢åŠ æ¶ˆæ¯é—´è· */
    }

    .message {
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      max-width: 85%;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
      line-height: 1.6;
      font-size: 13px;
    }

    /* ç”¨æˆ·æ¶ˆæ¯ï¼šç°ä»£æ¸å˜æˆ–çº¯è‰² */
    .user-message {
      align-self: flex-end;
      background: var(--user-msg-bg);
      color: var(--user-msg-text);
      border-bottom-right-radius: 2px;
      box-shadow: var(--shadow-sm);
    }

    /* AI æ¶ˆæ¯ï¼šå¹²å‡€çš„å¡ç‰‡é£æ ¼ */
    .ai-message {
      align-self: flex-start;
      background: var(--ai-msg-bg);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 2px;
      box-shadow: var(--shadow-sm);
    }

    /* AI æ¶ˆæ¯å†…çš„ Markdown æ ·å¼ä¼˜åŒ– */
    .ai-message p {
      margin: 0.5em 0;
    }

    .ai-message p:first-child {
      margin-top: 0;
    }

    .ai-message p:last-child {
      margin-bottom: 0;
    }

    .ai-message code {
      font-family: 'Fira Code', Consolas, monospace;
      font-size: 0.9em;
      background: rgba(127, 127, 127, 0.15);
      padding: 2px 5px;
      border-radius: 4px;
      color: var(--vscode-textPreformat-foreground);
    }

    /* ä»£ç å—ï¼šæ·»åŠ  macOS é£æ ¼å¤´éƒ¨ */
    .ai-message pre {
      background: var(--vscode-editor-background);
      border: 1px solid var(--border-color);
      padding: 30px 12px 12px 12px;
      /* Top padding reserved for header */
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
      position: relative;
    }

    .ai-message pre::before {
      /* æ¨¡æ‹Ÿ macOS çª—å£çº¢é»„ç»¿ç‚¹ */
      content: "";
      position: absolute;
      top: 10px;
      left: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff5f56;
      /* Red */
      box-shadow: 15px 0 0 #ffbd2e, 30px 0 0 #27c93f;
      /* Yellow & Green */
      opacity: 0.8;
    }

    /* Diff å—ç‰¹æ®Šæ ·å¼ */
    .ai-message pre.diff-block {
      border-left: 3px solid var(--accent);
    }

    .ai-message pre.diff-block::before {
      display: none;
      /* Diff å—ä¸æ˜¾ç¤ºçº¢ç»¿ç¯ï¼Œæ”¹ç”¨æ–‡å­— */
    }

    .ai-message pre.diff-block::after {
      content: "REVIEW DIFF";
      position: absolute;
      top: 6px;
      left: 8px;
      font-size: 10px;
      font-weight: bold;
      color: var(--text-secondary);
      letter-spacing: 1px;
    }

    /* æ¶ˆæ¯æ“ä½œæ  */
    .message-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    /* æ¶ˆæ¯æ“ä½œæŒ‰é’® */
    .message-action-btn {
      background: rgba(0, 0, 0, 0.6);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 14px;
      transition: all 0.2s;
    }

    .message-action-btn:hover {
      background: var(--vscode-list-hoverBackground);
      color: var(--text-primary);
      transform: none;
    }

    .user-message .message-action-btn {
      /* ç”¨æˆ·æ¶ˆæ¯æ˜¯æ·±è‰²èƒŒæ™¯æ—¶ï¼Œæ“ä½œæ éœ€è¦é€‚é… */
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .user-message .message-action-btn:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* åº”ç”¨ Diff æŒ‰é’® */
    .apply-diff-btn {
      position: absolute;
      top: 4px;
      right: 8px;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75em;
      font-family: var(--vscode-font-family);
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      z-index: 10;
    }

    .ai-message pre.diff-block:hover .apply-diff-btn {
      opacity: 1;
    }

    .apply-diff-btn:hover {
      background: var(--vscode-button-hoverBackground);
    }

    .apply-diff-btn:active {
      transform: scale(0.95);
    }

    .apply-diff-btn.applied {
      background: var(--vscode-testing-iconPassed);
      opacity: 1;
    }

    .apply-diff-btn.error {
      background: var(--vscode-testing-iconFailed);
      opacity: 1;
    }

    /* ç³»ç»Ÿæ¶ˆæ¯ */
    .system-message {
      align-self: center;
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(127, 127, 127, 0.05);
      padding: 4px 12px;
      border-radius: 100px;
      border: 1px solid transparent;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =========================================
       5. åº•éƒ¨è¾“å…¥åŒºåŸŸ (Input Area)
       ========================================= */
    #input-area {
      padding: 16px 20px 24px 20px;
      background: transparent;
      /* ç§»é™¤èƒŒæ™¯è‰²ï¼Œå®ç°æ‚¬æµ®æ„Ÿ */
      border-top: none;
      position: relative;
    }

    /* æ·»åŠ æ¸å˜é®ç½©ï¼Œé˜²æ­¢èŠå¤©å†…å®¹çªç„¶æˆªæ–­ */
    #input-area::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to top, var(--bg-primary), transparent);
      pointer-events: none;
    }

    .input-wrapper {
      display: flex;
      background: var(--vscode-input-background);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      /* æ›´å¤§çš„åœ†è§’ */
      padding: 8px 12px;
      align-items: flex-end;
      /* å¯¹é½åˆ°åº•éƒ¨ */
      box-shadow: var(--shadow-md);
      /* æ‚¬æµ®é˜´å½± */
      transition: all 0.2s ease;
    }

    .input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(127, 127, 127, 0.1);
      transform: translateY(-1px);
    }

    #user-input {
      padding: 8px 4px;
      font-size: 13px;
      line-height: 1.5;
      flex-grow: 1;
      background: transparent;
      color: var(--vscode-input-foreground);
      border: none;
      outline: none;
      resize: none;
      max-height: 120px;
      min-height: 24px;
      font-family: inherit;
    }

    #send-btn,
    #stop-btn {
      margin-bottom: 2px;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #send-btn {
      background: var(--accent);
      color: white;
      border: none;
      transition: all 0.2s;
    }

    #send-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    #stop-btn {
      background: var(--vscode-errorForeground);
      color: var(--vscode-button-foreground);
      border: none;
      display: none;
      animation: pulse 1.5s infinite;
    }

    #stop-btn:hover {
      opacity: 0.8;
    }

    #stop-btn.visible {
      display: flex;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(235, 86, 86, 0.7);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(235, 86, 86, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(235, 86, 86, 0);
      }
    }

    /* =========================================
       6. å»ºè®®åˆ—è¡¨
       ========================================= */
    #suggestions-list {
      position: absolute;
      bottom: 100%;
      left: 16px;
      right: 16px;
      background: var(--vscode-editor-background);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      margin-bottom: 8px;
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }

    .suggestion-item:hover,
    .suggestion-item.selected {
      background: var(--vscode-list-hoverBackground);
      color: var(--vscode-list-hoverForeground);
    }

    .suggestion-icon {
      opacity: 0.7;
      font-size: 1.1em;
    }

    /* =========================================
       7. ä¾§è¾¹é¢æ¿ (Context & Files)
       ========================================= */
    #files-panel,
    #context-panel {
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.2);
      /* æ›´æŸ”å’Œçš„æ·±é˜´å½± */
      background: var(--bg-secondary);
      backdrop-filter: blur(20px);
    }

    .files-panel-header,
    .context-panel-header {
      height: 48px;
      padding: 0 16px;
      border-bottom: 1px solid var(--border-color);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .files-panel-title,
    .context-panel-title {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .files-panel-stats,
    .context-panel-stats {
      font-size: 11px;
      opacity: 0.7;
    }

    /* æ–‡ä»¶é¢æ¿ */
    #files-panel {
      position: fixed;
      top: 48px;
      left: -400px;
      width: 380px;
      height: calc(100vh - 48px);
      border-right: 1px solid var(--border-color);
      border-top: 1px solid var(--border-color);
      z-index: 1000;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    #files-panel.open {
      left: 0;
    }

    .files-panel-close,
    .context-panel-close {
      background: transparent;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      padding: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .files-panel-close:hover,
    .context-panel-close:hover {
      opacity: 1;
    }

    .files-panel-controls {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .files-search,
    .context-search {
      flex: 1;
      background: var(--vscode-input-background);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--vscode-input-foreground);
      font-size: 12px;
      outline: none;
      transition: border-color 0.2s;
    }

    .files-search:focus,
    .context-search:focus {
      border-color: var(--accent);
    }

    .files-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .file-tree-item {
      display: flex;
      align-items: center;
      padding: 6px 16px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .file-tree-item:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .file-tree-item.selected {
      background: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .file-tree-icon {
      margin-right: 8px;
      font-size: 1em;
      opacity: 0.8;
      flex-shrink: 0;
    }

    .file-tree-icon.expanded::before {
      content: "â–¼";
      font-size: 0.7em;
      margin-right: 2px;
    }

    .file-tree-icon.collapsed::before {
      content: "â–¶";
      font-size: 0.7em;
      margin-right: 2px;
    }

    .file-tree-name {
      flex: 1;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-tree-children {
      display: none;
    }

    .file-tree-children.expanded {
      display: block;
    }

    .file-tree-item.folder {
      font-weight: 500;
    }

    .file-tree-item.file {
      opacity: 0.9;
    }

    .file-empty,
    .file-loading {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.5;
      font-size: 13px;
    }

    /* ä¸Šä¸‹æ–‡é¢æ¿ */
    #context-panel {
      position: fixed;
      top: 48px;
      right: -400px;
      width: 380px;
      height: calc(100vh - 48px);
      border-left: 1px solid var(--border-color);
      border-top: 1px solid var(--border-color);
      z-index: 1000;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    #context-panel.open {
      right: 0;
    }

    .context-panel-controls {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .context-filter-btn {
      background: var(--vscode-button-secondaryBackground);
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 4px 10px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .context-filter-btn:hover,
    .context-filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .context-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .context-item {
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }

    .context-item.collapsed .context-item-details {
      display: none;
    }

    .context-item.collapsed {
      padding: 10px 12px;
    }

    .context-item.expanded {
      padding: 12px;
    }

    .context-item:hover {
      background: var(--vscode-list-hoverBackground);
      border-color: var(--accent);
    }

    .context-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .context-item.collapsed .context-item-header {
      margin-bottom: 0;
    }

    .context-item-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
      transition: transform 0.2s;
    }

    .context-item.expanded .context-item-toggle {
      transform: rotate(90deg);
    }

    .context-item-details {
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .context-item-icon {
      font-size: 1.2em;
    }

    .context-item-title {
      flex: 1;
      font-weight: 500;
      font-size: 13px;
      word-break: break-all;
    }

    .context-item-badges {
      display: flex;
      gap: 4px;
    }

    .context-badge {
      background: rgba(127, 127, 127, 0.15);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      opacity: 0.9;
    }

    .context-badge.source_code {
      background: rgba(86, 156, 214, 0.2);
    }

    .context-badge.log {
      background: rgba(152, 195, 121, 0.2);
    }

    .context-badge.git {
      background: rgba(229, 192, 123, 0.2);
    }

    .context-badge.diagnostics {
      background: rgba(224, 108, 117, 0.2);
    }

    .context-item-stats {
      display: flex;
      gap: 12px;
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .context-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .context-usage-bar {
      height: 3px;
      background: rgba(127, 127, 127, 0.15);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .context-usage-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .context-item-preview {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      padding: 8px;
      font-family: 'Fira Code', Consolas, monospace;
      font-size: 11px;
      max-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .context-empty {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.5;
      font-size: 13px;
    }

    /* =========================================
       8. å…¶ä»– UI ç»„ä»¶
       ========================================= */

    /* Flash Notification Toast */
    .flash-notification {
      background: var(--vscode-button-secondaryBackground);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      top: 60px;
      right: 20px;
      /* é å³å¯¹é½ */
      border-radius: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      font-size: 13px;
      animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
      max-width: 300px;
      z-index: 5000;
    }

    /* å³é”®èœå• */
    .context-menu {
      border-radius: 8px;
      padding: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      min-width: 180px;
      z-index: 10000;
      display: none;
      overflow: hidden;
    }

    .context-menu.visible {
      display: block;
    }

    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-primary);
      transition: background 0.2s;
      border-radius: 4px;
    }

    .context-menu-item:hover {
      background: var(--vscode-list-hoverBackground);
      color: var(--text-primary);
    }

    .context-menu-separator {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    /* å…‰æ ‡é—ªçƒæ•ˆæœ */
    .cursor {
      display: inline-block;
      width: 8px;
      height: 16px;
      background: var(--text-primary);
      margin-left: 4px;
      animation: blink 1s step-start infinite;
      vertical-align: middle;
      opacity: 0.8;
      border-radius: 1px;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    /* æµå¼ä¼ è¾“æ ·å¼ */
    .streaming-draft {
      font-family: "Courier New", Consolas, Monaco, monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .streaming-content {
      margin: 0;
      padding: 0;
      font-family: inherit;
      line-height: inherit;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .final-render {
      /* æœ€ç»ˆæ¸²æŸ“å®Œæˆåçš„æ ·å¼ */
    }

    /* åŠ è½½åŠ¨ç”» */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 4px;
    }

    .dot {
      width: 6px;
      height: 6px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* Apply Commit Button */
    .apply-commit-btn {
      margin-top: 8px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .apply-commit-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Review Tags */
    .review-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      margin-right: 6px;
      vertical-align: middle;
    }

    .tag-error {
      background: #f14c4c;
      color: white;
    }

    .tag-warning {
      background: #cca700;
      color: white;
    }

    .tag-info {
      background: #3794ef;
      color: white;
    }

    .review-item {
      border-left: 3px solid var(--accent);
      padding-left: 10px;
      margin: 8px 0;
      background: rgba(127, 127, 127, 0.1);
      padding: 8px;
      border-radius: 0 4px 4px 0;
    }

    /* =========================================
       9. æ—¥å¿—é¢æ¿ (Log Panel)
       ========================================= */
    #log-panel {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      max-height: 200px;
      transition: max-height 0.3s ease;
    }

    #log-panel.collapsed {
      max-height: 40px;
      overflow: hidden;
    }

    /* Collapse log panel: hide content from layout and accessibility tree */
    #log-panel.collapsed .log-panel-content {
      display: none;
    }

    .log-panel-header {
      height: 36px;
      padding: 0 12px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .log-panel-title {
      font-weight: 600;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-panel-stats {
      font-size: 10px;
      opacity: 0.7;
    }

    .log-panel-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .log-action-btn {
      background: transparent;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      padding: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
      font-size: 12px;
    }

    .log-action-btn:hover {
      opacity: 1;
    }

    #log-toggle-btn {
      transition: transform 0.3s ease;
    }

    #log-panel.collapsed #log-toggle-btn {
      transform: rotate(180deg);
    }

    .log-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
      font-family: 'Fira Code', Consolas, monospace;
      font-size: 11px;
      line-height: 1.4;
      background: rgba(0, 0, 0, 0.02);
    }

    .log-entry {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(127, 127, 127, 0.1);
      cursor: pointer;
      transition: background 0.2s;
      word-break: break-all;
    }

    .log-entry:hover {
      background: rgba(127, 127, 127, 0.05);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text-secondary);
      opacity: 0.8;
      flex-shrink: 0;
      font-size: 10px;
      min-width: 70px;
    }

    .log-level {
      font-weight: 600;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 2px;
      flex-shrink: 0;
      min-width: 50px;
      text-align: center;
    }

    .log-entry.log-info .log-level {
      color: #3794ef;
      background: rgba(55, 148, 239, 0.1);
    }

    .log-entry.log-warn .log-level {
      color: #cca700;
      background: rgba(204, 167, 0, 0.1);
    }

    .log-entry.log-error .log-level {
      color: #f14c4c;
      background: rgba(241, 76, 76, 0.1);
    }

    .log-entry.log-debug .log-level {
      color: #c5c5c5;
      background: rgba(197, 197, 197, 0.1);
    }

    .log-message {
      flex: 1;
      color: var(--text-primary);
    }

    .log-entry.log-error .log-message {
      color: #f14c4c;
    }

    .log-entry.log-warn .log-message {
      color: #d7ba7d;
    }
  </style>
</head>

<body>
  <script>
    // æ£€æµ‹æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
    const urlParams = new URLSearchParams(window.location.search);
    const DEBUG_MODE = urlParams.get('debug') === 'true';

    // è°ƒè¯•æ—¥å¿—å‡½æ•°
    function debugLog(...args) {
      if (DEBUG_MODE) {
        console.log('[DEBUG]', ...args);
      }
    }

    // å¦‚æœæ˜¯è°ƒè¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºè°ƒè¯•é¢æ¿
    window.addEventListener('DOMContentLoaded', () => {
      const debugInfo = document.getElementById('debug-info');
      if (debugInfo) {
        debugInfo.style.display = DEBUG_MODE ? 'block' : 'none';
      }
      debugLog('Debug mode:', DEBUG_MODE ? 'enabled' : 'disabled');
    });
  </script>
  <header>
    <div class="header-title">YGS AI</div>
    <div class="header-actions">
      <!-- æ¨¡å‹é€‰æ‹©å™¨ -->
      <div class="model-selector" id="model-selector" title="Select AI Model">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6;">
          <path
            d="M8 1a7 7 0 0 1 0 14A7 7 0 0 1 8 1zM0 8a8 8 0 1 0 16 0A8 8 0 0 0 0 8zm8 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm1-2.5V6H7v4.5h2z" />
        </svg>
        <span class="model-selector-label" id="current-model">Loading...</span>
        <svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.5;">
          <path d="M8 11L3 6h2.5L8 8.5L10.5 6H13L8 11z" />
        </svg>
      </div>
      <!-- æ¨¡å‹ä¸‹æ‹‰èœå• -->
      <div class="model-selector-dropdown" id="model-dropdown">
        <!-- é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <button class="icon-btn" id="files-toggle" title="Show Files">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M1 3.5A1.5 1.5 0 0 1 2.5 2h3.879a1.5 1.5 0 0 1 1.06.44l1.122 1.12A1.5 1.5 0 0 0 9.62 4H13.5A1.5 1.5 0 0 1 15 5.5v8a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5v-10zM2.5 3a.5.5 0 0 0-.5.5V13a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5V5.5a.5.5 0 0 0-.5-.5H9.62a1.5 1.5 0 0 1-1.06-.44l-1.12-1.12A1.5 1.5 0 0 0 6.38 3H2.5zM4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM4 10a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z" />
        </svg>
      </button>
      <button class="icon-btn context-btn" id="context-toggle" title="Show Context Panel" style="z-index: 2000">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L10.293 7.5H4.5z" />
        </svg>
        <span style="margin-left: 4px; font-size: 0.8em">Context</span>
      </button>
      <button class="icon-btn" id="export-btn" title="Export Chat History (.md)">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM13 5H9V1h4v4zM3 2v12h10V6H8V2H3z" />
        </svg>
      </button>
      <button class="icon-btn" id="clear-btn" title="Clear Chat">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M10 3h3v1h-1v9l-1 1H4l-1-1V4H2V3h3V2a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v1zM9 2H6v1h3V2zM4 4v9h7V4H4z" />
        </svg>
      </button>
    </div>
  </header>

  <div class="git-toolbar">
    <button class="secondary-btn" id="commit-btn" title="Generate Conventional Commit Message based on staged changes">
      <span>ğŸ“</span> Commit
    </button>
    <button class="secondary-btn" id="review-btn" title="Run Expert Code Review on staged changes">
      <span>ğŸ”</span> Review
    </button>
    <div style="position: relative;">
      <button class="secondary-btn" id="patch-btn" title="Generate Git Patch">
        <span>ğŸ“‹</span> Patch
        <svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.5; margin-left: 4px;">
          <path d="M8 11L3 6h2.5L8 8.5L10.5 6H13L8 11z" />
        </svg>
      </button>
      <!-- Patch ä¸‹æ‹‰èœå• -->
      <div class="patch-dropdown" id="patch-dropdown">
        <div class="patch-option" data-type="staged">
          <span>ğŸ“¦</span>
          <div>
            <strong>æš‚å­˜åŒº Patch</strong>
            <span style="opacity: 0.6; font-size: 0.9em;">Staged changes</span>
          </div>
        </div>
        <div class="patch-option" data-type="unstaged">
          <span>ğŸ“„</span>
          <div>
            <strong>å·¥ä½œåŒº Patch</strong>
            <span style="opacity: 0.6; font-size: 0.9em;">Unstaged changes</span>
          </div>
        </div>
        <div class="patch-option" data-type="last">
          <span>ğŸ“œ</span>
          <div>
            <strong>æœ€åä¸€æ¬¡æäº¤ Patch</strong>
            <span style="opacity: 0.6; font-size: 0.9em;">Last commit</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <div id="debug-info" style="font-size: 10px; color: #888; padding: 5px; border-top: 1px solid #333;">
    Debug: <span id="debug-status">Ready</span>
  </div>

  <!-- æ—¥å¿—åŒºåŸŸ -->
  <div id="log-panel">
    <div class="log-panel-header">
      <div class="log-panel-title">
        <span>ğŸ“‹ Debug Log</span>
        <span class="log-panel-stats" id="log-stats">0 entries</span>
      </div>
      <div class="log-panel-actions">
        <button class="log-action-btn" id="log-clear-btn" title="Clear Logs">
          ğŸ—‘ï¸
        </button>
        <button class="log-action-btn" id="log-copy-btn" title="Copy All Logs">
          ğŸ“‹
        </button>
        <button class="log-action-btn" id="log-toggle-btn" title="Toggle Log Panel">
          â–¼
        </button>
      </div>
    </div>
    <div class="log-panel-content" id="log-panel-content">
      <div class="log-entry log-info">
        <span class="log-time">--:--:--</span>
        <span class="log-level">[INFO]</span>
        <span class="log-message">Debug panel initialized. Click logs to copy.</span>
      </div>
    </div>
  </div>

  <div id="chat-container">
    <!-- åˆå§‹ä¸ºç©ºï¼Œç­‰å¾…å†å²è®°å½•åŠ è½½ -->
  </div>

  <div id="input-area">
    <div id="suggestions-list"></div>
    <div class="input-wrapper">
      <textarea id="user-input" rows="1" placeholder="Type your message..."></textarea>
      <button id="send-btn">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M1.146 1.146a.5.5 0 0 1 .538-.093l13 5a.5.5 0 0 1 0 .94l-13 5a.5.5 0 0 1-.667-.615L2.854 8 1.017 2.618a.5.5 0 0 1 .129-.472zM3.854 8l-1.5 4.34L13.84 8 2.354 3.66 3.854 8z" />
        </svg>
      </button>
      <button id="stop-btn" title="Stop Generation">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M4 4h8v8H4V4z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- æ–‡ä»¶é¢æ¿ -->
  <div id="files-panel">
    <div class="files-panel-header">
      <div class="files-panel-title">
        <span>ğŸ“ Files</span>
        <span class="files-panel-stats" id="files-stats">Loading...</span>
      </div>
      <button class="files-panel-close" id="files-close">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
        </svg>
      </button>
    </div>
    <div class="files-panel-controls">
      <input type="text" class="files-search" id="files-search" placeholder="Search files..." />
    </div>
    <div class="files-panel-content" id="files-panel-content">
      <div class="file-loading">Loading files...</div>
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div class="context-menu" id="context-menu">
    <div class="context-menu-item" id="context-copy">
      <span>ğŸ“‹</span>
      <span>å¤åˆ¶æ¶ˆæ¯</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" id="context-delete">
      <span>ğŸ—‘ï¸</span>
      <span>åˆ é™¤æ¶ˆæ¯</span>
    </div>
  </div>

  <!-- ä¸Šä¸‹æ–‡é¢æ¿ -->
  <div id="context-panel">
    <div class="context-panel-header">
      <div class="context-panel-title">
        <span>ğŸ“‹ Context</span>
        <span class="context-panel-stats" id="context-stats">0 items</span>
      </div>
      <button class="context-panel-close" id="context-close">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
        </svg>
      </button>
    </div>
    <div class="context-panel-controls">
      <input type="text" class="context-search" id="context-search" placeholder="Search context..." />
      <button class="context-filter-btn active" data-filter="all">All</button>
      <button class="context-filter-btn" data-filter="source_code">
        Code
      </button>
      <button class="context-filter-btn" data-filter="log">Log</button>
      <button class="context-filter-btn" data-filter="git">Git</button>
    </div>
    <div class="context-panel-content" id="context-panel-content">
      <div class="context-empty">No context available</div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    const chatContainer = document.getElementById("chat-container");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const stopBtn = document.getElementById("stop-btn");
    const exportBtn = document.getElementById("export-btn");
    const clearBtn = document.getElementById("clear-btn");
    const suggestionsList = document.getElementById("suggestions-list");

    // ä¸Šä¸‹æ–‡é¢æ¿ç›¸å…³å…ƒç´ 
    const filesPanel = document.getElementById("files-panel");
    const filesToggle = document.getElementById("files-toggle");
    const filesClose = document.getElementById("files-close");
    const filesPanelContent = document.getElementById("files-panel-content");
    const filesSearch = document.getElementById("files-search");
    const filesStats = document.getElementById("files-stats");

    const contextPanel = document.getElementById("context-panel");
    const contextToggle = document.getElementById("context-toggle");
    const contextClose = document.getElementById("context-close");
    const contextPanelContent = document.getElementById(
      "context-panel-content",
    );
    const contextSearch = document.getElementById("context-search");
    const contextStats = document.getElementById("context-stats");
    const contextFilterBtns = document.querySelectorAll(
      ".context-filter-btn",
    );

    let currentAiMessageElement = null;
    let currentAiRawText = "";
    let suggestionType = null; // '@' or '#'
    let selectedSuggestionIndex = -1;
    let currentSuggestions = [];

    // ä¸Šä¸‹æ–‡ç›¸å…³çŠ¶æ€
    let currentContextItems = [];
    let currentFilter = "all";
    let currentSearchQuery = "";

    // æ–‡ä»¶ç›¸å…³çŠ¶æ€
    let fileTreeData = null;
    let currentFileSearchQuery = "";
    let allFiles = [];

    // è¾“å…¥æ¡†é«˜åº¦è‡ªåŠ¨ä¼¸ç¼©
    userInput.addEventListener("input", (e) => {
      userInput.style.height = "auto";
      userInput.style.height = userInput.scrollHeight + "px";

      handleTriggerDetection(e);
    });

    function handleTriggerDetection(e) {
      const value = userInput.value;
      const cursorPos = userInput.selectionStart;
      const textBeforeCursor = value.substring(0, cursorPos);

      // æ£€æµ‹è§¦å‘ç¬¦
      const lastAt = textBeforeCursor.lastIndexOf("@");
      const lastHash = textBeforeCursor.lastIndexOf("#");
      const lastTriggerIndex = Math.max(lastAt, lastHash);

      if (
        lastTriggerIndex !== -1 &&
        (lastTriggerIndex === 0 ||
          /\s/.test(textBeforeCursor[lastTriggerIndex - 1]))
      ) {
        const trigger = textBeforeCursor[lastTriggerIndex];
        const query = textBeforeCursor.substring(lastTriggerIndex + 1);

        // åªæœ‰å½“æŸ¥è¯¢ä¸­æ²¡æœ‰ç©ºæ ¼æ—¶æ‰è§¦å‘ï¼ˆç©ºæŸ¥è¯¢ä¹Ÿå…è®¸è§¦å‘ï¼‰
        if (!/\s/.test(query)) {
          suggestionType = trigger;

          // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          suggestionsList.innerHTML =
            '<div class="suggestion-item">ğŸ” Loading...</div>';
          suggestionsList.style.display = "block";

          if (trigger === "@") {
            vscode.postMessage({ type: "getFiles", query });
          } else {
            vscode.postMessage({ type: "getSymbols", query });
          }
          return;
        }
      }

      hideSuggestions();
    }

    function showSuggestions(suggestions, trigger) {
      currentSuggestions = suggestions;
      if (suggestions.length === 0) {
        hideSuggestions();
        return;
      }

      suggestionsList.innerHTML = "";
      suggestionsList.style.display = "block";
      selectedSuggestionIndex = 0;

      suggestions.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "suggestion-item" + (index === 0 ? " selected" : "");
        const icon = trigger === "@" ? "ğŸ“„" : "ğŸ”§";
        div.innerHTML = `<span class="suggestion-icon">${icon}</span><span>${item}</span>`;
        div.onclick = () => selectSuggestion(item);
        suggestionsList.appendChild(div);
      });
    }

    function hideSuggestions() {
      suggestionsList.style.display = "none";
      suggestionType = null;
      selectedSuggestionIndex = -1;
    }

    function selectSuggestion(value) {
      const text = userInput.value;
      const cursorPos = userInput.selectionStart;
      const textBeforeCursor = text.substring(0, cursorPos);
      const textAfterCursor = text.substring(cursorPos);

      const lastTriggerIndex = textBeforeCursor.lastIndexOf(suggestionType);

      // 1. æ›´æ–°è¾“å…¥æ¡†æ–‡å­—
      const newText =
        textBeforeCursor.substring(0, lastTriggerIndex) +
        suggestionType +
        value +
        " " +
        textAfterCursor;

      userInput.value = newText;
      hideSuggestions();
      userInput.focus();

      // 2. å¦‚æœæ˜¯æ–‡ä»¶å¼•ç”¨ (@)ï¼Œç«‹å³é€šçŸ¥åç«¯è¯»å–è¯¥æ–‡ä»¶å†…å®¹åˆ°ä¸Šä¸‹æ–‡
      if (suggestionType === '@') {
        vscode.postMessage({
          type: 'readFile', // å¤ç”¨ä½ å·²æœ‰çš„ readFile é€»è¾‘
          path: value      // æ³¨æ„ï¼šè¿™é‡Œçš„ value åº”è¯¥æ˜¯ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
        });
      }

      // é‡æ–°è®¡ç®—é«˜åº¦
      userInput.style.height = "auto";
      userInput.style.height = userInput.scrollHeight + "px";
    }

    function addMessage(text, role, isRaw = false) {
      const div = document.createElement("div");
      div.className = `message ${role}-message`;
      div.dataset.content = text; // ä¿å­˜åŸå§‹æ–‡æœ¬å†…å®¹

      // âœ… æ·»åŠ å³é”®èœå•äº‹ä»¶ç›‘å¬
      div.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        e.stopPropagation();
        showContextMenu(e.clientX, e.clientY, div, text);
      });

      // åˆ›å»ºæ¶ˆæ¯å†…å®¹å®¹å™¨ï¼ˆå…ˆæ·»åŠ å†…å®¹ï¼‰
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";

      if (role === "ai") {
        contentDiv.innerHTML = marked.parse(text);
        // å¤„ç† diff ä»£ç å—
        processDiffBlocks(contentDiv);
      } else {
        contentDiv.textContent = text;
      }

      div.appendChild(contentDiv);

      // åˆ›å»ºæ¶ˆæ¯æ“ä½œæŒ‰é’®å®¹å™¨
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "message-actions";

      // å¤åˆ¶æŒ‰é’®
      const copyBtn = document.createElement("button");
      copyBtn.className = "message-action-btn copy-action-btn";
      copyBtn.innerHTML = "ğŸ“‹";
      copyBtn.title = "å¤åˆ¶æ¶ˆæ¯";
      copyBtn.onclick = (e) => {
        e.stopPropagation();
        copyMessageText(text);
      };

      // åˆ é™¤æŒ‰é’®
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "message-action-btn delete-action-btn";
      deleteBtn.innerHTML = "ğŸ—‘ï¸";
      deleteBtn.title = "åˆ é™¤æ¶ˆæ¯";
      deleteBtn.style.pointerEvents = "auto";
      deleteBtn.style.zIndex = "100";
      deleteBtn.onclick = (e) => {
        console.log('[Delete button clicked], target:', e.target);
        e.preventDefault();
        e.stopImmediatePropagation();
        deleteMessage(div);
      };

      actionsDiv.appendChild(copyBtn);
      actionsDiv.appendChild(deleteBtn);
      div.appendChild(actionsDiv);

      chatContainer.appendChild(div);
      scrollToBottom();
      return div;
    }

    // å¤åˆ¶æ¶ˆæ¯æ–‡æœ¬
    function copyMessageText(text) {
      // åœ¨ VS Code webview ç¯å¢ƒä¸­ï¼Œnavigator.clipboard API å¯èƒ½å—åˆ°é™åˆ¶
      // ä½¿ç”¨å¤šç§æ–¹æ³•å°è¯•å¤åˆ¶

      // æ–¹æ³• 1: å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showFlashNotification("âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
          return;
        }).catch((err) => {
          console.warn("Clipboard API å¤±è´¥ï¼Œå°è¯• fallback æ–¹æ³•:", err);
          // ç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
        });
      }

      // æ–¹æ³• 2: ä½¿ç”¨ä¼ ç»Ÿçš„ execCommand æ–¹æ³•ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
      try {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // é¿å…é¡µé¢æ»šåŠ¨
        textArea.style.left = "-9999px";
        textArea.style.top = "0";
        textArea.style.opacity = "0"; // ä¸å¯è§
        document.body.appendChild(textArea);
        textArea.select();
        textArea.setSelectionRange(0, 99999); // é€‰ä¸­å…¨éƒ¨æ–‡æœ¬

        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
          showFlashNotification("âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
          return;
        } else {
          throw new Error("execCommand('copy') å¤±è´¥");
        }
      } catch (err) {
        console.error("execCommand å¤åˆ¶å¤±è´¥:", err);

        // æ–¹æ³• 3: ä½œä¸ºæœ€åçš„ fallbackï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
        alert(`å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š\n\n${text}`);
        return;
      }
    }

    // åˆ é™¤æ¶ˆæ¯
    function deleteMessage(messageElement) {
      console.log('[deleteMessage] Deleting message element:', messageElement);
      if (!messageElement) {
        console.error('[deleteMessage] messageElement is null/undefined');
        return;
      }

      // âŒ ç§»é™¤ confirm å¼¹çª—ï¼Œåœ¨ VS Code webview ç¯å¢ƒä¸­å¯èƒ½è¢«æ‹¦æˆª
      // æ”¹ä¸ºç›´æ¥åˆ é™¤å¹¶æ˜¾ç¤º Toast æç¤º

      try {
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»æ•ˆæœ
        messageElement.style.transition = "opacity 0.3s, transform 0.3s";
        messageElement.style.opacity = "0";
        messageElement.style.transform = "scale(0.9)";

        // ç­‰å¾…åŠ¨ç”»ç»“æŸåç§»é™¤ DOM
        setTimeout(() => {
          if (messageElement.remove) {
            messageElement.remove();
          } else if (messageElement.parentNode) {
            messageElement.parentNode.removeChild(messageElement);
          }
          console.log('[deleteMessage] Element removed successfully');

          // æ˜¾ç¤ºé€šçŸ¥
          showFlashNotification("ğŸ—‘ï¸ æ¶ˆæ¯å·²åˆ é™¤");

          // å¯é€‰ï¼šé€šçŸ¥åç«¯ä»å†å²è®°å½•ä¸­åˆ é™¤
          // vscode.postMessage({ type: "deleteMessage", index: ... });
        }, 300);

      } catch (error) {
        console.error('[deleteMessage] Error removing element:', error);
        showFlashNotification("âœ— åˆ é™¤å¤±è´¥");
      }
    }

    // æ£€æµ‹å¹¶å¤„ç† diff ä»£ç å—
    function processDiffBlocks(messageElement) {
      const codeBlocks = messageElement.querySelectorAll("pre code");

      codeBlocks.forEach((codeBlock, index) => {
        const content = codeBlock.textContent;
        const preElement = codeBlock.parentElement;

        // æ£€æµ‹æ˜¯å¦æ˜¯ diff æ ¼å¼
        if (isDiffContent(content)) {
          preElement.classList.add("diff-block");

          // æ·»åŠ åº”ç”¨æŒ‰é’®
          const applyBtn = document.createElement("button");
          applyBtn.className = "apply-diff-btn";
          applyBtn.innerHTML = "âœ“ Apply";
          applyBtn.title = "Apply this diff to your code";

          // å­˜å‚¨ diff å†…å®¹
          applyBtn.dataset.diffContent = content;
          applyBtn.dataset.diffIndex = index;

          applyBtn.onclick = () => applyDiff(applyBtn, content);

          preElement.appendChild(applyBtn);
        }
      });
    }

    // æ£€æµ‹æ˜¯å¦æ˜¯ diff å†…å®¹
    function isDiffContent(content) {
      const lines = content.trim().split("\n");

      // æ£€æµ‹å¸¸è§çš„ diff æ ¼å¼ç‰¹å¾
      const hasDiffMarkers = lines.some(
        (line) =>
          line.startsWith("+++") ||
          line.startsWith("---") ||
          line.startsWith("@@") ||
          line.match(/^diff --git/),
      );

      // æˆ–è€…æ£€æµ‹æ˜¯å¦æœ‰è¶³å¤Ÿå¤šçš„ +/- è¡Œ
      const changeLines = lines.filter(
        (line) => line.startsWith("+") || line.startsWith("-"),
      );

      return (
        hasDiffMarkers ||
        (changeLines.length >= 3 && changeLines.length / lines.length > 0.3)
      );
    }

    // åº”ç”¨ diff
    function applyDiff(button, diffContent) {
      button.disabled = true;
      button.innerHTML = "â³ Applying...";

      // è§£æ diff å†…å®¹
      const diffData = parseDiff(diffContent);

      if (!diffData) {
        button.innerHTML = "âœ— Invalid Diff";
        button.classList.add("error");
        setTimeout(() => {
          button.disabled = false;
          button.innerHTML = "âœ“ Apply";
          button.classList.remove("error");
        }, 2000);
        return;
      }

      // å‘é€åˆ° VS Code æ‰©å±•è¿›è¡Œåº”ç”¨
      vscode.postMessage({
        type: "applyDiff",
        value: diffData,
      });

      // ç­‰å¾…å“åº”
      button.dataset.pending = "true";
    }

    // è§£æ diff å†…å®¹
    function parseDiff(diffContent) {
      const lines = diffContent.trim().split("\n");
      let currentFile = null;
      const files = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // æ£€æµ‹æ–‡ä»¶å
        if (line.startsWith("--- ") || line.startsWith("+++ ")) {
          const match = line.match(/^[+-]{3}\s+(?:a\/|b\/)?(.+?)(?:\s+|$)/);
          if (match) {
            const filename = match[1];
            if (line.startsWith("---")) {
              currentFile = { oldFile: filename, newFile: null, hunks: [] };
            } else if (currentFile) {
              currentFile.newFile = filename;
              files.push(currentFile);
            }
          }
        }

        // æ£€æµ‹ hunk å¤´éƒ¨ (@@)
        if (line.startsWith("@@") && currentFile) {
          const hunkMatch = line.match(
            /@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/,
          );
          if (hunkMatch) {
            const hunk = {
              oldStart: parseInt(hunkMatch[1]),
              oldLines: parseInt(hunkMatch[2] || "1"),
              newStart: parseInt(hunkMatch[3]),
              newLines: parseInt(hunkMatch[4] || "1"),
              lines: [],
            };

            // æ”¶é›† hunk çš„å†…å®¹
            i++;
            while (
              i < lines.length &&
              !lines[i].startsWith("@@") &&
              !lines[i].startsWith("---")
            ) {
              hunk.lines.push(lines[i]);
              i++;
            }
            i--; // å›é€€ä¸€è¡Œ

            currentFile.hunks.push(hunk);
          }
        }
      }

      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†æ ¼å¼ï¼Œå°è¯•ç®€å•çš„ +/- æ ¼å¼
      if (files.length === 0) {
        const addedLines = [];
        const removedLines = [];
        const contextLines = [];

        lines.forEach((line) => {
          if (line.startsWith("+") && !line.startsWith("+++")) {
            addedLines.push(line.substring(1));
          } else if (line.startsWith("-") && !line.startsWith("---")) {
            removedLines.push(line.substring(1));
          } else if (!line.startsWith("@@")) {
            contextLines.push(line);
          }
        });

        if (addedLines.length > 0 || removedLines.length > 0) {
          return {
            type: "simple",
            added: addedLines,
            removed: removedLines,
            context: contextLines,
            raw: diffContent,
          };
        }
      }

      return files.length > 0
        ? { type: "unified", files, raw: diffContent }
        : null;
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function handleSend() {
      const text = userInput.value.trim();
      if (text) {
        addMessage(text, "user");
        vscode.postMessage({ type: "ask", value: text });
        userInput.value = "";
        userInput.style.height = "auto";
        currentAiMessageElement = null;
        currentAiRawText = "";
        userInput.disabled = true;
        sendBtn.style.display = "none";
        stopBtn.classList.add("visible");

        // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
        const loader = document.createElement("div");
        loader.id = "ai-loader";
        loader.className = "message ai-message system-message";
        loader.innerHTML =
          '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
        chatContainer.appendChild(loader);
        scrollToBottom();
      }
    }

    function handleStop() {
      vscode.postMessage({ type: "stop" });
      addMessage("ğŸ›‘ Generation stopped by user", "system");
    }

    sendBtn.addEventListener("click", handleSend);
    stopBtn.addEventListener("click", handleStop);

    // é”®ç›˜å¯¼èˆªåŠŸèƒ½ - è·Ÿè¸ªå½“å‰é€‰ä¸­çš„æ¶ˆæ¯ç´¢å¼•
    let currentMessageIndex = -1;

    function updateMessageSelection() {
      // æ¯æ¬¡éƒ½é‡æ–°è·å–æœ€æ–°çš„æ¶ˆæ¯åˆ—è¡¨
      const messages = chatContainer.getElementsByClassName("message");

      // ç§»é™¤æ‰€æœ‰æ¶ˆæ¯çš„é€‰ä¸­æ ·å¼
      Array.from(messages).forEach(msg => msg.style.outline = "none");

      // å¦‚æœæœ‰é€‰ä¸­çš„æ¶ˆæ¯ï¼Œæ·»åŠ é«˜äº®æ ·å¼
      if (currentMessageIndex >= 0 && currentMessageIndex < messages.length) {
        messages[currentMessageIndex].style.outline = "2px solid var(--accent)";
        messages[currentMessageIndex].style.outlineOffset = "2px";
      }
    }

    userInput.addEventListener("keydown", (e) => {
      if (suggestionsList.style.display === "block") {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedSuggestionIndex =
            (selectedSuggestionIndex + 1) % currentSuggestions.length;
          updateSuggestionSelection();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedSuggestionIndex =
            (selectedSuggestionIndex - 1 + currentSuggestions.length) %
            currentSuggestions.length;
          updateSuggestionSelection();
        } else if (e.key === "Enter" || e.key === "Tab") {
          e.preventDefault();
          if (selectedSuggestionIndex !== -1) {
            selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
          }
        } else if (e.key === "Escape") {
          hideSuggestions();
        }
        return;
      }

      // é”®ç›˜å¯¼èˆªæ¶ˆæ¯
      const currentMessages = chatContainer.getElementsByClassName("message");

      if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
        // å·¦ç®­å¤´æˆ–ä¸Šç®­å¤´ - ç§»åŠ¨åˆ°ä¸Šä¸€æ¡æ¶ˆæ¯
        e.preventDefault();
        if (currentMessages.length > 0) {
          currentMessageIndex = currentMessageIndex <= 0
            ? currentMessages.length - 1
            : currentMessageIndex - 1;
          updateMessageSelection();
          // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
          currentMessages[currentMessageIndex].scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
          });
        }
      } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
        // å³ç®­å¤´æˆ–ä¸‹ç®­å¤´ - ç§»åŠ¨åˆ°ä¸‹ä¸€æ¡æ¶ˆæ¯
        e.preventDefault();
        if (currentMessages.length > 0) {
          currentMessageIndex = currentMessageIndex >= currentMessages.length - 1
            ? 0
            : currentMessageIndex + 1;
          updateMessageSelection();
          // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
          currentMessages[currentMessageIndex].scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
          });
        }
      } else if (e.key === "Home") {
        // Home - è·³è½¬åˆ°ç¬¬ä¸€æ¡æ¶ˆæ¯
        e.preventDefault();
        if (currentMessages.length > 0) {
          currentMessageIndex = 0;
          updateMessageSelection();
          chatContainer.scrollTop = 0;
        }
      } else if (e.key === "End") {
        // End - è·³è½¬åˆ°æœ€åä¸€æ¡æ¶ˆæ¯
        e.preventDefault();
        if (currentMessages.length > 0) {
          currentMessageIndex = currentMessages.length - 1;
          updateMessageSelection();
          scrollToBottom();
        }
      } else if (e.key === "Escape") {
        // Escape - å–æ¶ˆé€‰ä¸­
        e.preventDefault();
        currentMessageIndex = -1;
        updateMessageSelection();
        // å¦‚æœå³é”®èœå•æ‰“å¼€ï¼Œå…³é—­å®ƒ
        if (contextMenu.classList.contains("visible")) {
          hideContextMenu();
        }
      }

      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ç›‘å¬æ¶ˆæ¯æ·»åŠ ï¼Œæ›´æ–°æ¶ˆæ¯åˆ—è¡¨
    const observer = new MutationObserver((mutations) => {
      // å½“æœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œé‡ç½®é€‰ä¸­çŠ¶æ€åˆ°æœ€åä¸€æ¡
      const messages = chatContainer.getElementsByClassName("message");
      if (messages.length > 0) {
        currentMessageIndex = messages.length - 1;
        updateMessageSelection();
      }
    });
    observer.observe(chatContainer, { childList: true });

    exportBtn.addEventListener("click", () => {
      vscode.postMessage({ type: "exportChat" });
    });

    clearBtn.addEventListener("click", () => {
      vscode.postMessage({ type: "clear" }); // å·²ç»åœ¨ Provider ä¸­å®ç°æ¸…ç†é€»è¾‘
    });

    function updateSuggestionSelection() {
      const items = suggestionsList.querySelectorAll(".suggestion-item");
      items.forEach((item, index) => {
        item.className =
          "suggestion-item" +
          (index === selectedSuggestionIndex ? " selected" : "");
        if (index === selectedSuggestionIndex) {
          item.scrollIntoView({ block: "nearest" });
        }
      });
    }

    // ç›‘å¬æ–‡æœ¬é€‰æ‹©äº‹ä»¶ï¼Œè‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†
    document.addEventListener("mouseup", () => {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();

      if (selectedText) {
        // æ£€æŸ¥é€‰ä¸­çš„æ–‡æœ¬æ˜¯å¦åœ¨èŠå¤©å®¹å™¨å†…
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        const parentElement =
          container.nodeType === Node.TEXT_NODE
            ? container.parentElement
            : container;

        // ç¡®ä¿é€‰ä¸­çš„å†…å®¹åœ¨èŠå¤©å®¹å™¨å†…ï¼Œä¸”ä¸åœ¨è¾“å…¥æ¡†å†…
        if (
          chatContainer.contains(parentElement) &&
          !userInput.contains(parentElement)
        ) {
          userInput.value = selectedText;
          userInput.focus();

          // é‡æ–°è®¡ç®—è¾“å…¥æ¡†é«˜åº¦
          userInput.style.height = "auto";
          userInput.style.height = userInput.scrollHeight + "px";

          // æ¸…é™¤é€‰æ‹©ï¼Œé¿å…è§†è§‰å¹²æ‰°
          selection.removeAllRanges();
        }
      }
    });

    // æ·»åŠ ä¸€ä¸ªæ ‡å¿—æ¥æ ‡è¯†å½“å‰æ˜¯å¦æ­£åœ¨æµå¼æ¥æ”¶AIæ¶ˆæ¯
    let isStreaming = false;

    // æ ‡è®°æ˜¯å¦å·²ç»åŠ è½½è¿‡å†å²è®°å½•
    let historyLoaded = false;

    // å½“å‰æ€è€ƒå—ï¼ˆç”¨äºæµå¼ä¼ è¾“ï¼‰
    let currentThinkingBlock = null;

    window.addEventListener("message", (event) => {
      const message = event.data;
      const loader = document.getElementById("ai-loader");

      switch (message.type) {
        case "closeFilesPanel":
          // å…³é—­æ–‡ä»¶é¢æ¿
          filesPanel.classList.remove("open");
          break;
        case "suggestions":
          showSuggestions(message.value, message.trigger);
          break;
        case "history":
          // åªåŠ è½½ä¸€æ¬¡å†å²è®°å½•ï¼Œé¿å…é‡å¤æ¸²æŸ“
          if (!historyLoaded) {
            historyLoaded = true;
            chatContainer.innerHTML = ""; // æ¸…ç©ºåˆå§‹åŒ–çŠ¶æ€

            if (message.value && message.value.length > 0) {
              message.value.forEach((msg) => {
                addMessage(msg.content, msg.role === "user" ? "user" : "ai");
              });
              // æ»šåŠ¨åˆ°åº•éƒ¨
              requestAnimationFrame(() => {
                scrollToBottom();
              });
            } else {
              chatContainer.innerHTML = '<div class="message system-message">âœ¨ Yuangs AI Agent initialized and ready.</div>';
            }
          }
          break;
        case "appendMessage":
          addMessage(message.value.content, message.value.role === "user" ? "user" : "ai");
          requestAnimationFrame(() => {
            scrollToBottom();
          });
          break;
        case "aiChunk":
          if (loader) {
            loader.remove();
            stopBtn.classList.add("visible");
          }

          // å¼€å§‹æµå¼æ¥æ”¶
          isStreaming = true;

          if (!currentAiMessageElement) {
            // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
            const aiMessageDiv = document.createElement("div");
            aiMessageDiv.className = "message ai-message"; // ç›´æ¥ä½¿ç”¨æœ€ç»ˆæ ·å¼
            // aiMessageDiv.style.minHeight = '24px'; // é˜²æ­¢é«˜åº¦å¡Œé™·
            chatContainer.appendChild(aiMessageDiv);
            currentAiMessageElement = aiMessageDiv;
          }

          currentAiRawText += message.value;

          // å®æ—¶ Markdown æ¸²æŸ“
          // æŠ€å·§ï¼šå¦‚æœä»£ç å—æœªé—­åˆï¼Œæ‰‹åŠ¨ä¸´æ—¶é—­åˆå®ƒä»¥ä¿è¯æ¸²æŸ“æ­£ç¡®
          let textToRender = currentAiRawText;
          const codeBlockCount = (textToRender.match(/```/g) || []).length;
          if (codeBlockCount % 2 !== 0) {
            textToRender += "\n```";
          }

          // æ¸²æŸ“å†…å®¹å¹¶æ·»åŠ å…‰æ ‡
          currentAiMessageElement.innerHTML =
            marked.parse(textToRender) + '<span class="cursor"></span>';

          // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
          // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
          requestAnimationFrame(() => {
            scrollToBottom();
          });
          break;
        case "done":
          // æµå¼ä¼ è¾“ç»“æŸ
          if (isStreaming && currentAiMessageElement) {
            isStreaming = false;

            // âœ… ä¿å­˜å½“å‰æ¶ˆæ¯å…ƒç´ çš„å¼•ç”¨
            const messageElementToDelete = currentAiMessageElement;
            const aiRawTextToCopy = currentAiRawText;

            // ç§»é™¤å…‰æ ‡ï¼Œè¿›è¡Œæœ€ç»ˆæ¸²æŸ“
            currentAiMessageElement.innerHTML =
              marked.parse(currentAiRawText);

            // ä¿å­˜åŸå§‹æ–‡æœ¬å†…å®¹åˆ° dataset
            messageElementToDelete.dataset.content = aiRawTextToCopy;

            // å¤„ç†diffå—å’Œå…¶ä»–åå¤„ç†
            processDiffBlocks(messageElementToDelete, aiRawTextToCopy);
            processCommitSuggestions(messageElementToDelete, aiRawTextToCopy);

            // é‡æ–°æ·»åŠ å³é”®èœå•äº‹ä»¶ç›‘å¬
            messageElementToDelete.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              e.stopPropagation();
              showContextMenu(e.clientX, e.clientY, messageElementToDelete, aiRawTextToCopy);
            });

            // é‡æ–°æ·»åŠ æ¶ˆæ¯æ“ä½œæŒ‰é’®ï¼ˆå› ä¸º innerHTML æ›¿æ¢ä¼šç§»é™¤å®ƒä»¬ï¼‰
            if (!messageElementToDelete.querySelector('.message-actions')) {
              const actionsDiv = document.createElement("div");
              actionsDiv.className = "message-actions";

              const copyBtn = document.createElement("button");
              copyBtn.className = "message-action-btn copy-action-btn";
              copyBtn.innerHTML = "ğŸ“‹";
              copyBtn.title = "å¤åˆ¶æ¶ˆæ¯";
              copyBtn.onclick = (e) => {
                e.stopPropagation();
                copyMessageText(aiRawTextToCopy);
              };

              const deleteBtn = document.createElement("button");
              deleteBtn.className = "message-action-btn delete-action-btn";
              deleteBtn.innerHTML = "ğŸ—‘ï¸";
              deleteBtn.title = "åˆ é™¤æ¶ˆæ¯";
              deleteBtn.style.pointerEvents = "auto";
              deleteBtn.style.zIndex = "100";
              deleteBtn.onclick = (e) => {
                console.log('[Delete button clicked from done case], target:', e.target);
                e.preventDefault();
                e.stopImmediatePropagation();
                deleteMessage(messageElementToDelete);
              };

              actionsDiv.appendChild(copyBtn);
              actionsDiv.appendChild(deleteBtn);
              messageElementToDelete.appendChild(actionsDiv);
            }

            // æ·»åŠ æ·¡å…¥æ•ˆæœæˆ–å…¶ä»–å®ŒæˆåŠ¨æ•ˆ
            messageElementToDelete.classList.add("final-render");

            // é‡è¦ï¼šå¤„ç†å®Œä¸€æ¬¡ AI å›å¤åï¼Œå¦‚æœæ˜¯ commit flowï¼Œé‡ç½®çŠ¶æ€
            // ä½†ä¸èƒ½ç«‹å³é‡ç½®ï¼Œå› ä¸ºå¯èƒ½è¿˜æœ‰åç»­æ¸²æŸ“å¸§ã€‚
            // è¿™é‡Œæˆ‘ä»¬ä¾èµ–ä¸‹ä¸€æ¬¡ triggerGit æ¥è¦†ç›–çŠ¶æ€ï¼Œæˆ–è€…è®¾ç½®ä¸€ä¸ªè¶…æ—¶
            if (lastGitAction === 'commit') {
              setTimeout(() => { lastGitAction = null; }, 1000);
            }
          }

          currentAiMessageElement = null;
          currentAiRawText = "";
          currentThinkingBlock = null;
          userInput.disabled = false;
          userInput.focus();
          sendBtn.style.display = "flex";
          stopBtn.classList.remove("visible");

          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æ–°æ¶ˆæ¯å¯è§
          requestAnimationFrame(() => {
            scrollToBottom();
          });
          break;
        case "clear":
          chatContainer.innerHTML =
            '<div class="message system-message">âœ¨ Chat cleared.</div>';
          userInput.disabled = false;
          userInput.focus();
          sendBtn.style.display = "flex";
          stopBtn.classList.remove("visible");
          break;
        case "error":
          if (loader) loader.remove();
          addMessage("âŒ Error: " + message.value, "system");
          userInput.disabled = false;
          userInput.focus();
          sendBtn.style.display = "flex";
          stopBtn.classList.remove("visible");
          break;
        case "success":
          // æˆåŠŸæ¶ˆæ¯ï¼Œæ˜¾ç¤ºä¸ºç³»ç»Ÿæ¶ˆæ¯
          showFlashNotification(message.value);
          break;
        case "diffApplied":
          // Diff åº”ç”¨æˆåŠŸ
          const successButtons = document.querySelectorAll(
            '.apply-diff-btn[data-pending="true"]',
          );
          successButtons.forEach((btn) => {
            btn.innerHTML = "âœ“ Applied";
            btn.classList.add("applied");
            btn.disabled = true;
            btn.dataset.pending = "false";
          });
          break;
        case "diffError":
          // Diff åº”ç”¨å¤±è´¥
          const errorButtons = document.querySelectorAll(
            '.apply-diff-btn[data-pending="true"]',
          );
          errorButtons.forEach((btn) => {
            btn.innerHTML = "âœ— Failed";
            btn.classList.add("error");
            btn.dataset.pending = "false";
            setTimeout(() => {
              btn.disabled = false;
              btn.innerHTML = "âœ“ Apply";
              btn.classList.remove("error");
            }, 3000);
          });
          if (message.value) {
            addMessage(
              "âŒ Diff application error: " + message.value,
              "system",
            );
          }
          break;
        case "contextUpdate":
          // æ›´æ–°ä¸Šä¸‹æ–‡æ•°æ®
          if (typeof updateContextItems === "function") {
            updateContextItems(message.value);
          }
          break;
        case "showContextPanel":
          // æ˜¾ç¤ºä¸Šä¸‹æ–‡é¢æ¿
          if (typeof showContextPanel === "function") {
            showContextPanel();
          }
          break;
        case "fileTreeData":
          // æ¥æ”¶æ–‡ä»¶æ ‘æ•°æ®
          handleFileTreeData(message.value);
          break;
        case "modelsConfig":
          // æ¥æ”¶æ¨¡å‹é…ç½®
          availableModels = message.value.availableModels || [];
          currentModel = message.value.defaultModel || currentModel;
          renderModelOptions();
          updateCurrentModel(currentModel);
          console.log("Models config received:", availableModels);
          break;
      }
    });

    // === æ—¥å¿—é¢æ¿åŠŸèƒ½ ===

    // æ—¥å¿—é¢æ¿ç›¸å…³å…ƒç´ 
    const logPanel = document.getElementById("log-panel");
    const logPanelContent = document.getElementById("log-panel-content");
    const logStats = document.getElementById("log-stats");
    const logClearBtn = document.getElementById("log-clear-btn");
    const logCopyBtn = document.getElementById("log-copy-btn");
    const logToggleBtn = document.getElementById("log-toggle-btn");

    // æ—¥å¿—å­˜å‚¨
    const logEntries = [];
    const MAX_LOG_ENTRIES = 1000;

    // æ·»åŠ æ—¥å¿—å‡½æ•°
    function addLog(level, message) {
      const timestamp = new Date();
      const timeStr = timestamp.toTimeString().split(' ')[0];
      const logEntry = { timestamp, timeStr, level, message };
      logEntries.push(logEntry);

      if (logEntries.length > MAX_LOG_ENTRIES) {
        logEntries.shift();
      }

      const logDiv = document.createElement("div");
      logDiv.className = `log-entry log-${level.toLowerCase()}`;
      logDiv.innerHTML = `
        <span class="log-time">${timeStr}</span>
        <span class="log-level">[${level.toUpperCase()}]</span>
        <span class="log-message">${escapeHtml(message)}</span>
      `;
      logDiv.addEventListener("click", () => {
        copyLog(`${timeStr} [${level.toUpperCase()}] ${message}`);
      });
      logPanelContent.appendChild(logDiv);
      logPanelContent.scrollTop = logPanelContent.scrollHeight;
      logStats.textContent = `${logEntries.length} entries`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyLog(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showFlashNotification("ğŸ“‹ Log copied");
        }).catch(err => console.warn("Clipboard API å¤±è´¥:", err));
      }
    }

    function clearLogs() {
      logEntries.length = 0;
      logPanelContent.innerHTML = '';
      addLog('info', 'Logs cleared by user');
    }

    function copyAllLogs() {
      const allLogs = logEntries.map(entry =>
        `${entry.timeStr} [${entry.level.toUpperCase()}] ${entry.message}`
      ).join('\n');

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(allLogs).then(() => {
          showFlashNotification(`ğŸ“‹ Copied ${logEntries.length} logs`);
        }).catch(err => console.warn("Clipboard API å¤±è´¥:", err));
      }
    }

    function toggleLogPanel() {
      logPanel.classList.toggle("collapsed");
      const isCollapsed = logPanel.classList.contains("collapsed");
      logToggleBtn.textContent = isCollapsed ? "â–¶" : "â–¼";
    }

    // æ—¥å¿—é¢æ¿äº‹ä»¶ç»‘å®š
    logClearBtn.addEventListener("click", clearLogs);
    logCopyBtn.addEventListener("click", copyAllLogs);
    logToggleBtn.addEventListener("click", toggleLogPanel);

    // æ‹¦æˆª console è¾“å‡º
    const originalConsoleLog = console.log;
    const originalConsoleWarn = console.warn;
    const originalConsoleError = console.error;

    console.log = function (...args) {
      originalConsoleLog.apply(console, args);
      addLog('info', args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' '));
    };

    console.warn = function (...args) {
      originalConsoleWarn.apply(console, args);
      addLog('warn', args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' '));
    };

    console.error = function (...args) {
      originalConsoleError.apply(console, args);
      addLog('error', args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' '));
    };

    // åˆå§‹åŒ–æ—¥å¿—
    addLog('info', 'Log panel initialized successfully');
    console.log('[LOG] Debug panel is ready to capture logs');

    // åˆå§‹åŒ–æ–‡ä»¶é¢æ¿
    if (typeof setupFilesPanel === "function") {
      setupFilesPanel();
    }

    // åˆå§‹åŒ–ä¸Šä¸‹æ–‡é¢æ¿
    if (typeof setupContextPanel === "function") {
      setupContextPanel();
    }

    // === æ–‡ä»¶é¢æ¿åŠŸèƒ½å‡½æ•° ===

    function setupFilesPanel() {
      // æ–‡ä»¶é¢æ¿å¼€å…³
      filesToggle.addEventListener("click", () => {
        filesPanel.classList.toggle("open");
        if (filesPanel.classList.contains("open") && !fileTreeData) {
          loadFileTree();
        }
      });

      filesClose.addEventListener("click", () => {
        filesPanel.classList.remove("open");
      });

      // æœç´¢åŠŸèƒ½
      filesSearch.addEventListener("input", (e) => {
        currentFileSearchQuery = e.target.value.toLowerCase();
        renderFileTree();
      });
    }

    // åŠ è½½æ–‡ä»¶æ ‘
    function loadFileTree() {
      filesPanelContent.innerHTML =
        '<div class="file-loading">Loading files...</div>';
      vscode.postMessage({ type: "loadFileTree" });
    }

    // å¤„ç†æ–‡ä»¶æ ‘æ•°æ®
    function handleFileTreeData(files) {
      allFiles = files;
      fileTreeData = buildFileTree(files);
      renderFileTree();
    }

    // æ„å»ºæ–‡ä»¶æ ‘ç»“æ„
    function buildFileTree(files) {
      const root = {};

      files.forEach((filePath) => {
        const parts = filePath.split("/");
        let current = root;
        let fullPath = "";

        parts.forEach((part, index) => {
          fullPath = fullPath ? fullPath + "/" + part : part;

          if (!current[part]) {
            current[part] = {
              name: part,
              path: fullPath, // ä¿å­˜å®Œæ•´è·¯å¾„
              isFile: index === parts.length - 1,
              children: {},
            };
          }
          current = current[part];
        });
      });

      return root;
    }

    // æ¸²æŸ“æ–‡ä»¶æ ‘
    function renderFileTree() {
      if (!fileTreeData) {
        filesPanelContent.innerHTML =
          '<div class="file-empty">No files loaded</div>';
        return;
      }

      // è¿‡æ»¤æ–‡ä»¶
      let filteredFiles = allFiles;
      if (currentFileSearchQuery) {
        filteredFiles = allFiles.filter((f) =>
          f.toLowerCase().includes(currentFileSearchQuery),
        );
        filesStats.textContent = `${filteredFiles.length} files`;
      } else {
        filesStats.textContent = `${allFiles.length} files`;
      }

      // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
      filesPanelContent.innerHTML = "";

      if (filteredFiles.length === 0) {
        filesPanelContent.innerHTML =
          '<div class="file-empty">No matching files</div>';
        return;
      }

      if (currentFileSearchQuery) {
        // æœç´¢æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰å¹³åˆ—è¡¨
        renderFileList(filteredFiles);
      } else {
        // æ ‘å½¢æ¨¡å¼ï¼šæ˜¾ç¤ºå±‚çº§ç»“æ„
        renderTreeNode(fileTreeData, filesPanelContent, 0);
      }
    }

    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆæœç´¢æ¨¡å¼ï¼‰
    function renderFileList(files) {
      files.forEach((filePath) => {
        const item = document.createElement("div");
        item.className = "file-tree-item file";

        const icon = getFileIcon(filePath);
        const fileName = filePath.split("/").pop();

        item.innerHTML = `
                    <span class="file-tree-icon">${icon}</span>
                    <span class="file-tree-name">${fileName}</span>
                `;

        item.addEventListener("click", () => {
          handleFileClick(filePath);
        });

        filesPanelContent.appendChild(item);
      });
    }

    // æ¸²æŸ“æ ‘èŠ‚ç‚¹
    function renderTreeNode(node, container, level) {
      const entries = Object.entries(node).sort((a, b) => {
        // æ–‡ä»¶å¤¹æ’åœ¨å‰é¢
        if (a[1].isFile && !b[1].isFile) return 1;
        if (!a[1].isFile && b[1].isFile) return -1;
        return a[0].localeCompare(b[0]);
      });

      entries.forEach(([name, data]) => {
        const item = document.createElement("div");

        if (!data.isFile) {
          // æ–‡ä»¶å¤¹
          item.className = "file-tree-item folder";
          item.style.paddingLeft = `${16 + level * 16}px`;

          item.innerHTML = `
                        <span class="file-tree-icon collapsed" data-path="${name}"></span>
                        <span class="file-tree-name">${name}</span>
                    `;

          const childrenContainer = document.createElement("div");
          childrenContainer.className = "file-tree-children";

          item
            .querySelector(".file-tree-icon")
            .addEventListener("click", (e) => {
              e.stopPropagation();
              const icon = e.target;
              if (icon.classList.contains("collapsed")) {
                icon.classList.remove("collapsed");
                icon.classList.add("expanded");
                childrenContainer.classList.add("expanded");
              } else {
                icon.classList.remove("expanded");
                icon.classList.add("collapsed");
                childrenContainer.classList.remove("expanded");
              }
            });

          item.addEventListener("click", () => {
            // é»˜è®¤å±•å¼€/æŠ˜å 
            const icon = item.querySelector(".file-tree-icon");
            icon.click();
          });

          container.appendChild(item);
          container.appendChild(childrenContainer);

          // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
          renderTreeNode(data.children, childrenContainer, level + 1);
        } else {
          // æ–‡ä»¶
          item.className = "file-tree-item file";
          item.style.paddingLeft = `${16 + level * 16}px`;

          const icon = getFileIcon(name);
          item.innerHTML = `
                        <span class="file-tree-icon">${icon}</span>
                        <span class="file-tree-name">${name}</span>
                    `;

          item.addEventListener("click", () => {
            handleFileClick(data.path);
          });

          container.appendChild(item);
        }
      });
    }

    // è·å–æ–‡ä»¶å›¾æ ‡
    function getFileIcon(filename) {
      const ext = filename.split(".").pop().toLowerCase();
      const iconMap = {
        js: "ğŸ“œ",
        ts: "ğŸ“˜",
        tsx: "âš›ï¸",
        jsx: "âš›ï¸",
        html: "ğŸŒ",
        css: "ğŸ¨",
        scss: "ğŸ¨",
        json: "ğŸ“‹",
        md: "ğŸ“",
        py: "ğŸ",
        java: "â˜•",
        go: "ğŸ¹",
        rs: "ğŸ¦€",
        cpp: "âš™ï¸",
        c: "âš™ï¸",
        h: "ğŸ“„",
        vue: "ğŸ’š",
        angular: "ğŸ…°ï¸",
        react: "âš›ï¸",
        yaml: "ğŸ“‹",
        yml: "ğŸ“‹",
        xml: "ğŸ“‹",
        sh: "ğŸ’»",
        bash: "ğŸ’»",
        zsh: "ğŸ’»",
        git: "ğŸ”€",
        lock: "ğŸ”’",
        env: "ğŸ”",
        test: "ğŸ§ª",
        spec: "ğŸ§ª",
      };

      return iconMap[ext] || "ğŸ“„";
    }

    // å¤„ç†æ–‡ä»¶ç‚¹å‡»
    function handleFileClick(filePath) {
      // âœ… ä¿®å¤ï¼šä¸å†ç«‹å³å‘é€ ask æ¶ˆæ¯ï¼Œè€Œæ˜¯åœ¨è¾“å…¥æ¡†ä¸­æ’å…¥ @æ–‡ä»¶è·¯å¾„
      // è¿™æ ·å¯ä»¥è®© @ å¼•ç”¨è§£ææœºåˆ¶æ­£å¸¸å·¥ä½œï¼Œç¡®ä¿æ–‡ä»¶å†…å®¹è¢«æ­£ç¡®åŠ è½½åˆ°ä¸Šä¸‹æ–‡ä¸­

      // å…³é—­æ–‡ä»¶é¢æ¿
      filesPanel.classList.remove("open");

      // åœ¨è¾“å…¥æ¡†ä¸­æ’å…¥ @æ–‡ä»¶è·¯å¾„ å’Œæç¤ºæ–‡æœ¬
      const question = `@${filePath} è¯·åˆ†æè¿™ä¸ªæ–‡ä»¶`;
      userInput.value = question;

      // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
      userInput.style.height = "auto";
      userInput.style.height = userInput.scrollHeight + "px";

      // èšç„¦åˆ°è¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·å¯ä»¥çœ‹åˆ°å¹¶ä¿®æ”¹
      userInput.focus();

      // å°†å…‰æ ‡ç§»åŠ¨åˆ°æœ«å°¾
      userInput.setSelectionRange(question.length, question.length);

      // å¯é€‰ï¼šè‡ªåŠ¨è§¦å‘å‘é€ï¼ˆå¦‚æœä½ å¸Œæœ›è‡ªåŠ¨å‘é€çš„è¯ï¼‰
      // æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»å‘é€æŒ‰é’®
      // sendBtn.click();
    }

    // è·å–æ–‡ä»¶è¯­è¨€ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
    function getFileLanguage(filename) {
      const ext = filename.split(".").pop()?.toLowerCase() || "";
      const langMap = {
        js: "javascript",
        ts: "typescript",
        tsx: "typescript",
        jsx: "javascript",
        py: "python",
        java: "java",
        go: "go",
        rs: "rust",
        cpp: "cpp",
        c: "c",
        h: "c",
        vue: "vue",
        yaml: "yaml",
        yml: "yaml",
        json: "json",
        md: "markdown",
        html: "html",
        css: "css",
        sh: "bash",
        bash: "bash",
      };
      return langMap[ext] || "text";
    }

    // === ä¸Šä¸‹æ–‡é¢æ¿åŠŸèƒ½å‡½æ•° ===

    // ä¸Šä¸‹æ–‡é¢æ¿å¼€å…³
    function setupContextPanel() {
      // ä¸Šä¸‹æ–‡é¢æ¿å¼€å…³
      contextToggle.addEventListener("click", () => {
        contextPanel.classList.toggle("open");
        contextToggle.classList.toggle("visible");
      });

      contextClose.addEventListener("click", () => {
        contextPanel.classList.remove("open");
        contextToggle.classList.remove("visible");
      });

      // è¿‡æ»¤æŒ‰é’®äº‹ä»¶
      contextFilterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          // ç§»é™¤æ‰€æœ‰activeç±»
          contextFilterBtns.forEach((b) => b.classList.remove("active"));
          // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
          btn.classList.add("active");
          // æ›´æ–°è¿‡æ»¤å™¨
          currentFilter = btn.dataset.filter;
          // é‡æ–°æ¸²æŸ“
          renderContextItems();
        });
      });

      // æœç´¢åŠŸèƒ½
      contextSearch.addEventListener("input", (e) => {
        currentSearchQuery = e.target.value.toLowerCase();
        renderContextItems();
      });
    }

    // æ›´æ–°ä¸Šä¸‹æ–‡æ•°æ®
    function updateContextItems(items) {
      const oldCount = currentContextItems.length;
      currentContextItems = items || [];
      const newCount = currentContextItems.length;

      renderContextItems();

      // å¦‚æœæœ‰æ›´æ–°ï¼Œæ˜¾ç¤º flash é€šçŸ¥
      if (newCount > oldCount) {
        showFlashNotification(`ğŸ“‹ Context updated: ${newCount - oldCount} new item${newCount - oldCount > 1 ? 's' : ''} added`);
      }
    }

    // æ¸²æŸ“ä¸Šä¸‹æ–‡é¡¹ç›®
    function renderContextItems() {
      // è¿‡æ»¤ä¸Šä¸‹æ–‡é¡¹ç›®
      let filteredItems = currentContextItems.filter((item) => {
        // ç±»å‹è¿‡æ»¤
        if (currentFilter !== "all" && item.semantic !== currentFilter) {
          return false;
        }

        // æœç´¢è¿‡æ»¤
        if (currentSearchQuery) {
          const searchText = (
            item.path +
            item.summary +
            item.content
          ).toLowerCase();
          if (!searchText.includes(currentSearchQuery)) {
            return false;
          }
        }

        return true;
      });

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      contextStats.textContent = `${filteredItems.length} items`;

      // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
      contextPanelContent.innerHTML = "";

      if (filteredItems.length === 0) {
        contextPanelContent.innerHTML =
          '<div class="context-empty">No context available</div>';
        return;
      }

      // æ¸²æŸ“æ¯ä¸ªä¸Šä¸‹æ–‡é¡¹ç›®
      filteredItems.forEach((item) => {
        const itemElement = createContextItemElement(item);
        contextPanelContent.appendChild(itemElement);
      });
    }

    // åˆ›å»ºå•ä¸ªä¸Šä¸‹æ–‡é¡¹ç›®å…ƒç´ 
    function createContextItemElement(item) {
      const div = document.createElement("div");
      div.className = "context-item collapsed"; // é»˜è®¤æŠ˜å 

      // è·å–å›¾æ ‡
      const icon = getContextIcon(item.semantic);

      // è·å–é‡è¦æ€§ç™¾åˆ†æ¯”
      const importancePercent = item.importance
        ? (item.importance.confidence * 100).toFixed(0)
        : "50";

      // è·å–æ ‡ç­¾HTML
      const badgesHtml = createContextBadges(item);

      // è·å–ç»Ÿè®¡ä¿¡æ¯
      const statsHtml = createContextStats(item);

      // è·å–å†…å®¹é¢„è§ˆ
      const previewText = item.summary || item.content.substring(0, 200);

      div.innerHTML = `
                <div class="context-item-header">
                    <span class="context-item-toggle">â–¶</span>
                    <span class="context-item-icon">${icon}</span>
                    <span class="context-item-title">${item.alias || item.path}</span>
                    <div class="context-item-badges">${badgesHtml}</div>
                </div>
                <div class="context-item-details">
                    <div class="context-item-stats">${statsHtml}</div>
                    <div class="context-usage-bar">
                        <div class="context-usage-fill" style="width: ${importancePercent}%"></div>
                    </div>
                    <div class="context-item-preview">${previewText}</div>
                </div>
            `;

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - åˆ‡æ¢å±•å¼€/æŠ˜å 
      div.addEventListener("click", (e) => {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
        e.stopPropagation();

        // åˆ‡æ¢å±•å¼€/æŠ˜å çŠ¶æ€
        div.classList.toggle("collapsed");
        div.classList.toggle("expanded");

        // å¦‚æœå±•å¼€ï¼Œæ‰“å¼€æ–‡ä»¶
        if (!div.classList.contains("collapsed") && item.path) {
          vscode.postMessage({
            type: "open",
            path: item.path,
          });
        }

        console.log("Context item toggled:", item, "expanded:", !div.classList.contains("collapsed"));
      });

      return div;
    }

    // è·å–ä¸Šä¸‹æ–‡å›¾æ ‡
    function getContextIcon(semantic) {
      const iconMap = {
        source_code: "ğŸ“„",
        log: "ğŸ“‹",
        config: "âš™ï¸",
        documentation: "ğŸ“š",
        test: "ğŸ§ª",
        git: "ğŸ”€",
        evidence: "ğŸ”",
        diagnostics: "âš ï¸",
      };

      return iconMap[semantic] || "ğŸ“„";
    }

    // åˆ›å»ºæ ‡ç­¾
    function createContextBadges(item) {
      const badges = [];

      // ç±»å‹æ ‡ç­¾
      if (item.semantic) {
        badges.push(
          `<span class="context-badge ${item.semantic}">${item.semantic}</span>`,
        );
      }

      // æ ‡ç­¾
      if (item.tags && item.tags.length > 0) {
        item.tags.slice(0, 2).forEach((tag) => {
          badges.push(`<span class="context-badge">${tag}</span>`);
        });
      }

      return badges.join("");
    }

    // åˆ›å»ºç»Ÿè®¡ä¿¡æ¯
    function createContextStats(item) {
      const stats = [];

      // Tokenæ•°é‡
      if (item.tokens) {
        stats.push(
          `<span class="context-stat">ğŸ“Š ${item.tokens} tokens</span>`,
        );
      }

      // ä½¿ç”¨æ¬¡æ•°
      if (item.importance && item.importance.useCount > 0) {
        stats.push(
          `<span class="context-stat">ğŸ”„ ${item.importance.useCount} uses</span>`,
        );
      }

      // æœ€åä½¿ç”¨æ—¶é—´
      if (item.importance && item.importance.lastUsed) {
        const lastUsed = new Date(item.importance.lastUsed);
        const now = new Date();
        const diffMinutes = Math.floor((now - lastUsed) / 60000);

        if (diffMinutes < 1) {
          stats.push(`<span class="context-stat">â° just now</span>`);
        } else if (diffMinutes < 60) {
          stats.push(
            `<span class="context-stat">â° ${diffMinutes}m ago</span>`,
          );
        } else if (diffMinutes < 1440) {
          stats.push(
            `<span class="context-stat">â° ${Math.floor(diffMinutes / 60)}h ago</span>`,
          );
        } else {
          stats.push(
            `<span class="context-stat">â° ${Math.floor(diffMinutes / 1440)}d ago</span>`,
          );
        }
      }

      return stats.join("");
    }

    // æ˜¾ç¤ºä¸Šä¸‹æ–‡é¢æ¿
    function showContextPanel() {
      contextPanel.classList.add("open");
      contextToggle.classList.add("visible");
    }

    // éšè—ä¸Šä¸‹æ–‡é¢æ¿
    function hideContextPanel() {
      contextPanel.classList.remove("open");
      contextToggle.classList.remove("visible");
    }

    // æ˜¾ç¤º flash é€šçŸ¥
    function showFlashNotification(message) {
      const notification = document.createElement("div");
      notification.className = "flash-notification";
      notification.textContent = message;

      document.body.appendChild(notification);

      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // === å³é”®èœå•åŠŸèƒ½ ===

    const contextMenu = document.getElementById("context-menu");
    const contextCopy = document.getElementById("context-copy");
    const contextDelete = document.getElementById("context-delete");

    // å½“å‰å³é”®èœå•å…³è”çš„æ¶ˆæ¯å…ƒç´ å’Œæ–‡æœ¬
    let currentContextMessageElement = null;
    let currentContextMessageText = "";

    // æ˜¾ç¤ºå³é”®èœå•
    function showContextMenu(x, y, messageElement, messageText) {
      currentContextMessageElement = messageElement;
      currentContextMessageText = messageText;

      // è®¾ç½®èœå•ä½ç½®
      contextMenu.style.left = x + "px";
      contextMenu.style.top = y + "px";
      contextMenu.classList.add("visible");
    }

    // éšè—å³é”®èœå•
    function hideContextMenu() {
      contextMenu.classList.remove("visible");
      currentContextMessageElement = null;
      currentContextMessageText = "";
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—å³é”®èœå•
    document.addEventListener("click", (e) => {
      if (!contextMenu.contains(e.target)) {
        hideContextMenu();
      }
    });

    // å³é”®èœå•é¡¹ï¼šå¤åˆ¶
    contextCopy.addEventListener("click", (e) => {
      e.stopPropagation();
      e.preventDefault();
      console.log('[Context menu copy clicked]');
      if (currentContextMessageText) {
        copyMessageText(currentContextMessageText);
      }
      hideContextMenu();
    });

    // å³é”®èœå•é¡¹ï¼šåˆ é™¤
    contextDelete.addEventListener("click", (e) => {
      e.stopPropagation();
      e.preventDefault();
      console.log('[Context menu delete clicked]');
      if (currentContextMessageElement) {
        deleteMessage(currentContextMessageElement);
      }
      hideContextMenu();
    });

    // === æ¨¡å‹é€‰æ‹©å™¨åŠŸèƒ½ ===

    const modelSelector = document.getElementById("model-selector");
    const modelDropdown = document.getElementById("model-dropdown");
    const currentModelLabel = document.getElementById("current-model");

    // å¯ç”¨çš„ AI æ¨¡å‹åˆ—è¡¨ï¼ˆä»åç«¯åŠ è½½ï¼‰
    let availableModels = [];

    // å½“å‰é€‰ä¸­çš„æ¨¡å‹
    let currentModel = "gpt-4o-mini";

    // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨
    function initModelSelector() {
      // ä»æ‰©å±•è·å–æ¨¡å‹é…ç½®
      vscode.postMessage({ type: "getModelsConfig" });
      // åŒæ—¶è·å–å½“å‰é€‰ä¸­çš„æ¨¡å‹
      vscode.postMessage({ type: "getCurrentModel" });

      // ç‚¹å‡»åˆ‡æ¢ä¸‹æ‹‰èœå•
      modelSelector.addEventListener("click", (e) => {
        e.stopPropagation();
        modelDropdown.classList.toggle("visible");
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener("click", (e) => {
        if (!modelSelector.contains(e.target) && !modelDropdown.contains(e.target)) {
          modelDropdown.classList.remove("visible");
        }
      });

      // é˜»æ­¢ä¸‹æ‹‰èœå•å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
      modelDropdown.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    }

    // æ¸²æŸ“æ¨¡å‹é€‰é¡¹
    function renderModelOptions() {
      modelDropdown.innerHTML = "";

      availableModels.forEach((model) => {
        const option = document.createElement("div");
        option.className = `model-option ${model.id === currentModel ? "active" : ""}`;
        option.innerHTML = `
            <span class="model-option-name">
              <strong>${model.name}</strong>
              <br>
              <span style="opacity: 0.6; font-size: 0.9em;">${model.description}</span>
            </span>
            <span class="model-option-icon">${model.id === currentModel ? "âœ“" : ""}</span>
          `;

        option.addEventListener("click", () => {
          selectModel(model.id);
        });

        modelDropdown.appendChild(option);
      });
    }

    // é€‰æ‹©æ¨¡å‹
    function selectModel(modelId) {
      if (currentModel === modelId) {
        modelDropdown.classList.remove("visible");
        return;
      }

      currentModel = modelId;
      currentModelLabel.textContent = availableModels.find(m => m.id === modelId)?.name || modelId;

      // é‡æ–°æ¸²æŸ“é€‰é¡¹ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
      renderModelOptions();

      // å…³é—­ä¸‹æ‹‰èœå•
      modelDropdown.classList.remove("visible");

      // å‘é€åˆ°æ‰©å±•
      vscode.postMessage({ type: "changeModel", value: modelId });

      // æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸæ¶ˆæ¯
      addMessage(`ğŸ”„ å·²åˆ‡æ¢åˆ°æ¨¡å‹: ${availableModels.find(m => m.id === modelId)?.name}`, "system");
    }

    // === Git Operations ===
    let lastGitAction = null; // Track the last action type for context

    function triggerGit(actionType) {
      try {
        console.log('[DEBUG] triggerGit called with action:', actionType);
        const debugStatus = document.getElementById('debug-status');
        if (debugStatus) {
          debugStatus.textContent = 'triggerGit called: ' + actionType;
          debugStatus.style.color = '#00ff00';
        }
        lastGitAction = actionType;
        addMessage(`Running Git ${actionType === 'commit' ? 'Commit Generation' : 'Code Review'} on staged changes...`, 'system');
        vscode.postMessage({
          type: 'gitAction',
          action: actionType
        });
        console.log('[DEBUG] Message posted to vscode');
        if (debugStatus) {
          debugStatus.textContent = 'Message posted: ' + actionType;
        }
      } catch (error) {
        console.error('[ERROR] triggerGit failed:', error);
        alert('Error: ' + error.message);
        const debugStatus = document.getElementById('debug-status');
        if (debugStatus) {
          debugStatus.textContent = 'ERROR: ' + error.message;
          debugStatus.style.color = '#ff0000';
        }
      }
    }

    // ä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨ç»‘å®šæŒ‰é’®ï¼Œè€Œä¸æ˜¯ onclick
    document.addEventListener('DOMContentLoaded', function () {
      const commitBtn = document.getElementById('commit-btn');
      const reviewBtn = document.getElementById('review-btn');

      console.log('[DEBUG] DOM loaded, binding buttons...');

      if (commitBtn) {
        commitBtn.addEventListener('click', function (e) {
          console.log('[DEBUG] Commit button clicked!');
          e.preventDefault();
          e.stopPropagation();
          triggerGit('commit');
        });
        console.log('[DEBUG] Commit button bound');
      } else {
        console.error('[ERROR] Commit button not found!');
      }

      if (reviewBtn) {
        reviewBtn.addEventListener('click', function (e) {
          console.log('[DEBUG] Review button clicked!');
          e.preventDefault();
          e.stopPropagation();
          triggerGit('review');
        });
        console.log('[DEBUG] Review button bound');
      } else {
        console.error('[ERROR] Review button not found!');
      }

      console.log('[DEBUG] All buttons bound successfully');
    });

    function processCommitSuggestions(messageElement, rawText) {
      // If user explicitly requested a commit message, be more lenient with detection
      // Otherwise, stick to stricter regex to avoid false positives in general chat
      const content = rawText.trim();
      let isCommitMsg = false;

      if (lastGitAction === 'commit') {
        // Context-aware: If we just asked for a commit, almost any non-empty short text is likely one
        isCommitMsg = content.length > 0 && content.length < 500;
        // Reset after processing to avoid affecting future messages
        // (Wait a bit in case of streaming chunks affecting logic, but here we process final block)
      } else {
        // Fallback: Standard heuristic detection
        isCommitMsg = /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?:/.test(content) && content.length < 300;
      }

      if (isCommitMsg) {
        // Avoid adding duplicate buttons
        if (!messageElement.querySelector('.apply-commit-btn')) {
          const applyBtn = document.createElement('button');
          applyBtn.className = 'apply-commit-btn';
          applyBtn.innerHTML = `<span>ğŸ“¥</span> Apply to Git Input`;
          applyBtn.onclick = () => {
            vscode.postMessage({
              type: 'applyCommitMessage',
              value: content
            });
            applyBtn.innerHTML = `<span>âœ…</span> Applied`;
            applyBtn.disabled = true;
            applyBtn.style.opacity = '0.7';
          };
          messageElement.appendChild(applyBtn);
        }
      }
    }

    // === Patch åŠŸèƒ½ ===
    const patchBtn = document.getElementById('patch-btn');
    const patchDropdown = document.getElementById('patch-dropdown');
    const patchOptions = document.querySelectorAll('.patch-option');

    if (patchBtn) {
      patchBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        patchDropdown.classList.toggle('visible');
      });

      // ç‚¹å‡»é€‰é¡¹ç”Ÿæˆ patch
      patchOptions.forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const type = option.dataset.type;
          patchDropdown.classList.remove('visible');

          vscode.postMessage({
            type: 'generatePatch',
            value: type
          });
        });
      });
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', (e) => {
      if (patchBtn && patchDropdown && !patchBtn.contains(e.target) && !patchDropdown.contains(e.target)) {
        patchDropdown.classList.remove('visible');
      }
    });
    function updateCurrentModel(modelId) {
      currentModel = modelId;
      const model = availableModels.find(m => m.id === modelId);
      currentModelLabel.textContent = model ? model.name : modelId;
      renderModelOptions();
    }

    // åœ¨æ¶ˆæ¯ç›‘å¬å™¨ä¸­æ·»åŠ æ¨¡å‹ç›¸å…³å¤„ç†
    window.addEventListener("message", (event) => {
      const message = event.data;

      // åœ¨ç°æœ‰çš„ switch è¯­å¥ä¸­æ·»åŠ æ–° case
      if (message.type === "currentModel") {
        updateCurrentModel(message.value);
      }
    });

    // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨
    initModelSelector();
  </script>
</body>

</html>