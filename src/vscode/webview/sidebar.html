<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yuangs Premium AI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        --bubble-user: var(--vscode-button-background);
        --bubble-ai: var(--vscode-editor-background);
        --text-main: var(--vscode-foreground);
        --accent: var(--vscode-focusBorder);
        --border: var(--vscode-panel-border);
        --input-bg: var(--vscode-input-background);
      }

      body {
        font-family:
          var(--vscode-font-family),
          "Inter",
          -apple-system,
          sans-serif;
        font-size: var(--vscode-font-size);
        color: var(--text-main);
        background: var(--vscode-sideBar-background);
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* È°∂ÈÉ®Ë£ÖÈ•∞Á∫ø‰∏éÊ†áÈ¢òÊ†è */
      header {
        height: 40px;
        width: 100%;
        background: var(--vscode-sideBar-background);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        box-sizing: border-box;
        z-index: 100;
      }

      header::before {
        content: "";
        height: 2px;
        width: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        position: absolute;
        top: 0;
        left: 0;
      }

      .header-title {
        font-size: 0.9em;
        font-weight: bold;
        opacity: 0.8;
      }

      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        z-index: 2000;
      }

      .icon-btn {
        background: transparent;
        border: none;
        color: var(--text-main);
        cursor: pointer;
        opacity: 0.6;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        border-radius: 4px;
      }

      /* Ê®°ÂûãÈÄâÊã©Âô®Ê†∑Âºè */
      .model-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 8px;
        background: var(--vscode-input-background);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .model-selector:hover {
        border-color: var(--accent);
      }

      .model-selector-label {
        font-size: 0.75em;
        opacity: 0.8;
        white-space: nowrap;
      }

      .model-selector-dropdown {
        position: absolute;
        top: 40px;
        right: 12px;
        background: var(--vscode-editor-background);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 3000;
      }

      .model-selector-dropdown.visible {
        display: block;
      }

      .model-option {
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.85em;
      }

      .model-option:hover {
        background: var(--vscode-list-hoverBackground);
      }

      .model-option.active {
        background: var(--vscode-list-activeSelectionBackground);
        color: var(--vscode-list-activeSelectionForeground);
      }

      .model-option-name {
        flex: 1;
      }

      .model-option-icon {
        opacity: 0.5;
        font-size: 0.8em;
      }

      .model-option.active .model-option-icon {
        opacity: 1;
      }

      .icon-btn:hover {
        opacity: 1;
        background: var(--vscode-toolbar-hoverBackground);
      }

      .icon-btn.context-btn {
        opacity: 1 !important;
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: 1px solid var(--vscode-focusBorder);
        z-index: 2000;
        padding: 6px 12px;
      }

      .icon-btn.context-btn:hover {
        opacity: 1;
        background: var(--vscode-button-hoverBackground);
      }

      #chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        scroll-behavior: smooth;
      }

      /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
      #chat-container::-webkit-scrollbar {
        width: 6px;
      }

      #chat-container::-webkit-scrollbar-thumb {
        background: var(--vscode-scrollbarSlider-background);
        border-radius: 10px;
      }

      .message {
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
        position: relative;
        animation: fadeIn 0.3s ease-out;
        line-height: 1.5;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆÂÆπÂô® */
      .message-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
      }

      .message:hover .message-actions {
        opacity: 1;
      }

      /* Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆ */
      .message-action-btn {
        background: rgba(0, 0, 0, 0.6);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        font-size: 14px;
        transition: all 0.2s;
      }

      .message-action-btn:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
      }

      .message-action-btn:active {
        transform: scale(0.95);
      }

      .user-message .message-action-btn {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .user-message .message-action-btn:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-message {
        align-self: flex-end;
        background: var(--bubble-user);
        color: var(--vscode-button-foreground);
        border-bottom-right-radius: 2px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .ai-message {
        align-self: flex-start;
        background: var(--bubble-ai);
        border: 1px solid var(--border);
        border-bottom-left-radius: 2px;
        backdrop-filter: blur(10px);
      }

      /* Markdown Ê†∑Âºè */
      .ai-message pre {
        background: rgba(0, 0, 0, 0.2);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 8px 0;
        position: relative;
      }

      /* Diff ‰ª£Á†ÅÂùóÊ†∑Âºè */
      .ai-message pre.diff-block {
        border: 1px solid var(--vscode-editorWidget-border);
        background: rgba(0, 0, 0, 0.3);
      }

      .ai-message pre.diff-block::before {
        content: "üìù Diff";
        position: absolute;
        top: 4px;
        left: 8px;
        font-size: 0.75em;
        opacity: 0.6;
        font-family: var(--vscode-font-family);
      }

      /* Â∫îÁî®ÊåâÈíÆ */
      .apply-diff-btn {
        position: absolute;
        top: 4px;
        right: 8px;
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75em;
        font-family: var(--vscode-font-family);
        display: flex;
        align-items: center;
        gap: 4px;
        opacity: 0;
        transition:
          opacity 0.2s,
          background 0.2s;
        z-index: 10;
      }

      .ai-message pre.diff-block:hover .apply-diff-btn {
        opacity: 1;
      }

      .apply-diff-btn:hover {
        background: var(--vscode-button-hoverBackground);
      }

      .apply-diff-btn:active {
        transform: scale(0.95);
      }

      .apply-diff-btn.applied {
        background: var(--vscode-testing-iconPassed);
        opacity: 1;
      }

      .apply-diff-btn.error {
        background: var(--vscode-testing-iconFailed);
        opacity: 1;
      }

      .ai-message code {
        font-family: var(--vscode-editor-font-family);
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 4px;
        border-radius: 4px;
      }

      .system-message {
        align-self: center;
        font-size: 0.85em;
        color: var(--vscode-descriptionForeground);
        background: transparent;
        box-shadow: none;
        text-align: center;
        opacity: 0.7;
      }

      #input-area {
        padding: 16px;
        background: var(--vscode-sideBar-background);
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
      }

      .input-wrapper {
        display: flex;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px 8px;
        align-items: center;
        transition: border-color 0.2s;
      }

      .input-wrapper:focus-within {
        border-color: var(--accent);
      }

      #user-input {
        flex-grow: 1;
        background: transparent;
        color: var(--vscode-input-foreground);
        border: none;
        padding: 8px;
        outline: none;
        resize: none;
        max-height: 120px;
        min-height: 24px;
        font-family: inherit;
      }

      #send-btn {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
      }

      #send-btn:hover {
        opacity: 0.9;
      }

      #stop-btn {
        background: var(--vscode-errorForeground);
        color: var(--vscode-button-foreground);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
        animation: pulse 1.5s infinite;
      }

      #stop-btn:hover {
        opacity: 0.8;
      }

      #stop-btn.visible {
        display: flex;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(235, 86, 86, 0.7);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(235, 86, 86, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(235, 86, 86, 0);
        }
      }

      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 4px;
      }

      .dot {
        width: 6px;
        height: 6px;
        background: #aaa;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }

      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }

        40% {
          transform: scale(1);
        }
      }

      /* Âª∫ËÆÆÂàóË°®Ê†∑Âºè */
      #suggestions-list {
        position: absolute;
        bottom: 100%;
        left: 16px;
        right: 16px;
        background: var(--vscode-editor-background);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
        margin-bottom: 8px;
      }

      .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
      }

      .suggestion-item:hover,
      .suggestion-item.selected {
        background: var(--vscode-list-hoverBackground);
        color: var(--vscode-list-hoverForeground);
      }

      .suggestion-icon {
        opacity: 0.7;
        font-size: 1.1em;
      }

      /* ÊµÅÂºè‰º†ËæìÊúüÈó¥ÁöÑËçâÁ®øÊÄÅÊ†∑Âºè */
      .streaming-draft {
        font-family: "Courier New", Consolas, Monaco, monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.4;
      }

      .streaming-content {
        margin: 0;
        padding: 0;
        font-family: inherit;
        line-height: inherit;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .final-render {
        /* ÊúÄÁªàÊ∏≤ÊüìÂÆåÊàêÂêéÁöÑÊ†∑Âºè */
      }

      /* ÂÖâÊ†áÈó™ÁÉÅÊïàÊûú */
      .cursor {
        display: inline-block;
        width: 8px;
        height: 16px;
        background: var(--text-main);
        margin-left: 4px;
        animation: blink 1s step-start infinite;
        vertical-align: middle;
        opacity: 0.8;
        border-radius: 1px;
      }

      @keyframes blink {
        50% {
          opacity: 0;
        }
      }

      /* Êñá‰ª∂Èù¢ÊùøÊ†∑Âºè */
      #files-panel {
        position: fixed;
        top: 40px;
        left: -400px;
        width: 380px;
        height: calc(100vh - 40px);
        background: var(--vscode-sideBar-background);
        border-right: 1px solid var(--border);
        border-top: 1px solid var(--border);
        z-index: 1000;
        transition: left 0.3s ease;
        display: flex;
        flex-direction: column;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.2);
      }

      #files-panel.open {
        left: 0;
      }

      .files-panel-header {
        padding: 12px 16px;
        background: var(--vscode-editor-background);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .files-panel-title {
        font-weight: bold;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .files-panel-stats {
        font-size: 0.75em;
        opacity: 0.7;
      }

      .files-panel-close {
        background: transparent;
        border: none;
        color: var(--text-main);
        cursor: pointer;
        padding: 4px;
        opacity: 0.6;
      }

      .files-panel-close:hover {
        opacity: 1;
      }

      .files-panel-controls {
        padding: 8px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 8px;
      }

      .files-search {
        flex: 1;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 6px 10px;
        color: var(--vscode-input-foreground);
        font-size: 0.85em;
        outline: none;
      }

      .files-search:focus {
        border-color: var(--accent);
      }

      .files-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
      }

      .file-tree-item {
        display: flex;
        align-items: center;
        padding: 4px 16px;
        cursor: pointer;
        transition: background 0.2s;
        user-select: none;
      }

      .file-tree-item:hover {
        background: var(--vscode-list-hoverBackground);
      }

      .file-tree-item.selected {
        background: var(--vscode-list-activeSelectionBackground);
        color: var(--vscode-list-activeSelectionForeground);
      }

      .file-tree-icon {
        margin-right: 6px;
        font-size: 1em;
        opacity: 0.8;
        flex-shrink: 0;
      }

      .file-tree-icon.expanded::before {
        content: "‚ñº";
        font-size: 0.7em;
        margin-right: 2px;
      }

      .file-tree-icon.collapsed::before {
        content: "‚ñ∂";
        font-size: 0.7em;
        margin-right: 2px;
      }

      .file-tree-name {
        flex: 1;
        font-size: 0.85em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .file-tree-children {
        display: none;
      }

      .file-tree-children.expanded {
        display: block;
      }

      .file-tree-item.folder {
        font-weight: 500;
      }

      .file-tree-item.file {
        opacity: 0.9;
      }

      .file-empty {
        text-align: center;
        padding: 40px 20px;
        opacity: 0.5;
        font-size: 0.9em;
      }

      .file-loading {
        text-align: center;
        padding: 20px;
        opacity: 0.7;
      }

      /* ‰∏ä‰∏ãÊñáÈù¢ÊùøÊ†∑Âºè */
      #context-panel {
        position: fixed;
        top: 40px;
        right: -400px;
        width: 380px;
        height: calc(100vh - 40px);
        background: var(--vscode-sideBar-background);
        border-left: 1px solid var(--border);
        border-top: 1px solid var(--border);
        z-index: 1000;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
        box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
      }

      #context-panel.open {
        right: 0;
      }

      .context-panel-header {
        padding: 12px 16px;
        background: var(--vscode-editor-background);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .context-panel-title {
        font-weight: bold;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .context-panel-stats {
        font-size: 0.75em;
        opacity: 0.7;
      }

      .context-panel-close {
        background: transparent;
        border: none;
        color: var(--text-main);
        cursor: pointer;
        padding: 4px;
        opacity: 0.6;
      }

      .context-panel-close:hover {
        opacity: 1;
      }

      .context-panel-controls {
        padding: 8px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .context-search {
        flex: 1;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 6px 10px;
        color: var(--vscode-input-foreground);
        font-size: 0.85em;
        outline: none;
      }

      .context-search:focus {
        border-color: var(--accent);
      }

      .context-filter-btn {
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 4px 8px;
        color: var(--text-main);
        cursor: pointer;
        font-size: 0.75em;
        transition: all 0.2s;
      }

      .context-filter-btn:hover,
      .context-filter-btn.active {
        background: var(--accent);
        color: var(--vscode-button-foreground);
        border-color: var(--accent);
      }

      .context-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
      }

      .context-item {
        background: var(--vscode-editor-background);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        overflow: hidden;
      }

      .context-item.collapsed .context-item-details {
        display: none;
      }

      .context-item.collapsed {
        padding: 8px 12px;
      }

      .context-item.expanded {
        padding: 12px;
      }

      .context-item:hover {
        border-color: var(--accent);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .context-item-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .context-item.collapsed .context-item-header {
        margin-bottom: 0;
      }

      .context-item-toggle {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.6;
        transition: transform 0.2s;
      }

      .context-item.expanded .context-item-toggle {
        transform: rotate(90deg);
      }

      .context-item-details {
        animation: slideDown 0.2s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }


      .context-item-icon {
        font-size: 1.2em;
      }

      .context-item-title {
        flex: 1;
        font-weight: 500;
        font-size: 0.85em;
        word-break: break-all;
      }

      .context-item-badges {
        display: flex;
        gap: 4px;
      }

      .context-badge {
        background: rgba(127, 127, 127, 0.2);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.7em;
        opacity: 0.8;
      }

      .context-badge.source_code {
        background: rgba(86, 156, 214, 0.2);
      }

      .context-badge.log {
        background: rgba(152, 195, 121, 0.2);
      }

      .context-badge.git {
        background: rgba(229, 192, 123, 0.2);
      }

      .context-badge.diagnostics {
        background: rgba(224, 108, 117, 0.2);
      }

      .context-item-stats {
        display: flex;
        gap: 12px;
        font-size: 0.75em;
        opacity: 0.7;
        margin-bottom: 8px;
      }

      .context-stat {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .context-usage-bar {
        height: 3px;
        background: rgba(127, 127, 127, 0.2);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .context-usage-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--vscode-focusBorder),
          var(--accent)
        );
        border-radius: 2px;
        transition: width 0.3s ease;
      }

      .context-item-preview {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        padding: 8px;
        font-family: var(--vscode-editor-font-family);
        font-size: 0.8em;
        max-height: 100px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .context-empty {
        text-align: center;
        padding: 40px 20px;
        opacity: 0.5;
        font-size: 0.9em;
      }

      /* Flash notification styles */
      .flash-notification {
        position: fixed;
        top: 60px;
        right: 400px;
        background: var(--vscode-notificationsInfoIcon-foreground);
        color: var(--vscode-notificationsInfoIcon-background);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 5000;
        font-size: 0.9em;
        animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
        max-width: 300px;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      /* Update indicator for context panel */
      .context-panel-update-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        background: var(--vscode-testing-iconPassed);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="header-title">YUANGS AI</div>
      <div class="header-actions">
        <!-- Ê®°ÂûãÈÄâÊã©Âô® -->
        <div class="model-selector" id="model-selector" title="Select AI Model">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6;">
            <path d="M8 1a7 7 0 0 1 0 14A7 7 0 0 1 8 1zM0 8a8 8 0 1 0 16 0A8 8 0 0 0 0 8zm8 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm1-2.5V6H7v4.5h2z"/>
          </svg>
          <span class="model-selector-label" id="current-model">Loading...</span>
          <svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.5;">
            <path d="M8 11L3 6h2.5L8 8.5L10.5 6H13L8 11z"/>
          </svg>
        </div>
        <!-- Ê®°Âûã‰∏ãÊãâËèúÂçï -->
        <div class="model-selector-dropdown" id="model-dropdown">
          <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
        </div>
        <button class="icon-btn" id="files-toggle" title="Show Files">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M1 3.5A1.5 1.5 0 0 1 2.5 2h3.879a1.5 1.5 0 0 1 1.06.44l1.122 1.12A1.5 1.5 0 0 0 9.62 4H13.5A1.5 1.5 0 0 1 15 5.5v8a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5v-10zM2.5 3a.5.5 0 0 0-.5.5V13a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5V5.5a.5.5 0 0 0-.5-.5H9.62a1.5 1.5 0 0 1-1.06-.44l-1.12-1.12A1.5 1.5 0 0 0 6.38 3H2.5zM4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM4 10a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z"
            />
          </svg>
        </button>
        <button
          class="icon-btn context-btn"
          id="context-toggle"
          title="Show Context Panel"
          style="z-index: 2000"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L10.293 7.5H4.5z"
            />
          </svg>
          <span style="margin-left: 4px; font-size: 0.8em">Context</span>
        </button>
        <button
          class="icon-btn"
          id="export-btn"
          title="Export Chat History (.md)"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM13 5H9V1h4v4zM3 2v12h10V6H8V2H3z"
            />
          </svg>
        </button>
        <button class="icon-btn" id="clear-btn" title="Clear Chat">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M10 3h3v1h-1v9l-1 1H4l-1-1V4H2V3h3V2a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v1zM9 2H6v1h3V2zM4 4v9h7V4H4z"
            />
          </svg>
        </button>
      </div>
    </header>

    <div id="chat-container">
      <!-- ÂàùÂßã‰∏∫Á©∫ÔºåÁ≠âÂæÖÂéÜÂè≤ËÆ∞ÂΩïÂä†ËΩΩ -->
    </div>

    <div id="input-area">
      <div id="suggestions-list"></div>
      <div class="input-wrapper">
        <textarea
          id="user-input"
          rows="1"
          placeholder="Type your message..."
        ></textarea>
        <button id="send-btn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M1.146 1.146a.5.5 0 0 1 .538-.093l13 5a.5.5 0 0 1 0 .94l-13 5a.5.5 0 0 1-.667-.615L2.854 8 1.017 2.618a.5.5 0 0 1 .129-.472zM3.854 8l-1.5 4.34L13.84 8 2.354 3.66 3.854 8z"
            />
          </svg>
        </button>
        <button id="stop-btn" title="Stop Generation">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M4 4h8v8H4V4z"
            />
          </svg>
        </button>
      </div>
    </div>

    <!-- Êñá‰ª∂Èù¢Êùø -->
    <div id="files-panel">
      <div class="files-panel-header">
        <div class="files-panel-title">
          <span>üìÅ Files</span>
          <span class="files-panel-stats" id="files-stats">Loading...</span>
        </div>
        <button class="files-panel-close" id="files-close">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"
            />
          </svg>
        </button>
      </div>
      <div class="files-panel-controls">
        <input
          type="text"
          class="files-search"
          id="files-search"
          placeholder="Search files..."
        />
      </div>
      <div class="files-panel-content" id="files-panel-content">
        <div class="file-loading">Loading files...</div>
      </div>
    </div>

    <!-- ‰∏ä‰∏ãÊñáÈù¢Êùø -->
    <div id="context-panel">
      <div class="context-panel-header">
        <div class="context-panel-title">
          <span>üìã Context</span>
          <span class="context-panel-stats" id="context-stats">0 items</span>
        </div>
        <button class="context-panel-close" id="context-close">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path
              d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"
            />
          </svg>
        </button>
      </div>
      <div class="context-panel-controls">
        <input
          type="text"
          class="context-search"
          id="context-search"
          placeholder="Search context..."
        />
        <button class="context-filter-btn active" data-filter="all">All</button>
        <button class="context-filter-btn" data-filter="source_code">
          Code
        </button>
        <button class="context-filter-btn" data-filter="log">Log</button>
        <button class="context-filter-btn" data-filter="git">Git</button>
      </div>
      <div class="context-panel-content" id="context-panel-content">
        <div class="context-empty">No context available</div>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      const chatContainer = document.getElementById("chat-container");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const stopBtn = document.getElementById("stop-btn");
      const exportBtn = document.getElementById("export-btn");
      const clearBtn = document.getElementById("clear-btn");
      const suggestionsList = document.getElementById("suggestions-list");

      // ‰∏ä‰∏ãÊñáÈù¢ÊùøÁõ∏ÂÖ≥ÂÖÉÁ¥†
      const filesPanel = document.getElementById("files-panel");
      const filesToggle = document.getElementById("files-toggle");
      const filesClose = document.getElementById("files-close");
      const filesPanelContent = document.getElementById("files-panel-content");
      const filesSearch = document.getElementById("files-search");
      const filesStats = document.getElementById("files-stats");

      const contextPanel = document.getElementById("context-panel");
      const contextToggle = document.getElementById("context-toggle");
      const contextClose = document.getElementById("context-close");
      const contextPanelContent = document.getElementById(
        "context-panel-content",
      );
      const contextSearch = document.getElementById("context-search");
      const contextStats = document.getElementById("context-stats");
      const contextFilterBtns = document.querySelectorAll(
        ".context-filter-btn",
      );

      let currentAiMessageElement = null;
      let currentAiRawText = "";
      let suggestionType = null; // '@' or '#'
      let selectedSuggestionIndex = -1;
      let currentSuggestions = [];

      // ‰∏ä‰∏ãÊñáÁõ∏ÂÖ≥Áä∂ÊÄÅ
      let currentContextItems = [];
      let currentFilter = "all";
      let currentSearchQuery = "";

      // Êñá‰ª∂Áõ∏ÂÖ≥Áä∂ÊÄÅ
      let fileTreeData = null;
      let currentFileSearchQuery = "";
      let allFiles = [];

      // ËæìÂÖ•Ê°ÜÈ´òÂ∫¶Ëá™Âä®‰º∏Áº©
      userInput.addEventListener("input", (e) => {
        userInput.style.height = "auto";
        userInput.style.height = userInput.scrollHeight + "px";

        handleTriggerDetection(e);
      });

      function handleTriggerDetection(e) {
        const value = userInput.value;
        const cursorPos = userInput.selectionStart;
        const textBeforeCursor = value.substring(0, cursorPos);

        // Ê£ÄÊµãËß¶ÂèëÁ¨¶
        const lastAt = textBeforeCursor.lastIndexOf("@");
        const lastHash = textBeforeCursor.lastIndexOf("#");
        const lastTriggerIndex = Math.max(lastAt, lastHash);

        if (
          lastTriggerIndex !== -1 &&
          (lastTriggerIndex === 0 ||
            /\s/.test(textBeforeCursor[lastTriggerIndex - 1]))
        ) {
          const trigger = textBeforeCursor[lastTriggerIndex];
          const query = textBeforeCursor.substring(lastTriggerIndex + 1);

          // Âè™ÊúâÂΩìÊü•ËØ¢‰∏≠Ê≤°ÊúâÁ©∫Ê†ºÊó∂ÊâçËß¶ÂèëÔºàÁ©∫Êü•ËØ¢‰πüÂÖÅËÆ∏Ëß¶ÂèëÔºâ
          if (!/\s/.test(query)) {
            suggestionType = trigger;

            // Á´ãÂç≥ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            suggestionsList.innerHTML =
              '<div class="suggestion-item">üîç Loading...</div>';
            suggestionsList.style.display = "block";

            if (trigger === "@") {
              vscode.postMessage({ type: "getFiles", query });
            } else {
              vscode.postMessage({ type: "getSymbols", query });
            }
            return;
          }
        }

        hideSuggestions();
      }

      function showSuggestions(suggestions, trigger) {
        currentSuggestions = suggestions;
        if (suggestions.length === 0) {
          hideSuggestions();
          return;
        }

        suggestionsList.innerHTML = "";
        suggestionsList.style.display = "block";
        selectedSuggestionIndex = 0;

        suggestions.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "suggestion-item" + (index === 0 ? " selected" : "");
          const icon = trigger === "@" ? "üìÑ" : "üîß";
          div.innerHTML = `<span class="suggestion-icon">${icon}</span><span>${item}</span>`;
          div.onclick = () => selectSuggestion(item);
          suggestionsList.appendChild(div);
        });
      }

      function hideSuggestions() {
        suggestionsList.style.display = "none";
        suggestionType = null;
        selectedSuggestionIndex = -1;
      }

      function selectSuggestion(value) {
        const text = userInput.value;
        const cursorPos = userInput.selectionStart;
        const textBeforeCursor = text.substring(0, cursorPos);
        const textAfterCursor = text.substring(cursorPos);

        const lastTriggerIndex = textBeforeCursor.lastIndexOf(suggestionType);

        // 1. Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÊñáÂ≠ó
        const newText =
          textBeforeCursor.substring(0, lastTriggerIndex) +
          suggestionType +
          value +
          " " +
          textAfterCursor;

        userInput.value = newText;
        hideSuggestions();
        userInput.focus();

        // 2. Â¶ÇÊûúÊòØÊñá‰ª∂ÂºïÁî® (@)ÔºåÁ´ãÂç≥ÈÄöÁü•ÂêéÁ´ØËØªÂèñËØ•Êñá‰ª∂ÂÜÖÂÆπÂà∞‰∏ä‰∏ãÊñá
        if (suggestionType === '@') {
            vscode.postMessage({
                type: 'readFile', // Â§çÁî®‰Ω†Â∑≤ÊúâÁöÑ readFile ÈÄªËæë
                path: value      // Ê≥®ÊÑèÔºöËøôÈáåÁöÑ value Â∫îËØ•ÊòØÁõ∏ÂØπË∑ØÂæÑÊàñÁªùÂØπË∑ØÂæÑ
            });
        }

        // ÈáçÊñ∞ËÆ°ÁÆóÈ´òÂ∫¶
        userInput.style.height = "auto";
        userInput.style.height = userInput.scrollHeight + "px";
      }

      function addMessage(text, role, isRaw = false) {
        const div = document.createElement("div");
        div.className = `message ${role}-message`;
        div.dataset.content = text; // ‰øùÂ≠òÂéüÂßãÊñáÊú¨ÂÜÖÂÆπ

        // ÂàõÂª∫Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆÂÆπÂô®
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "message-actions";

        // Â§çÂà∂ÊåâÈíÆ
        const copyBtn = document.createElement("button");
        copyBtn.className = "message-action-btn";
        copyBtn.innerHTML = "üìã";
        copyBtn.title = "Â§çÂà∂Ê∂àÊÅØ";
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          copyMessageText(text);
        };

        // Âà†Èô§ÊåâÈíÆ
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "message-action-btn";
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.title = "Âà†Èô§Ê∂àÊÅØ";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteMessage(div);
        };

        actionsDiv.appendChild(copyBtn);
        actionsDiv.appendChild(deleteBtn);
        div.appendChild(actionsDiv);

        // ÂàõÂª∫Ê∂àÊÅØÂÜÖÂÆπÂÆπÂô®
        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        if (role === "ai") {
          contentDiv.innerHTML = marked.parse(text);
          // Â§ÑÁêÜ diff ‰ª£Á†ÅÂùó
          processDiffBlocks(contentDiv);
        } else {
          contentDiv.textContent = text;
        }

        div.appendChild(contentDiv);
        chatContainer.appendChild(div);
        scrollToBottom();
        return div;
      }

      // Â§çÂà∂Ê∂àÊÅØÊñáÊú¨
      function copyMessageText(text) {
        navigator.clipboard.writeText(text).then(() => {
          showFlashNotification("‚úì Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø");
        }).catch((err) => {
          console.error("Â§çÂà∂Â§±Ë¥•:", err);
          showFlashNotification("‚úó Â§çÂà∂Â§±Ë¥•");
        });
      }

      // Âà†Èô§Ê∂àÊÅØ
      function deleteMessage(messageElement) {
        if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü")) {
          // ‰ªé DOM ‰∏≠ÁßªÈô§
          messageElement.remove();
          showFlashNotification("‚úì Ê∂àÊÅØÂ∑≤Âà†Èô§");
          
          // ÈÄöÁü•ÂêéÁ´ØÊõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÔºàÂ¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºâ
          // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™Ê∂àÊÅØÂà∞ÂêéÁ´ØÔºåËÆ©ÂêéÁ´Ø‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âà†Èô§ËøôÊù°Ê∂àÊÅØ
          // vscode.postMessage({ type: "deleteMessage", index: messageIndex });
        }
      }

      // Ê£ÄÊµãÂπ∂Â§ÑÁêÜ diff ‰ª£Á†ÅÂùó
      function processDiffBlocks(messageElement) {
        const codeBlocks = messageElement.querySelectorAll("pre code");

        codeBlocks.forEach((codeBlock, index) => {
          const content = codeBlock.textContent;
          const preElement = codeBlock.parentElement;

          // Ê£ÄÊµãÊòØÂê¶ÊòØ diff Ê†ºÂºè
          if (isDiffContent(content)) {
            preElement.classList.add("diff-block");

            // Ê∑ªÂä†Â∫îÁî®ÊåâÈíÆ
            const applyBtn = document.createElement("button");
            applyBtn.className = "apply-diff-btn";
            applyBtn.innerHTML = "‚úì Apply";
            applyBtn.title = "Apply this diff to your code";

            // Â≠òÂÇ® diff ÂÜÖÂÆπ
            applyBtn.dataset.diffContent = content;
            applyBtn.dataset.diffIndex = index;

            applyBtn.onclick = () => applyDiff(applyBtn, content);

            preElement.appendChild(applyBtn);
          }
        });
      }

      // Ê£ÄÊµãÊòØÂê¶ÊòØ diff ÂÜÖÂÆπ
      function isDiffContent(content) {
        const lines = content.trim().split("\n");

        // Ê£ÄÊµãÂ∏∏ËßÅÁöÑ diff Ê†ºÂºèÁâπÂæÅ
        const hasDiffMarkers = lines.some(
          (line) =>
            line.startsWith("+++") ||
            line.startsWith("---") ||
            line.startsWith("@@") ||
            line.match(/^diff --git/),
        );

        // ÊàñËÄÖÊ£ÄÊµãÊòØÂê¶ÊúâË∂≥Â§üÂ§öÁöÑ +/- Ë°å
        const changeLines = lines.filter(
          (line) => line.startsWith("+") || line.startsWith("-"),
        );

        return (
          hasDiffMarkers ||
          (changeLines.length >= 3 && changeLines.length / lines.length > 0.3)
        );
      }

      // Â∫îÁî® diff
      function applyDiff(button, diffContent) {
        button.disabled = true;
        button.innerHTML = "‚è≥ Applying...";

        // Ëß£Êûê diff ÂÜÖÂÆπ
        const diffData = parseDiff(diffContent);

        if (!diffData) {
          button.innerHTML = "‚úó Invalid Diff";
          button.classList.add("error");
          setTimeout(() => {
            button.disabled = false;
            button.innerHTML = "‚úì Apply";
            button.classList.remove("error");
          }, 2000);
          return;
        }

        // ÂèëÈÄÅÂà∞ VS Code Êâ©Â±ïËøõË°åÂ∫îÁî®
        vscode.postMessage({
          type: "applyDiff",
          value: diffData,
        });

        // Á≠âÂæÖÂìçÂ∫î
        button.dataset.pending = "true";
      }

      // Ëß£Êûê diff ÂÜÖÂÆπ
      function parseDiff(diffContent) {
        const lines = diffContent.trim().split("\n");
        let currentFile = null;
        const files = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          // Ê£ÄÊµãÊñá‰ª∂Âêç
          if (line.startsWith("--- ") || line.startsWith("+++ ")) {
            const match = line.match(/^[+-]{3}\s+(?:a\/|b\/)?(.+?)(?:\s+|$)/);
            if (match) {
              const filename = match[1];
              if (line.startsWith("---")) {
                currentFile = { oldFile: filename, newFile: null, hunks: [] };
              } else if (currentFile) {
                currentFile.newFile = filename;
                files.push(currentFile);
              }
            }
          }

          // Ê£ÄÊµã hunk Â§¥ÈÉ® (@@)
          if (line.startsWith("@@") && currentFile) {
            const hunkMatch = line.match(
              /@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/,
            );
            if (hunkMatch) {
              const hunk = {
                oldStart: parseInt(hunkMatch[1]),
                oldLines: parseInt(hunkMatch[2] || "1"),
                newStart: parseInt(hunkMatch[3]),
                newLines: parseInt(hunkMatch[4] || "1"),
                lines: [],
              };

              // Êî∂ÈõÜ hunk ÁöÑÂÜÖÂÆπ
              i++;
              while (
                i < lines.length &&
                !lines[i].startsWith("@@") &&
                !lines[i].startsWith("---")
              ) {
                hunk.lines.push(lines[i]);
                i++;
              }
              i--; // ÂõûÈÄÄ‰∏ÄË°å

              currentFile.hunks.push(hunk);
            }
          }
        }

        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ê†áÂáÜÊ†ºÂºèÔºåÂ∞ùËØïÁÆÄÂçïÁöÑ +/- Ê†ºÂºè
        if (files.length === 0) {
          const addedLines = [];
          const removedLines = [];
          const contextLines = [];

          lines.forEach((line) => {
            if (line.startsWith("+") && !line.startsWith("+++")) {
              addedLines.push(line.substring(1));
            } else if (line.startsWith("-") && !line.startsWith("---")) {
              removedLines.push(line.substring(1));
            } else if (!line.startsWith("@@")) {
              contextLines.push(line);
            }
          });

          if (addedLines.length > 0 || removedLines.length > 0) {
            return {
              type: "simple",
              added: addedLines,
              removed: removedLines,
              context: contextLines,
              raw: diffContent,
            };
          }
        }

        return files.length > 0
          ? { type: "unified", files, raw: diffContent }
          : null;
      }

      function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function handleSend() {
        const text = userInput.value.trim();
        if (text) {
          addMessage(text, "user");
          vscode.postMessage({ type: "ask", value: text });
          userInput.value = "";
          userInput.style.height = "auto";
          currentAiMessageElement = null;
          currentAiRawText = "";
          userInput.disabled = true;
          sendBtn.style.display = "none";
          stopBtn.classList.add("visible");

          // Ê∑ªÂä†Âä†ËΩΩÊåáÁ§∫Âô®
          const loader = document.createElement("div");
          loader.id = "ai-loader";
          loader.className = "message ai-message system-message";
          loader.innerHTML =
            '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
          chatContainer.appendChild(loader);
          scrollToBottom();
        }
      }

      function handleStop() {
        vscode.postMessage({ type: "stop" });
        addMessage("üõë Generation stopped by user", "system");
      }

      sendBtn.addEventListener("click", handleSend);
      stopBtn.addEventListener("click", handleStop);

      userInput.addEventListener("keydown", (e) => {
        if (suggestionsList.style.display === "block") {
          if (e.key === "ArrowDown") {
            e.preventDefault();
            selectedSuggestionIndex =
              (selectedSuggestionIndex + 1) % currentSuggestions.length;
            updateSuggestionSelection();
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            selectedSuggestionIndex =
              (selectedSuggestionIndex - 1 + currentSuggestions.length) %
              currentSuggestions.length;
            updateSuggestionSelection();
          } else if (e.key === "Enter" || e.key === "Tab") {
            e.preventDefault();
            if (selectedSuggestionIndex !== -1) {
              selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
            }
          } else if (e.key === "Escape") {
            hideSuggestions();
          }
          return;
        }

        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });

      exportBtn.addEventListener("click", () => {
        vscode.postMessage({ type: "exportChat" });
      });

      clearBtn.addEventListener("click", () => {
        vscode.postMessage({ type: "clear" }); // Â∑≤ÁªèÂú® Provider ‰∏≠ÂÆûÁé∞Ê∏ÖÁêÜÈÄªËæë
      });

      function updateSuggestionSelection() {
        const items = suggestionsList.querySelectorAll(".suggestion-item");
        items.forEach((item, index) => {
          item.className =
            "suggestion-item" +
            (index === selectedSuggestionIndex ? " selected" : "");
          if (index === selectedSuggestionIndex) {
            item.scrollIntoView({ block: "nearest" });
          }
        });
      }

      // ÁõëÂê¨ÊñáÊú¨ÈÄâÊã©‰∫ã‰ª∂ÔºåËá™Âä®Â°´ÂÖ•ËæìÂÖ•Ê°Ü
      document.addEventListener("mouseup", () => {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (selectedText) {
          // Ê£ÄÊü•ÈÄâ‰∏≠ÁöÑÊñáÊú¨ÊòØÂê¶Âú®ËÅäÂ§©ÂÆπÂô®ÂÜÖ
          const range = selection.getRangeAt(0);
          const container = range.commonAncestorContainer;
          const parentElement =
            container.nodeType === Node.TEXT_NODE
              ? container.parentElement
              : container;

          // Á°Æ‰øùÈÄâ‰∏≠ÁöÑÂÜÖÂÆπÂú®ËÅäÂ§©ÂÆπÂô®ÂÜÖÔºå‰∏î‰∏çÂú®ËæìÂÖ•Ê°ÜÂÜÖ
          if (
            chatContainer.contains(parentElement) &&
            !userInput.contains(parentElement)
          ) {
            userInput.value = selectedText;
            userInput.focus();

            // ÈáçÊñ∞ËÆ°ÁÆóËæìÂÖ•Ê°ÜÈ´òÂ∫¶
            userInput.style.height = "auto";
            userInput.style.height = userInput.scrollHeight + "px";

            // Ê∏ÖÈô§ÈÄâÊã©ÔºåÈÅøÂÖçËßÜËßâÂπ≤Êâ∞
            selection.removeAllRanges();
          }
        }
      });

      // Ê∑ªÂä†‰∏Ä‰∏™Ê†áÂøóÊù•Ê†áËØÜÂΩìÂâçÊòØÂê¶Ê≠£Âú®ÊµÅÂºèÊé•Êî∂AIÊ∂àÊÅØ
      let isStreaming = false;

      // Ê†áËÆ∞ÊòØÂê¶Â∑≤ÁªèÂä†ËΩΩËøáÂéÜÂè≤ËÆ∞ÂΩï
      let historyLoaded = false;

      window.addEventListener("message", (event) => {
        const message = event.data;
        const loader = document.getElementById("ai-loader");

        switch (message.type) {
          case "closeFilesPanel":
            // ÂÖ≥Èó≠Êñá‰ª∂Èù¢Êùø
            filesPanel.classList.remove("open");
            break;
          case "suggestions":
            showSuggestions(message.value, message.trigger);
            break;
          case "history":
            // Âè™Âä†ËΩΩ‰∏ÄÊ¨°ÂéÜÂè≤ËÆ∞ÂΩïÔºåÈÅøÂÖçÈáçÂ§çÊ∏≤Êüì
            if (!historyLoaded) {
              historyLoaded = true;
              chatContainer.innerHTML = ""; // Ê∏ÖÁ©∫ÂàùÂßãÂåñÁä∂ÊÄÅ
              
              if (message.value && message.value.length > 0) {
                message.value.forEach((msg) => {
                  addMessage(msg.content, msg.role === "user" ? "user" : "ai");
                });
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                requestAnimationFrame(() => {
                  scrollToBottom();
                });
              } else {
                chatContainer.innerHTML = '<div class="message system-message">‚ú® Yuangs AI Agent initialized and ready.</div>';
              }
            }
            break;
          case "aiChunk":
            if (loader) {
              loader.remove();
              stopBtn.classList.add("visible");
            }

            // ÂºÄÂßãÊµÅÂºèÊé•Êî∂
            isStreaming = true;

            if (!currentAiMessageElement) {
              // ÂàõÂª∫AIÊ∂àÊÅØÂÆπÂô®
              const aiMessageDiv = document.createElement("div");
              aiMessageDiv.className = "message ai-message"; // Áõ¥Êé•‰ΩøÁî®ÊúÄÁªàÊ†∑Âºè
              // aiMessageDiv.style.minHeight = '24px'; // Èò≤Ê≠¢È´òÂ∫¶Â°åÈô∑
              chatContainer.appendChild(aiMessageDiv);
              currentAiMessageElement = aiMessageDiv;
            }

            currentAiRawText += message.value;

            // ÂÆûÊó∂ Markdown Ê∏≤Êüì
            // ÊäÄÂ∑ßÔºöÂ¶ÇÊûú‰ª£Á†ÅÂùóÊú™Èó≠ÂêàÔºåÊâãÂä®‰∏¥Êó∂Èó≠ÂêàÂÆÉ‰ª•‰øùËØÅÊ∏≤ÊüìÊ≠£Á°Æ
            let textToRender = currentAiRawText;
            const codeBlockCount = (textToRender.match(/```/g) || []).length;
            if (codeBlockCount % 2 !== 0) {
              textToRender += "\n```";
            }

            // Ê∏≤ÊüìÂÜÖÂÆπÂπ∂Ê∑ªÂä†ÂÖâÊ†á
            currentAiMessageElement.innerHTML =
              marked.parse(textToRender) + '<span class="cursor"></span>';

            // Âπ≥ÊªëÊªöÂä®Âà∞Â∫ïÈÉ®
            // ‰ΩøÁî® requestAnimationFrame ‰ºòÂåñÊªöÂä®ÊÄßËÉΩ
            requestAnimationFrame(() => {
              scrollToBottom();
            });
            break;
          case "done":
            // ÊµÅÂºè‰º†ËæìÁªìÊùü
            if (isStreaming && currentAiMessageElement) {
              isStreaming = false;

              // ÁßªÈô§ÂÖâÊ†áÔºåËøõË°åÊúÄÁªàÊ∏≤Êüì
              currentAiMessageElement.innerHTML =
                marked.parse(currentAiRawText);

              // Â§ÑÁêÜdiffÂùóÂíåÂÖ∂‰ªñÂêéÂ§ÑÁêÜ
              processDiffBlocks(currentAiMessageElement);

              // Ê∑ªÂä†Ê∑°ÂÖ•ÊïàÊûúÊàñÂÖ∂‰ªñÂÆåÊàêÂä®Êïà
              currentAiMessageElement.classList.add("final-render");
            }

            currentAiMessageElement = null;
            currentAiRawText = "";
            userInput.disabled = false;
            userInput.focus();
            sendBtn.style.display = "flex";
            stopBtn.classList.remove("visible");
            
            // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÁ°Æ‰øùÊñ∞Ê∂àÊÅØÂèØËßÅ
            requestAnimationFrame(() => {
              scrollToBottom();
            });
            break;
          case "clear":
            chatContainer.innerHTML =
              '<div class="message system-message">‚ú® Chat cleared.</div>';
            userInput.disabled = false;
            userInput.focus();
            sendBtn.style.display = "flex";
            stopBtn.classList.remove("visible");
            break;
          case "error":
            if (loader) loader.remove();
            addMessage("‚ùå Error: " + message.value, "system");
            userInput.disabled = false;
            userInput.focus();
            sendBtn.style.display = "flex";
            stopBtn.classList.remove("visible");
            break;
          case "success":
            // ÊàêÂäüÊ∂àÊÅØÔºåÊòæÁ§∫‰∏∫Á≥ªÁªüÊ∂àÊÅØ
            showFlashNotification(message.value);
            break;
          case "diffApplied":
            // Diff Â∫îÁî®ÊàêÂäü
            const successButtons = document.querySelectorAll(
              '.apply-diff-btn[data-pending="true"]',
            );
            successButtons.forEach((btn) => {
              btn.innerHTML = "‚úì Applied";
              btn.classList.add("applied");
              btn.disabled = true;
              btn.dataset.pending = "false";
            });
            break;
          case "diffError":
            // Diff Â∫îÁî®Â§±Ë¥•
            const errorButtons = document.querySelectorAll(
              '.apply-diff-btn[data-pending="true"]',
            );
            errorButtons.forEach((btn) => {
              btn.innerHTML = "‚úó Failed";
              btn.classList.add("error");
              btn.dataset.pending = "false";
              setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = "‚úì Apply";
                btn.classList.remove("error");
              }, 3000);
            });
            if (message.value) {
              addMessage(
                "‚ùå Diff application error: " + message.value,
                "system",
              );
            }
            break;
          case "contextUpdate":
            // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÊï∞ÊçÆ
            if (typeof updateContextItems === "function") {
              updateContextItems(message.value);
            }
            break;
          case "showContextPanel":
            // ÊòæÁ§∫‰∏ä‰∏ãÊñáÈù¢Êùø
            if (typeof showContextPanel === "function") {
              showContextPanel();
            }
            break;
          case "fileTreeData":
            // Êé•Êî∂Êñá‰ª∂Ê†ëÊï∞ÊçÆ
            handleFileTreeData(message.value);
            break;
          case "modelsConfig":
            // Êé•Êî∂Ê®°ÂûãÈÖçÁΩÆ
            availableModels = message.value.availableModels || [];
            currentModel = message.value.defaultModel || currentModel;
            renderModelOptions();
            updateCurrentModel(currentModel);
            console.log("Models config received:", availableModels);
            break;
        }
      });

      // ÂàùÂßãÂåñÊñá‰ª∂Èù¢Êùø
      if (typeof setupFilesPanel === "function") {
        setupFilesPanel();
      }

      // ÂàùÂßãÂåñ‰∏ä‰∏ãÊñáÈù¢Êùø
      if (typeof setupContextPanel === "function") {
        setupContextPanel();
      }

      // === Êñá‰ª∂Èù¢ÊùøÂäüËÉΩÂáΩÊï∞ ===

      function setupFilesPanel() {
        // Êñá‰ª∂Èù¢ÊùøÂºÄÂÖ≥
        filesToggle.addEventListener("click", () => {
          filesPanel.classList.toggle("open");
          if (filesPanel.classList.contains("open") && !fileTreeData) {
            loadFileTree();
          }
        });

        filesClose.addEventListener("click", () => {
          filesPanel.classList.remove("open");
        });

        // ÊêúÁ¥¢ÂäüËÉΩ
        filesSearch.addEventListener("input", (e) => {
          currentFileSearchQuery = e.target.value.toLowerCase();
          renderFileTree();
        });
      }

      // Âä†ËΩΩÊñá‰ª∂Ê†ë
      function loadFileTree() {
        filesPanelContent.innerHTML =
          '<div class="file-loading">Loading files...</div>';
        vscode.postMessage({ type: "loadFileTree" });
      }

      // Â§ÑÁêÜÊñá‰ª∂Ê†ëÊï∞ÊçÆ
      function handleFileTreeData(files) {
        allFiles = files;
        fileTreeData = buildFileTree(files);
        renderFileTree();
      }

      // ÊûÑÂª∫Êñá‰ª∂Ê†ëÁªìÊûÑ
      function buildFileTree(files) {
        const root = {};

        files.forEach((filePath) => {
          const parts = filePath.split("/");
          let current = root;
          let fullPath = "";

          parts.forEach((part, index) => {
            fullPath = fullPath ? fullPath + "/" + part : part;

            if (!current[part]) {
              current[part] = {
                name: part,
                path: fullPath, // ‰øùÂ≠òÂÆåÊï¥Ë∑ØÂæÑ
                isFile: index === parts.length - 1,
                children: {},
              };
            }
            current = current[part];
          });
        });

        return root;
      }

      // Ê∏≤ÊüìÊñá‰ª∂Ê†ë
      function renderFileTree() {
        if (!fileTreeData) {
          filesPanelContent.innerHTML =
            '<div class="file-empty">No files loaded</div>';
          return;
        }

        // ËøáÊª§Êñá‰ª∂
        let filteredFiles = allFiles;
        if (currentFileSearchQuery) {
          filteredFiles = allFiles.filter((f) =>
            f.toLowerCase().includes(currentFileSearchQuery),
          );
          filesStats.textContent = `${filteredFiles.length} files`;
        } else {
          filesStats.textContent = `${allFiles.length} files`;
        }

        // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Ê∏≤Êüì
        filesPanelContent.innerHTML = "";

        if (filteredFiles.length === 0) {
          filesPanelContent.innerHTML =
            '<div class="file-empty">No matching files</div>';
          return;
        }

        if (currentFileSearchQuery) {
          // ÊêúÁ¥¢Ê®°ÂºèÔºöÊòæÁ§∫ÊâÅÂπ≥ÂàóË°®
          renderFileList(filteredFiles);
        } else {
          // Ê†ëÂΩ¢Ê®°ÂºèÔºöÊòæÁ§∫Â±ÇÁ∫ßÁªìÊûÑ
          renderTreeNode(fileTreeData, filesPanelContent, 0);
        }
      }

      // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®ÔºàÊêúÁ¥¢Ê®°ÂºèÔºâ
      function renderFileList(files) {
        files.forEach((filePath) => {
          const item = document.createElement("div");
          item.className = "file-tree-item file";

          const icon = getFileIcon(filePath);
          const fileName = filePath.split("/").pop();

          item.innerHTML = `
                    <span class="file-tree-icon">${icon}</span>
                    <span class="file-tree-name">${fileName}</span>
                `;

          item.addEventListener("click", () => {
            handleFileClick(filePath);
          });

          filesPanelContent.appendChild(item);
        });
      }

      // Ê∏≤ÊüìÊ†ëËäÇÁÇπ
      function renderTreeNode(node, container, level) {
        const entries = Object.entries(node).sort((a, b) => {
          // Êñá‰ª∂Â§πÊéíÂú®ÂâçÈù¢
          if (a[1].isFile && !b[1].isFile) return 1;
          if (!a[1].isFile && b[1].isFile) return -1;
          return a[0].localeCompare(b[0]);
        });

        entries.forEach(([name, data]) => {
          const item = document.createElement("div");

          if (!data.isFile) {
            // Êñá‰ª∂Â§π
            item.className = "file-tree-item folder";
            item.style.paddingLeft = `${16 + level * 16}px`;

            item.innerHTML = `
                        <span class="file-tree-icon collapsed" data-path="${name}"></span>
                        <span class="file-tree-name">${name}</span>
                    `;

            const childrenContainer = document.createElement("div");
            childrenContainer.className = "file-tree-children";

            item
              .querySelector(".file-tree-icon")
              .addEventListener("click", (e) => {
                e.stopPropagation();
                const icon = e.target;
                if (icon.classList.contains("collapsed")) {
                  icon.classList.remove("collapsed");
                  icon.classList.add("expanded");
                  childrenContainer.classList.add("expanded");
                } else {
                  icon.classList.remove("expanded");
                  icon.classList.add("collapsed");
                  childrenContainer.classList.remove("expanded");
                }
              });

            item.addEventListener("click", () => {
              // ÈªòËÆ§Â±ïÂºÄ/ÊäòÂè†
              const icon = item.querySelector(".file-tree-icon");
              icon.click();
            });

            container.appendChild(item);
            container.appendChild(childrenContainer);

            // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êËäÇÁÇπ
            renderTreeNode(data.children, childrenContainer, level + 1);
          } else {
            // Êñá‰ª∂
            item.className = "file-tree-item file";
            item.style.paddingLeft = `${16 + level * 16}px`;

            const icon = getFileIcon(name);
            item.innerHTML = `
                        <span class="file-tree-icon">${icon}</span>
                        <span class="file-tree-name">${name}</span>
                    `;

            item.addEventListener("click", () => {
              handleFileClick(data.path);
            });

            container.appendChild(item);
          }
        });
      }

      // Ëé∑ÂèñÊñá‰ª∂ÂõæÊ†á
      function getFileIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const iconMap = {
          js: "üìú",
          ts: "üìò",
          tsx: "‚öõÔ∏è",
          jsx: "‚öõÔ∏è",
          html: "üåê",
          css: "üé®",
          scss: "üé®",
          json: "üìã",
          md: "üìù",
          py: "üêç",
          java: "‚òï",
          go: "üêπ",
          rs: "ü¶Ä",
          cpp: "‚öôÔ∏è",
          c: "‚öôÔ∏è",
          h: "üìÑ",
          vue: "üíö",
          angular: "üÖ∞Ô∏è",
          react: "‚öõÔ∏è",
          yaml: "üìã",
          yml: "üìã",
          xml: "üìã",
          sh: "üíª",
          bash: "üíª",
          zsh: "üíª",
          git: "üîÄ",
          lock: "üîí",
          env: "üîê",
          test: "üß™",
          spec: "üß™",
        };

        return iconMap[ext] || "üìÑ";
      }

      // Â§ÑÁêÜÊñá‰ª∂ÁÇπÂáª
      function handleFileClick(filePath) {
        // ÁßªÈô§Á≥ªÁªüÊ∂àÊÅØÔºåÁõ¥Êé•ËØªÂèñÊñá‰ª∂
        vscode.postMessage({
          type: "readFile",
          filePath: filePath,
        });
      }

      // Ëé∑ÂèñÊñá‰ª∂ËØ≠Ë®ÄÔºàËæÖÂä©ÂáΩÊï∞Ôºâ
      function getFileLanguage(filename) {
        const ext = filename.split(".").pop()?.toLowerCase() || "";
        const langMap = {
          js: "javascript",
          ts: "typescript",
          tsx: "typescript",
          jsx: "javascript",
          py: "python",
          java: "java",
          go: "go",
          rs: "rust",
          cpp: "cpp",
          c: "c",
          h: "c",
          vue: "vue",
          yaml: "yaml",
          yml: "yaml",
          json: "json",
          md: "markdown",
          html: "html",
          css: "css",
          sh: "bash",
          bash: "bash",
        };
        return langMap[ext] || "text";
      }

      // === ‰∏ä‰∏ãÊñáÈù¢ÊùøÂäüËÉΩÂáΩÊï∞ ===

      // ‰∏ä‰∏ãÊñáÈù¢ÊùøÂºÄÂÖ≥
      function setupContextPanel() {
        // ‰∏ä‰∏ãÊñáÈù¢ÊùøÂºÄÂÖ≥
        contextToggle.addEventListener("click", () => {
          contextPanel.classList.toggle("open");
          contextToggle.classList.toggle("visible");
        });

        contextClose.addEventListener("click", () => {
          contextPanel.classList.remove("open");
          contextToggle.classList.remove("visible");
        });

        // ËøáÊª§ÊåâÈíÆ‰∫ã‰ª∂
        contextFilterBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
            contextFilterBtns.forEach((b) => b.classList.remove("active"));
            // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÊåâÈíÆ
            btn.classList.add("active");
            // Êõ¥Êñ∞ËøáÊª§Âô®
            currentFilter = btn.dataset.filter;
            // ÈáçÊñ∞Ê∏≤Êüì
            renderContextItems();
          });
        });

        // ÊêúÁ¥¢ÂäüËÉΩ
        contextSearch.addEventListener("input", (e) => {
          currentSearchQuery = e.target.value.toLowerCase();
          renderContextItems();
        });
      }

      // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÊï∞ÊçÆ
      function updateContextItems(items) {
        const oldCount = currentContextItems.length;
        currentContextItems = items || [];
        const newCount = currentContextItems.length;
        
        renderContextItems();
        
        // Â¶ÇÊûúÊúâÊõ¥Êñ∞ÔºåÊòæÁ§∫ flash ÈÄöÁü•
        if (newCount > oldCount) {
          showFlashNotification(`üìã Context updated: ${newCount - oldCount} new item${newCount - oldCount > 1 ? 's' : ''} added`);
        }
      }

      // Ê∏≤Êüì‰∏ä‰∏ãÊñáÈ°πÁõÆ
      function renderContextItems() {
        // ËøáÊª§‰∏ä‰∏ãÊñáÈ°πÁõÆ
        let filteredItems = currentContextItems.filter((item) => {
          // Á±ªÂûãËøáÊª§
          if (currentFilter !== "all" && item.semantic !== currentFilter) {
            return false;
          }

          // ÊêúÁ¥¢ËøáÊª§
          if (currentSearchQuery) {
            const searchText = (
              item.path +
              item.summary +
              item.content
            ).toLowerCase();
            if (!searchText.includes(currentSearchQuery)) {
              return false;
            }
          }

          return true;
        });

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        contextStats.textContent = `${filteredItems.length} items`;

        // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Ê∏≤Êüì
        contextPanelContent.innerHTML = "";

        if (filteredItems.length === 0) {
          contextPanelContent.innerHTML =
            '<div class="context-empty">No context available</div>';
          return;
        }

        // Ê∏≤ÊüìÊØè‰∏™‰∏ä‰∏ãÊñáÈ°πÁõÆ
        filteredItems.forEach((item) => {
          const itemElement = createContextItemElement(item);
          contextPanelContent.appendChild(itemElement);
        });
      }

      // ÂàõÂª∫Âçï‰∏™‰∏ä‰∏ãÊñáÈ°πÁõÆÂÖÉÁ¥†
      function createContextItemElement(item) {
        const div = document.createElement("div");
        div.className = "context-item collapsed"; // ÈªòËÆ§ÊäòÂè†

        // Ëé∑ÂèñÂõæÊ†á
        const icon = getContextIcon(item.semantic);

        // Ëé∑ÂèñÈáçË¶ÅÊÄßÁôæÂàÜÊØî
        const importancePercent = item.importance
          ? (item.importance.confidence * 100).toFixed(0)
          : "50";

        // Ëé∑ÂèñÊ†áÁ≠æHTML
        const badgesHtml = createContextBadges(item);

        // Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØ
        const statsHtml = createContextStats(item);

        // Ëé∑ÂèñÂÜÖÂÆπÈ¢ÑËßà
        const previewText = item.summary || item.content.substring(0, 200);

        div.innerHTML = `
                <div class="context-item-header">
                    <span class="context-item-toggle">‚ñ∂</span>
                    <span class="context-item-icon">${icon}</span>
                    <span class="context-item-title">${item.alias || item.path}</span>
                    <div class="context-item-badges">${badgesHtml}</div>
                </div>
                <div class="context-item-details">
                    <div class="context-item-stats">${statsHtml}</div>
                    <div class="context-usage-bar">
                        <div class="context-usage-fill" style="width: ${importancePercent}%"></div>
                    </div>
                    <div class="context-item-preview">${previewText}</div>
                </div>
            `;

        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ - ÂàáÊç¢Â±ïÂºÄ/ÊäòÂè†
        div.addEventListener("click", (e) => {
          // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂
          e.stopPropagation();
          
          // ÂàáÊç¢Â±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
          div.classList.toggle("collapsed");
          div.classList.toggle("expanded");
          
          // Â¶ÇÊûúÂ±ïÂºÄÔºåÊâìÂºÄÊñá‰ª∂
          if (!div.classList.contains("collapsed") && item.path) {
            vscode.postMessage({
              type: "open",
              path: item.path,
            });
          }
          
          console.log("Context item toggled:", item, "expanded:", !div.classList.contains("collapsed"));
        });

        return div;
      }

      // Ëé∑Âèñ‰∏ä‰∏ãÊñáÂõæÊ†á
      function getContextIcon(semantic) {
        const iconMap = {
          source_code: "üìÑ",
          log: "üìã",
          config: "‚öôÔ∏è",
          documentation: "üìö",
          test: "üß™",
          git: "üîÄ",
          evidence: "üîç",
          diagnostics: "‚ö†Ô∏è",
        };

        return iconMap[semantic] || "üìÑ";
      }

      // ÂàõÂª∫Ê†áÁ≠æ
      function createContextBadges(item) {
        const badges = [];

        // Á±ªÂûãÊ†áÁ≠æ
        if (item.semantic) {
          badges.push(
            `<span class="context-badge ${item.semantic}">${item.semantic}</span>`,
          );
        }

        // Ê†áÁ≠æ
        if (item.tags && item.tags.length > 0) {
          item.tags.slice(0, 2).forEach((tag) => {
            badges.push(`<span class="context-badge">${tag}</span>`);
          });
        }

        return badges.join("");
      }

      // ÂàõÂª∫ÁªüËÆ°‰ø°ÊÅØ
      function createContextStats(item) {
        const stats = [];

        // TokenÊï∞Èáè
        if (item.tokens) {
          stats.push(
            `<span class="context-stat">üìä ${item.tokens} tokens</span>`,
          );
        }

        // ‰ΩøÁî®Ê¨°Êï∞
        if (item.importance && item.importance.useCount > 0) {
          stats.push(
            `<span class="context-stat">üîÑ ${item.importance.useCount} uses</span>`,
          );
        }

        // ÊúÄÂêé‰ΩøÁî®Êó∂Èó¥
        if (item.importance && item.importance.lastUsed) {
          const lastUsed = new Date(item.importance.lastUsed);
          const now = new Date();
          const diffMinutes = Math.floor((now - lastUsed) / 60000);

          if (diffMinutes < 1) {
            stats.push(`<span class="context-stat">‚è∞ just now</span>`);
          } else if (diffMinutes < 60) {
            stats.push(
              `<span class="context-stat">‚è∞ ${diffMinutes}m ago</span>`,
            );
          } else if (diffMinutes < 1440) {
            stats.push(
              `<span class="context-stat">‚è∞ ${Math.floor(diffMinutes / 60)}h ago</span>`,
            );
          } else {
            stats.push(
              `<span class="context-stat">‚è∞ ${Math.floor(diffMinutes / 1440)}d ago</span>`,
            );
          }
        }

        return stats.join("");
      }

      // ÊòæÁ§∫‰∏ä‰∏ãÊñáÈù¢Êùø
      function showContextPanel() {
        contextPanel.classList.add("open");
        contextToggle.classList.add("visible");
      }

      // ÈöêËóè‰∏ä‰∏ãÊñáÈù¢Êùø
      function hideContextPanel() {
        contextPanel.classList.remove("open");
        contextToggle.classList.remove("visible");
      }

      // ÊòæÁ§∫ flash ÈÄöÁü•
      function showFlashNotification(message) {
        const notification = document.createElement("div");
        notification.className = "flash-notification";
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 3ÁßíÂêéËá™Âä®ÁßªÈô§
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // === Ê®°ÂûãÈÄâÊã©Âô®ÂäüËÉΩ ===

      const modelSelector = document.getElementById("model-selector");
      const modelDropdown = document.getElementById("model-dropdown");
      const currentModelLabel = document.getElementById("current-model");

      // ÂèØÁî®ÁöÑ AI Ê®°ÂûãÂàóË°®Ôºà‰ªéÂêéÁ´ØÂä†ËΩΩÔºâ
      let availableModels = [];

      // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã
      let currentModel = "gpt-4o-mini";

      // ÂàùÂßãÂåñÊ®°ÂûãÈÄâÊã©Âô®
      function initModelSelector() {
        // ‰ªéÊâ©Â±ïËé∑ÂèñÊ®°ÂûãÈÖçÁΩÆ
        vscode.postMessage({ type: "getModelsConfig" });
        // ÂêåÊó∂Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã
        vscode.postMessage({ type: "getCurrentModel" });

        // ÁÇπÂáªÂàáÊç¢‰∏ãÊãâËèúÂçï
        modelSelector.addEventListener("click", (e) => {
          e.stopPropagation();
          modelDropdown.classList.toggle("visible");
        });

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener("click", (e) => {
          if (!modelSelector.contains(e.target) && !modelDropdown.contains(e.target)) {
            modelDropdown.classList.remove("visible");
          }
        });

        // ÈòªÊ≠¢‰∏ãÊãâËèúÂçïÂÜÖÈÉ®ÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
        modelDropdown.addEventListener("click", (e) => {
          e.stopPropagation();
        });
      }

      // Ê∏≤ÊüìÊ®°ÂûãÈÄâÈ°π
      function renderModelOptions() {
        modelDropdown.innerHTML = "";

        availableModels.forEach((model) => {
          const option = document.createElement("div");
          option.className = `model-option ${model.id === currentModel ? "active" : ""}`;
          option.innerHTML = `
            <span class="model-option-name">
              <strong>${model.name}</strong>
              <br>
              <span style="opacity: 0.6; font-size: 0.9em;">${model.description}</span>
            </span>
            <span class="model-option-icon">${model.id === currentModel ? "‚úì" : ""}</span>
          `;

          option.addEventListener("click", () => {
            selectModel(model.id);
          });

          modelDropdown.appendChild(option);
        });
      }

      // ÈÄâÊã©Ê®°Âûã
      function selectModel(modelId) {
        if (currentModel === modelId) {
          modelDropdown.classList.remove("visible");
          return;
        }

        currentModel = modelId;
        currentModelLabel.textContent = availableModels.find(m => m.id === modelId)?.name || modelId;

        // ÈáçÊñ∞Ê∏≤ÊüìÈÄâÈ°π‰ª•Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        renderModelOptions();

        // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        modelDropdown.classList.remove("visible");

        // ÂèëÈÄÅÂà∞Êâ©Â±ï
        vscode.postMessage({ type: "changeModel", value: modelId });

        // ÊòæÁ§∫ÂàáÊç¢ÊàêÂäüÊ∂àÊÅØ
        addMessage(`üîÑ Â∑≤ÂàáÊç¢Âà∞Ê®°Âûã: ${availableModels.find(m => m.id === modelId)?.name}`, "system");
      }

      // Êõ¥Êñ∞ÂΩìÂâçÊ®°ÂûãÊòæÁ§∫
      function updateCurrentModel(modelId) {
        currentModel = modelId;
        const model = availableModels.find(m => m.id === modelId);
        currentModelLabel.textContent = model ? model.name : modelId;
        renderModelOptions();
      }

      // Âú®Ê∂àÊÅØÁõëÂê¨Âô®‰∏≠Ê∑ªÂä†Ê®°ÂûãÁõ∏ÂÖ≥Â§ÑÁêÜ
      window.addEventListener("message", (event) => {
        const message = event.data;

        // Âú®Áé∞ÊúâÁöÑ switch ËØ≠Âè•‰∏≠Ê∑ªÂä†Êñ∞ case
        if (message.type === "currentModel") {
          updateCurrentModel(message.value);
        }
      });

      // ÂàùÂßãÂåñÊ®°ÂûãÈÄâÊã©Âô®
      initModelSelector();
    </script>
  </body>
</html>
