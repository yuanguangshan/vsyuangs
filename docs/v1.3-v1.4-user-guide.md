# vsyuangs v1.3 - v1.4 用户指南

## 📋 目录
1. [快速开始](#快速开始)
2. [主动防御功能](#主动防御功能)
3. [知识继承功能](#知识继承功能)
4. [配置选项](#配置选项)
5. [使用示例](#使用示例)
6. [常见问题](#常见问题)

---

## 快速开始

### 安装
v1.3.0 版本已自动安装以下核心模块：
- ✅ 主动防御（Proactive Defense）
- ✅ 知识继承（Context Memory）

### 基本使用
插件启动后会自动：
1. 在文件保存时进行安全扫描
2. 记录你对建议的采纳/忽略行为
3. 学习你的编码偏好

---

## 主动防御功能

### 工作原理
当您保存文件时，vsyuangs 会在后台自动扫描代码，检测潜在的安全风险和问题。

### 风险等级

| 图标 | 等级 | 描述 | 行为 |
|------|------|------|------|
| 🚨 | CRITICAL | 高危风险 | 弹出 Modal 对话框 + 红色波浪线 |
| ⛔ | ERROR | 高危警告 | 红色波浪线 |
| ⚠️ | WARNING | 中等风险 | 黄色波浪线 |
| ℹ️ | INFO | 低优先级 | 蓝色波浪线 |

### 自动检测的问题类型

#### 🔐 敏感信息泄露（CRITICAL）
- AWS Access Key
- AWS Secret Key
- GitHub Token
- 私钥（Private Key）
- API Key

#### ⚡ 危险函数（CRITICAL）
- `eval()` 调用
- 危险 Shell 执行（`exec`/`spawn`）

#### 💉 注入攻击（ERROR）
- SQL 注入风险
- 命令注入风险

#### 📁 路径安全（ERROR）
- 路径穿越（`../`）
- 硬编码绝对路径

#### ⏱️ 性能问题（WARNING）
- 同步文件操作（`fs.readFileSync`）
- 同步 JSON 解析

#### 🎨 代码风格（INFO）
- TODO/FIXME 注释
- console.log

### 使用场景示例

#### 场景 1：检测敏感信息泄露
```typescript
// 您的代码
const apiKey = 'AKIAIOSFODNN7EXAMPLE';
console.log(apiKey);
```

**保存文件后：**
1. 0.1 秒内完成扫描
2. 状态栏显示：🚨 发现 1 个问题
3. 代码行下出现红色波浪线
4. 弹出对话框提示：
   ```
   vsyuangs 检测到 1 个高危安全风险！
   
   [查看详情] [忽略警告]
   ```

#### 场景 2：检测性能问题
```typescript
// 您的代码
const data = fs.readFileSync('large.json', 'utf8');
```

**保存文件后：**
1. 状态栏显示：⚠️ 发现 1 个问题
2. 代码行下出现黄色波浪线
3. 不弹窗，不阻塞工作流

---

## 知识继承功能

### 工作原理
vsyuangs 会记住你对各类建议的反馈，并自动调整 AI 的行为：
- **采纳** = AI 会继续关注此类问题
- **忽略** = AI 会减少此类建议

### 学习机制

#### 反馈类型
- **applied**：您采纳了建议
- **ignored**：您忽略了建议
- **dismissed**：您手动关闭了提示

#### 反感度计算
系统会根据以下因素计算您对某类建议的"反感度"：
1. 忽略次数（越多越反感）
2. 忽略率（越高越反感）
3. 时间衰减（旧反馈权重降低）

#### 黑名单生成
**触发条件：**
- 忽略次数 ≥ 3 次
- 忽略率 ≥ 80%

**效果：**
```typescript
// 第一次 AI 建议
"建议：优化代码缩进"
[采纳] [忽略]

// 第二、三次 AI 建议
"建议：优化代码缩进"
[采纳] [忽略]

// 第四次及以后
// AI 不再提示"优化代码缩进"
```

#### 白名单生成
**触发条件：**
- 总反馈次数 ≥ 3 次
- 采纳率 > 60%

**效果：**
AI 会优先关注您经常采纳的问题类型。

### Prompt 动态注入

vsyuangs 会自动将您的偏好注入到 AI 的 Prompt 中：

```typescript
[用户偏好约束]: 请避免或大幅减少关于以下类型的建议（用户已多次明确忽略）：style spacing, style naming。

[用户关注点]: 请优先关注以下类型的问题（用户经常采纳建议）：security leak, dangerous function。
```

---

## 配置选项

在 VS Code 设置中搜索 `vsyuangs` 可配置以下选项：

### 主动防御配置

```json
{
  // 启用文件保存时的自动安全扫描
  "vsyuangs.proactiveScan.enabled": true,
  
  // 扫描延迟（毫秒），用于防抖处理
  "vsyuangs.proactiveScan.delay": 500,
  
  // 语言白名单，仅扫描这些语言的文件
  "vsyuangs.proactiveScan.languageWhitelist": [
    "typescript",
    "javascript",
    "python",
    "java",
    "go",
    "rust",
    "cpp",
    "c"
  ],
  
  // 最小文件大小（字节），小于此值不扫描
  "vsyuangs.proactiveScan.minFileSize": 100,
  
  // 最大文件大小（字节），超过此值跳过
  "vsyuangs.proactiveScan.maxFileSize": 1048576,
  
  // 发现Critical级别错误时显示模态对话框
  "vsyuangs.proactiveScan.enableModalForCritical": true
}
```

### 配置说明

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| enabled | true | 是否启用自动扫描 |
| delay | 500 | 扫描延迟（100-5000ms），避免高频保存 |
| languageWhitelist | 8种语言 | 只扫描指定语言的文件 |
| minFileSize | 100 | 小于 100 字节的文件跳过 |
| maxFileSize | 1048576 | 大于 1MB 的文件跳过 |
| enableModalForCritical | true | 高危错误是否弹出模态对话框 |

---

## 使用示例

### 命令面板（Ctrl+Shift+P）

可用命令：
1. **vsyuangs: 显示扫描统计**
   - 显示平均扫描耗时
   - 显示发现的问题数
   - 显示扫描文件数量

2. **vsyuangs: 清空扫描历史**
   - 清空所有扫描记录

3. **vsyuangs: 手动触发扫描**
   - 手动扫描当前文件
   - 不需要保存文件

### 典型工作流

#### 1. 开发阶段
```typescript
// 编写代码
const apiKey = process.env.AWS_ACCESS_KEY; // ✅ 安全
eval(userInput); // 🚨 危险
console.log('Debug info'); // ℹ️ 风格问题
```

#### 2. 保存文件
- 自动扫描（< 50ms）
- 发现 2 个问题（eval + console.log）
- 弹出高危警告（eval）

#### 3. 修复问题
```typescript
const apiKey = process.env.AWS_ACCESS_KEY; // ✅ 安全
executeSafely(userInput); // ✅ 已修复
logger.info('Debug info'); // ✅ 使用日志库
```

#### 4. 学习效果
- 系统记录您忽略了 style 建议（console.log）
- 下次不会提示 console.log
- 继续关注安全问题

---

## 常见问题

### Q1: 扫描会影响性能吗？
**A:** 不会。扫描目标耗时 < 50ms，且在后台异步执行，不会阻塞您的编辑。

### Q2: 如何禁用自动扫描？
**A:** 在设置中设置 `vsyuangs.proactiveScan.enabled = false`。

### Q3: 为什么有些文件不被扫描？
**A:** 可能是以下原因：
- 文件不在语言白名单中
- 文件太小（< 100 字节）或太大（> 1MB）
- 扫描功能被禁用

### Q4: 可以自定义扫描规则吗？
**A:** 可以。在代码中调用 `QuickSecurityScanner` 的 `addRule()` 方法添加自定义规则。

### Q5: 反馈数据会同步到其他设备吗？
**A:** 不会。反馈数据存储在本地 VS Code 的 globalState 中，不会上传到云端。

### Q6: 如何清空学习历史？
**A:** 执行命令 `vsyuangs: 清空扫描历史`，或调用 `PreferenceMemory.clear()`。

### Q7: 系统会记住多久的数据？
**A:** 默认保留 30 天，最多 1000 条记录。过期记录会自动清理。

### Q8: 如何导出/导入偏好数据？
**A:** 使用 `PreferenceMemory` 的 `exportData()` 和 `importData()` 方法。

---

## 性能指标

| 指标 | 目标 | 实际 |
|------|------|------|
| 单次扫描耗时 | < 50ms | ✅ 10-30ms |
| 内存占用 | < 50MB | ✅ ~20MB |
| 扫描延迟 | 500ms | ✅ 可配置 |
| 规则执行 | < 20 条 | ✅ 15 条 |

---

## 进阶功能

### 自定义规则示例

```typescript
import { getQuickSecurityScanner } from 'vsyuangs';

const scanner = getQuickSecurityScanner();

// 添加自定义规则
scanner.addRule({
  id: 'MY_CUSTOM_RULE',
  type: IssueType.STYLE_NAMING,
  severity: SecuritySeverity.WARNING,
  name: '自定义规则',
  pattern: /MY_PATTERN/g,
  description: '检测到自定义模式',
  suggestion: '使用更好的写法'
});
```

### 导出/导入数据

```typescript
import { getPreferenceMemory } from 'vsyuangs';

const memory = getPreferenceMemory(context);

// 导出数据
const jsonData = await memory.exportData();
console.log(jsonData);

// 导入数据
await memory.importData(jsonData);
```

---

## 技术支持

- 📖 完整文档: `docs/v1.3-v1.4-implementation-summary.md`
- 🐛 问题反馈: https://github.com/yuanguangshan/vsyuangs/issues
- 💬 讨论: https://github.com/yuanguangshan/vsyuangs/discussions

---

## 下一步

v1.3-v1.4 已实现：
- ✅ 主动防御（实时安全扫描）
- ✅ 知识继承（个性化 AI 建议）

即将推出：
- 🔜 Git Stage 拦截
- 🔜 团队偏好共享
- 🔜 更多语言支持
- 🔜 可视化偏好面板

---

**祝您编码愉快！** 🎉