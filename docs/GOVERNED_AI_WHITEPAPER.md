# Smart Stage：Governed AI 的工程实践

## 摘要

Smart Stage 是 Yuangs AI Agent 中的一个 **治理型智能决策系统**，
用于在代码提交前对文件变更进行**自动分组与建议**。

与传统 AI 不同，Smart Stage 从设计之初即遵循：

> **AI 只能建议，不能越权；
> 不确定时，必须停下。**

## 核心问题

在 Git 提交阶段，AI 常见风险包括：

- 错误分组导致历史污染
- 不可解释的决策
- 模型"自作聪明"却无法纠正
- 一次错误被无限放大

Smart Stage 的目标不是"更聪明"，而是 **更可靠**。

## 核心设计原则

### 1️⃣ 投票而非单一判断
Smart Stage 使用多信号投票系统（路径、内容、语义等），
避免单点误判。

### 2️⃣ 置信度优先
每一次决策都会生成 **0.0–1.0 的置信度评分**：

- ≥ 0.6 → 自动分组
- 0.3–0.6 → 建议分组
- < 0.3 → 需要人工确认

AI 被明确要求：**低置信度时不得行动。**

### 3️⃣ 可解释性是强制的
每一个分组结果都附带：

- 使用了哪些信号
- 为什么这些信号重要
- 为什么其他分类被否定

解释不是日志，而是产品能力。

### 4️⃣ Human-in-the-loop 学习
当用户纠正错误时：

- 系统不会"学会新规则"
- 只会调整 **已有信号的权重**
- 所有学习都有上下限与时间衰减

这是一种 **可治理的学习**。

## 架构设计

### 核心组件

1. **VotingFileClassifier**：多信号投票分类器
2. **GroupExplanation**：决策解释数据结构
3. **PreferenceMemory**：用户反馈记忆系统
4. **SmartStageSuggester**：业务逻辑编排层

### 投票机制

系统从三个维度收集信号：

- **路径信号**：基于文件路径模式（如 `/ui/`, `.test.ts`）
- **内容信号**：基于diff内容特征（如JSX标记、测试框架语法）
- **关键词信号**：基于特定关键词（如"fix:", "docs:"）

每种信号都有预设权重，通过加权投票得出最终分类。

### 治理机制

1. **置信度阈值**：决定AI的行为模式
2. **人类反馈循环**：用户纠正被记录并影响未来决策
3. **权重调整**：基于反馈调整信号权重，但有上下界
4. **时间衰减**：旧反馈的影响随时间减弱

## 安全与治理

- 无自进化
- 无隐式状态
- 所有学习可审计
- 所有行为可回滚

Smart Stage 不追求自治，而追求 **可信协作**。

## 学习机制详解

### 权重调整算法

当用户纠正分类时，系统会：

1. 记录具体的错误类型和置信度
2. 根据置信度计算惩罚强度（高置信度错误惩罚更重）
3. 调整相关信号的权重倍率
4. 设置权重倍率的上下界（0.5-1.5）

### 时间衰减机制

所有用户反馈和权重调整都有7天的时间衰减，
确保系统不会因临时模式而固化错误行为。

## 结论

Smart Stage 代表了一种新的 AI 工程范式：

> **Governed AI ——
> 一个被约束、被解释、被人类主导的智能系统。**

它证明了AI系统可以在保持智能性的同时，严格遵守人类设定的边界和规则。