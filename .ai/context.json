[
  {
    "type": "file",
    "path": "src/vscode/provider/ChatViewProvider.ts",
    "content": "import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { VSCodeAgentRuntime } from '../core/runtime';\nimport { GovernanceService } from '../../engine/agent/governance';\nimport * as chatHistoryStorage from '../../engine/agent/chatHistoryStorage';\nimport { createIgnoreFilter, IgnoreFilter } from '../utils/ignoreFilter';\n\n// Ê®°ÂûãÈÖçÁΩÆÊé•Âè£\ninterface ModelConfig {\n    id: string;\n    name: string;\n    description: string;\n}\n\ninterface ModelsConfigFile {\n    availableModels: ModelConfig[];\n    defaultModel: string;\n}\n\n/**\n * ChatView Provider - ‰æßËæπÊ†èËÅäÂ§©ËßÜÂõæÊèê‰æõËÄÖ\n * \n * ËÅåË¥£Ôºö\n * - ÁÆ°ÁêÜ Webview UI ÁöÑÁîüÂëΩÂë®Êúü\n * - Áª¥Êä§ËÅäÂ§©ÂéÜÂè≤ËÆ∞ÂΩï\n * - Êèê‰æõÁî®Êà∑ËæìÂÖ•ÊµÅÂºèÂ±ïÁ§∫\n * - ÈÄöËøá VSCodeAgentRuntime ÊâßË°å AI ‰ªªÂä°\n * \n * Ê≥®ÊÑèÔºö‰∏çË¥üË¥£ context ÊûÑÈÄ†ÔºåÂè™Ë¥üË¥£ UI Â±Ç\n */\nexport class ChatViewProvider implements vscode.WebviewViewProvider {\n    public static readonly viewType = 'yuangs.chatView';\n    private _view?: vscode.WebviewView;\n    private _messages: { role: string, content: string }[] = [];\n    private _abortController: AbortController | null = null;\n    private _ignoreFilter: IgnoreFilter | null = null;\n    private _currentModel: string = 'gpt-4o-mini';\n\n    constructor(\n        private readonly _context: vscode.ExtensionContext,\n    ) {\n        console.log('[ChatViewProvider] Initializing...');\n        // Initialize ignore filter for file selection\n        this._ignoreFilter = createIgnoreFilter();\n        // ‰ªé workspaceState Âä†ËΩΩ‰øùÂ≠òÁöÑÊ®°Âûã\n        this._currentModel = this._context.workspaceState.get('currentModel', this.getDefaultModel());\n        console.log(`[ChatViewProvider] Current model: ${this._currentModel}`);\n        // ‰ºòÂÖà‰ªéÊñá‰ª∂Á≥ªÁªüÊÅ¢Â§çÂéÜÂè≤ËÆ∞ÂΩïÔºåÂê¶Âàô‰ªé workspaceState ÊÅ¢Â§ç\n        this.loadHistory();\n    }\n\n    /**\n     * Ëé∑ÂèñÈªòËÆ§Ê®°Âûã\n     */\n    private getDefaultModel(): string {\n        try {\n            const config = this.getModelsConfig();\n            return config.defaultModel;\n        } catch (error) {\n            console.warn('[ChatViewProvider] Failed to read default model from config, using fallback');\n            return 'gpt-4o-mini';\n        }\n    }\n\n    /**\n     * ËØªÂèñÊ®°ÂûãÈÖçÁΩÆÊñá‰ª∂\n     */\n    private getModelsConfig(): ModelsConfigFile {\n        // ‰ºòÂÖà‰ªé dist ÁõÆÂΩïËØªÂèñÔºàÊâìÂåÖÂêéÁöÑ‰ΩçÁΩÆÔºâ\n        const possiblePaths = [\n            path.join(this._context.extensionPath, 'dist', 'engine', 'core', 'models.config.json'),\n            path.join(this._context.extensionPath, 'src', 'engine', 'core', 'models.config.json')\n        ];\n        \n        let configPath: string | null = null;\n        for (const testPath of possiblePaths) {\n            if (fs.existsSync(testPath)) {\n                configPath = testPath;\n                console.log(`[ChatViewProvider] Found config file at: ${configPath}`);\n                break;\n            }\n        }\n\n        if (!configPath) {\n            console.warn('[ChatViewProvider] Models config file not found at any location, using defaults');\n            return {\n                availableModels: [\n                    { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Âø´ÈÄü‰∏îÈ´òÊïà' },\n                    { id: 'gpt-4o', name: 'GPT-4o', description: 'Âπ≥Ë°°ÊÄßËÉΩ' },\n                    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', description: 'È´òÊÄßËÉΩ' },\n                    { id: 'gpt-4', name: 'GPT-4', description: 'ÊúÄÂº∫ËÉΩÂäõ' },\n                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'ÁªèÊµéÂÆûÊÉ†' }\n                ],\n                defaultModel: 'gpt-4o-mini'\n            };\n        }\n\n        try {\n            const content = fs.readFileSync(configPath, 'utf-8');\n            const config = JSON.parse(content) as ModelsConfigFile;\n            console.log(`[ChatViewProvider] Loaded config with ${config.availableModels.length} models, default: ${config.defaultModel}`);\n            return config;\n        } catch (error) {\n            console.error('[ChatViewProvider] Failed to parse models config:', error);\n            throw error;\n        }\n    }\n\n    public resolveWebviewView(\n        webviewView: vscode.WebviewView,\n        context: vscode.WebviewViewResolveContext,\n        _token: vscode.CancellationToken,\n    ) {\n        console.log('[ChatViewProvider] Resolving webview view...');\n        this._view = webviewView;\n\n        webviewView.webview.options = {\n            enableScripts: true,\n            localResourceRoots: [\n                this._context.extensionUri\n            ]\n        };\n\n        try {\n            webviewView.webview.html = this._getHtmlForWebview(webviewView.webview);\n        } catch (error: any) {\n            console.error('[ChatViewProvider] Error loading view:', error);\n            webviewView.webview.html = `<html><body><h3>Error loading view</h3><pre>${error.message}</pre></body></html>`;\n        }\n\n        // ÁõëÂê¨ webview ÂèØËßÅÊÄßÂèòÂåñ\n        webviewView.onDidChangeVisibility(() => {\n            console.log(`[ChatViewProvider] Webview visibility changed. Visible: ${webviewView.visible}`);\n            // ÊØèÊ¨° webview Âèò‰∏∫ÂèØËßÅÊó∂ÔºåÁ°Æ‰øùÂèëÈÄÅÂéÜÂè≤ËÆ∞ÂΩï\n            if (webviewView.visible && this._view) {\n                this._view.webview.postMessage({ type: 'history', value: this._messages });\n            }\n        });\n\n        // ÁõëÂê¨ webview ÈîÄÊØÅ\n        webviewView.onDidDispose(() => {\n            console.log('[ChatViewProvider] Webview disposed');\n            this._view = undefined;\n        });\n\n        // ÂΩì webview ÂáÜÂ§áÂ•ΩÂêéÔºåÂèëÈÄÅÂéÜÂè≤ËÆ∞ÂΩï\n        // ‰ΩøÁî® setTimeout Á°Æ‰øù webview ÂÆåÂÖ®ÂàùÂßãÂåñ\n        setTimeout(() => {\n            if (this._view) {\n                console.log(`[ChatViewProvider] Sending ${this._messages.length} messages to UI`);\n                this._view.webview.postMessage({ type: 'history', value: this._messages });\n            }\n        }, 100);\n\n        webviewView.webview.onDidReceiveMessage(async data => {\n            switch (data.type) {\n                case 'ask':\n                    console.log('[ChatViewProvider] User asked question');\n                    await this.handleAgentTask(data.value);\n                    break;\n                case 'stop':\n                    console.log('[ChatViewProvider] User requested stop');\n                    if (this._abortController) {\n                        this._abortController.abort();\n                        this._abortController = null;\n                    }\n                    break;\n                case 'getFiles':\n                    const excludePattern = this._ignoreFilter?.getExcludePattern() || '**/node_modules/**';\n                    // Â¢ûÂä†Êñá‰ª∂Êï∞ÈáèÈôêÂà∂ÔºåÁ°Æ‰øùËÉΩËé∑ÂèñÂà∞Êõ¥Â§öÊñá‰ª∂\n                    const files = await vscode.workspace.findFiles('**/*', excludePattern, 1000);\n                    \n                    // Ëé∑ÂèñÁõ∏ÂØπË∑ØÂæÑ\n                    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n                    let fileNames = files.map(f => \n                        workspaceFolder \n                            ? path.relative(workspaceFolder.uri.fsPath, f.fsPath) \n                            : f.fsPath\n                    );\n                    \n                    // Â¶ÇÊûúÊúâÊü•ËØ¢ËØçÔºåËøõË°åÊ®°Á≥äÂåπÈÖçËøáÊª§\n                    if (data.query && data.query.trim()) {\n                        const queryLower = data.query.toLowerCase();\n                        fileNames = fileNames.filter(name => \n                            name.toLowerCase().includes(queryLower)\n                        );\n                    }\n                    \n                    // ÈôêÂà∂ËøîÂõûÊï∞ÈáèÔºåÈÅøÂÖçÂàóË°®Â§™ÈïøÂΩ±ÂìçÊÄßËÉΩ\n                    fileNames = fileNames.slice(0, 50);\n                    \n                    webviewView.webview.postMessage({ \n                        type: 'suggestions', \n                        value: fileNames, \n                        trigger: '@' \n                    });\n                    console.log(`[ChatViewProvider] Returned ${fileNames.length} files for query: \"${data.query}\"`);\n                    break;\n                case 'loadFileTree':\n                    const allExcludePattern = this._ignoreFilter?.getExcludePattern() || '**/node_modules/**';\n                    const allFiles = await vscode.workspace.findFiles('**/*', allExcludePattern, 500);\n                    const allFileNames = allFiles.map(f => path.relative(vscode.workspace.workspaceFolders?.[0].uri.fsPath || '', f.fsPath));\n                    webviewView.webview.postMessage({ type: 'fileTreeData', value: allFileNames });\n                    break;\n                case 'readFile':\n                    await this.handleReadFile(webviewView, data.filePath, data.isReference || false);\n                    break;\n                case 'exportChat':\n                    this.exportChatHistory();\n                    break;\n                case 'clear':\n                    this.clear();\n                    break;\n                case 'getSymbols':\n                    const editor = vscode.window.activeTextEditor;\n                    if (editor) {\n                        try {\n                            const symbols = await vscode.commands.executeCommand<vscode.SymbolInformation[]>(\n                                'vscode.executeDocumentSymbolProvider',\n                                editor.document.uri\n                            );\n                            if (symbols) {\n                                const symbolNames = symbols.map(s => s.name);\n                                webviewView.webview.postMessage({ type: 'suggestions', value: symbolNames, trigger: '#' });\n                            }\n                        } catch (e) {\n                            webviewView.webview.postMessage({ type: 'suggestions', value: [], trigger: '#' });\n                        }\n                    }\n                    break;\n                case 'applyDiff':\n                    await this.handleApplyDiff(data.value);\n                    break;\n                case 'open':\n                    if (data.path) {\n                        try {\n                            const uri = vscode.Uri.file(data.path);\n                            const doc = await vscode.workspace.openTextDocument(uri);\n                            await vscode.window.showTextDocument(doc, { preview: true });\n                        } catch (e) {\n                            vscode.window.showErrorMessage(`Failed to open file: ${data.path}`);\n                        }\n                    }\n                    break;\n                case 'getCurrentModel':\n                    // ÂèëÈÄÅÂΩìÂâçÊ®°ÂûãÂà∞ UI\n                    webviewView.webview.postMessage({ type: 'currentModel', value: this._currentModel });\n                    break;\n                case 'getModelsConfig':\n                    // ÂèëÈÄÅÊ®°ÂûãÈÖçÁΩÆÂà∞ UI\n                    try {\n                        const config = this.getModelsConfig();\n                        webviewView.webview.postMessage({ \n                            type: 'modelsConfig', \n                            value: config \n                        });\n                    } catch (error: any) {\n                        console.error('[ChatViewProvider] Failed to send models config:', error);\n                        webviewView.webview.postMessage({ \n                            type: 'error', \n                            value: `Failed to load models config: ${error.message}` \n                        });\n                    }\n                    break;\n                case 'changeModel':\n                    // Êõ¥Êñ∞ÂΩìÂâçÊ®°Âûã\n                    this._currentModel = data.value;\n                    console.log(`[ChatViewProvider] Model changed to: ${this._currentModel}`);\n                    // ‰øùÂ≠òÂà∞ workspaceState\n                    this._context.workspaceState.update('currentModel', this._currentModel);\n                    break;\n            }\n        });\n    }\n\n    /**\n     * ‰ªé UI Ëß¶ÂèëÁöÑËÅäÂ§©ÊâßË°å\n     * \n     * ËøôÊòØ ChatViewProvider ÁöÑ‰∏ªË¶ÅÂÖ¨ÂÖ± API\n     * Êú™Êù• AskAI ÂëΩ‰ª§‰πüÂèØ‰ª•ÈÄöËøá‰∫ã‰ª∂Êú∫Âà∂Ë∞ÉÁî®Ê≠§ÊñπÊ≥ï\n     */\n    public async runChatFromUI(userInput: string) {\n        console.log(`[ChatViewProvider] Running chat from UI: ${userInput.substring(0, 50)}...`);\n        await this.handleAgentTask(userInput);\n    }\n\n    private async handleAgentTask(userInput: string) {\n        if (!this._view) {\n            console.warn('[ChatViewProvider] No webview available');\n            return;\n        }\n\n        // Â¶ÇÊûúÊúâÊ≠£Âú®ËøêË°åÁöÑ‰ªªÂä°ÔºåÂÖàÂèñÊ∂àÂÆÉ\n        if (this._abortController) {\n            this._abortController.abort();\n        }\n\n        // ÂàõÂª∫Êñ∞ÁöÑ AbortController\n        this._abortController = new AbortController();\n        const signal = this._abortController.signal;\n\n        try {\n            console.log('[ChatViewProvider] Starting AI task...');\n            this._messages.push({ role: 'user', content: userInput });\n            this._saveHistory();\n\n            await GovernanceService.init(this._context.extensionUri.fsPath);\n\n            const originalAdjudicate = GovernanceService.adjudicate;\n            (GovernanceService as any).adjudicate = async (action: any) => {\n                let details = '';\n                let summary = '';\n                \n                if (action.type === 'tool_call') {\n                    const toolName = action.payload.tool_name;\n                    const params = action.payload.parameters;\n                    \n                    // For skill creation, provide a concise summary\n                    if (toolName === 'skill_create' && params) {\n                        summary = `üìã Create New Skill: ${params.name || 'Unnamed Skill'}`;\n                        details = `\\nüìù Description: ${params.description || 'No description'}`;\n                        \n                        // Truncate long descriptions to avoid overflow\n                        if (details.length > 300) {\n                            details = details.substring(0, 300) + '...';\n                        }\n                        \n                        details += `\\n\\nüí° Use when: ${params.whenToUse || 'Not specified'}`;\n                        \n                        // Show success rate if available\n                        if (params.confidence) {\n                            details += `\\nüìä Confidence: ${(params.confidence * 100).toFixed(1)}%`;\n                        }\n                    } else {\n                        // For other tools, show basic info\n                        details = `\\nTool: ${toolName}`;\n                        const paramsStr = JSON.stringify(params, null, 2);\n                        // Truncate long parameter strings\n                        if (paramsStr.length > 200) {\n                            details += `\\nParams: ${paramsStr.substring(0, 200)}...`;\n                        } else {\n                            details += `\\nParams: ${paramsStr}`;\n                        }\n                    }\n                } else if (action.type === 'shell_cmd') {\n                    details = `\\nCommand: ${action.payload.command}`;\n                }\n\n                // Truncate reasoning to fit on screen\n                let reasoning = action.reasoning || 'No reason provided';\n                const maxReasoningLength = 200;\n                if (reasoning.length > maxReasoningLength) {\n                    reasoning = reasoning.substring(0, maxReasoningLength) + '...';\n                }\n\n                const message = `${summary || `Agent wants to execute ${action.type}`}${details}\\n\\nReason: ${reasoning}`;\n\n                const choice = await vscode.window.showInformationMessage(\n                    message,\n                    { modal: true },\n                    'Approve', 'Reject'\n                );\n\n                if (choice === 'Approve') {\n                    return { status: 'approved', by: 'human', timestamp: Date.now() };\n                } else {\n                    return { status: 'rejected', by: 'human', reason: 'User Denied via VS Code UI', timestamp: Date.now() };\n                }\n            };\n\n            // ‰ΩøÁî® VSCodeAgentRuntime Êõø‰ª£ÂéüÂßãÁöÑ AgentRuntime\n            const runtime = new VSCodeAgentRuntime();\n\n            let fullAiResponse = '';\n            await runtime.runChat(\n                userInput,\n                (chunk) => {\n                    fullAiResponse += chunk;\n                    this._view?.webview.postMessage({ type: 'aiChunk', value: chunk });\n                },\n                this._currentModel, // ‰ΩøÁî®ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã\n                () => {\n                    // Context initialized callback\n                    console.log('[ChatViewProvider] Context initialized, sending to UI...');\n                    this.sendContextToUI(runtime.getContextManager());\n                },\n                signal // ‚úÖ ‰º†ÈÄíÂèñÊ∂à‰ø°Âè∑\n            );\n\n            // ÂèëÈÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØÂà∞UIÔºà‰ΩÜ‰∏çËá™Âä®ÂºπÂá∫Èù¢ÊùøÔºâ\n            this.sendContextToUI(runtime.getContextManager());\n\n            // Âè™‰øùÂ≠òÊúâÊÑè‰πâÁöÑ AI ÂõûÂ§çÔºåËøáÊª§Á©∫ÂÜÖÂÆπ\n            if (fullAiResponse && fullAiResponse.trim()) {\n                this._messages.push({ role: 'assistant', content: fullAiResponse });\n            }\n            this._saveHistory();\n            this._view?.webview.postMessage({ type: 'done' });\n            (GovernanceService as any).adjudicate = originalAdjudicate;\n\n        } catch (error: any) {\n            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂèñÊ∂àÊìç‰Ωú\n            if (signal.aborted) {\n                console.log('[ChatViewProvider] Task was aborted');\n                this._view?.webview.postMessage({ \n                    type: 'error', \n                    value: 'Generation stopped by user' \n                });\n            } else {\n                this._view.webview.postMessage({ type: 'error', value: error.message });\n            }\n        } finally {\n            // Ê∏ÖÁêÜ AbortController\n            this._abortController = null;\n        }\n    }\n\n    /**\n     * ÂèëÈÄÅ‰∏ä‰∏ãÊñá‰ø°ÊÅØÂà∞UI\n     */\n    private sendContextToUI(contextManager: any) {\n        if (!this._view) return;\n\n        try {\n            const contextBuffer = contextManager.getContextBuffer();\n            const items = contextBuffer.export();\n\n            const high: any[] = [];\n            const medium: any[] = [];\n            const low: any[] = [];\n\n            for (const item of items) {\n                const confidence = item.importance?.confidence ?? 0.5;\n                // Á°Æ‰øù tags Â≠òÂú®\n                const tags = item.tags || [];\n                \n                // Â∞Ü item ËΩ¨Êç¢‰∏∫ UI ÈúÄË¶ÅÁöÑËΩªÈáèÁ∫ßÂØπË±°\n                const payload = {\n                    ...item,\n                    tags: tags // Á°Æ‰øù‰º†ÈÄíÂ§ÑÁêÜÂêéÁöÑ tags\n                };\n\n                if (confidence >= 0.8) high.push(payload);\n                else if (confidence >= 0.4) medium.push(payload);\n                else low.push(payload);\n            }\n\n            // ÂèëÈÄÅÂàÜÁªÑÂêéÁöÑ‰∏ä‰∏ãÊñáÊï∞ÊçÆÂà∞webview\n            this._view.webview.postMessage({\n                type: 'contextUpdate',\n                value: [...high, ...medium, ...low], // ÊöÇÊó∂‰øùÊåÅÊâÅÂπ≥ÂàóË°®‰ª•ÂÖºÂÆπÁé∞ÊúâUIÔºåÂêéÁª≠ÂèØÂçáÁ∫ß‰∏∫ÂàÜÁªÑÊòæÁ§∫\n                groups: { high, medium, low } // ÂêåÊó∂ÂèëÈÄÅÂàÜÁªÑÊï∞ÊçÆ‰æõÊú™Êù•‰ΩøÁî®\n            });\n\n            // Ëá™Âä®ÊâìÂºÄ‰∏ä‰∏ãÊñáÈù¢Êùø\n            if (items.length > 0) {\n                this._view.webview.postMessage({ type: 'showContextPanel' });\n            }\n\n            console.log(`[ChatViewProvider] Sent context: High(${high.length}) Med(${medium.length}) Low(${low.length})`);\n        } catch (error) {\n            console.error('[ChatViewProvider] Error sending context to UI:', error);\n        }\n    }\n\n    private async handleReadFile(webviewView: vscode.WebviewView, filePath: string, isReference: boolean = false) {\n        try {\n            const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n            if (!workspaceFolder) {\n                webviewView.webview.postMessage({ \n                    type: 'error', \n                    value: 'No workspace folder open' \n                });\n                return;\n            }\n\n            const fileUri = vscode.Uri.file(path.join(workspaceFolder.uri.fsPath, filePath));\n            const document = await vscode.workspace.openTextDocument(fileUri);\n            const content = document.getText();\n            \n            // ÂèëÈÄÅÊñá‰ª∂ÂÜÖÂÆπÂà∞ UI\n            webviewView.webview.postMessage({\n                type: 'fileContent',\n                filePath: filePath,\n                content: content,\n                isReference: isReference\n            });\n            \n            // Âè™Êúâ‰∏çÊòØÂºïÁî®Êó∂ÊâçËá™Âä®ÂàÜÊûê\n            if (!isReference) {\n                const message = `ËØ∑ÂàÜÊûê‰ª•‰∏ãÊñá‰ª∂Ôºö${filePath}\\n\\n\\`\\`\\`\\`${this.getFileLanguage(filePath)}\\n${content}\\n\\`\\`\\``;\n                await this.handleAgentTask(message);\n            }\n            \n        } catch (error: any) {\n            webviewView.webview.postMessage({ \n                type: 'error', \n                value: `Failed to read file: ${error.message}` \n            });\n        }\n    }\n\n    private getFileLanguage(filePath: string): string {\n        const ext = filePath.split('.').pop()?.toLowerCase() || '';\n        const langMap: Record<string, string> = {\n            'js': 'javascript',\n            'ts': 'typescript',\n            'tsx': 'typescript',\n            'jsx': 'javascript',\n            'py': 'python',\n            'java': 'java',\n            'go': 'go',\n            'rs': 'rust',\n            'cpp': 'cpp',\n            'c': 'c',\n            'h': 'c',\n            'vue': 'vue',\n            'yaml': 'yaml',\n            'yml': 'yaml',\n            'json': 'json',\n            'md': 'markdown',\n            'html': 'html',\n            'css': 'css',\n            'sh': 'bash',\n            'bash': 'bash'\n        };\n        return langMap[ext] || 'text';\n    }\n\n    private async handleApplyDiff(diffData: any) {\n        if (!this._view) return;\n\n        try {\n            if (diffData.type === 'unified') {\n                for (const file of diffData.files) {\n                    await this.applyUnifiedDiff(file);\n                }\n                this._view.webview.postMessage({ type: 'diffApplied' });\n                vscode.window.showInformationMessage('‚úì Diff applied successfully!');\n            } else if (diffData.type === 'simple') {\n                await this.applySimpleDiff(diffData);\n                this._view.webview.postMessage({ type: 'diffApplied' });\n                vscode.window.showInformationMessage('‚úì Diff applied successfully!');\n            } else {\n                throw new Error('Unknown diff format');\n            }\n        } catch (error: any) {\n            this._view.webview.postMessage({ type: 'diffError', value: error.message });\n            vscode.window.showErrorMessage(`Failed to apply diff: ${error.message}`);\n        }\n    }\n\n    private async applyUnifiedDiff(file: any) {\n        const workspaceFolder = vscode.workspace.workspaceFolders?.[0];\n        if (!workspaceFolder) {\n            throw new Error('No workspace folder open');\n        }\n\n        const filePath = path.join(workspaceFolder.uri.fsPath, file.newFile || file.oldFile);\n        const fileUri = vscode.Uri.file(filePath);\n\n        let document: vscode.TextDocument;\n        try {\n            document = await vscode.workspace.openTextDocument(fileUri);\n        } catch {\n            const edit = new vscode.WorkspaceEdit();\n            edit.createFile(fileUri, { ignoreIfExists: true });\n            await vscode.workspace.applyEdit(edit);\n            document = await vscode.workspace.openTextDocument(fileUri);\n        }\n\n        const edit = new vscode.WorkspaceEdit();\n        for (const hunk of file.hunks) {\n            let startLine = hunk.oldStart - 1;\n            if (startLine < 0) startLine = 0;\n            const endLine = startLine + hunk.oldLines;\n\n            const newLines: string[] = [];\n            for (const line of hunk.lines) {\n                if (line.startsWith('+')) {\n                    newLines.push(line.substring(1));\n                } else if (!line.startsWith('-')) {\n                    newLines.push(line.startsWith(' ') ? line.substring(1) : line);\n                }\n            }\n\n            const range = new vscode.Range(startLine, 0, endLine, 0);\n            edit.replace(fileUri, range, newLines.join('\\n') + '\\n');\n        }\n\n        await vscode.workspace.applyEdit(edit);\n        await document.save();\n        await vscode.window.showTextDocument(document);\n    }\n\n    private async applySimpleDiff(diffData: any) {\n        const editor = vscode.window.activeTextEditor;\n        if (!editor) {\n            throw new Error('No active editor. Please open a file first.');\n        }\n\n        const document = editor.document;\n        const edit = new vscode.WorkspaceEdit();\n        const fullText = document.getText();\n\n        if (diffData.removed.length > 0) {\n            const toRemove = diffData.removed.join('\\n');\n            const index = fullText.indexOf(toRemove);\n\n            if (index !== -1) {\n                const startPos = document.positionAt(index);\n                const endPos = document.positionAt(index + toRemove.length);\n                const range = new vscode.Range(startPos, endPos);\n\n                if (diffData.added.length > 0) {\n                    edit.replace(document.uri, range, diffData.added.join('\\n'));\n                } else {\n                    edit.delete(document.uri, range);\n                }\n            } else {\n                throw new Error('Could not find the content to replace in the active file');\n            }\n        } else if (diffData.added.length > 0) {\n            edit.insert(document.uri, editor.selection.active, diffData.added.join('\\n'));\n        }\n\n        await vscode.workspace.applyEdit(edit);\n        await document.save();\n    }\n\n    public async clear() {\n        this._messages = [];\n        await this._saveHistory();\n        await chatHistoryStorage.clearChatHistory();\n        this._view?.webview.postMessage({ type: 'clear' });\n    }\n\n    private async loadHistory() {\n        // ‰ºòÂÖàÂ∞ùËØï‰ªéÊñá‰ª∂Á≥ªÁªüÂä†ËΩΩ\n        try {\n            const fileHistory = await chatHistoryStorage.loadChatHistory();\n            if (fileHistory && fileHistory.length > 0) {\n                // Â∞Ü AIRequestMessage ËΩ¨Êç¢‰∏∫ÂÜÖÈÉ®Ê†ºÂºè\n                this._messages = fileHistory.map(msg => ({\n                    role: msg.role,\n                    content: msg.content\n                }));\n                console.log(`[ChatViewProvider] Loaded ${this._messages.length} messages from file storage`);\n                return;\n            }\n        } catch (e) {\n            console.warn('[ChatViewProvider] Failed to load from file storage, falling back to workspaceState:', e);\n        }\n        \n        // ÂõûÈÄÄÂà∞ workspaceState\n        this._messages = this._context.workspaceState.get<{ role: string, content: string }[]>('chatHistory', []);\n        console.log(`[ChatViewProvider] Restored ${this._messages.length} messages from workspaceState`);\n    }\n\n    private _saveHistory() {\n        // ‰øùÂ≠òÂà∞Êñá‰ª∂Á≥ªÁªüÔºàÊåÅ‰πÖÂåñÔºâ\n        const historyForFile = this._messages.map(msg => ({\n            role: msg.role as 'system' | 'user' | 'assistant',\n            content: msg.content\n        }));\n        chatHistoryStorage.saveChatHistory(historyForFile);\n        \n        // ÂêåÊó∂‰øùÂ≠òÂà∞ workspaceStateÔºà‰Ωú‰∏∫Â§á‰ªΩÔºâ\n        this._context.workspaceState.update('chatHistory', this._messages);\n    }\n\n    private async exportChatHistory() {\n        if (this._messages.length === 0) {\n            vscode.window.showWarningMessage('No chat history to export.');\n            return;\n        }\n\n        const mdContent = this._messages.map(m => {\n            const role = m.role === 'user' ? '### üë§ User' : '### ü§ñ Assistant';\n            return `${role}\\n\\n${m.content}\\n\\n---\\n`;\n        }).join('\\n');\n\n        const uri = await vscode.window.showSaveDialog({\n            defaultUri: vscode.Uri.file(path.join(vscode.workspace.workspaceFolders?.[0].uri.fsPath || '', 'chat_export.md')),\n            filters: { 'Markdown': ['md'] }\n        });\n\n        if (uri) {\n            fs.writeFileSync(uri.fsPath, mdContent);\n            vscode.window.showInformationMessage('Chat history exported successfully!');\n        }\n    }\n\n    private _getHtmlForWebview(webview: vscode.Webview) {\n        const scriptUri = webview.asWebviewUri(vscode.Uri.joinPath(this._context.extensionUri, 'dist', 'webview', 'marked.min.js'));\n        const htmlPath = path.join(this._context.extensionPath, 'dist', 'webview', 'sidebar.html');\n        let htmlSnippet = fs.readFileSync(htmlPath, 'utf8');\n\n        // ÁîüÊàêÈöèÊú∫ nonce Áî®‰∫é CSP\n        const nonce = getNonce();\n\n        // Ê≥®ÂÖ• CSP ÂíåÊú¨Âú∞ËÑöÊú¨Ë∑ØÂæÑ\n        htmlSnippet = htmlSnippet.replace(\n            /<script src=\"https:\\/\\/cdn\\.jsdelivr\\.net\\/npm\\/marked\\/marked\\.min\\.js\"><\\/script>/,\n            `<script nonce=\"${nonce}\" src=\"${scriptUri}\"></script>`\n        );\n\n        // Ê≥®ÂÖ• CSP Meta Ê†áÁ≠æ\n        const csp = `<meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}'; img-src ${webview.cspSource} https:; connect-src *;\">`;\n        htmlSnippet = htmlSnippet.replace('<head>', `<head>\\n    ${csp}`);\n\n        // ‰∏∫ÊâÄÊúâÁöÑ <script> Ê†áÁ≠æÊ≥®ÂÖ• nonce\n        htmlSnippet = htmlSnippet.replace(/<script>/g, `<script nonce=\"${nonce}\">`);\n\n        return htmlSnippet;\n    }\n}\n\nfunction getNonce() {\n    let text = '';\n    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    for (let i = 0; i < 32; i++) {\n        text += possible.charAt(Math.floor(Math.random() * possible.length));\n    }\n    return text;\n}\n",
    "id": "file:src/vscode/provider/ChatViewProvider.ts",
    "tokens": 7259,
    "importance": 0.5,
    "lastUsedAt": 1769749107898
  },
  {
    "type": "file",
    "path": "src/vscode/webview/sidebar.html",
    "content": "<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>Yuangs Premium AI</title>\n    <script src=\"https://cdn.jsdelivr.net/npm/marked/marked.min.js\"></script>\n    <style>\n      :root {\n        --bubble-user: var(--vscode-button-background);\n        --bubble-ai: var(--vscode-editor-background);\n        --text-main: var(--vscode-foreground);\n        --accent: var(--vscode-focusBorder);\n        --border: var(--vscode-panel-border);\n        --input-bg: var(--vscode-input-background);\n      }\n\n      body {\n        font-family:\n          var(--vscode-font-family),\n          \"Inter\",\n          -apple-system,\n          sans-serif;\n        font-size: var(--vscode-font-size);\n        color: var(--text-main);\n        background: var(--vscode-sideBar-background);\n        padding: 0;\n        margin: 0;\n        display: flex;\n        flex-direction: column;\n        height: 100vh;\n      }\n\n      /* È°∂ÈÉ®Ë£ÖÈ•∞Á∫ø‰∏éÊ†áÈ¢òÊ†è */\n      header {\n        height: 40px;\n        width: 100%;\n        background: var(--vscode-sideBar-background);\n        border-bottom: 1px solid var(--border);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 0 12px;\n        box-sizing: border-box;\n        z-index: 100;\n      }\n\n      header::before {\n        content: \"\";\n        height: 2px;\n        width: 100%;\n        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);\n        position: absolute;\n        top: 0;\n        left: 0;\n      }\n\n      .header-title {\n        font-size: 0.9em;\n        font-weight: bold;\n        opacity: 0.8;\n      }\n\n      .header-actions {\n        display: flex;\n        gap: 8px;\n        align-items: center;\n        z-index: 2000;\n      }\n\n      .icon-btn {\n        background: transparent;\n        border: none;\n        color: var(--text-main);\n        cursor: pointer;\n        opacity: 0.6;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 4px;\n        border-radius: 4px;\n      }\n\n      /* Ê®°ÂûãÈÄâÊã©Âô®Ê†∑Âºè */\n      .model-selector {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding: 4px 8px;\n        background: var(--vscode-input-background);\n        border: 1px solid var(--border);\n        border-radius: 6px;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .model-selector:hover {\n        border-color: var(--accent);\n      }\n\n      .model-selector-label {\n        font-size: 0.75em;\n        opacity: 0.8;\n        white-space: nowrap;\n      }\n\n      .model-selector-dropdown {\n        position: absolute;\n        top: 40px;\n        right: 12px;\n        background: var(--vscode-editor-background);\n        border: 1px solid var(--border);\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n        min-width: 200px;\n        max-height: 300px;\n        overflow-y: auto;\n        display: none;\n        z-index: 3000;\n      }\n\n      .model-selector-dropdown.visible {\n        display: block;\n      }\n\n      .model-option {\n        padding: 8px 12px;\n        cursor: pointer;\n        transition: background 0.2s;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        font-size: 0.85em;\n      }\n\n      .model-option:hover {\n        background: var(--vscode-list-hoverBackground);\n      }\n\n      .model-option.active {\n        background: var(--vscode-list-activeSelectionBackground);\n        color: var(--vscode-list-activeSelectionForeground);\n      }\n\n      .model-option-name {\n        flex: 1;\n      }\n\n      .model-option-icon {\n        opacity: 0.5;\n        font-size: 0.8em;\n      }\n\n      .model-option.active .model-option-icon {\n        opacity: 1;\n      }\n\n      .icon-btn:hover {\n        opacity: 1;\n        background: var(--vscode-toolbar-hoverBackground);\n      }\n\n      .icon-btn.context-btn {\n        opacity: 1 !important;\n        background: var(--vscode-button-background);\n        color: var(--vscode-button-foreground);\n        border: 1px solid var(--vscode-focusBorder);\n        z-index: 2000;\n        padding: 6px 12px;\n      }\n\n      .icon-btn.context-btn:hover {\n        opacity: 1;\n        background: var(--vscode-button-hoverBackground);\n      }\n\n      #chat-container {\n        flex-grow: 1;\n        overflow-y: auto;\n        padding: 16px;\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n        scroll-behavior: smooth;\n      }\n\n      /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */\n      #chat-container::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      #chat-container::-webkit-scrollbar-thumb {\n        background: var(--vscode-scrollbarSlider-background);\n        border-radius: 10px;\n      }\n\n      .message {\n        padding: 12px 16px;\n        border-radius: 12px;\n        max-width: 85%;\n        word-wrap: break-word;\n        position: relative;\n        animation: fadeIn 0.3s ease-out;\n        line-height: 1.5;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n\n      /* Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆÂÆπÂô® */\n      .message-actions {\n        position: absolute;\n        top: 8px;\n        right: 8px;\n        display: flex;\n        gap: 4px;\n        opacity: 0;\n        transition: opacity 0.2s;\n        z-index: 10;\n      }\n\n      .message:hover .message-actions {\n        opacity: 1;\n      }\n\n      /* Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆ */\n      .message-action-btn {\n        background: rgba(0, 0, 0, 0.6);\n        border: none;\n        color: white;\n        width: 24px;\n        height: 24px;\n        border-radius: 4px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 0;\n        font-size: 14px;\n        transition: all 0.2s;\n      }\n\n      .message-action-btn:hover {\n        background: rgba(0, 0, 0, 0.8);\n        transform: scale(1.1);\n      }\n\n      .message-action-btn:active {\n        transform: scale(0.95);\n      }\n\n      .user-message .message-action-btn {\n        background: rgba(255, 255, 255, 0.3);\n        color: white;\n      }\n\n      .user-message .message-action-btn:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      @keyframes fadeIn {\n        from {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      .user-message {\n        align-self: flex-end;\n        background: var(--bubble-user);\n        color: var(--vscode-button-foreground);\n        border-bottom-right-radius: 2px;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      }\n\n      .ai-message {\n        align-self: flex-start;\n        background: var(--bubble-ai);\n        border: 1px solid var(--border);\n        border-bottom-left-radius: 2px;\n        backdrop-filter: blur(10px);\n      }\n\n      /* Markdown Ê†∑Âºè */\n      .ai-message pre {\n        background: rgba(0, 0, 0, 0.2);\n        padding: 8px;\n        border-radius: 6px;\n        overflow-x: auto;\n        margin: 8px 0;\n        position: relative;\n      }\n\n      /* Diff ‰ª£Á†ÅÂùóÊ†∑Âºè */\n      .ai-message pre.diff-block {\n        border: 1px solid var(--vscode-editorWidget-border);\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .ai-message pre.diff-block::before {\n        content: \"üìù Diff\";\n        position: absolute;\n        top: 4px;\n        left: 8px;\n        font-size: 0.75em;\n        opacity: 0.6;\n        font-family: var(--vscode-font-family);\n      }\n\n      /* Â∫îÁî®ÊåâÈíÆ */\n      .apply-diff-btn {\n        position: absolute;\n        top: 4px;\n        right: 8px;\n        background: var(--vscode-button-background);\n        color: var(--vscode-button-foreground);\n        border: none;\n        padding: 4px 12px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 0.75em;\n        font-family: var(--vscode-font-family);\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        opacity: 0;\n        transition:\n          opacity 0.2s,\n          background 0.2s;\n        z-index: 10;\n      }\n\n      .ai-message pre.diff-block:hover .apply-diff-btn {\n        opacity: 1;\n      }\n\n      .apply-diff-btn:hover {\n        background: var(--vscode-button-hoverBackground);\n      }\n\n      .apply-diff-btn:active {\n        transform: scale(0.95);\n      }\n\n      .apply-diff-btn.applied {\n        background: var(--vscode-testing-iconPassed);\n        opacity: 1;\n      }\n\n      .apply-diff-btn.error {\n        background: var(--vscode-testing-iconFailed);\n        opacity: 1;\n      }\n\n      .ai-message code {\n        font-family: var(--vscode-editor-font-family);\n        background: rgba(0, 0, 0, 0.1);\n        padding: 2px 4px;\n        border-radius: 4px;\n      }\n\n      .system-message {\n        align-self: center;\n        font-size: 0.85em;\n        color: var(--vscode-descriptionForeground);\n        background: transparent;\n        box-shadow: none;\n        text-align: center;\n        opacity: 0.7;\n      }\n\n      #input-area {\n        padding: 16px;\n        background: var(--vscode-sideBar-background);\n        border-top: 1px solid var(--border);\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        position: relative;\n      }\n\n      .input-wrapper {\n        display: flex;\n        background: var(--input-bg);\n        border: 1px solid var(--border);\n        border-radius: 8px;\n        padding: 4px 8px;\n        align-items: center;\n        transition: border-color 0.2s;\n      }\n\n      .input-wrapper:focus-within {\n        border-color: var(--accent);\n      }\n\n      #user-input {\n        flex-grow: 1;\n        background: transparent;\n        color: var(--vscode-input-foreground);\n        border: none;\n        padding: 8px;\n        outline: none;\n        resize: none;\n        max-height: 120px;\n        min-height: 24px;\n        font-family: inherit;\n      }\n\n      #send-btn {\n        background: var(--vscode-button-background);\n        color: var(--vscode-button-foreground);\n        border: none;\n        width: 32px;\n        height: 32px;\n        border-radius: 6px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.2s;\n      }\n\n      #send-btn:hover {\n        opacity: 0.9;\n      }\n\n      #stop-btn {\n        background: var(--vscode-errorForeground);\n        color: var(--vscode-button-foreground);\n        border: none;\n        width: 32px;\n        height: 32px;\n        border-radius: 6px;\n        cursor: pointer;\n        display: none;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.2s;\n        animation: pulse 1.5s infinite;\n      }\n\n      #stop-btn:hover {\n        opacity: 0.8;\n      }\n\n      #stop-btn.visible {\n        display: flex;\n      }\n\n      @keyframes pulse {\n        0% {\n          box-shadow: 0 0 0 0 rgba(235, 86, 86, 0.7);\n        }\n        70% {\n          box-shadow: 0 0 0 6px rgba(235, 86, 86, 0);\n        }\n        100% {\n          box-shadow: 0 0 0 0 rgba(235, 86, 86, 0);\n        }\n      }\n\n      .typing-indicator {\n        display: flex;\n        gap: 4px;\n        padding: 4px;\n      }\n\n      .dot {\n        width: 6px;\n        height: 6px;\n        background: #aaa;\n        border-radius: 50%;\n        animation: bounce 1.4s infinite ease-in-out both;\n      }\n\n      .dot:nth-child(1) {\n        animation-delay: -0.32s;\n      }\n\n      .dot:nth-child(2) {\n        animation-delay: -0.16s;\n      }\n\n      @keyframes bounce {\n        0%,\n        80%,\n        100% {\n          transform: scale(0);\n        }\n\n        40% {\n          transform: scale(1);\n        }\n      }\n\n      /* Âª∫ËÆÆÂàóË°®Ê†∑Âºè */\n      #suggestions-list {\n        position: absolute;\n        bottom: 100%;\n        left: 16px;\n        right: 16px;\n        background: var(--vscode-editor-background);\n        border: 1px solid var(--border);\n        border-radius: 8px;\n        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);\n        max-height: 200px;\n        overflow-y: auto;\n        display: none;\n        z-index: 1000;\n        margin-bottom: 8px;\n      }\n\n      .suggestion-item {\n        padding: 8px 12px;\n        cursor: pointer;\n        transition: background 0.2s;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        font-size: 0.9em;\n      }\n\n      .suggestion-item:hover,\n      .suggestion-item.selected {\n        background: var(--vscode-list-hoverBackground);\n        color: var(--vscode-list-hoverForeground);\n      }\n\n      .suggestion-icon {\n        opacity: 0.7;\n        font-size: 1.1em;\n      }\n\n      /* ÊµÅÂºè‰º†ËæìÊúüÈó¥ÁöÑËçâÁ®øÊÄÅÊ†∑Âºè */\n      .streaming-draft {\n        font-family: \"Courier New\", Consolas, Monaco, monospace;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n        line-height: 1.4;\n      }\n\n      .streaming-content {\n        margin: 0;\n        padding: 0;\n        font-family: inherit;\n        line-height: inherit;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n      }\n\n      .final-render {\n        /* ÊúÄÁªàÊ∏≤ÊüìÂÆåÊàêÂêéÁöÑÊ†∑Âºè */\n      }\n\n      /* ÂÖâÊ†áÈó™ÁÉÅÊïàÊûú */\n      .cursor {\n        display: inline-block;\n        width: 8px;\n        height: 16px;\n        background: var(--text-main);\n        margin-left: 4px;\n        animation: blink 1s step-start infinite;\n        vertical-align: middle;\n        opacity: 0.8;\n        border-radius: 1px;\n      }\n\n      @keyframes blink {\n        50% {\n          opacity: 0;\n        }\n      }\n\n      /* Êñá‰ª∂Èù¢ÊùøÊ†∑Âºè */\n      #files-panel {\n        position: fixed;\n        top: 40px;\n        left: -400px;\n        width: 380px;\n        height: calc(100vh - 40px);\n        background: var(--vscode-sideBar-background);\n        border-right: 1px solid var(--border);\n        border-top: 1px solid var(--border);\n        z-index: 1000;\n        transition: left 0.3s ease;\n        display: flex;\n        flex-direction: column;\n        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.2);\n      }\n\n      #files-panel.open {\n        left: 0;\n      }\n\n      .files-panel-header {\n        padding: 12px 16px;\n        background: var(--vscode-editor-background);\n        border-bottom: 1px solid var(--border);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .files-panel-title {\n        font-weight: bold;\n        font-size: 0.9em;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .files-panel-stats {\n        font-size: 0.75em;\n        opacity: 0.7;\n      }\n\n      .files-panel-close {\n        background: transparent;\n        border: none;\n        color: var(--text-main);\n        cursor: pointer;\n        padding: 4px;\n        opacity: 0.6;\n      }\n\n      .files-panel-close:hover {\n        opacity: 1;\n      }\n\n      .files-panel-controls {\n        padding: 8px 16px;\n        border-bottom: 1px solid var(--border);\n        display: flex;\n        gap: 8px;\n      }\n\n      .files-search {\n        flex: 1;\n        background: var(--input-bg);\n        border: 1px solid var(--border);\n        border-radius: 4px;\n        padding: 6px 10px;\n        color: var(--vscode-input-foreground);\n        font-size: 0.85em;\n        outline: none;\n      }\n\n      .files-search:focus {\n        border-color: var(--accent);\n      }\n\n      .files-panel-content {\n        flex: 1;\n        overflow-y: auto;\n        padding: 8px 0;\n      }\n\n      .file-tree-item {\n        display: flex;\n        align-items: center;\n        padding: 4px 16px;\n        cursor: pointer;\n        transition: background 0.2s;\n        user-select: none;\n      }\n\n      .file-tree-item:hover {\n        background: var(--vscode-list-hoverBackground);\n      }\n\n      .file-tree-item.selected {\n        background: var(--vscode-list-activeSelectionBackground);\n        color: var(--vscode-list-activeSelectionForeground);\n      }\n\n      .file-tree-icon {\n        margin-right: 6px;\n        font-size: 1em;\n        opacity: 0.8;\n        flex-shrink: 0;\n      }\n\n      .file-tree-icon.expanded::before {\n        content: \"‚ñº\";\n        font-size: 0.7em;\n        margin-right: 2px;\n      }\n\n      .file-tree-icon.collapsed::before {\n        content: \"‚ñ∂\";\n        font-size: 0.7em;\n        margin-right: 2px;\n      }\n\n      .file-tree-name {\n        flex: 1;\n        font-size: 0.85em;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .file-tree-children {\n        display: none;\n      }\n\n      .file-tree-children.expanded {\n        display: block;\n      }\n\n      .file-tree-item.folder {\n        font-weight: 500;\n      }\n\n      .file-tree-item.file {\n        opacity: 0.9;\n      }\n\n      .file-empty {\n        text-align: center;\n        padding: 40px 20px;\n        opacity: 0.5;\n        font-size: 0.9em;\n      }\n\n      .file-loading {\n        text-align: center;\n        padding: 20px;\n        opacity: 0.7;\n      }\n\n      /* ‰∏ä‰∏ãÊñáÈù¢ÊùøÊ†∑Âºè */\n      #context-panel {\n        position: fixed;\n        top: 40px;\n        right: -400px;\n        width: 380px;\n        height: calc(100vh - 40px);\n        background: var(--vscode-sideBar-background);\n        border-left: 1px solid var(--border);\n        border-top: 1px solid var(--border);\n        z-index: 1000;\n        transition: right 0.3s ease;\n        display: flex;\n        flex-direction: column;\n        box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);\n      }\n\n      #context-panel.open {\n        right: 0;\n      }\n\n      .context-panel-header {\n        padding: 12px 16px;\n        background: var(--vscode-editor-background);\n        border-bottom: 1px solid var(--border);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .context-panel-title {\n        font-weight: bold;\n        font-size: 0.9em;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .context-panel-stats {\n        font-size: 0.75em;\n        opacity: 0.7;\n      }\n\n      .context-panel-close {\n        background: transparent;\n        border: none;\n        color: var(--text-main);\n        cursor: pointer;\n        padding: 4px;\n        opacity: 0.6;\n      }\n\n      .context-panel-close:hover {\n        opacity: 1;\n      }\n\n      .context-panel-controls {\n        padding: 8px 16px;\n        border-bottom: 1px solid var(--border);\n        display: flex;\n        gap: 8px;\n        flex-wrap: wrap;\n      }\n\n      .context-search {\n        flex: 1;\n        background: var(--input-bg);\n        border: 1px solid var(--border);\n        border-radius: 4px;\n        padding: 6px 10px;\n        color: var(--vscode-input-foreground);\n        font-size: 0.85em;\n        outline: none;\n      }\n\n      .context-search:focus {\n        border-color: var(--accent);\n      }\n\n      .context-filter-btn {\n        background: var(--input-bg);\n        border: 1px solid var(--border);\n        border-radius: 4px;\n        padding: 4px 8px;\n        color: var(--text-main);\n        cursor: pointer;\n        font-size: 0.75em;\n        transition: all 0.2s;\n      }\n\n      .context-filter-btn:hover,\n      .context-filter-btn.active {\n        background: var(--accent);\n        color: var(--vscode-button-foreground);\n        border-color: var(--accent);\n      }\n\n      .context-panel-content {\n        flex: 1;\n        overflow-y: auto;\n        padding: 12px;\n      }\n\n      .context-item {\n        background: var(--vscode-editor-background);\n        border: 1px solid var(--border);\n        border-radius: 8px;\n        margin-bottom: 8px;\n        cursor: pointer;\n        transition: all 0.2s;\n        overflow: hidden;\n      }\n\n      .context-item.collapsed .context-item-details {\n        display: none;\n      }\n\n      .context-item.collapsed {\n        padding: 8px 12px;\n      }\n\n      .context-item.expanded {\n        padding: 12px;\n      }\n\n      .context-item:hover {\n        border-color: var(--accent);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n\n      .context-item-header {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 8px;\n      }\n\n      .context-item.collapsed .context-item-header {\n        margin-bottom: 0;\n      }\n\n      .context-item-toggle {\n        width: 16px;\n        height: 16px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0.6;\n        transition: transform 0.2s;\n      }\n\n      .context-item.expanded .context-item-toggle {\n        transform: rotate(90deg);\n      }\n\n      .context-item-details {\n        animation: slideDown 0.2s ease-out;\n      }\n\n      @keyframes slideDown {\n        from {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n\n      .context-item-icon {\n        font-size: 1.2em;\n      }\n\n      .context-item-title {\n        flex: 1;\n        font-weight: 500;\n        font-size: 0.85em;\n        word-break: break-all;\n      }\n\n      .context-item-badges {\n        display: flex;\n        gap: 4px;\n      }\n\n      .context-badge {\n        background: rgba(127, 127, 127, 0.2);\n        border-radius: 4px;\n        padding: 2px 6px;\n        font-size: 0.7em;\n        opacity: 0.8;\n      }\n\n      .context-badge.source_code {\n        background: rgba(86, 156, 214, 0.2);\n      }\n\n      .context-badge.log {\n        background: rgba(152, 195, 121, 0.2);\n      }\n\n      .context-badge.git {\n        background: rgba(229, 192, 123, 0.2);\n      }\n\n      .context-badge.diagnostics {\n        background: rgba(224, 108, 117, 0.2);\n      }\n\n      .context-item-stats {\n        display: flex;\n        gap: 12px;\n        font-size: 0.75em;\n        opacity: 0.7;\n        margin-bottom: 8px;\n      }\n\n      .context-stat {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n      }\n\n      .context-usage-bar {\n        height: 3px;\n        background: rgba(127, 127, 127, 0.2);\n        border-radius: 2px;\n        overflow: hidden;\n        margin-bottom: 8px;\n      }\n\n      .context-usage-fill {\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          var(--vscode-focusBorder),\n          var(--accent)\n        );\n        border-radius: 2px;\n        transition: width 0.3s ease;\n      }\n\n      .context-item-preview {\n        background: rgba(0, 0, 0, 0.1);\n        border-radius: 6px;\n        padding: 8px;\n        font-family: var(--vscode-editor-font-family);\n        font-size: 0.8em;\n        max-height: 100px;\n        overflow-y: auto;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n      }\n\n      .context-empty {\n        text-align: center;\n        padding: 40px 20px;\n        opacity: 0.5;\n        font-size: 0.9em;\n      }\n\n      /* Flash notification styles */\n      .flash-notification {\n        position: fixed;\n        top: 60px;\n        right: 400px;\n        background: var(--vscode-notificationsInfoIcon-foreground);\n        color: var(--vscode-notificationsInfoIcon-background);\n        padding: 12px 20px;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n        z-index: 5000;\n        font-size: 0.9em;\n        animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;\n        max-width: 300px;\n      }\n\n      @keyframes slideInRight {\n        from {\n          opacity: 0;\n          transform: translateX(100%);\n        }\n        to {\n          opacity: 1;\n          transform: translateX(0);\n        }\n      }\n\n      @keyframes fadeOut {\n        from {\n          opacity: 1;\n        }\n        to {\n          opacity: 0;\n        }\n      }\n\n      /* Update indicator for context panel */\n      .context-panel-update-indicator {\n        position: absolute;\n        top: 8px;\n        right: 8px;\n        width: 8px;\n        height: 8px;\n        background: var(--vscode-testing-iconPassed);\n        border-radius: 50%;\n        animation: pulse 2s infinite;\n      }\n    </style>\n  </head>\n\n  <body>\n    <header>\n      <div class=\"header-title\">YUANGS AI</div>\n      <div class=\"header-actions\">\n        <!-- Ê®°ÂûãÈÄâÊã©Âô® -->\n        <div class=\"model-selector\" id=\"model-selector\" title=\"Select AI Model\">\n          <svg width=\"14\" height=\"14\" viewBox=\"0 0 16 16\" fill=\"currentColor\" style=\"opacity: 0.6;\">\n            <path d=\"M8 1a7 7 0 0 1 0 14A7 7 0 0 1 8 1zM0 8a8 8 0 1 0 16 0A8 8 0 0 0 0 8zm8 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm1-2.5V6H7v4.5h2z\"/>\n          </svg>\n          <span class=\"model-selector-label\" id=\"current-model\">Loading...</span>\n          <svg width=\"10\" height=\"10\" viewBox=\"0 0 16 16\" fill=\"currentColor\" style=\"opacity: 0.5;\">\n            <path d=\"M8 11L3 6h2.5L8 8.5L10.5 6H13L8 11z\"/>\n          </svg>\n        </div>\n        <!-- Ê®°Âûã‰∏ãÊãâËèúÂçï -->\n        <div class=\"model-selector-dropdown\" id=\"model-dropdown\">\n          <!-- ÈÄâÈ°πÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->\n        </div>\n        <button class=\"icon-btn\" id=\"files-toggle\" title=\"Show Files\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M1 3.5A1.5 1.5 0 0 1 2.5 2h3.879a1.5 1.5 0 0 1 1.06.44l1.122 1.12A1.5 1.5 0 0 0 9.62 4H13.5A1.5 1.5 0 0 1 15 5.5v8a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5v-10zM2.5 3a.5.5 0 0 0-.5.5V13a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5V5.5a.5.5 0 0 0-.5-.5H9.62a1.5 1.5 0 0 1-1.06-.44l-1.12-1.12A1.5 1.5 0 0 0 6.38 3H2.5zM4 7.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM4 10a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z\"\n            />\n          </svg>\n        </button>\n        <button\n          class=\"icon-btn context-btn\"\n          id=\"context-toggle\"\n          title=\"Show Context Panel\"\n          style=\"z-index: 2000\"\n        >\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L10.293 7.5H4.5z\"\n            />\n          </svg>\n          <span style=\"margin-left: 4px; font-size: 0.8em\">Context</span>\n        </button>\n        <button\n          class=\"icon-btn\"\n          id=\"export-btn\"\n          title=\"Export Chat History (.md)\"\n        >\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM13 5H9V1h4v4zM3 2v12h10V6H8V2H3z\"\n            />\n          </svg>\n        </button>\n        <button class=\"icon-btn\" id=\"clear-btn\" title=\"Clear Chat\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              fill-rule=\"evenodd\"\n              clip-rule=\"evenodd\"\n              d=\"M10 3h3v1h-1v9l-1 1H4l-1-1V4H2V3h3V2a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v1zM9 2H6v1h3V2zM4 4v9h7V4H4z\"\n            />\n          </svg>\n        </button>\n      </div>\n    </header>\n\n    <div id=\"chat-container\">\n      <!-- ÂàùÂßã‰∏∫Á©∫ÔºåÁ≠âÂæÖÂéÜÂè≤ËÆ∞ÂΩïÂä†ËΩΩ -->\n    </div>\n\n    <div id=\"input-area\">\n      <div id=\"suggestions-list\"></div>\n      <div class=\"input-wrapper\">\n        <textarea\n          id=\"user-input\"\n          rows=\"1\"\n          placeholder=\"Type your message...\"\n        ></textarea>\n        <button id=\"send-btn\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M1.146 1.146a.5.5 0 0 1 .538-.093l13 5a.5.5 0 0 1 0 .94l-13 5a.5.5 0 0 1-.667-.615L2.854 8 1.017 2.618a.5.5 0 0 1 .129-.472zM3.854 8l-1.5 4.34L13.84 8 2.354 3.66 3.854 8z\"\n            />\n          </svg>\n        </button>\n        <button id=\"stop-btn\" title=\"Stop Generation\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M4 4h8v8H4V4z\"\n            />\n          </svg>\n        </button>\n      </div>\n    </div>\n\n    <!-- Êñá‰ª∂Èù¢Êùø -->\n    <div id=\"files-panel\">\n      <div class=\"files-panel-header\">\n        <div class=\"files-panel-title\">\n          <span>üìÅ Files</span>\n          <span class=\"files-panel-stats\" id=\"files-stats\">Loading...</span>\n        </div>\n        <button class=\"files-panel-close\" id=\"files-close\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z\"\n            />\n          </svg>\n        </button>\n      </div>\n      <div class=\"files-panel-controls\">\n        <input\n          type=\"text\"\n          class=\"files-search\"\n          id=\"files-search\"\n          placeholder=\"Search files...\"\n        />\n      </div>\n      <div class=\"files-panel-content\" id=\"files-panel-content\">\n        <div class=\"file-loading\">Loading files...</div>\n      </div>\n    </div>\n\n    <!-- ‰∏ä‰∏ãÊñáÈù¢Êùø -->\n    <div id=\"context-panel\">\n      <div class=\"context-panel-header\">\n        <div class=\"context-panel-title\">\n          <span>üìã Context</span>\n          <span class=\"context-panel-stats\" id=\"context-stats\">0 items</span>\n        </div>\n        <button class=\"context-panel-close\" id=\"context-close\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\">\n            <path\n              d=\"M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z\"\n            />\n          </svg>\n        </button>\n      </div>\n      <div class=\"context-panel-controls\">\n        <input\n          type=\"text\"\n          class=\"context-search\"\n          id=\"context-search\"\n          placeholder=\"Search context...\"\n        />\n        <button class=\"context-filter-btn active\" data-filter=\"all\">All</button>\n        <button class=\"context-filter-btn\" data-filter=\"source_code\">\n          Code\n        </button>\n        <button class=\"context-filter-btn\" data-filter=\"log\">Log</button>\n        <button class=\"context-filter-btn\" data-filter=\"git\">Git</button>\n      </div>\n      <div class=\"context-panel-content\" id=\"context-panel-content\">\n        <div class=\"context-empty\">No context available</div>\n      </div>\n    </div>\n\n    <script>\n      const vscode = acquireVsCodeApi();\n      const chatContainer = document.getElementById(\"chat-container\");\n      const userInput = document.getElementById(\"user-input\");\n      const sendBtn = document.getElementById(\"send-btn\");\n      const stopBtn = document.getElementById(\"stop-btn\");\n      const exportBtn = document.getElementById(\"export-btn\");\n      const clearBtn = document.getElementById(\"clear-btn\");\n      const suggestionsList = document.getElementById(\"suggestions-list\");\n\n      // ‰∏ä‰∏ãÊñáÈù¢ÊùøÁõ∏ÂÖ≥ÂÖÉÁ¥†\n      const filesPanel = document.getElementById(\"files-panel\");\n      const filesToggle = document.getElementById(\"files-toggle\");\n      const filesClose = document.getElementById(\"files-close\");\n      const filesPanelContent = document.getElementById(\"files-panel-content\");\n      const filesSearch = document.getElementById(\"files-search\");\n      const filesStats = document.getElementById(\"files-stats\");\n\n      const contextPanel = document.getElementById(\"context-panel\");\n      const contextToggle = document.getElementById(\"context-toggle\");\n      const contextClose = document.getElementById(\"context-close\");\n      const contextPanelContent = document.getElementById(\n        \"context-panel-content\",\n      );\n      const contextSearch = document.getElementById(\"context-search\");\n      const contextStats = document.getElementById(\"context-stats\");\n      const contextFilterBtns = document.querySelectorAll(\n        \".context-filter-btn\",\n      );\n\n      let currentAiMessageElement = null;\n      let currentAiRawText = \"\";\n      let suggestionType = null; // '@' or '#'\n      let selectedSuggestionIndex = -1;\n      let currentSuggestions = [];\n\n      // ‰∏ä‰∏ãÊñáÁõ∏ÂÖ≥Áä∂ÊÄÅ\n      let currentContextItems = [];\n      let currentFilter = \"all\";\n      let currentSearchQuery = \"\";\n\n      // Êñá‰ª∂Áõ∏ÂÖ≥Áä∂ÊÄÅ\n      let fileTreeData = null;\n      let currentFileSearchQuery = \"\";\n      let allFiles = [];\n\n      // ËæìÂÖ•Ê°ÜÈ´òÂ∫¶Ëá™Âä®‰º∏Áº©\n      userInput.addEventListener(\"input\", (e) => {\n        userInput.style.height = \"auto\";\n        userInput.style.height = userInput.scrollHeight + \"px\";\n\n        handleTriggerDetection(e);\n      });\n\n      function handleTriggerDetection(e) {\n        const value = userInput.value;\n        const cursorPos = userInput.selectionStart;\n        const textBeforeCursor = value.substring(0, cursorPos);\n\n        // Ê£ÄÊµãËß¶ÂèëÁ¨¶\n        const lastAt = textBeforeCursor.lastIndexOf(\"@\");\n        const lastHash = textBeforeCursor.lastIndexOf(\"#\");\n        const lastTriggerIndex = Math.max(lastAt, lastHash);\n\n        if (\n          lastTriggerIndex !== -1 &&\n          (lastTriggerIndex === 0 ||\n            /\\s/.test(textBeforeCursor[lastTriggerIndex - 1]))\n        ) {\n          const trigger = textBeforeCursor[lastTriggerIndex];\n          const query = textBeforeCursor.substring(lastTriggerIndex + 1);\n\n          // Âè™ÊúâÂΩìÊü•ËØ¢‰∏≠Ê≤°ÊúâÁ©∫Ê†ºÊó∂ÊâçËß¶ÂèëÔºàÁ©∫Êü•ËØ¢‰πüÂÖÅËÆ∏Ëß¶ÂèëÔºâ\n          if (!/\\s/.test(query)) {\n            suggestionType = trigger;\n\n            // Á´ãÂç≥ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ\n            suggestionsList.innerHTML =\n              '<div class=\"suggestion-item\">üîç Loading...</div>';\n            suggestionsList.style.display = \"block\";\n\n            if (trigger === \"@\") {\n              vscode.postMessage({ type: \"getFiles\", query });\n            } else {\n              vscode.postMessage({ type: \"getSymbols\", query });\n            }\n            return;\n          }\n        }\n\n        hideSuggestions();\n      }\n\n      function showSuggestions(suggestions, trigger) {\n        currentSuggestions = suggestions;\n        if (suggestions.length === 0) {\n          hideSuggestions();\n          return;\n        }\n\n        suggestionsList.innerHTML = \"\";\n        suggestionsList.style.display = \"block\";\n        selectedSuggestionIndex = 0;\n\n        suggestions.forEach((item, index) => {\n          const div = document.createElement(\"div\");\n          div.className = \"suggestion-item\" + (index === 0 ? \" selected\" : \"\");\n          const icon = trigger === \"@\" ? \"üìÑ\" : \"üîß\";\n          div.innerHTML = `<span class=\"suggestion-icon\">${icon}</span><span>${item}</span>`;\n          div.onclick = () => selectSuggestion(item);\n          suggestionsList.appendChild(div);\n        });\n      }\n\n      function hideSuggestions() {\n        suggestionsList.style.display = \"none\";\n        suggestionType = null;\n        selectedSuggestionIndex = -1;\n      }\n\n      function selectSuggestion(value) {\n        const text = userInput.value;\n        const cursorPos = userInput.selectionStart;\n        const textBeforeCursor = text.substring(0, cursorPos);\n        const textAfterCursor = text.substring(cursorPos);\n\n        const lastTriggerIndex = textBeforeCursor.lastIndexOf(suggestionType);\n        const newText =\n          textBeforeCursor.substring(0, lastTriggerIndex) +\n          suggestionType +\n          value +\n          \" \" +\n          textAfterCursor;\n\n        userInput.value = newText;\n        hideSuggestions();\n        userInput.focus();\n\n        // ÈáçÊñ∞ËÆ°ÁÆóÈ´òÂ∫¶\n        userInput.style.height = \"auto\";\n        userInput.style.height = userInput.scrollHeight + \"px\";\n\n        // Â¶ÇÊûúÊòØ @ Êñá‰ª∂ÂºïÁî®ÔºåËá™Âä®ËØªÂèñÊñá‰ª∂Âπ∂ÊèíÂÖ•ÂÜÖÂÆπ\n        if (suggestionType === \"@\") {\n          console.log(`[selectSuggestion] Reading file for reference: ${value}`);\n          handleFileReadForReference(value);\n        }\n      }\n\n      // Â§ÑÁêÜ @ Êñá‰ª∂ÂºïÁî® - Âè™Ê∑ªÂä†Êñá‰ª∂Ë∑ØÂæÑÂºïÁî®Ôºå‰∏çÊèíÂÖ•ÂÜÖÂÆπ\n      async function handleFileReadForReference(filePath) {\n        console.log(`[handleFileReadForReference] Requesting file content for context: ${filePath}`);\n        // ÂèëÈÄÅËØªÂèñÊñá‰ª∂ËØ∑Ê±ÇÔºåÊ†áËÆ∞‰∏∫ÂºïÁî®Ê®°ÂºèÔºàÁî®‰∫éÂä†ÂÖ•‰∏ä‰∏ãÊñáÔºâ\n        vscode.postMessage({\n          type: \"readFile\",\n          filePath: filePath,\n          isReference: true, // Ê†áËÆ∞ËøôÊòØÂºïÁî®Ôºå‰∏çÊòØÁõ¥Êé•ÂàÜÊûê\n        });\n        \n        // ‰∏çÂÜçÂ∞ÜÊñá‰ª∂ÂÜÖÂÆπÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü‰∏≠\n        // Âè™‰øùÁïô @filename Ê†ºÂºèÔºåËÆ©ÂêéÁ´Ø resolveUserReferences Ëá™Âä®Â§ÑÁêÜ\n      }\n\n      function addMessage(text, role, isRaw = false) {\n        const div = document.createElement(\"div\");\n        div.className = `message ${role}-message`;\n        div.dataset.content = text; // ‰øùÂ≠òÂéüÂßãÊñáÊú¨ÂÜÖÂÆπ\n\n        // ÂàõÂª∫Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆÂÆπÂô®\n        const actionsDiv = document.createElement(\"div\");\n        actionsDiv.className = \"message-actions\";\n\n        // Â§çÂà∂ÊåâÈíÆ\n        const copyBtn = document.createElement(\"button\");\n        copyBtn.className = \"message-action-btn\";\n        copyBtn.innerHTML = \"üìã\";\n        copyBtn.title = \"Â§çÂà∂Ê∂àÊÅØ\";\n        copyBtn.onclick = (e) => {\n          e.stopPropagation();\n          copyMessageText(text);\n        };\n\n        // Âà†Èô§ÊåâÈíÆ\n        const deleteBtn = document.createElement(\"button\");\n        deleteBtn.className = \"message-action-btn\";\n        deleteBtn.innerHTML = \"üóëÔ∏è\";\n        deleteBtn.title = \"Âà†Èô§Ê∂àÊÅØ\";\n        deleteBtn.onclick = (e) => {\n          e.stopPropagation();\n          deleteMessage(div);\n        };\n\n        actionsDiv.appendChild(copyBtn);\n        actionsDiv.appendChild(deleteBtn);\n        div.appendChild(actionsDiv);\n\n        // ÂàõÂª∫Ê∂àÊÅØÂÜÖÂÆπÂÆπÂô®\n        const contentDiv = document.createElement(\"div\");\n        contentDiv.className = \"message-content\";\n\n        if (role === \"ai\") {\n          contentDiv.innerHTML = marked.parse(text);\n          // Â§ÑÁêÜ diff ‰ª£Á†ÅÂùó\n          processDiffBlocks(contentDiv);\n        } else {\n          contentDiv.textContent = text;\n        }\n\n        div.appendChild(contentDiv);\n        chatContainer.appendChild(div);\n        scrollToBottom();\n        return div;\n      }\n\n      // Â§çÂà∂Ê∂àÊÅØÊñáÊú¨\n      function copyMessageText(text) {\n        navigator.clipboard.writeText(text).then(() => {\n          showFlashNotification(\"‚úì Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø\");\n        }).catch((err) => {\n          console.error(\"Â§çÂà∂Â§±Ë¥•:\", err);\n          showFlashNotification(\"‚úó Â§çÂà∂Â§±Ë¥•\");\n        });\n      }\n\n      // Âà†Èô§Ê∂àÊÅØ\n      function deleteMessage(messageElement) {\n        if (confirm(\"Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü\")) {\n          // ‰ªé DOM ‰∏≠ÁßªÈô§\n          messageElement.remove();\n          showFlashNotification(\"‚úì Ê∂àÊÅØÂ∑≤Âà†Èô§\");\n          \n          // ÈÄöÁü•ÂêéÁ´ØÊõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÔºàÂ¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºâ\n          // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™Ê∂àÊÅØÂà∞ÂêéÁ´ØÔºåËÆ©ÂêéÁ´Ø‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âà†Èô§ËøôÊù°Ê∂àÊÅØ\n          // vscode.postMessage({ type: \"deleteMessage\", index: messageIndex });\n        }\n      }\n\n      // Ê£ÄÊµãÂπ∂Â§ÑÁêÜ diff ‰ª£Á†ÅÂùó\n      function processDiffBlocks(messageElement) {\n        const codeBlocks = messageElement.querySelectorAll(\"pre code\");\n\n        codeBlocks.forEach((codeBlock, index) => {\n          const content = codeBlock.textContent;\n          const preElement = codeBlock.parentElement;\n\n          // Ê£ÄÊµãÊòØÂê¶ÊòØ diff Ê†ºÂºè\n          if (isDiffContent(content)) {\n            preElement.classList.add(\"diff-block\");\n\n            // Ê∑ªÂä†Â∫îÁî®ÊåâÈíÆ\n            const applyBtn = document.createElement(\"button\");\n            applyBtn.className = \"apply-diff-btn\";\n            applyBtn.innerHTML = \"‚úì Apply\";\n            applyBtn.title = \"Apply this diff to your code\";\n\n            // Â≠òÂÇ® diff ÂÜÖÂÆπ\n            applyBtn.dataset.diffContent = content;\n            applyBtn.dataset.diffIndex = index;\n\n            applyBtn.onclick = () => applyDiff(applyBtn, content);\n\n            preElement.appendChild(applyBtn);\n          }\n        });\n      }\n\n      // Ê£ÄÊµãÊòØÂê¶ÊòØ diff ÂÜÖÂÆπ\n      function isDiffContent(content) {\n        const lines = content.trim().split(\"\\n\");\n\n        // Ê£ÄÊµãÂ∏∏ËßÅÁöÑ diff Ê†ºÂºèÁâπÂæÅ\n        const hasDiffMarkers = lines.some(\n          (line) =>\n            line.startsWith(\"+++\") ||\n            line.startsWith(\"---\") ||\n            line.startsWith(\"@@\") ||\n            line.match(/^diff --git/),\n        );\n\n        // ÊàñËÄÖÊ£ÄÊµãÊòØÂê¶ÊúâË∂≥Â§üÂ§öÁöÑ +/- Ë°å\n        const changeLines = lines.filter(\n          (line) => line.startsWith(\"+\") || line.startsWith(\"-\"),\n        );\n\n        return (\n          hasDiffMarkers ||\n          (changeLines.length >= 3 && changeLines.length / lines.length > 0.3)\n        );\n      }\n\n      // Â∫îÁî® diff\n      function applyDiff(button, diffContent) {\n        button.disabled = true;\n        button.innerHTML = \"‚è≥ Applying...\";\n\n        // Ëß£Êûê diff ÂÜÖÂÆπ\n        const diffData = parseDiff(diffContent);\n\n        if (!diffData) {\n          button.innerHTML = \"‚úó Invalid Diff\";\n          button.classList.add(\"error\");\n          setTimeout(() => {\n            button.disabled = false;\n            button.innerHTML = \"‚úì Apply\";\n            button.classList.remove(\"error\");\n          }, 2000);\n          return;\n        }\n\n        // ÂèëÈÄÅÂà∞ VS Code Êâ©Â±ïËøõË°åÂ∫îÁî®\n        vscode.postMessage({\n          type: \"applyDiff\",\n          value: diffData,\n        });\n\n        // Á≠âÂæÖÂìçÂ∫î\n        button.dataset.pending = \"true\";\n      }\n\n      // Ëß£Êûê diff ÂÜÖÂÆπ\n      function parseDiff(diffContent) {\n        const lines = diffContent.trim().split(\"\\n\");\n        let currentFile = null;\n        const files = [];\n\n        for (let i = 0; i < lines.length; i++) {\n          const line = lines[i];\n\n          // Ê£ÄÊµãÊñá‰ª∂Âêç\n          if (line.startsWith(\"--- \") || line.startsWith(\"+++ \")) {\n            const match = line.match(/^[+-]{3}\\s+(?:a\\/|b\\/)?(.+?)(?:\\s+|$)/);\n            if (match) {\n              const filename = match[1];\n              if (line.startsWith(\"---\")) {\n                currentFile = { oldFile: filename, newFile: null, hunks: [] };\n              } else if (currentFile) {\n                currentFile.newFile = filename;\n                files.push(currentFile);\n              }\n            }\n          }\n\n          // Ê£ÄÊµã hunk Â§¥ÈÉ® (@@)\n          if (line.startsWith(\"@@\") && currentFile) {\n            const hunkMatch = line.match(\n              /@@ -(\\d+)(?:,(\\d+))? \\+(\\d+)(?:,(\\d+))? @@/,\n            );\n            if (hunkMatch) {\n              const hunk = {\n                oldStart: parseInt(hunkMatch[1]),\n                oldLines: parseInt(hunkMatch[2] || \"1\"),\n                newStart: parseInt(hunkMatch[3]),\n                newLines: parseInt(hunkMatch[4] || \"1\"),\n                lines: [],\n              };\n\n              // Êî∂ÈõÜ hunk ÁöÑÂÜÖÂÆπ\n              i++;\n              while (\n                i < lines.length &&\n                !lines[i].startsWith(\"@@\") &&\n                !lines[i].startsWith(\"---\")\n              ) {\n                hunk.lines.push(lines[i]);\n                i++;\n              }\n              i--; // ÂõûÈÄÄ‰∏ÄË°å\n\n              currentFile.hunks.push(hunk);\n            }\n          }\n        }\n\n        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ê†áÂáÜÊ†ºÂºèÔºåÂ∞ùËØïÁÆÄÂçïÁöÑ +/- Ê†ºÂºè\n        if (files.length === 0) {\n          const addedLines = [];\n          const removedLines = [];\n          const contextLines = [];\n\n          lines.forEach((line) => {\n            if (line.startsWith(\"+\") && !line.startsWith(\"+++\")) {\n              addedLines.push(line.substring(1));\n            } else if (line.startsWith(\"-\") && !line.startsWith(\"---\")) {\n              removedLines.push(line.substring(1));\n            } else if (!line.startsWith(\"@@\")) {\n              contextLines.push(line);\n            }\n          });\n\n          if (addedLines.length > 0 || removedLines.length > 0) {\n            return {\n              type: \"simple\",\n              added: addedLines,\n              removed: removedLines,\n              context: contextLines,\n              raw: diffContent,\n            };\n          }\n        }\n\n        return files.length > 0\n          ? { type: \"unified\", files, raw: diffContent }\n          : null;\n      }\n\n      function scrollToBottom() {\n        chatContainer.scrollTop = chatContainer.scrollHeight;\n      }\n\n      function handleSend() {\n        const text = userInput.value.trim();\n        if (text) {\n          addMessage(text, \"user\");\n          vscode.postMessage({ type: \"ask\", value: text });\n          userInput.value = \"\";\n          userInput.style.height = \"auto\";\n          currentAiMessageElement = null;\n          currentAiRawText = \"\";\n          userInput.disabled = true;\n          sendBtn.style.display = \"none\";\n          stopBtn.classList.add(\"visible\");\n\n          // Ê∑ªÂä†Âä†ËΩΩÊåáÁ§∫Âô®\n          const loader = document.createElement(\"div\");\n          loader.id = \"ai-loader\";\n          loader.className = \"message ai-message system-message\";\n          loader.innerHTML =\n            '<div class=\"typing-indicator\"><div class=\"dot\"></div><div class=\"dot\"></div><div class=\"dot\"></div></div>';\n          chatContainer.appendChild(loader);\n          scrollToBottom();\n        }\n      }\n\n      function handleStop() {\n        vscode.postMessage({ type: \"stop\" });\n        addMessage(\"üõë Generation stopped by user\", \"system\");\n      }\n\n      sendBtn.addEventListener(\"click\", handleSend);\n      stopBtn.addEventListener(\"click\", handleStop);\n\n      userInput.addEventListener(\"keydown\", (e) => {\n        if (suggestionsList.style.display === \"block\") {\n          if (e.key === \"ArrowDown\") {\n            e.preventDefault();\n            selectedSuggestionIndex =\n              (selectedSuggestionIndex + 1) % currentSuggestions.length;\n            updateSuggestionSelection();\n          } else if (e.key === \"ArrowUp\") {\n            e.preventDefault();\n            selectedSuggestionIndex =\n              (selectedSuggestionIndex - 1 + currentSuggestions.length) %\n              currentSuggestions.length;\n            updateSuggestionSelection();\n          } else if (e.key === \"Enter\" || e.key === \"Tab\") {\n            e.preventDefault();\n            if (selectedSuggestionIndex !== -1) {\n              selectSuggestion(currentSuggestions[selectedSuggestionIndex]);\n            }\n          } else if (e.key === \"Escape\") {\n            hideSuggestions();\n          }\n          return;\n        }\n\n        if (e.key === \"Enter\" && !e.shiftKey) {\n          e.preventDefault();\n          handleSend();\n        }\n      });\n\n      exportBtn.addEventListener(\"click\", () => {\n        vscode.postMessage({ type: \"exportChat\" });\n      });\n\n      clearBtn.addEventListener(\"click\", () => {\n        vscode.postMessage({ type: \"clear\" }); // Â∑≤ÁªèÂú® Provider ‰∏≠ÂÆûÁé∞Ê∏ÖÁêÜÈÄªËæë\n      });\n\n      function updateSuggestionSelection() {\n        const items = suggestionsList.querySelectorAll(\".suggestion-item\");\n        items.forEach((item, index) => {\n          item.className =\n            \"suggestion-item\" +\n            (index === selectedSuggestionIndex ? \" selected\" : \"\");\n          if (index === selectedSuggestionIndex) {\n            item.scrollIntoView({ block: \"nearest\" });\n          }\n        });\n      }\n\n      // ÁõëÂê¨ÊñáÊú¨ÈÄâÊã©‰∫ã‰ª∂ÔºåËá™Âä®Â°´ÂÖ•ËæìÂÖ•Ê°Ü\n      document.addEventListener(\"mouseup\", () => {\n        const selection = window.getSelection();\n        const selectedText = selection.toString().trim();\n\n        if (selectedText) {\n          // Ê£ÄÊü•ÈÄâ‰∏≠ÁöÑÊñáÊú¨ÊòØÂê¶Âú®ËÅäÂ§©ÂÆπÂô®ÂÜÖ\n          const range = selection.getRangeAt(0);\n          const container = range.commonAncestorContainer;\n          const parentElement =\n            container.nodeType === Node.TEXT_NODE\n              ? container.parentElement\n              : container;\n\n          // Á°Æ‰øùÈÄâ‰∏≠ÁöÑÂÜÖÂÆπÂú®ËÅäÂ§©ÂÆπÂô®ÂÜÖÔºå‰∏î‰∏çÂú®ËæìÂÖ•Ê°ÜÂÜÖ\n          if (\n            chatContainer.contains(parentElement) &&\n            !userInput.contains(parentElement)\n          ) {\n            userInput.value = selectedText;\n            userInput.focus();\n\n            // ÈáçÊñ∞ËÆ°ÁÆóËæìÂÖ•Ê°ÜÈ´òÂ∫¶\n            userInput.style.height = \"auto\";\n            userInput.style.height = userInput.scrollHeight + \"px\";\n\n            // Ê∏ÖÈô§ÈÄâÊã©ÔºåÈÅøÂÖçËßÜËßâÂπ≤Êâ∞\n            selection.removeAllRanges();\n          }\n        }\n      });\n\n      // Ê∑ªÂä†‰∏Ä‰∏™Ê†áÂøóÊù•Ê†áËØÜÂΩìÂâçÊòØÂê¶Ê≠£Âú®ÊµÅÂºèÊé•Êî∂AIÊ∂àÊÅØ\n      let isStreaming = false;\n\n      // Ê†áËÆ∞ÊòØÂê¶Â∑≤ÁªèÂä†ËΩΩËøáÂéÜÂè≤ËÆ∞ÂΩï\n      let historyLoaded = false;\n\n      window.addEventListener(\"message\", (event) => {\n        const message = event.data;\n        const loader = document.getElementById(\"ai-loader\");\n\n        switch (message.type) {\n          case \"suggestions\":\n            showSuggestions(message.value, message.trigger);\n            break;\n          case \"history\":\n            // Âè™Âä†ËΩΩ‰∏ÄÊ¨°ÂéÜÂè≤ËÆ∞ÂΩïÔºåÈÅøÂÖçÈáçÂ§çÊ∏≤Êüì\n            if (!historyLoaded) {\n              historyLoaded = true;\n              chatContainer.innerHTML = \"\"; // Ê∏ÖÁ©∫ÂàùÂßãÂåñÁä∂ÊÄÅ\n              \n              if (message.value && message.value.length > 0) {\n                message.value.forEach((msg) => {\n                  addMessage(msg.content, msg.role === \"user\" ? \"user\" : \"ai\");\n                });\n                // ÊªöÂä®Âà∞Â∫ïÈÉ®\n                requestAnimationFrame(() => {\n                  scrollToBottom();\n                });\n              } else {\n                chatContainer.innerHTML = '<div class=\"message system-message\">‚ú® Yuangs AI Agent initialized and ready.</div>';\n              }\n            }\n            break;\n          case \"aiChunk\":\n            if (loader) {\n              loader.remove();\n              stopBtn.classList.add(\"visible\");\n            }\n\n            // ÂºÄÂßãÊµÅÂºèÊé•Êî∂\n            isStreaming = true;\n\n            if (!currentAiMessageElement) {\n              // ÂàõÂª∫AIÊ∂àÊÅØÂÆπÂô®\n              const aiMessageDiv = document.createElement(\"div\");\n              aiMessageDiv.className = \"message ai-message\"; // Áõ¥Êé•‰ΩøÁî®ÊúÄÁªàÊ†∑Âºè\n              // aiMessageDiv.style.minHeight = '24px'; // Èò≤Ê≠¢È´òÂ∫¶Â°åÈô∑\n              chatContainer.appendChild(aiMessageDiv);\n              currentAiMessageElement = aiMessageDiv;\n            }\n\n            currentAiRawText += message.value;\n\n            // ÂÆûÊó∂ Markdown Ê∏≤Êüì\n            // ÊäÄÂ∑ßÔºöÂ¶ÇÊûú‰ª£Á†ÅÂùóÊú™Èó≠ÂêàÔºåÊâãÂä®‰∏¥Êó∂Èó≠ÂêàÂÆÉ‰ª•‰øùËØÅÊ∏≤ÊüìÊ≠£Á°Æ\n            let textToRender = currentAiRawText;\n            const codeBlockCount = (textToRender.match(/```/g) || []).length;\n            if (codeBlockCount % 2 !== 0) {\n              textToRender += \"\\n```\";\n            }\n\n            // Ê∏≤ÊüìÂÜÖÂÆπÂπ∂Ê∑ªÂä†ÂÖâÊ†á\n            currentAiMessageElement.innerHTML =\n              marked.parse(textToRender) + '<span class=\"cursor\"></span>';\n\n            // Âπ≥ÊªëÊªöÂä®Âà∞Â∫ïÈÉ®\n            // ‰ΩøÁî® requestAnimationFrame ‰ºòÂåñÊªöÂä®ÊÄßËÉΩ\n            requestAnimationFrame(() => {\n              scrollToBottom();\n            });\n            break;\n          case \"done\":\n            // ÊµÅÂºè‰º†ËæìÁªìÊùü\n            if (isStreaming && currentAiMessageElement) {\n              isStreaming = false;\n\n              // ÁßªÈô§ÂÖâÊ†áÔºåËøõË°åÊúÄÁªàÊ∏≤Êüì\n              currentAiMessageElement.innerHTML =\n                marked.parse(currentAiRawText);\n\n              // Â§ÑÁêÜdiffÂùóÂíåÂÖ∂‰ªñÂêéÂ§ÑÁêÜ\n              processDiffBlocks(currentAiMessageElement);\n\n              // Ê∑ªÂä†Ê∑°ÂÖ•ÊïàÊûúÊàñÂÖ∂‰ªñÂÆåÊàêÂä®Êïà\n              currentAiMessageElement.classList.add(\"final-render\");\n            }\n\n            currentAiMessageElement = null;\n            currentAiRawText = \"\";\n            userInput.disabled = false;\n            userInput.focus();\n            sendBtn.style.display = \"flex\";\n            stopBtn.classList.remove(\"visible\");\n            \n            // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÁ°Æ‰øùÊñ∞Ê∂àÊÅØÂèØËßÅ\n            requestAnimationFrame(() => {\n              scrollToBottom();\n            });\n            break;\n          case \"clear\":\n            chatContainer.innerHTML =\n              '<div class=\"message system-message\">‚ú® Chat cleared.</div>';\n            userInput.disabled = false;\n            userInput.focus();\n            sendBtn.style.display = \"flex\";\n            stopBtn.classList.remove(\"visible\");\n            break;\n          case \"error\":\n            if (loader) loader.remove();\n            addMessage(\"‚ùå Error: \" + message.value, \"system\");\n            userInput.disabled = false;\n            userInput.focus();\n            sendBtn.style.display = \"flex\";\n            stopBtn.classList.remove(\"visible\");\n            break;\n          case \"diffApplied\":\n            // Diff Â∫îÁî®ÊàêÂäü\n            const successButtons = document.querySelectorAll(\n              '.apply-diff-btn[data-pending=\"true\"]',\n            );\n            successButtons.forEach((btn) => {\n              btn.innerHTML = \"‚úì Applied\";\n              btn.classList.add(\"applied\");\n              btn.disabled = true;\n              btn.dataset.pending = \"false\";\n            });\n            break;\n          case \"diffError\":\n            // Diff Â∫îÁî®Â§±Ë¥•\n            const errorButtons = document.querySelectorAll(\n              '.apply-diff-btn[data-pending=\"true\"]',\n            );\n            errorButtons.forEach((btn) => {\n              btn.innerHTML = \"‚úó Failed\";\n              btn.classList.add(\"error\");\n              btn.dataset.pending = \"false\";\n              setTimeout(() => {\n                btn.disabled = false;\n                btn.innerHTML = \"‚úì Apply\";\n                btn.classList.remove(\"error\");\n              }, 3000);\n            });\n            if (message.value) {\n              addMessage(\n                \"‚ùå Diff application error: \" + message.value,\n                \"system\",\n              );\n            }\n            break;\n          case \"contextUpdate\":\n            // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÊï∞ÊçÆ\n            if (typeof updateContextItems === \"function\") {\n              updateContextItems(message.value);\n            }\n            break;\n          case \"showContextPanel\":\n            // ÊòæÁ§∫‰∏ä‰∏ãÊñáÈù¢Êùø\n            if (typeof showContextPanel === \"function\") {\n              showContextPanel();\n            }\n            break;\n          case \"fileTreeData\":\n            // Êé•Êî∂Êñá‰ª∂Ê†ëÊï∞ÊçÆ\n            handleFileTreeData(message.value);\n            break;\n          case \"fileContent\":\n            // Êé•Êî∂Êñá‰ª∂ÂÜÖÂÆπ\n            handleFileContent(\n              message.filePath,\n              message.content,\n              message.isReference,\n            );\n            break;\n          case \"modelsConfig\":\n            // Êé•Êî∂Ê®°ÂûãÈÖçÁΩÆ\n            availableModels = message.value.availableModels || [];\n            currentModel = message.value.defaultModel || currentModel;\n            renderModelOptions();\n            updateCurrentModel(currentModel);\n            console.log(\"Models config received:\", availableModels);\n            break;\n        }\n      });\n\n      // ÂàùÂßãÂåñÊñá‰ª∂Èù¢Êùø\n      if (typeof setupFilesPanel === \"function\") {\n        setupFilesPanel();\n      }\n\n      // ÂàùÂßãÂåñ‰∏ä‰∏ãÊñáÈù¢Êùø\n      if (typeof setupContextPanel === \"function\") {\n        setupContextPanel();\n      }\n\n      // === Êñá‰ª∂Èù¢ÊùøÂäüËÉΩÂáΩÊï∞ ===\n\n      function setupFilesPanel() {\n        // Êñá‰ª∂Èù¢ÊùøÂºÄÂÖ≥\n        filesToggle.addEventListener(\"click\", () => {\n          filesPanel.classList.toggle(\"open\");\n          if (filesPanel.classList.contains(\"open\") && !fileTreeData) {\n            loadFileTree();\n          }\n        });\n\n        filesClose.addEventListener(\"click\", () => {\n          filesPanel.classList.remove(\"open\");\n        });\n\n        // ÊêúÁ¥¢ÂäüËÉΩ\n        filesSearch.addEventListener(\"input\", (e) => {\n          currentFileSearchQuery = e.target.value.toLowerCase();\n          renderFileTree();\n        });\n      }\n\n      // Âä†ËΩΩÊñá‰ª∂Ê†ë\n      function loadFileTree() {\n        filesPanelContent.innerHTML =\n          '<div class=\"file-loading\">Loading files...</div>';\n        vscode.postMessage({ type: \"loadFileTree\" });\n      }\n\n      // Â§ÑÁêÜÊñá‰ª∂Ê†ëÊï∞ÊçÆ\n      function handleFileTreeData(files) {\n        allFiles = files;\n        fileTreeData = buildFileTree(files);\n        renderFileTree();\n      }\n\n      // ÊûÑÂª∫Êñá‰ª∂Ê†ëÁªìÊûÑ\n      function buildFileTree(files) {\n        const root = {};\n\n        files.forEach((filePath) => {\n          const parts = filePath.split(\"/\");\n          let current = root;\n          let fullPath = \"\";\n\n          parts.forEach((part, index) => {\n            fullPath = fullPath ? fullPath + \"/\" + part : part;\n\n            if (!current[part]) {\n              current[part] = {\n                name: part,\n                path: fullPath, // ‰øùÂ≠òÂÆåÊï¥Ë∑ØÂæÑ\n                isFile: index === parts.length - 1,\n                children: {},\n              };\n            }\n            current = current[part];\n          });\n        });\n\n        return root;\n      }\n\n      // Ê∏≤ÊüìÊñá‰ª∂Ê†ë\n      function renderFileTree() {\n        if (!fileTreeData) {\n          filesPanelContent.innerHTML =\n            '<div class=\"file-empty\">No files loaded</div>';\n          return;\n        }\n\n        // ËøáÊª§Êñá‰ª∂\n        let filteredFiles = allFiles;\n        if (currentFileSearchQuery) {\n          filteredFiles = allFiles.filter((f) =>\n            f.toLowerCase().includes(currentFileSearchQuery),\n          );\n          filesStats.textContent = `${filteredFiles.length} files`;\n        } else {\n          filesStats.textContent = `${allFiles.length} files`;\n        }\n\n        // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Ê∏≤Êüì\n        filesPanelContent.innerHTML = \"\";\n\n        if (filteredFiles.length === 0) {\n          filesPanelContent.innerHTML =\n            '<div class=\"file-empty\">No matching files</div>';\n          return;\n        }\n\n        if (currentFileSearchQuery) {\n          // ÊêúÁ¥¢Ê®°ÂºèÔºöÊòæÁ§∫ÊâÅÂπ≥ÂàóË°®\n          renderFileList(filteredFiles);\n        } else {\n          // Ê†ëÂΩ¢Ê®°ÂºèÔºöÊòæÁ§∫Â±ÇÁ∫ßÁªìÊûÑ\n          renderTreeNode(fileTreeData, filesPanelContent, 0);\n        }\n      }\n\n      // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®ÔºàÊêúÁ¥¢Ê®°ÂºèÔºâ\n      function renderFileList(files) {\n        files.forEach((filePath) => {\n          const item = document.createElement(\"div\");\n          item.className = \"file-tree-item file\";\n\n          const icon = getFileIcon(filePath);\n          const fileName = filePath.split(\"/\").pop();\n\n          item.innerHTML = `\n                    <span class=\"file-tree-icon\">${icon}</span>\n                    <span class=\"file-tree-name\">${fileName}</span>\n                `;\n\n          item.addEventListener(\"click\", () => {\n            handleFileClick(filePath);\n          });\n\n          filesPanelContent.appendChild(item);\n        });\n      }\n\n      // Ê∏≤ÊüìÊ†ëËäÇÁÇπ\n      function renderTreeNode(node, container, level) {\n        const entries = Object.entries(node).sort((a, b) => {\n          // Êñá‰ª∂Â§πÊéíÂú®ÂâçÈù¢\n          if (a[1].isFile && !b[1].isFile) return 1;\n          if (!a[1].isFile && b[1].isFile) return -1;\n          return a[0].localeCompare(b[0]);\n        });\n\n        entries.forEach(([name, data]) => {\n          const item = document.createElement(\"div\");\n\n          if (!data.isFile) {\n            // Êñá‰ª∂Â§π\n            item.className = \"file-tree-item folder\";\n            item.style.paddingLeft = `${16 + level * 16}px`;\n\n            item.innerHTML = `\n                        <span class=\"file-tree-icon collapsed\" data-path=\"${name}\"></span>\n                        <span class=\"file-tree-name\">${name}</span>\n                    `;\n\n            const childrenContainer = document.createElement(\"div\");\n            childrenContainer.className = \"file-tree-children\";\n\n            item\n              .querySelector(\".file-tree-icon\")\n              .addEventListener(\"click\", (e) => {\n                e.stopPropagation();\n                const icon = e.target;\n                if (icon.classList.contains(\"collapsed\")) {\n                  icon.classList.remove(\"collapsed\");\n                  icon.classList.add(\"expanded\");\n                  childrenContainer.classList.add(\"expanded\");\n                } else {\n                  icon.classList.remove(\"expanded\");\n                  icon.classList.add(\"collapsed\");\n                  childrenContainer.classList.remove(\"expanded\");\n                }\n              });\n\n            item.addEventListener(\"click\", () => {\n              // ÈªòËÆ§Â±ïÂºÄ/ÊäòÂè†\n              const icon = item.querySelector(\".file-tree-icon\");\n              icon.click();\n            });\n\n            container.appendChild(item);\n            container.appendChild(childrenContainer);\n\n            // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êËäÇÁÇπ\n            renderTreeNode(data.children, childrenContainer, level + 1);\n          } else {\n            // Êñá‰ª∂\n            item.className = \"file-tree-item file\";\n            item.style.paddingLeft = `${16 + level * 16}px`;\n\n            const icon = getFileIcon(name);\n            item.innerHTML = `\n                        <span class=\"file-tree-icon\">${icon}</span>\n                        <span class=\"file-tree-name\">${name}</span>\n                    `;\n\n            item.addEventListener(\"click\", () => {\n              handleFileClick(data.path);\n            });\n\n            container.appendChild(item);\n          }\n        });\n      }\n\n      // Ëé∑ÂèñÊñá‰ª∂ÂõæÊ†á\n      function getFileIcon(filename) {\n        const ext = filename.split(\".\").pop().toLowerCase();\n        const iconMap = {\n          js: \"üìú\",\n          ts: \"üìò\",\n          tsx: \"‚öõÔ∏è\",\n          jsx: \"‚öõÔ∏è\",\n          html: \"üåê\",\n          css: \"üé®\",\n          scss: \"üé®\",\n          json: \"üìã\",\n          md: \"üìù\",\n          py: \"üêç\",\n          java: \"‚òï\",\n          go: \"üêπ\",\n          rs: \"ü¶Ä\",\n          cpp: \"‚öôÔ∏è\",\n          c: \"‚öôÔ∏è\",\n          h: \"üìÑ\",\n          vue: \"üíö\",\n          angular: \"üÖ∞Ô∏è\",\n          react: \"‚öõÔ∏è\",\n          yaml: \"üìã\",\n          yml: \"üìã\",\n          xml: \"üìã\",\n          sh: \"üíª\",\n          bash: \"üíª\",\n          zsh: \"üíª\",\n          git: \"üîÄ\",\n          lock: \"üîí\",\n          env: \"üîê\",\n          test: \"üß™\",\n          spec: \"üß™\",\n        };\n\n        return iconMap[ext] || \"üìÑ\";\n      }\n\n      // Â§ÑÁêÜÊñá‰ª∂ÁÇπÂáª\n      function handleFileClick(filePath) {\n        // ÁßªÈô§Á≥ªÁªüÊ∂àÊÅØÔºåÁõ¥Êé•ËØªÂèñÊñá‰ª∂\n        vscode.postMessage({\n          type: \"readFile\",\n          filePath: filePath,\n        });\n      }\n\n      // Â§ÑÁêÜÊñá‰ª∂ÂÜÖÂÆπ\n      function handleFileContent(filePath, content, isReference = false) {\n        console.log(`[handleFileContent] Received file: ${filePath}, isReference: ${isReference}, content length: ${content.length}`);\n        \n        if (isReference) {\n          // Â¶ÇÊûúÊòØÂºïÁî®ÔºåÂú®ËæìÂÖ•Ê°Ü‰∏≠Ê∑ªÂä†Êñá‰ª∂Ê†áËÆ∞\n          const currentValue = userInput.value;\n          const fileMarker = `\\`\\`\\`${getFileLanguage(filePath)}\\n// File: ${filePath}\\n${content}\\n\\`\\`\\`\\n\\n`;\n          userInput.value = currentValue + fileMarker;\n          userInput.focus();\n\n          // ÈáçÊñ∞ËÆ°ÁÆóÈ´òÂ∫¶ÔºåÁ°Æ‰øùÊñá‰ª∂ÂÜÖÂÆπÂèØËßÅ\n          userInput.style.height = \"auto\";\n          userInput.style.height = Math.max(userInput.scrollHeight, 120) + \"px\";\n          \n          // Á°Æ‰øùËæìÂÖ•Ê°ÜËÉΩÊªöÂä®Êü•ÁúãÊâÄÊúâÂÜÖÂÆπ\n          userInput.style.overflowY = \"auto\";\n\n          console.log(`[handleFileContent] Inserted file content into input box, total length: ${userInput.value.length}, height: ${userInput.style.height}`);\n          \n          // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫\n          showFlashNotification(`‚úì Â∑≤Ê∑ªÂä†Êñá‰ª∂ÂºïÁî®: ${filePath} (${content.length} Â≠óÁ¨¶)`);\n        } else {\n          // Áõ¥Êé•ÂàÜÊûêÊñá‰ª∂\n          console.log(\n            \"File content received for analysis:\",\n            filePath,\n            content.length,\n            \"bytes\",\n          );\n        }\n      }\n\n      // Ëé∑ÂèñÊñá‰ª∂ËØ≠Ë®ÄÔºàËæÖÂä©ÂáΩÊï∞Ôºâ\n      function getFileLanguage(filename) {\n        const ext = filename.split(\".\").pop()?.toLowerCase() || \"\";\n        const langMap = {\n          js: \"javascript\",\n          ts: \"typescript\",\n          tsx: \"typescript\",\n          jsx: \"javascript\",\n          py: \"python\",\n          java: \"java\",\n          go: \"go\",\n          rs: \"rust\",\n          cpp: \"cpp\",\n          c: \"c\",\n          h: \"c\",\n          vue: \"vue\",\n          yaml: \"yaml\",\n          yml: \"yaml\",\n          json: \"json\",\n          md: \"markdown\",\n          html: \"html\",\n          css: \"css\",\n          sh: \"bash\",\n          bash: \"bash\",\n        };\n        return langMap[ext] || \"text\";\n      }\n\n      // === ‰∏ä‰∏ãÊñáÈù¢ÊùøÂäüËÉΩÂáΩÊï∞ ===\n\n      // ‰∏ä‰∏ãÊñáÈù¢ÊùøÂºÄÂÖ≥\n      function setupContextPanel() {\n        // ‰∏ä‰∏ãÊñáÈù¢ÊùøÂºÄÂÖ≥\n        contextToggle.addEventListener(\"click\", () => {\n          contextPanel.classList.toggle(\"open\");\n          contextToggle.classList.toggle(\"visible\");\n        });\n\n        contextClose.addEventListener(\"click\", () => {\n          contextPanel.classList.remove(\"open\");\n          contextToggle.classList.remove(\"visible\");\n        });\n\n        // ËøáÊª§ÊåâÈíÆ‰∫ã‰ª∂\n        contextFilterBtns.forEach((btn) => {\n          btn.addEventListener(\"click\", () => {\n            // ÁßªÈô§ÊâÄÊúâactiveÁ±ª\n            contextFilterBtns.forEach((b) => b.classList.remove(\"active\"));\n            // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÊåâÈíÆ\n            btn.classList.add(\"active\");\n            // Êõ¥Êñ∞ËøáÊª§Âô®\n            currentFilter = btn.dataset.filter;\n            // ÈáçÊñ∞Ê∏≤Êüì\n            renderContextItems();\n          });\n        });\n\n        // ÊêúÁ¥¢ÂäüËÉΩ\n        contextSearch.addEventListener(\"input\", (e) => {\n          currentSearchQuery = e.target.value.toLowerCase();\n          renderContextItems();\n        });\n      }\n\n      // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÊï∞ÊçÆ\n      function updateContextItems(items) {\n        const oldCount = currentContextItems.length;\n        currentContextItems = items || [];\n        const newCount = currentContextItems.length;\n        \n        renderContextItems();\n        \n        // Â¶ÇÊûúÊúâÊõ¥Êñ∞ÔºåÊòæÁ§∫ flash ÈÄöÁü•\n        if (newCount > oldCount) {\n          showFlashNotification(`üìã Context updated: ${newCount - oldCount} new item${newCount - oldCount > 1 ? 's' : ''} added`);\n        }\n      }\n\n      // Ê∏≤Êüì‰∏ä‰∏ãÊñáÈ°πÁõÆ\n      function renderContextItems() {\n        // ËøáÊª§‰∏ä‰∏ãÊñáÈ°πÁõÆ\n        let filteredItems = currentContextItems.filter((item) => {\n          // Á±ªÂûãËøáÊª§\n          if (currentFilter !== \"all\" && item.semantic !== currentFilter) {\n            return false;\n          }\n\n          // ÊêúÁ¥¢ËøáÊª§\n          if (currentSearchQuery) {\n            const searchText = (\n              item.path +\n              item.summary +\n              item.content\n            ).toLowerCase();\n            if (!searchText.includes(currentSearchQuery)) {\n              return false;\n            }\n          }\n\n          return true;\n        });\n\n        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ\n        contextStats.textContent = `${filteredItems.length} items`;\n\n        // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Ê∏≤Êüì\n        contextPanelContent.innerHTML = \"\";\n\n        if (filteredItems.length === 0) {\n          contextPanelContent.innerHTML =\n            '<div class=\"context-empty\">No context available</div>';\n          return;\n        }\n\n        // Ê∏≤ÊüìÊØè‰∏™‰∏ä‰∏ãÊñáÈ°πÁõÆ\n        filteredItems.forEach((item) => {\n          const itemElement = createContextItemElement(item);\n          contextPanelContent.appendChild(itemElement);\n        });\n      }\n\n      // ÂàõÂª∫Âçï‰∏™‰∏ä‰∏ãÊñáÈ°πÁõÆÂÖÉÁ¥†\n      function createContextItemElement(item) {\n        const div = document.createElement(\"div\");\n        div.className = \"context-item collapsed\"; // ÈªòËÆ§ÊäòÂè†\n\n        // Ëé∑ÂèñÂõæÊ†á\n        const icon = getContextIcon(item.semantic);\n\n        // Ëé∑ÂèñÈáçË¶ÅÊÄßÁôæÂàÜÊØî\n        const importancePercent = item.importance\n          ? (item.importance.confidence * 100).toFixed(0)\n          : \"50\";\n\n        // Ëé∑ÂèñÊ†áÁ≠æHTML\n        const badgesHtml = createContextBadges(item);\n\n        // Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØ\n        const statsHtml = createContextStats(item);\n\n        // Ëé∑ÂèñÂÜÖÂÆπÈ¢ÑËßà\n        const previewText = item.summary || item.content.substring(0, 200);\n\n        div.innerHTML = `\n                <div class=\"context-item-header\">\n                    <span class=\"context-item-toggle\">‚ñ∂</span>\n                    <span class=\"context-item-icon\">${icon}</span>\n                    <span class=\"context-item-title\">${item.alias || item.path}</span>\n                    <div class=\"context-item-badges\">${badgesHtml}</div>\n                </div>\n                <div class=\"context-item-details\">\n                    <div class=\"context-item-stats\">${statsHtml}</div>\n                    <div class=\"context-usage-bar\">\n                        <div class=\"context-usage-fill\" style=\"width: ${importancePercent}%\"></div>\n                    </div>\n                    <div class=\"context-item-preview\">${previewText}</div>\n                </div>\n            `;\n\n        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ - ÂàáÊç¢Â±ïÂºÄ/ÊäòÂè†\n        div.addEventListener(\"click\", (e) => {\n          // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂\n          e.stopPropagation();\n          \n          // ÂàáÊç¢Â±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ\n          div.classList.toggle(\"collapsed\");\n          div.classList.toggle(\"expanded\");\n          \n          // Â¶ÇÊûúÂ±ïÂºÄÔºåÊâìÂºÄÊñá‰ª∂\n          if (!div.classList.contains(\"collapsed\") && item.path) {\n            vscode.postMessage({\n              type: \"open\",\n              path: item.path,\n            });\n          }\n          \n          console.log(\"Context item toggled:\", item, \"expanded:\", !div.classList.contains(\"collapsed\"));\n        });\n\n        return div;\n      }\n\n      // Ëé∑Âèñ‰∏ä‰∏ãÊñáÂõæÊ†á\n      function getContextIcon(semantic) {\n        const iconMap = {\n          source_code: \"üìÑ\",\n          log: \"üìã\",\n          config: \"‚öôÔ∏è\",\n          documentation: \"üìö\",\n          test: \"üß™\",\n          git: \"üîÄ\",\n          evidence: \"üîç\",\n          diagnostics: \"‚ö†Ô∏è\",\n        };\n\n        return iconMap[semantic] || \"üìÑ\";\n      }\n\n      // ÂàõÂª∫Ê†áÁ≠æ\n      function createContextBadges(item) {\n        const badges = [];\n\n        // Á±ªÂûãÊ†áÁ≠æ\n        if (item.semantic) {\n          badges.push(\n            `<span class=\"context-badge ${item.semantic}\">${item.semantic}</span>`,\n          );\n        }\n\n        // Ê†áÁ≠æ\n        if (item.tags && item.tags.length > 0) {\n          item.tags.slice(0, 2).forEach((tag) => {\n            badges.push(`<span class=\"context-badge\">${tag}</span>`);\n          });\n        }\n\n        return badges.join(\"\");\n      }\n\n      // ÂàõÂª∫ÁªüËÆ°‰ø°ÊÅØ\n      function createContextStats(item) {\n        const stats = [];\n\n        // TokenÊï∞Èáè\n        if (item.tokens) {\n          stats.push(\n            `<span class=\"context-stat\">üìä ${item.tokens} tokens</span>`,\n          );\n        }\n\n        // ‰ΩøÁî®Ê¨°Êï∞\n        if (item.importance && item.importance.useCount > 0) {\n          stats.push(\n            `<span class=\"context-stat\">üîÑ ${item.importance.useCount} uses</span>`,\n          );\n        }\n\n        // ÊúÄÂêé‰ΩøÁî®Êó∂Èó¥\n        if (item.importance && item.importance.lastUsed) {\n          const lastUsed = new Date(item.importance.lastUsed);\n          const now = new Date();\n          const diffMinutes = Math.floor((now - lastUsed) / 60000);\n\n          if (diffMinutes < 1) {\n            stats.push(`<span class=\"context-stat\">‚è∞ just now</span>`);\n          } else if (diffMinutes < 60) {\n            stats.push(\n              `<span class=\"context-stat\">‚è∞ ${diffMinutes}m ago</span>`,\n            );\n          } else if (diffMinutes < 1440) {\n            stats.push(\n              `<span class=\"context-stat\">‚è∞ ${Math.floor(diffMinutes / 60)}h ago</span>`,\n            );\n          } else {\n            stats.push(\n              `<span class=\"context-stat\">‚è∞ ${Math.floor(diffMinutes / 1440)}d ago</span>`,\n            );\n          }\n        }\n\n        return stats.join(\"\");\n      }\n\n      // ÊòæÁ§∫‰∏ä‰∏ãÊñáÈù¢Êùø\n      function showContextPanel() {\n        contextPanel.classList.add(\"open\");\n        contextToggle.classList.add(\"visible\");\n      }\n\n      // ÈöêËóè‰∏ä‰∏ãÊñáÈù¢Êùø\n      function hideContextPanel() {\n        contextPanel.classList.remove(\"open\");\n        contextToggle.classList.remove(\"visible\");\n      }\n\n      // ÊòæÁ§∫ flash ÈÄöÁü•\n      function showFlashNotification(message) {\n        const notification = document.createElement(\"div\");\n        notification.className = \"flash-notification\";\n        notification.textContent = message;\n        \n        document.body.appendChild(notification);\n        \n        // 3ÁßíÂêéËá™Âä®ÁßªÈô§\n        setTimeout(() => {\n          notification.remove();\n        }, 3000);\n      }\n\n      // === Ê®°ÂûãÈÄâÊã©Âô®ÂäüËÉΩ ===\n\n      const modelSelector = document.getElementById(\"model-selector\");\n      const modelDropdown = document.getElementById(\"model-dropdown\");\n      const currentModelLabel = document.getElementById(\"current-model\");\n\n      // ÂèØÁî®ÁöÑ AI Ê®°ÂûãÂàóË°®Ôºà‰ªéÂêéÁ´ØÂä†ËΩΩÔºâ\n      let availableModels = [];\n\n      // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã\n      let currentModel = \"gpt-4o-mini\";\n\n      // ÂàùÂßãÂåñÊ®°ÂûãÈÄâÊã©Âô®\n      function initModelSelector() {\n        // ‰ªéÊâ©Â±ïËé∑ÂèñÊ®°ÂûãÈÖçÁΩÆ\n        vscode.postMessage({ type: \"getModelsConfig\" });\n        // ÂêåÊó∂Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âûã\n        vscode.postMessage({ type: \"getCurrentModel\" });\n\n        // ÁÇπÂáªÂàáÊç¢‰∏ãÊãâËèúÂçï\n        modelSelector.addEventListener(\"click\", (e) => {\n          e.stopPropagation();\n          modelDropdown.classList.toggle(\"visible\");\n        });\n\n        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï\n        document.addEventListener(\"click\", (e) => {\n          if (!modelSelector.contains(e.target) && !modelDropdown.contains(e.target)) {\n            modelDropdown.classList.remove(\"visible\");\n          }\n        });\n\n        // ÈòªÊ≠¢‰∏ãÊãâËèúÂçïÂÜÖÈÉ®ÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°\n        modelDropdown.addEventListener(\"click\", (e) => {\n          e.stopPropagation();\n        });\n      }\n\n      // Ê∏≤ÊüìÊ®°ÂûãÈÄâÈ°π\n      function renderModelOptions() {\n        modelDropdown.innerHTML = \"\";\n\n        availableModels.forEach((model) => {\n          const option = document.createElement(\"div\");\n          option.className = `model-option ${model.id === currentModel ? \"active\" : \"\"}`;\n          option.innerHTML = `\n            <span class=\"model-option-name\">\n              <strong>${model.name}</strong>\n              <br>\n              <span style=\"opacity: 0.6; font-size: 0.9em;\">${model.description}</span>\n            </span>\n            <span class=\"model-option-icon\">${model.id === currentModel ? \"‚úì\" : \"\"}</span>\n          `;\n\n          option.addEventListener(\"click\", () => {\n            selectModel(model.id);\n          });\n\n          modelDropdown.appendChild(option);\n        });\n      }\n\n      // ÈÄâÊã©Ê®°Âûã\n      function selectModel(modelId) {\n        if (currentModel === modelId) {\n          modelDropdown.classList.remove(\"visible\");\n          return;\n        }\n\n        currentModel = modelId;\n        currentModelLabel.textContent = availableModels.find(m => m.id === modelId)?.name || modelId;\n\n        // ÈáçÊñ∞Ê∏≤ÊüìÈÄâÈ°π‰ª•Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ\n        renderModelOptions();\n\n        // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï\n        modelDropdown.classList.remove(\"visible\");\n\n        // ÂèëÈÄÅÂà∞Êâ©Â±ï\n        vscode.postMessage({ type: \"changeModel\", value: modelId });\n\n        // ÊòæÁ§∫ÂàáÊç¢ÊàêÂäüÊ∂àÊÅØ\n        addMessage(`üîÑ Â∑≤ÂàáÊç¢Âà∞Ê®°Âûã: ${availableModels.find(m => m.id === modelId)?.name}`, \"system\");\n      }\n\n      // Êõ¥Êñ∞ÂΩìÂâçÊ®°ÂûãÊòæÁ§∫\n      function updateCurrentModel(modelId) {\n        currentModel = modelId;\n        const model = availableModels.find(m => m.id === modelId);\n        currentModelLabel.textContent = model ? model.name : modelId;\n        renderModelOptions();\n      }\n\n      // Âú®Ê∂àÊÅØÁõëÂê¨Âô®‰∏≠Ê∑ªÂä†Ê®°ÂûãÁõ∏ÂÖ≥Â§ÑÁêÜ\n      window.addEventListener(\"message\", (event) => {\n        const message = event.data;\n\n        // Âú®Áé∞ÊúâÁöÑ switch ËØ≠Âè•‰∏≠Ê∑ªÂä†Êñ∞ case\n        if (message.type === \"currentModel\") {\n          updateCurrentModel(message.value);\n        }\n      });\n\n      // ÂàùÂßãÂåñÊ®°ÂûãÈÄâÊã©Âô®\n      initModelSelector();\n    </script>\n  </body>\n</html>\n",
    "id": "file:src/vscode/webview/sidebar.html",
    "tokens": 18328,
    "importance": 0.5,
    "lastUsedAt": 1769749122803
  },
  {
    "type": "file",
    "path": "/Users/ygs/ygs/vsyuangs/src/vscode/webview/context-panel-functions.js",
    "content": "// ‰∏ä‰∏ãÊñáÈù¢ÊùøÂäüËÉΩÂáΩÊï∞\n// Ëøô‰∫õÂáΩÊï∞Â∞ÜË¢´ÊèíÂÖ•Âà∞sidebar.html‰∏≠\n\n// ‰∏ä‰∏ãÊñáÈù¢ÊùøÂºÄÂÖ≥\nfunction setupContextPanel() {\n    // ‰∏ä‰∏ãÊñáÈù¢ÊùøÂºÄÂÖ≥\n    contextToggle.addEventListener('click', () => {\n        contextPanel.classList.toggle('open');\n        contextToggle.classList.toggle('visible');\n    });\n\n    contextClose.addEventListener('click', () => {\n        contextPanel.classList.remove('open');\n        contextToggle.classList.remove('visible');\n    });\n\n    // ËøáÊª§ÊåâÈíÆ‰∫ã‰ª∂\n    contextFilterBtns.forEach(btn => {\n        btn.addEventListener('click', () => {\n            // ÁßªÈô§ÊâÄÊúâactiveÁ±ª\n            contextFilterBtns.forEach(b => b.classList.remove('active'));\n            // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÊåâÈíÆ\n            btn.classList.add('active');\n            // Êõ¥Êñ∞ËøáÊª§Âô®\n            currentFilter = btn.dataset.filter;\n            // ÈáçÊñ∞Ê∏≤Êüì\n            renderContextItems();\n        });\n    });\n\n    // ÊêúÁ¥¢ÂäüËÉΩ\n    contextSearch.addEventListener('input', (e) => {\n        currentSearchQuery = e.target.value.toLowerCase();\n        renderContextItems();\n    });\n}\n\n// Êõ¥Êñ∞‰∏ä‰∏ãÊñáÊï∞ÊçÆ\nfunction updateContextItems(items) {\n    currentContextItems = items || [];\n    renderContextItems();\n}\n\n// Ê∏≤Êüì‰∏ä‰∏ãÊñáÈ°πÁõÆ\nfunction renderContextItems() {\n    // ËøáÊª§‰∏ä‰∏ãÊñáÈ°πÁõÆ\n    let filteredItems = currentContextItems.filter(item => {\n        // Á±ªÂûãËøáÊª§\n        if (currentFilter !== 'all' && item.semantic !== currentFilter) {\n            return false;\n        }\n        \n        // ÊêúÁ¥¢ËøáÊª§\n        if (currentSearchQuery) {\n            const searchText = (item.path + item.summary + item.content).toLowerCase();\n            if (!searchText.includes(currentSearchQuery)) {\n                return false;\n            }\n        }\n        \n        return true;\n    });\n\n    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ\n    contextStats.textContent = `${filteredItems.length} items`;\n    \n    // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Ê∏≤Êüì\n    contextPanelContent.innerHTML = '';\n    \n    if (filteredItems.length === 0) {\n        contextPanelContent.innerHTML = '<div class=\"context-empty\">No context available</div>';\n        return;\n    }\n\n    // Ê∏≤ÊüìÊØè‰∏™‰∏ä‰∏ãÊñáÈ°πÁõÆ\n    filteredItems.forEach(item => {\n        const itemElement = createContextItemElement(item);\n        contextPanelContent.appendChild(itemElement);\n    });\n}\n\n// ÂàõÂª∫Âçï‰∏™‰∏ä‰∏ãÊñáÈ°πÁõÆÂÖÉÁ¥†\nfunction createContextItemElement(item) {\n    const div = document.createElement('div');\n    div.className = 'context-item';\n    \n    // Ëé∑ÂèñÂõæÊ†á\n    const icon = getContextIcon(item.semantic);\n    \n    // Ëé∑ÂèñÈáçË¶ÅÊÄßÁôæÂàÜÊØî\n    const importancePercent = item.importance ? \n        (item.importance.confidence * 100).toFixed(0) : '50';\n    \n    // Ëé∑ÂèñÊ†áÁ≠æHTML\n    const badgesHtml = createContextBadges(item);\n    \n    // Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØ\n    const statsHtml = createContextStats(item);\n    \n    // Ëé∑ÂèñÂÜÖÂÆπÈ¢ÑËßà\n    const previewText = item.summary || item.content.substring(0, 200);\n    \n    div.innerHTML = `\n        <div class=\"context-item-header\">\n            <span class=\"context-item-icon\">${icon}</span>\n            <span class=\"context-item-title\">${item.alias || item.path}</span>\n            <div class=\"context-item-badges\">${badgesHtml}</div>\n        </div>\n        <div class=\"context-item-stats\">${statsHtml}</div>\n        <div class=\"context-usage-bar\">\n            <div class=\"context-usage-fill\" style=\"width: ${importancePercent}%\"></div>\n        </div>\n        <div class=\"context-item-preview\">${previewText}</div>\n    `;\n    \n    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂\n    div.addEventListener('click', () => {\n        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Êõ¥Â§ö‰∫§‰∫íÈÄªËæë\n        console.log('Context item clicked:', item);\n    });\n    \n    return div;\n}\n\n// Ëé∑Âèñ‰∏ä‰∏ãÊñáÂõæÊ†á\nfunction getContextIcon(semantic) {\n    const iconMap = {\n        'source_code': 'üìÑ',\n        'log': 'üìã',\n        'config': '‚öôÔ∏è',\n        'documentation': 'üìö',\n        'test': 'üß™',\n        'git': 'üîÄ',\n        'evidence': 'üîç',\n        'diagnostics': '‚ö†Ô∏è'\n    };\n    \n    return iconMap[semantic] || 'üìÑ';\n}\n\n// ÂàõÂª∫Ê†áÁ≠æ\nfunction createContextBadges(item) {\n    const badges = [];\n    \n    // Á±ªÂûãÊ†áÁ≠æ\n    if (item.semantic) {\n        badges.push(`<span class=\"context-badge ${item.semantic}\">${item.semantic}</span>`);\n    }\n    \n    // Ê†áÁ≠æ\n    if (item.tags && item.tags.length > 0) {\n        item.tags.slice(0, 2).forEach(tag => {\n            badges.push(`<span class=\"context-badge\">${tag}</span>`);\n        });\n    }\n    \n    return badges.join('');\n}\n\n// ÂàõÂª∫ÁªüËÆ°‰ø°ÊÅØ\nfunction createContextStats(item) {\n    const stats = [];\n    \n    // TokenÊï∞Èáè\n    if (item.tokens) {\n        stats.push(`<span class=\"context-stat\">üìä ${item.tokens} tokens</span>`);\n    }\n    \n    // ‰ΩøÁî®Ê¨°Êï∞\n    if (item.importance && item.importance.useCount > 0) {\n        stats.push(`<span class=\"context-stat\">üîÑ ${item.importance.useCount} uses</span>`);\n    }\n    \n    // ÊúÄÂêé‰ΩøÁî®Êó∂Èó¥\n    if (item.importance && item.importance.lastUsed) {\n        const lastUsed = new Date(item.importance.lastUsed);\n        const now = new Date();\n        const diffMinutes = Math.floor((now - lastUsed) / 60000);\n        \n        if (diffMinutes < 1) {\n            stats.push(`<span class=\"context-stat\">‚è∞ just now</span>`);\n        } else if (diffMinutes < 60) {\n            stats.push(`<span class=\"context-stat\">‚è∞ ${diffMinutes}m ago</span>`);\n        } else if (diffMinutes < 1440) {\n            stats.push(`<span class=\"context-stat\">‚è∞ ${Math.floor(diffMinutes / 60)}h ago</span>`);\n        } else {\n            stats.push(`<span class=\"context-stat\">‚è∞ ${Math.floor(diffMinutes / 1440)}d ago</span>`);\n        }\n    }\n    \n    return stats.join('');\n}\n\n// ÊòæÁ§∫‰∏ä‰∏ãÊñáÈù¢Êùø\nfunction showContextPanel() {\n    contextPanel.classList.add('open');\n    contextToggle.classList.add('visible');\n}\n\n// ÈöêËóè‰∏ä‰∏ãÊñáÈù¢Êùø\nfunction hideContextPanel() {\n    contextPanel.classList.remove('open');\n    contextToggle.classList.remove('visible');\n}\n",
    "id": "file:/Users/ygs/ygs/vsyuangs/src/vscode/webview/context-panel-functions.js",
    "tokens": 1402,
    "importance": 0.5,
    "lastUsedAt": 1769749136739
  }
]